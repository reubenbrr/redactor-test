if(void 0===CodeMirror)var CodeMirror;!function(){const t=[{}],s=`data${Date.now()}`;class r{constructor(t){t?t instanceof r?this.nodes=t.nodes:"string"==typeof t&&/^\s*<(\w+|!)[^>]*>/.test(t)?this.nodes=this.create(t):t instanceof NodeList||Array.isArray(t)?this.nodes=Array.from(t):t.nodeType&&11===t.nodeType?this.nodes=Array.from(t.childNodes):t.nodeType||this._isWindowNode(t)?this.nodes=[t]:this.nodes=this._slice(this._query(t)):this.nodes=[]}get length(){return this.nodes.length}create(t){const e=/^<(\w+)\s*\/?>(?:<\/\1>|)$/.exec(t);if(e)return[document.createElement(e[1])];const s=document.createElement("div");return s.innerHTML=t,Array.from(s.childNodes)}dataset(e,s){return this.each((i=>{const r=i.get();if(r){const i=this.dataindex(r);t[i][e]=s}}))}dataget(e){const s=this.get();if(s){const i=this.dataindex(s);return t[i][e]}}dataindex(e){if(!e)return null;let i=e[s];return i||(i=t.length,e[s]=i,t[i]={}),i}add(...t){return t.forEach((t=>{"string"==typeof t&&(t=new r(t).nodes),this.nodes=[...this.nodes,...this._array(t)]})),this}get(t=0){return this.nodes[t]||null}all(){return this.nodes}getAll(){return this.all()}eq(t){return new r(this.nodes[t]||null)}first(){return new r(this.nodes[0]||null)}last(){return new r(this.nodes[this.nodes.length-1]||null)}contents(){return this.get()?.childNodes||[]}each(t){return this.nodes.forEach(((e,s)=>t(new r(e),s))),this}map(t){return this.nodes.map(((e,s)=>t(new r(e),s)))}some(t){return this.nodes.some(((e,s)=>t(new r(e),s)))}is(t){return this.filter(t).length>0}filter(t){if(void 0===t)return new r(this.nodes);const e="function"==typeof t?e=>t(new r(e)):e=>(t=t instanceof r?t.get():t)instanceof Node?t===e:"string"==typeof t&&(1===e.nodeType&&e.matches(t||"*"));return new r(this.nodes.filter(e))}not(t){return this.filter((e=>!new r(e).is(t||!0)))}find(t){const e=[];return this.each((s=>{e.push(...this._query(t,s.get()))})),new r(e)}children(t){const e=[];return this.each((t=>{e.push(...t.get().children||[])})),new r(e).filter(t)}parent(t){const e=this.get(),s=e?e.parentNode:null;return s?new r(s).filter(t):new r}parents(t,e){e=this._context(e);const s=[];return this.each((i=>{let a=i.get().parentNode;for(;a&&a!==e;)t&&!new r(a).is(t)||s.push(a),a=a.parentNode})),new r(s)}closest(t,e){e=this._context(e),t=t instanceof r?t.get():t;const s=[];return this.each((i=>{let a=i.get();for(;a&&a!==e;){if(t instanceof Node?a===t:new r(a).is(t)){s.push(a);break}a=a.parentNode}})),new r(s)}next(t){return this._sibling(t,"nextSibling")}nextElement(t){return this._sibling(t,"nextElementSibling")}prev(t){return this._sibling(t,"previousSibling")}prevElement(t){return this._sibling(t,"previousElementSibling")}addClass(t){return this._eachClass(t,"add")}removeClass(t){return this._eachClass(t,"remove")}toggleClass(t,e){return this.each((s=>{const i=s.get();i&&i.classList&&t.split(" ").forEach((t=>{void 0!==e?i.classList.toggle(t,e):i.classList.toggle(t)}))}))}hasClass(t){const e=this.get();return!!(t&&e&&e.classList)&&t.split(" ").every((t=>e.classList.contains(t)))}swapClass(t,e){return this._eachClass(t,"remove")._eachClass(e,"add")}css(t,e){if(void 0===e&&"object"!=typeof t){const e=this.get();if(!e||!e.style)return;return"width"===t||"height"===t?this._getDimensions(t)+"px":getComputedStyle(e)[t]}const s="object"==typeof t?t:{[t]:e};return this.each((t=>{const e=t.get();e&&e.style&&Object.assign(e.style,s)}))}rect(){const t=this.offset(),e=this.width(),s=this.height(),i=Math.round(t.top),r=Math.round(t.left);return{top:i,left:r,bottom:i+s,right:r+e,width:e,height:s}}attr(t,e,s=!1){if(s=s?"data-":"",void 0===e&&"object"!=typeof t){const e=this.get();return e&&3!==e.nodeType?"checked"===t?e.checked:this._boolean(e.getAttribute(s+t)):void 0}return this.each((i=>{const r=i.get();if(!r||3===r.nodeType)return;const a="object"==typeof t?t:{[t]:e};Object.entries(a).forEach((([t,e])=>{"checked"===t?r.checked=e:r.setAttribute(s+t,e)}))}))}data(t,e){if(void 0===t||!0===t){const e=/^data-(.+)$/,s=this.get().attributes,i={};return Array.from(s).forEach((s=>{if(e.test(s.nodeName)){let r=s.nodeName.match(e)[1],a=s.value;!0!==t&&(r=r.replace(/-([a-z])/g,((t,e)=>e.toUpperCase()))),a=a.startsWith("{")?this._object(a):this._number(a)?parseFloat(a):this._boolean(a),i[r]=a}})),i}return this.attr(t,e,!0)}val(t){if(void 0===t){const t=this.get();return"checkbox"===t.type?t.checked:t.value}return this.each((e=>{const s=e.get();"checkbox"===s.type?s.checked=t:s.value=t}))}removeAttr(t){return this.each((e=>{const s=e.get();3!==s.nodeType&&t.split(" ").forEach((t=>s.removeAttribute(t)))}))}removeEmptyAttr(t){return""===this.attr(t)&&!!this.removeAttr(t)}tag(t){let e=this.get();if(3===e.nodeType)return!1;let s=e.tagName.toLowerCase();return void 0===t?s:t.toLowerCase()===s}tagName(t){return this.tag(t)}empty(){return this.each((t=>{t.get().innerHTML=""}))}html(t){return void 0===t?this.get().innerHTML||"":this.empty().append(t)}text(t){return void 0===t?this.get().textContent||"":this.each((e=>{e.get().textContent=t}))}outer(){return this.get().outerHTML}after(...t){return t.forEach((t=>this._insert(t,"after"))),this}before(...t){return t.forEach((t=>this._insert(t,"before"))),this}append(...t){return t.forEach((t=>this._insert(t,"append"))),this}prepend(...t){return t.forEach((t=>this._insert(t,"prepend"))),this}wrap(t){return this._inject(t,((t,e)=>{const s="string"==typeof t||"number"==typeof t?this.create(t)[0]:t instanceof Node?t:this._array(t)[0];return e.parentNode&&e.parentNode.insertBefore(s,e),s.appendChild(e),s}))}unwrap(){return this.each((t=>{const e=t.get(),s=document.createDocumentFragment();for(;e.firstChild;)s.appendChild(e.firstChild);e.parentNode&&e.parentNode.replaceChild(s,e)}))}replaceWith(t){return this._inject(t,((t,e)=>{const s=document.createDocumentFragment();("string"==typeof t||"number"==typeof t?this.create(t):t instanceof Node?[t]:this._array(t)).forEach((t=>s.appendChild(t)));const i=s.firstChild;return e.parentNode&&e.parentNode.replaceChild(s,e),i}),!0)}replaceTag(t,e=!0){const s=this.nodes.map((s=>{const i=document.createElement(t);if(e)for(;s.firstChild;)i.appendChild(s.firstChild);return Array.from(s.attributes).forEach((t=>{i.setAttribute(t.name,t.value)})),s.parentNode&&s.parentNode.replaceChild(i,s),i}));return new r(s)}remove(){return this.each((t=>{t.get().remove()}))}clone(t){const e=[];return this.each((s=>{let i=s.get(),r=this._clone(i);t&&(r=this._cloneEvents(i,r)),e.push(r)})),new r(e)}cloneAttrs(t){const e=new r(t);return e.length?this.each((t=>{const s=t.get().attributes;for(const t of s)e.attr(t.name,t.value)})):this}cloneEmpty(){return new r(`<${this.tag()}>`)}toggle(t){return this.each((e=>{const s=e.get();s&&s.style&&(void 0===t?this._hasDisplayNone(s)?e.show():e.hide():t?e.show():e.hide())}))}show(){return this.each((t=>{const e=t.get();if(!e.style||!this._hasDisplayNone(e))return;const s=e.getAttribute("domTargetShow")||"block";e.style.setProperty("display",s,"important"),e.removeAttribute("domTargetShow")}))}hide(){return this.each((t=>{const e=t.get();if(!e.style||this._hasDisplayNone(e))return;const s=e.style.display;s&&"block"!==s&&e.setAttribute("domTargetShow",s),e.style.setProperty("display","none","important")}))}scrollTop(t){const e=this.get(),s=this._isWindowNode(e),i=9===e.nodeType?e.scrollingElement||e.documentElement:e;if(void 0!==t){const r=parseInt(t,10);return s?e.scrollTo(0,r):i.scrollTop=r,this}return s?e.pageYOffset:i.scrollTop}scroll(){this.get().scrollIntoView({behavior:"smooth"})}offset(){return this._getPos("offset")}position(){return this._getPos("position")}width(t){return void 0!==t?this.css("width",`${parseInt(t,10)}px`):this._getSize("width","Width")}height(t){return void 0!==t?this.css("height",`${parseInt(t,10)}px`):this._getSize("height","Height")}outerWidth(){return this._getSize("width","Width","outer")}outerHeight(){return this._getSize("height","Height","outer")}innerWidth(){return this._getSize("width","Width","inner")}innerHeight(){return this._getSize("height","Height","inner")}click(){return this._trigger("click")}focus(t={}){return this._trigger("focus",t)}blur(){return this._trigger("blur")}on(t,e,s=!1){return this.each((i=>{const r=i.get();t.split(" ").forEach((i=>{const a=this._getEventName(i),n=this._getEventNamespace(i),o=s?this._getOneHandler(e,t):e;r.addEventListener(a,o),r._e=r._e||{},r._e[n]=r._e[n]||{},r._e[n][a]=r._e[n][a]||[],r._e[n][a].push(o)}))}))}one(t,e){return this.on(t,e,!0)}off(t,e){const s=(t,e,s)=>t===s,i=(t,e,s,i)=>e===i,r=(t,e,s,i)=>t===s&&e===i,a=()=>!0;return void 0===t?this.each((t=>{this._offEvent(t.get(),!1,!1,e,a)})):this.each((a=>{const n=a.get();t.split(" ").forEach((t=>{const a=this._getEventName(t),o=this._getEventNamespace(t);"_events"===o?this._offEvent(n,a,o,e,s):a||"_events"===o?this._offEvent(n,a,o,e,r):this._offEvent(n,a,o,e,i)}))}))}serialize(t=!1){const e={},s=this.get().elements;return Array.from(s).forEach((t=>{/(checkbox|radio)/.test(t.type)&&!t.checked||!t.name||t.disabled||"file"===t.type||("select-multiple"===t.type?Array.from(t.options).forEach((s=>{s.selected&&(e[t.name]=s.value)})):e[t.name]=this._number(t.value)?parseFloat(t.value):this._boolean(t.value))})),t?e:this._params(e)}fadeIn(t,e){const s=this._anim(t,e,500);return this.each((t=>{t.css({display:"block",opacity:0,animation:`fadeIn ${s.speed}s ease-in-out`}).removeClass("hidden"),t.one("animationend",(()=>{t.css({opacity:"",animation:""}),s.fn&&s.fn(t)}))}))}fadeOut(t,e){const s=this._anim(t,e,300);return this.each((t=>{t.css({opacity:1,animation:`fadeOut ${s.speed}s ease-in-out`}),t.one("animationend",(()=>{t.css({display:"none",opacity:"",animation:""}),s.fn&&s.fn(t)}))}))}slideUp(t,e){const s=this._anim(t,e,300);return this.each((t=>{const e=t.height();t.height(e),t.css({overflow:"hidden",animation:`slideUp ${s.speed}s ease-out`}),t.one("animationend",(()=>{t.css({display:"none",height:"",animation:""}),s.fn&&s.fn(t)}))}))}slideDown(t,e){const s=this._anim(t,e,400);return this.each((t=>{const e=t.height();t.height(e),t.css({display:"block",overflow:"hidden",animation:`slideDown ${s.speed}s ease-in-out`}).removeClass("hidden"),t.one("animationend",(()=>{t.css({overflow:"",height:"",animation:""}),s.fn&&s.fn(t)}))}))}_params(t){return Object.keys(t).map((e=>`${this._encodeUri(e)}=${this._encodeUri(t[e])}`)).join("&")}_encodeUri(t){return encodeURIComponent(t).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")}_getOneHandler(t,e){return(...s)=>{t.apply(this,s),this.off(e,t)}}_getEventNamespace(t){const[e,s="_events",i]=t.split(".");return i?`${s}${i}`:s}_getEventName(t){return t.split(".")[0]}_offEvent(t,e,s,i,r){Object.keys(t._e||{}).forEach((a=>{Object.keys(t._e[a]).forEach((n=>{if(r(n,a,e,s)){const e=t._e[a][n];for(let s=e.length-1;s>=0;s--)i&&e[s].toString()!==i.toString()||(t.removeEventListener(n,e[s]),e.splice(s,1));0===e.length&&delete t._e[a][n],0===Object.keys(t._e[a]).length&&delete t._e[a]}}))}))}_trigger(t,e={}){const s=this.get();return s&&3!==s.nodeType&&"function"==typeof s[t]&&s[t](e),this}_hasDisplayNone(t){return"none"===(t.style.display||getComputedStyle(t).display)}_clone(t){if(void 0!==t)return"string"==typeof t?t:t instanceof Node?t.cloneNode(!0):"length"in t?Array.from(this._array(t)).map((t=>t.cloneNode(!0))):void 0}_cloneEvents(t,e){if(t._e){e._e={...t._e};for(const[s,i]of Object.entries(t._e._events||{}))i.forEach((t=>e.addEventListener(s,t)))}return e}_insert(t,e){return this._inject(t,((t,s)=>{const i={after:"afterend",before:"beforebegin",append:"beforeend",prepend:"afterbegin"};if("string"==typeof t||"number"==typeof t)s.insertAdjacentHTML(i[e],t);else{let i=t instanceof Node?[t]:this._array(t);"after"===e&&i.reverse(),i.forEach((t=>s[e](t)))}return s}))}_inject(t,e,s=!1){const i=this.nodes.map(((i,a)=>{const n=s?new r(i):i,o="function"==typeof t?t.call(this,n):t,l=0===a?o:this._clone(o);return e.call(this,l,i)}));return new r(i.filter((t=>t)))}_getSize(t,e,s=""){const i=this.get();return i?3===i.nodeType?0:9===i.nodeType?this._getDocSize(i,e):this._isWindowNode(i)?window[`inner${e}`]:"outer"===s?i[`offset${e}`]:"inner"===s?i[`client${e}`]:this._getDimensions(t):0}_getDocSize(t,e){const s=t.body,i=t.documentElement;return Math.max(s[`scroll${e}`],s[`offset${e}`],i[`client${e}`],i[`scroll${e}`],i[`offset${e}`])}_getPos(t){const e=this.get(),s={top:0,left:0};if(3===e.nodeType||this._isWindowNode(e)||9===e.nodeType)return s;if("position"===t)return{top:e.offsetTop,left:e.offsetLeft};if("offset"===t){const t=e.getBoundingClientRect(),s=e.ownerDocument,i=s.documentElement,r=s.defaultView;return{top:Math.round(t.top+r.pageYOffset-i.clientTop),left:Math.round(t.left+r.pageXOffset-i.clientLeft)}}return s}_getDimensions(t){const e=t.charAt(0).toUpperCase()+t.slice(1),s=this.get();if(!s)return 0;const i=getComputedStyle(s);let r=0;const a=this.parents().filter((t=>{const e=t.get();return 1===e.nodeType&&"none"===getComputedStyle(e).display}));if("none"===i.display&&a.add(s),0!==a.length){const t="visibility: hidden !important; display: block !important;",i=[];a.each(((e,s)=>{const r=e.attr("style");i[s]=null!==r?r:"",e.attr("style",r?r+";"+t:t)})),r=s[`offset${e}`],a.each(((t,e)=>{i[e]?t.attr("style",i[e]):t.removeAttr("style")}))}else r=s[`offset${e}`];return r}_boolean(t){return"true"===t||"false"!==t&&t}_number(t){return!isNaN(t)&&!isNaN(parseFloat(t))}_object(t){try{const e=t.replace(/(\w+)\s*:/g,'"$1":');return JSON.parse(e)}catch(t){return null}}_eachClass(t,e){return this.each(((s,i)=>{const r=s.get();if("function"==typeof t){const s=t(r.className);s&&s.split(" ").forEach((t=>r.classList[e](t)))}else t&&t.split(" ").forEach((t=>r.classList[e](t)))}))}_sibling(t,e){let s=null;return this.each((i=>{let a=i.get();for(;a=a[e];)if(t instanceof Node?a===t:new r(a).is(t)){s=a;break}})),new r(s)}_array(t){return void 0===t?[]:t instanceof NodeList?Array.from(t):t instanceof r?t.nodes:"object"==typeof t?Array.from(t):Array.isArray(t)?t:[t]}_slice(t){return Array.from(t?.nodes||t||[])}_query(t,e){return e?this._queryContext(t,e):this._simpleQuery(t)}_simpleQuery(t){const e=document;return/^[.#]?[\w-]*$/.test(t)?"#"===t[0]?[e.getElementById(t.slice(1))].filter(Boolean):"."===t[0]?e.getElementsByClassName(t.slice(1)):e.getElementsByTagName(t):e.querySelectorAll(t)}_queryContext(t,e){return 3!==(e=this._context(e)).nodeType&&"function"==typeof e.querySelectorAll?e.querySelectorAll(t):[]}_context(t){return t?"string"==typeof t?document.querySelector(t):t:document}_isWindowNode(t){return t===window||t?.parent===window}_anim(t,e,s){return"function"==typeof t?(e=t,t=s):t=t||s,{fn:e||null,speed:t/1e3}}}var a={settings:{},post:function(t){return new n("post",t)},get:function(t){return new n("get",t)},request:function(t,e){return new n(t,e)}},n=function(t,e){var s={method:t,url:"",before(){},success(){},error(){},data:!1,async:!0,headers:{}};this.p=this.extend(s,e),this.p=this.extend(this.p,a.settings),this.p.method=this.p.method.toUpperCase(),this.prepareData(),this.xhr=new XMLHttpRequest,this.xhr.open(this.p.method,this.p.url,this.p.async),this.setHeaders(),!1!==("function"!=typeof this.p.before||this.p.before(this.xhr))&&this.send()};n.prototype={extend:(t,e)=>(e&&Object.keys(e).forEach((function(s){t[s]=e[s]})),t),prepareData(){if(-1===["POST","PUT"].indexOf(this.p.method)||this.isFormData()||(this.p.headers["Content-Type"]="application/x-www-form-urlencoded"),"object"!=typeof this.p.data||this.isFormData()||(this.p.data=this.toParams(this.p.data)),"GET"===this.p.method){var t=-1!==this.p.url.search(/\?/)?"&":"?";this.p.url=this.p.data?this.p.url+t+this.p.data:this.p.url}},setHeaders(){this.xhr.setRequestHeader("X-Requested-With",this.p.headers["X-Requested-With"]||"XMLHttpRequest"),Object.keys(this.p.headers).forEach(function(t){this.xhr.setRequestHeader(t,this.p.headers[t])}.bind(this))},isFormData(){return void 0!==window.FormData&&this.p.data instanceof window.FormData},isComplete(){return!(this.xhr.status<200||this.xhr.status>=300&&304!==this.xhr.status)},send(){this.p.async?(this.xhr.onload=this.loaded.bind(this),this.xhr.send(this.p.data)):(this.xhr.send(this.p.data),this.loaded.call(this))},loaded(){var t;this.isComplete()?(t=this.parseResponse(),"function"==typeof this.p.success&&this.p.success(t,this.xhr)):(t=this.parseResponse(),"function"==typeof this.p.error&&this.p.error(t,this.xhr,this.xhr.status))},parseResponse(){var t=this.xhr.response,e=this.parseJson(t);return e||t},parseJson(t){try{var e=JSON.parse(t);if(e&&"object"==typeof e)return e}catch(t){return!1}return!1},toParams:t=>Object.keys(t).map((function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])})).join("&")};let o=0,l=function(t,e){let s,i=new r(t);return i.each((t=>{s=t.dataget(l.namespace),s||(s=new h(t,e,o),t.dataset(l.namespace,s),l.instances[o]=s,o++)})),i.length>1?l.instances:s};l.dom=function(t){return new r(t)},l.ajax=a,l.mapping={},l._mixins={},l.instances=[],l.namespace="redactor",l.version="4.4.6",l.settings={},l.lang={},l.triggers={},l.customTags=[],l.keycodes={BACKSPACE:8,DELETE:46,UP:38,DOWN:40,ENTER:13,SPACE:32,ESC:27,TAB:9,CTRL:17,META:91,SHIFT:16,ALT:18,RIGHT:39,LEFT:37},l.add=function(t,e,s){if(s.translations&&(l.lang=l.extend(!0,l.lang,s.translations)),"block"!==t&&s.defaults){let t={};t[e]=s.defaults,l.opts=l.extend(!0,l.opts,t)}if("block"===t&&s.props.custom&&l.customTags.push(s.props.custom),s.nested&&(l.opts.nested.push(e),l.opts.nestedValue.push(s.nested)),void 0!==s.parser&&!1===s.parser&&l.opts.nonparse.push(e),s.triggers&&(l.triggers=l.extend(!0,l.triggers,s.triggers)),"mixin"===t)l._mixins[e]=s;else{let i=function(){};if(i.prototype=s,s.mixins)for(let t=0;t<s.mixins.length;t++)l.inherit(i,l._mixins[s.mixins[t]]);void 0===l.mapping[t]&&(l.mapping[t]={}),l.mapping[t][e]={type:t,proto:i,obj:s}}},l.addLang=function(t,e){"object"==typeof t?l.lang=l.extend(!0,{},l.lang,t):(void 0===l.lang[t]&&(l.lang[t]={}),l.lang[t]=l.extend(!0,l.lang[t],e))},l.extend=function(){let t,e,s={},i=!1,r=0,a=arguments.length;for("[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(i=arguments[0],r++),e=function(e){for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(!e[t]||!0!==e[t].set&&!0!==e[t]._replace||(s[t]={}),i&&"[object Object]"===Object.prototype.toString.call(e[t])?s[t]=l.extend(!0,s[t],e[t]):s[t]=e[t],void 0!==s[t]&&(delete s[t].set,delete s[t]._replace))};r<a;r++){e(arguments[r])}return s},l.inherit=function(t,e){let s=function(){};s.prototype=e;let i=new s;for(let e in t.prototype)t.prototype.__lookupGetter__(e)?i.__defineGetter__(e,t.prototype.__lookupGetter__(e)):i[e]=t.prototype[e];return t.prototype=i,t.prototype.super=e,t},l.opts={plugins:[],focus:!1,tabindex:!1,content:!1,data:!1,output:!1,css:!1,cssFile:"redactor.min.css",frame:{lang:!1,dir:!1},doctype:"<!doctype html>",csscache:!1,custom:{css:!1,js:!1},lang:"en",breakline:!1,markup:"p",structure:!1,command:!0,nocontainer:!1,nostyle:!1,https:!1,clicktoedit:!1,theme:"auto",themeAttr:!1,placeholder:!1,readonly:!1,disabled:!1,dataBlock:"data-block",classname:"rx-content",dir:"ltr",reloadmarker:!0,addPosition:"top",spellcheck:!0,grammarly:!1,notranslate:!1,width:"100%",padding:"20px 28px",minHeight:"72px",maxHeight:!1,classes:!1,templateSyntax:!1,source:!0,enterKey:!0,drop:!0,draggable:!1,reorder:!0,scrollTarget:!1,scrollOverflow:!1,sync:!0,syncDelay:300,codemirror:!1,codemirrorSrc:!1,ai:!1,bsmodal:!1,paragraphize:!0,paragraphizer:{selfClosingXmlTags:!1},block:{outline:!0},colorpicker:{size:!1,wrap:!1,row:!1,width:!1},container:{border:!0},state:{limit:200},autosave:{url:!1,name:!1,data:!1,method:"post",interval:!1},toolbar:{raised:!1,target:!1,sharedTarget:!1,sticky:!0,stickyMinHeight:200,stickyTopOffset:0},statusbar:{sticky:!1,target:!1},pathbar:!1,control:!0,context:!1,clean:{comments:!1,enter:!0,enterinline:!0},tab:{key:!0,spaces:!1},format:!0,addbar:!0,extrabar:!0,addbarItems:{},inlineItems:{},formatItems:{},replaceTags:!1,buttons:{toolbar:["add","ai-tools","html","format","bold","italic","deleted","moreinline","list","link","image","table"],extrabar:["hotkeys"],control:["toggle"],context:["ai-tools","format","bold","italic","deleted","moreinline","link"],icons:!1},popups:{format:["text","h1","h2","h3","h4","quote","bulletlist","numberedlist","todo"],control:["add","move-up","move-down","duplicate","trash"],addbar:["ai-prompt","ai-image","text","heading","image","todo","list","embed","table","quote","pre","line","layout","wrapper"],inline:["code","underline","sup","sub","highlight","removeinline"]},active:{tags:{b:["bold"],strong:["bold"],i:["italic"],em:["italic"],del:["deleted"],u:["underline"],a:["link"],code:["code"],mark:["mark"],sub:["subscript"],sup:["superscript"],h1:["h1"],h2:["h2"],h3:["h3"],h4:["h4"],h5:["h5"],h6:["h6"],ul:["bulletlist"],ol:["numberedlist"]},blocks:{listitem:["list"],list:["list"],pre:["pre"],table:["table"],cell:["table"],image:["image"],embed:["embed"],layout:["layout"],wrapper:["wrapper"],todo:["todo"],text:["text"],quote:["quote"]}},paste:{clean:!0,autoparse:!0,paragraphize:!0,paragraphizeLines:!1,stripAttr:!0,plaintext:!1,linkTarget:!1,images:!0,links:!0,keepIdAttr:!1,keepNameAttr:!1,keepClass:[],keepStyle:[],keepAttrs:["td","th"],keepWordFormatting:{},keepEmptyLines:!1,formTags:["form","input","button","select","textarea","legend","fieldset"],blockTags:["pre","h1","h2","h3","h4","h5","h6","table","tbody","thead","tfoot","th","tr","td","ul","ol","li","dl","dt","dd","blockquote","p","hr","figure","iframe","figcaption","address"],inlineTags:["a","svg","img","br","strong","ins","code","del","span","samp","kbd","sup","sub","mark","var","cite","small","b","u","em","i","abbr"]},link:{create:!1,edit:!1,truncate:24},image:{create:!1,edit:!1,states:!0,upload:!1,url:!0,select:!1,selectMethod:"get",name:"file",data:!1,drop:!0,multiple:!0,clipboard:!0,types:["image/*"],tag:"figure",newtab:!1,link:!0,width:!1},layout:{grid:!1,column:!1},layouts:{single:{title:"## layout.single-column ##",pattern:"100%"},"two-columns":{title:"## layout.two-columns ##",pattern:"50%|50%"},"three-columns":{title:"## layout.three-columns ##",pattern:"33%|33%|33%"},"four-columns":{title:"## layout.four-columns ##",pattern:"25%|25%|25%|25%"},"60-40":{title:"60/40",pattern:"60%|40%"},"40-60":{title:"40/60",pattern:"40%|60%"}},wrapper:{template:"<div></div>"},figcaption:{template:"<figcaption></figcaption>"},line:{template:"<hr>"},noneditable:{remove:!0,select:!0},pre:{template:"<pre></pre>",spaces:4},table:{template:"<table><tr><td></td><td></td></tr><tr><td></td><td></td></tr></table>",nowrap:"nowrap"},todo:{toggleClass:!1,templateItem:"[ ]",templateItemDone:"[x]",templateInput:'<input type="checkbox">',templateContent:"<div></div>",template:!1},quote:{template:'<blockquote><p data-placeholder="Quote..."></p><p><cite data-placeholder="Attribution"></cite></p></blockquote>'},embed:{classname:"embed-content",responsive:!1,responsiveClassname:"embed-responsive",script:!0},outset:{none:"none",left:"outset-left",both:"outset-both",right:"outset-right"},wrapWithStyle:!1,wrap:{none:"none",left:"float-left",center:"wrap-center",right:"float-right"},colors:{base:["#000000","#ffffff"],gray:["#212529","#343a40","#495057","#868e96","#adb5bd","#ced4da","#dee2e6","#e9ecef","#f1f3f5","#f8f9fa"],red:["#c92a2a","#e03131","#f03e3e","#fa5252","#ff6b6b","#ff8787","#ffa8a8","#ffc9c9","#ffe3e3","#fff5f5"],pink:["#a61e4d","#c2255c","#d6336c","#e64980","#f06595","#f783ac","#faa2c1","#fcc2d7","#ffdeeb","#fff0f6"],grape:["#862e9c","#9c36b5","#ae3ec9","#be4bdb","#cc5de8","#da77f2","#e599f7","#eebefa","#f3d9fa","#f8f0fc"],violet:["#5f3dc4","#6741d9","#7048e8","#7950f2","#845ef7","#9775fa","#b197fc","#d0bfff","#e5dbff","#f3f0ff"],indigo:["#364fc7","#3b5bdb","#4263eb","#4c6ef5","#5c7cfa","#748ffc","#91a7ff","#bac8ff","#dbe4ff","#edf2ff"],blue:["#1864ab","#1971c2","#1c7ed6","#228be6","#339af0","#4dabf7","#74c0fc","#a5d8ff","#d0ebff","#e7f5ff"],cyan:["#0b7285","#0c8599","#1098ad","#15aabf","#22b8cf","#3bc9db","#66d9e8","#99e9f2","#c5f6fa","#e3fafc"],teal:["#087f5b","#099268","#0ca678","#12b886","#20c997","#38d9a9","#63e6be","#96f2d7","#c3fae8","#e6fcf5"],green:["#2b8a3e","#2f9e44","#37b24d","#40c057","#51cf66","#69db7c","#8ce99a","#b2f2bb","#d3f9d8","#ebfbee"],lime:["#5c940d","#66a80f","#74b816","#82c91e","#94d82d","#a9e34b","#c0eb75","#d8f5a2","#e9fac8","#f4fce3"],yellow:["#e67700","#f08c00","#f59f00","#fab005","#fcc419","#ffd43b","#ffe066","#ffec99","#fff3bf","#fff9db"],orange:["#d9480f","#e8590c","#f76707","#fd7e14","#ff922b","#ffa94d","#ffc078","#ffd8a8","#ffe8cc","#fff4e6"]},hotkeysAdd:!1,hotkeysRemove:!1,hotkeysBase:{"meta+z":"## hotkeys.meta-z ##","meta+shift+z":"## hotkeys.meta-shift-z ##","meta+a":"## hotkeys.meta-a ##","meta+shift+a":"## hotkeys.meta-shift-a ##"},hotkeys:{"ctrl+alt+a, meta+alt+a":{title:"## hotkeys.meta-shift-o ##",name:"meta+alt+a",command:"addbar.popup"},"ctrl+shift+d, meta+shift+d":{title:"## hotkeys.meta-shift-d ##",name:"meta+shift+d",command:"block.duplicate"},"ctrl+shift+up, meta+shift+up":{title:"## hotkeys.meta-shift-up ##",name:"meta+shift+&uarr;",command:"block.moveUp"},"ctrl+shift+down, meta+shift+down":{title:"## hotkeys.meta-shift-down ##",name:"meta+shift+&darr;",command:"block.moveDown"},"ctrl+shift+m, meta+shift+m":{title:"## hotkeys.meta-shift-m ##",name:"meta+shift+m",command:"inline.removeFormat"},"ctrl+b, meta+b":{title:"## hotkeys.meta-b ##",name:"meta+b",command:"inline.set",params:{tag:"b"}},"ctrl+i, meta+i":{title:"## hotkeys.meta-i ##",name:"meta+i",command:"inline.set",params:{tag:"i"}},"ctrl+u, meta+u":{title:"## hotkeys.meta-u ##",name:"meta+u",command:"inline.set",params:{tag:"u"}},"ctrl+h, meta+h":{title:"## hotkeys.meta-h ##",name:"meta+h",command:"inline.set",params:{tag:"sup"}},"ctrl+l, meta+l":{title:"## hotkeys.meta-l ##",name:"meta+l",command:"inline.set",params:{tag:"sub"}},"ctrl+alt+0, meta+alt+0":{title:"## hotkeys.meta-alt-0 ##",name:"meta+alt+0",command:"format.set",params:{tag:"p"}},"ctrl+alt+1, meta+alt+1":{title:"## hotkeys.meta-alt-1 ##",name:"meta+alt+1",command:"format.set",params:{tag:"h1"}},"ctrl+alt+2, meta+alt+2":{title:"## hotkeys.meta-alt-2 ##",name:"meta+alt+2",command:"format.set",params:{tag:"h2"}},"ctrl+alt+3, meta+alt+3":{title:"## hotkeys.meta-alt-3 ##",name:"meta+alt+3",command:"format.set",params:{tag:"h3"}},"ctrl+alt+4, meta+alt+4":{title:"## hotkeys.meta-alt-4 ##",name:"meta+alt+4",command:"format.set",params:{tag:"h4"}},"ctrl+alt+5, meta+alt+5":{title:"## hotkeys.meta-alt-5 ##",name:"meta+alt+5",command:"format.set",params:{tag:"h5"}},"ctrl+alt+6, meta+alt+6":{title:"## hotkeys.meta-alt-6 ##",name:"meta+alt+6",command:"format.set",params:{tag:"h6"}},"ctrl+shift+7, meta+shift+7":{title:"## hotkeys.meta-shift-7 ##",name:"meta+shift+7",command:"format.set",params:{tag:"ol"}},"ctrl+shift+8, meta+shift+8":{title:"## hotkeys.meta-shift-8 ##",name:"meta+shift+8",command:"format.set",params:{tag:"ul"}},"ctrl+], meta+]":{title:"## hotkeys.meta-indent ##",name:"meta+]",command:"list.indent"},"ctrl+[, meta+[, shift+tab":{title:"## hotkeys.meta-outdent ##",name:"meta+[",command:"list.outdent"},"ctrl+k, meta+k":{title:"## hotkeys.meta-k ##",name:"meta+k",command:"link.popup"}},markerChar:"\ufeff",containers:{main:["toolbox","editor","source","preview","statusbar"],toolbox:["pathbar","toolbar"]},modes:{nocontainer:{toolbar:!1,extrabar:!1,pathbar:!1,padding:"0"}},buttonsObj:{"ai-tools":{title:"## buttons.ai-tools ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M18 3C18.5523 3 19 3.44772 19 4C19 4.26522 19.1054 4.51957 19.2929 4.70711C19.4804 4.89464 19.7348 5 20 5C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7C19.7348 7 19.4804 7.10536 19.2929 7.29289C19.1054 7.48043 19 7.73478 19 8C19 8.55228 18.5523 9 18 9C17.4477 9 17 8.55228 17 8C17 7.73478 16.8946 7.48043 16.7071 7.29289C16.5196 7.10536 16.2652 7 16 7C15.4477 7 15 6.55228 15 6C15 5.44772 15.4477 5 16 5C16.2652 5 16.5196 4.89464 16.7071 4.70711C16.8946 4.51957 17 4.26522 17 4C17 3.44772 17.4477 3 18 3ZM9 5C9.55228 5 10 5.44772 10 6C10 7.32608 10.5268 8.59785 11.4645 9.53553C12.4021 10.4732 13.6739 11 15 11C15.5523 11 16 11.4477 16 12C16 12.5523 15.5523 13 15 13C13.6739 13 12.4021 13.5268 11.4645 14.4645C10.5268 15.4021 10 16.6739 10 18C10 18.5523 9.55228 19 9 19C8.44772 19 8 18.5523 8 18C8 16.6739 7.47322 15.4021 6.53553 14.4645C5.59785 13.5268 4.32608 13 3 13C2.44772 13 2 12.5523 2 12C2 11.4477 2.44772 11 3 11C4.32608 11 5.59785 10.4732 6.53553 9.53553C7.47322 8.59785 8 7.32608 8 6C8 5.44772 8.44772 5 9 5ZM9 9.60559C8.70843 10.0908 8.35673 10.5428 7.94975 10.9497C7.54276 11.3567 7.09082 11.7084 6.60559 12C7.09082 12.2916 7.54276 12.6433 7.94975 13.0503C8.35673 13.4572 8.70843 13.9092 9 14.3944C9.29157 13.9092 9.64327 13.4572 10.0503 13.0503C10.4572 12.6433 10.9092 12.2916 11.3944 12C10.9092 11.7084 10.4572 11.3567 10.0503 10.9497C9.64327 10.5428 9.29157 10.0908 9 9.60559ZM16.7071 16.7071C16.8946 16.5196 17 16.2652 17 16C17 15.4477 17.4477 15 18 15C18.5523 15 19 15.4477 19 16C19 16.2652 19.1054 16.5196 19.2929 16.7071C19.4804 16.8946 19.7348 17 20 17C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19C19.7348 19 19.4804 19.1054 19.2929 19.2929C19.1054 19.4804 19 19.7348 19 20C19 20.5523 18.5523 21 18 21C17.4477 21 17 20.5523 17 20C17 19.7348 16.8946 19.4804 16.7071 19.2929C16.5196 19.1054 16.2652 19 16 19C15.4477 19 15 18.5523 15 18C15 17.4477 15.4477 17 16 17C16.2652 17 16.5196 16.8946 16.7071 16.7071Z"/></svg>',observer:"ai.observe",command:"ai.popup"},"ai-prompt":{title:"## buttons.ai-tools ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M18 3C18.5523 3 19 3.44772 19 4C19 4.26522 19.1054 4.51957 19.2929 4.70711C19.4804 4.89464 19.7348 5 20 5C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7C19.7348 7 19.4804 7.10536 19.2929 7.29289C19.1054 7.48043 19 7.73478 19 8C19 8.55228 18.5523 9 18 9C17.4477 9 17 8.55228 17 8C17 7.73478 16.8946 7.48043 16.7071 7.29289C16.5196 7.10536 16.2652 7 16 7C15.4477 7 15 6.55228 15 6C15 5.44772 15.4477 5 16 5C16.2652 5 16.5196 4.89464 16.7071 4.70711C16.8946 4.51957 17 4.26522 17 4C17 3.44772 17.4477 3 18 3ZM9 5C9.55228 5 10 5.44772 10 6C10 7.32608 10.5268 8.59785 11.4645 9.53553C12.4021 10.4732 13.6739 11 15 11C15.5523 11 16 11.4477 16 12C16 12.5523 15.5523 13 15 13C13.6739 13 12.4021 13.5268 11.4645 14.4645C10.5268 15.4021 10 16.6739 10 18C10 18.5523 9.55228 19 9 19C8.44772 19 8 18.5523 8 18C8 16.6739 7.47322 15.4021 6.53553 14.4645C5.59785 13.5268 4.32608 13 3 13C2.44772 13 2 12.5523 2 12C2 11.4477 2.44772 11 3 11C4.32608 11 5.59785 10.4732 6.53553 9.53553C7.47322 8.59785 8 7.32608 8 6C8 5.44772 8.44772 5 9 5ZM9 9.60559C8.70843 10.0908 8.35673 10.5428 7.94975 10.9497C7.54276 11.3567 7.09082 11.7084 6.60559 12C7.09082 12.2916 7.54276 12.6433 7.94975 13.0503C8.35673 13.4572 8.70843 13.9092 9 14.3944C9.29157 13.9092 9.64327 13.4572 10.0503 13.0503C10.4572 12.6433 10.9092 12.2916 11.3944 12C10.9092 11.7084 10.4572 11.3567 10.0503 10.9497C9.64327 10.5428 9.29157 10.0908 9 9.60559ZM16.7071 16.7071C16.8946 16.5196 17 16.2652 17 16C17 15.4477 17.4477 15 18 15C18.5523 15 19 15.4477 19 16C19 16.2652 19.1054 16.5196 19.2929 16.7071C19.4804 16.8946 19.7348 17 20 17C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19C19.7348 19 19.4804 19.1054 19.2929 19.2929C19.1054 19.4804 19 19.7348 19 20C19 20.5523 18.5523 21 18 21C17.4477 21 17 20.5523 17 20C17 19.7348 16.8946 19.4804 16.7071 19.2929C16.5196 19.1054 16.2652 19 16 19C15.4477 19 15 18.5523 15 18C15 17.4477 15.4477 17 16 17C16.2652 17 16.5196 16.8946 16.7071 16.7071Z"/></svg>',observer:"ai.observe",command:"ai.popupPrompt"},"ai-image":{title:"## buttons.ai-image ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M18 3C18.5523 3 19 3.44772 19 4C19 4.26522 19.1054 4.51957 19.2929 4.70711C19.4804 4.89464 19.7348 5 20 5C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7C19.7348 7 19.4804 7.10536 19.2929 7.29289C19.1054 7.48043 19 7.73478 19 8C19 8.55228 18.5523 9 18 9C17.4477 9 17 8.55228 17 8C17 7.73478 16.8946 7.48043 16.7071 7.29289C16.5196 7.10536 16.2652 7 16 7C15.4477 7 15 6.55228 15 6C15 5.44772 15.4477 5 16 5C16.2652 5 16.5196 4.89464 16.7071 4.70711C16.8946 4.51957 17 4.26522 17 4C17 3.44772 17.4477 3 18 3ZM9 5C9.55228 5 10 5.44772 10 6C10 7.32608 10.5268 8.59785 11.4645 9.53553C12.4021 10.4732 13.6739 11 15 11C15.5523 11 16 11.4477 16 12C16 12.5523 15.5523 13 15 13C13.6739 13 12.4021 13.5268 11.4645 14.4645C10.5268 15.4021 10 16.6739 10 18C10 18.5523 9.55228 19 9 19C8.44772 19 8 18.5523 8 18C8 16.6739 7.47322 15.4021 6.53553 14.4645C5.59785 13.5268 4.32608 13 3 13C2.44772 13 2 12.5523 2 12C2 11.4477 2.44772 11 3 11C4.32608 11 5.59785 10.4732 6.53553 9.53553C7.47322 8.59785 8 7.32608 8 6C8 5.44772 8.44772 5 9 5ZM9 9.60559C8.70843 10.0908 8.35673 10.5428 7.94975 10.9497C7.54276 11.3567 7.09082 11.7084 6.60559 12C7.09082 12.2916 7.54276 12.6433 7.94975 13.0503C8.35673 13.4572 8.70843 13.9092 9 14.3944C9.29157 13.9092 9.64327 13.4572 10.0503 13.0503C10.4572 12.6433 10.9092 12.2916 11.3944 12C10.9092 11.7084 10.4572 11.3567 10.0503 10.9497C9.64327 10.5428 9.29157 10.0908 9 9.60559ZM16.7071 16.7071C16.8946 16.5196 17 16.2652 17 16C17 15.4477 17.4477 15 18 15C18.5523 15 19 15.4477 19 16C19 16.2652 19.1054 16.5196 19.2929 16.7071C19.4804 16.8946 19.7348 17 20 17C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19C19.7348 19 19.4804 19.1054 19.2929 19.2929C19.1054 19.4804 19 19.7348 19 20C19 20.5523 18.5523 21 18 21C17.4477 21 17 20.5523 17 20C17 19.7348 16.8946 19.4804 16.7071 19.2929C16.5196 19.1054 16.2652 19 16 19C15.4477 19 15 18.5523 15 18C15 17.4477 15.4477 17 16 17C16.2652 17 16.5196 16.8946 16.7071 16.7071Z"/></svg>',observer:"ai.observe",command:"ai.promptImage"},add:{title:"## buttons.add ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M13 3.75C13 3.19772 12.5523 2.75 12 2.75C11.4477 2.75 11 3.19772 11 3.75V11H3.75C3.19772 11 2.75 11.4477 2.75 12C2.75 12.5523 3.19772 13 3.75 13H11V20.25C11 20.8023 11.4477 21.25 12 21.25C12.5523 21.25 13 20.8023 13 20.25V13H20.25C20.8023 13 21.25 12.5523 21.25 12C21.25 11.4477 20.8023 11 20.25 11H13V3.75Z"/></svg>',command:"addbar.popup"},html:{title:"## buttons.html ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.9701 4.24253C15.1041 3.70673 14.7783 3.1638 14.2425 3.02985C13.7067 2.8959 13.1638 3.22166 13.0299 3.75746L9.02986 19.7575C8.89591 20.2933 9.22167 20.8362 9.75746 20.9701C10.2933 21.1041 10.8362 20.7783 10.9701 20.2425L14.9701 4.24253ZM7.70711 7.29289C8.09763 7.68341 8.09763 8.31658 7.70711 8.7071L4.41421 12L7.70711 15.2929C8.09763 15.6834 8.09763 16.3166 7.70711 16.7071C7.31658 17.0976 6.68342 17.0976 6.29289 16.7071L2.29289 12.7071C1.90237 12.3166 1.90237 11.6834 2.29289 11.2929L6.29289 7.29289C6.68342 6.90236 7.31658 6.90236 7.70711 7.29289ZM16.2929 7.29289C16.6834 6.90236 17.3166 6.90236 17.7071 7.29289L21.7071 11.2929C22.0976 11.6834 22.0976 12.3166 21.7071 12.7071L17.7071 16.7071C17.3166 17.0976 16.6834 17.0976 16.2929 16.7071C15.9024 16.3166 15.9024 15.6834 16.2929 15.2929L19.5858 12L16.2929 8.7071C15.9024 8.31658 15.9024 7.68341 16.2929 7.29289Z"/></svg>',command:"source.toggle"},format:{title:"## buttons.format ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.32413 6.98804C6.14654 7.2864 6 7.75331 6 8.5C6 9.24669 6.14654 9.7136 6.32413 10.012C6.49608 10.3008 6.73889 10.5026 7.06782 10.6511C7.58542 10.8849 8.24184 10.9625 9 10.9879V6.01213C8.24184 6.03755 7.58542 6.11512 7.06782 6.34887C6.73889 6.49742 6.49608 6.69917 6.32413 6.98804ZM6.24464 12.4739C7.10428 12.8621 8.10853 12.9642 9 12.9908V19C9 19.5523 9.44772 20 10 20C10.5523 20 11 19.5523 11 19V12V6H15V19C15 19.5523 15.4477 20 16 20C16.5523 20 17 19.5523 17 19V6H18C18.5523 6 19 5.55228 19 5C19 4.44772 18.5523 4 18 4H16H15C14.9996 4 14.9993 4 14.9989 4L10 4L9.99773 4L9.90325 3.99997C8.84701 3.99946 7.4124 3.99876 6.24464 4.52613C5.60483 4.81508 5.01952 5.26959 4.60554 5.96509C4.1972 6.65111 4 7.49669 4 8.5C4 9.50331 4.1972 10.3489 4.60554 11.0349C5.01952 11.7304 5.60483 12.1849 6.24464 12.4739Z"/></svg>',command:"format.popup"},bold:{title:"## buttons.bold ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 4C6.44772 4 6 4.44772 6 5V12V19C6 19.5523 6.44772 20 7 20H14C15.1935 20 16.3381 19.5259 17.182 18.682C18.0259 17.8381 18.5 16.6935 18.5 15.5C18.5 14.3065 18.0259 13.1619 17.182 12.318C16.9031 12.0391 16.5914 11.8006 16.2559 11.6063C17.0535 10.7703 17.5 9.65816 17.5 8.5C17.5 7.30653 17.0259 6.16193 16.182 5.31802C15.3381 4.47411 14.1935 4 13 4H7ZM13 13H8V18H14C14.663 18 15.2989 17.7366 15.7678 17.2678C16.2366 16.7989 16.5 16.163 16.5 15.5C16.5 14.837 16.2366 14.2011 15.7678 13.7322C15.2989 13.2634 14.663 13 14 13H13ZM13 11C13.663 11 14.2989 10.7366 14.7678 10.2678C15.2366 9.79893 15.5 9.16304 15.5 8.5C15.5 7.83696 15.2366 7.20107 14.7678 6.73223C14.2989 6.26339 13.663 6 13 6H8V11H13Z"/></svg>',command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.0222 4H17C17.5523 4 18 4.44772 18 5C18 5.55228 17.5523 6 17 6H14.7543L11.3257 18H13C13.5523 18 14 18.4477 14 19C14 19.5523 13.5523 20 13 20H10.023C10.0081 20.0003 9.99304 20.0003 9.97798 20H7C6.44772 20 6 19.5523 6 19C6 18.4477 6.44772 18 7 18H9.24571L12.6743 6H11C10.4477 6 10 5.55228 10 5C10 4.44772 10.4477 4 11 4H13.9768C13.9919 3.99966 14.007 3.99965 14.0222 4Z"/></svg>',command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.8776 4.46266C14.0175 4.14012 13.0023 3.98493 11.9923 3.99999H11C9.80652 3.99999 8.66193 4.4741 7.81802 5.31801C6.9741 6.16193 6.5 7.30652 6.5 8.49999C6.5 9.39648 6.76751 10.2654 7.25832 11H5C4.44772 11 4 11.4477 4 12C4 12.5523 4.44772 13 5 13H13.0058C13.6667 13.0015 14.3003 13.2647 14.7678 13.7322C15.2366 14.2011 15.5 14.837 15.5 15.5C15.5 16.163 15.2366 16.7989 14.7678 17.2678C14.2989 17.7366 13.663 18 13 18H11.5L11.4842 18.0001C10.6801 18.0128 9.9163 17.8865 9.32462 17.6647C8.70357 17.4318 8.45244 17.1652 8.38892 17.0419C8.13594 16.551 7.53288 16.3581 7.04194 16.6111C6.551 16.864 6.35809 17.4671 6.61107 17.9581C7.00105 18.7149 7.78931 19.2249 8.62237 19.5373C9.4825 19.8599 10.4977 20.0151 11.5077 20H13C14.1935 20 15.3381 19.5259 16.182 18.682C17.0259 17.8381 17.5 16.6935 17.5 15.5C17.5 14.6035 17.2325 13.7346 16.7417 13H19C19.5523 13 20 12.5523 20 12C20 11.4477 19.5523 11 19 11H13.0083C13.0055 11 13.0028 11 13 11H11C10.337 11 9.70107 10.7366 9.23223 10.2678C8.76339 9.79892 8.5 9.16303 8.5 8.49999C8.5 7.83695 8.76339 7.20107 9.23223 6.73223C9.70107 6.26338 10.337 5.99999 11 5.99999H12L12.0158 5.99987C12.8199 5.98715 13.5837 6.11344 14.1754 6.33532C14.7964 6.56822 15.0476 6.83478 15.1111 6.95805C15.3641 7.44899 15.9671 7.64189 16.4581 7.38892C16.949 7.13594 17.1419 6.53287 16.8889 6.04193C16.4989 5.28513 15.7107 4.77506 14.8776 4.46266Z"/></svg>',command:"inline.set",params:{tag:"del"}},moreinline:{title:"## buttons.more-formatting ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3 12C3 10.8954 3.89543 10 5 10C6.10457 10 7 10.8954 7 12C7 13.1046 6.10457 14 5 14C3.89543 14 3 13.1046 3 12ZM10 12C10 10.8954 10.8954 10 12 10C13.1046 10 14 10.8954 14 12C14 13.1046 13.1046 14 12 14C10.8954 14 10 13.1046 10 12ZM19 10C17.8954 10 17 10.8954 17 12C17 13.1046 17.8954 14 19 14C20.1046 14 21 13.1046 21 12C21 10.8954 20.1046 10 19 10Z"/></svg>',command:"inline.popup"},link:{title:"## buttons.link ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.1946 6.14687L11.7568 6.65369C11.3957 7.07164 10.7643 7.11778 10.3463 6.75676C9.92836 6.39573 9.88222 5.76425 10.2432 5.34631L10.7062 4.81031C10.7222 4.79189 10.7387 4.77405 10.7559 4.75684C11.8813 3.63165 13.4075 2.99958 14.9989 2.99969C16.5903 2.99981 18.1165 3.63209 19.2417 4.75744C20.3669 5.8828 20.9989 7.40904 20.9988 9.00042C20.9987 10.5918 20.3664 12.118 19.2411 13.2432C19.2246 13.2596 19.2075 13.2756 19.1899 13.2909L18.6559 13.7549C18.239 14.1171 17.6074 14.0728 17.2452 13.6559C16.8829 13.239 16.9272 12.6074 17.3441 12.2452L17.8502 11.8054C18.5859 11.0576 18.9987 10.0502 18.9988 9.00028C18.9989 7.93934 18.5775 6.92181 17.8273 6.17156C17.0772 5.4213 16.0597 4.99977 14.9988 4.99969C13.9493 4.99962 12.9424 5.41192 12.1946 6.14687ZM15.7071 8.29289C16.0976 8.68342 16.0976 9.31658 15.7071 9.70711L9.70711 15.7071C9.31658 16.0976 8.68342 16.0976 8.29289 15.7071C7.90237 15.3166 7.90237 14.6834 8.29289 14.2929L14.2929 8.29289C14.6834 7.90237 15.3166 7.90237 15.7071 8.29289ZM6.7494 10.3379C7.11509 10.7517 7.07603 11.3837 6.66216 11.7494L6.16037 12.1928C5.7956 12.5583 5.50555 12.9915 5.30653 13.4681C5.10411 13.953 4.99988 14.4731 4.99988 14.9985C4.99988 15.5239 5.10411 16.044 5.30653 16.5289C5.50895 17.0137 5.80554 17.4535 6.17913 17.8229L6.17916 17.8229C6.9407 18.576 7.96851 18.9984 9.03952 18.9984C10.0866 18.9984 11.0923 18.5947 11.8483 17.873L12.1975 17.4034C12.527 16.9602 13.1534 16.868 13.5966 17.1975C14.0399 17.527 14.132 18.1534 13.8025 18.5966L13.4055 19.1306C13.3754 19.1712 13.3421 19.2095 13.3062 19.2451C12.1702 20.3684 10.6371 20.9984 9.03952 20.9984C7.44197 20.9984 5.90886 20.3684 4.77291 19.2451C4.21121 18.6897 3.76528 18.0284 3.46093 17.2994C3.15659 16.5705 2.99988 15.7884 2.99988 14.9985C2.99988 14.2086 3.15659 13.4265 3.46093 12.6976C3.76528 11.9686 4.21121 11.3073 4.77291 10.7519C4.78621 10.7388 4.79987 10.726 4.81388 10.7136L5.33788 10.2506C5.75175 9.88493 6.38371 9.92399 6.7494 10.3379Z"/></svg>',observer:"link.observe",command:"link.popup"},"link-text":{title:"## buttons.link-text ##",command:"link.open"},unlink:{title:"## buttons.unlink ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 1C7.55228 1 8 1.44772 8 2V4C8 4.55228 7.55228 5 7 5C6.44772 5 6 4.55228 6 4V2C6 1.44772 6.44772 1 7 1ZM12.1946 6.14687L11.7568 6.65369C11.3957 7.07164 10.7643 7.11778 10.3463 6.75676C9.92836 6.39573 9.88222 5.76425 10.2432 5.34631L10.7062 4.81031C10.7222 4.79189 10.7387 4.77405 10.7559 4.75684C11.8813 3.63165 13.4075 2.99958 14.9989 2.99969C16.5903 2.99981 18.1165 3.63209 19.2417 4.75744C20.3669 5.8828 20.9989 7.40905 20.9988 9.00043C20.9987 10.5918 20.3664 12.118 19.2411 13.2432C19.2246 13.2596 19.2075 13.2756 19.1899 13.2909L18.6559 13.7549C18.239 14.1171 17.6074 14.0728 17.2452 13.6559C16.8829 13.239 16.9272 12.6074 17.3441 12.2452L17.8502 11.8054C18.5859 11.0576 18.9987 10.0502 18.9988 9.00028C18.9989 7.93934 18.5775 6.92181 17.8273 6.17156C17.0772 5.4213 16.0597 4.99977 14.9988 4.99969C13.9493 4.99962 12.9424 5.41192 12.1946 6.14687ZM1 7C1 6.44772 1.44772 6 2 6H4C4.55228 6 5 6.44772 5 7C5 7.55228 4.55228 8 4 8H2C1.44772 8 1 7.55228 1 7ZM15.7071 8.29289C16.0976 8.68342 16.0976 9.31658 15.7071 9.70711L9.70711 15.7071C9.31658 16.0976 8.68342 16.0976 8.29289 15.7071C7.90237 15.3166 7.90237 14.6834 8.29289 14.2929L14.2929 8.29289C14.6834 7.90237 15.3166 7.90237 15.7071 8.29289ZM6.7494 10.3379C7.11509 10.7517 7.07603 11.3837 6.66216 11.7494L6.16037 12.1928C5.7956 12.5583 5.50555 12.9915 5.30653 13.4681C5.10411 13.953 4.99988 14.4731 4.99988 14.9985C4.99988 15.5239 5.10411 16.044 5.30653 16.5289C5.50895 17.0137 5.80554 17.4535 6.17913 17.8229L6.17916 17.8229C6.9407 18.576 7.96851 18.9984 9.03952 18.9984C10.0866 18.9984 11.0923 18.5947 11.8483 17.873L12.1975 17.4034C12.527 16.9602 13.1534 16.868 13.5966 17.1975C14.0399 17.527 14.132 18.1534 13.8025 18.5966L13.4055 19.1306C13.3754 19.1712 13.3421 19.2095 13.3062 19.2451C12.1702 20.3684 10.6371 20.9984 9.03952 20.9984C7.44197 20.9984 5.90886 20.3684 4.77291 19.2451C4.21121 18.6897 3.76528 18.0284 3.46093 17.2994C3.15659 16.5705 2.99988 15.7884 2.99988 14.9985C2.99988 14.2086 3.15659 13.4265 3.46093 12.6976C3.76528 11.9686 4.21121 11.3073 4.77291 10.7519C4.78621 10.7388 4.79987 10.726 4.81388 10.7136L5.33788 10.2506C5.75175 9.88493 6.38371 9.92399 6.7494 10.3379ZM19 17C19 16.4477 19.4477 16 20 16H22C22.5523 16 23 16.4477 23 17C23 17.5523 22.5523 18 22 18H20C19.4477 18 19 17.5523 19 17ZM17 19C17.5523 19 18 19.4477 18 20V22C18 22.5523 17.5523 23 17 23C16.4477 23 16 22.5523 16 22V20C16 19.4477 16.4477 19 17 19Z"/></svg>',command:"link.unlink"},image:{title:"## buttons.image ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5 7C5 5.89543 5.89543 5 7 5H17C18.1046 5 19 5.89543 19 7V12.5858L18.7071 12.2929L18.6934 12.2794C18.091 11.6998 17.3358 11.3301 16.5 11.3301C15.6642 11.3301 14.909 11.6998 14.3066 12.2794L14.2929 12.2929L14 12.5858L11.7071 10.2929L11.6934 10.2794C11.091 9.6998 10.3358 9.33014 9.5 9.33014C8.66419 9.33014 7.909 9.6998 7.30662 10.2794L7.29289 10.2929L5 12.5858V7ZM15.4142 14L15.6997 13.7146C16.0069 13.4213 16.2841 13.3301 16.5 13.3301C16.7159 13.3301 16.9931 13.4213 17.3003 13.7146L19 15.4142V17C19 18.1046 18.1046 19 17 19H7C5.89543 19 5 18.1046 5 17V15.4142L8.69966 11.7146C9.0069 11.4213 9.28406 11.3301 9.5 11.3301C9.71594 11.3301 9.9931 11.4213 10.3003 11.7146L13.2929 14.7071L15.2929 16.7071C15.6834 17.0976 16.3166 17.0976 16.7071 16.7071C17.0976 16.3166 17.0976 15.6834 16.7071 15.2929L15.4142 14ZM21 15.001V17C21 19.2091 19.2091 21 17 21H7C4.79086 21 3 19.2091 3 17V15.0002V14.9998V7C3 4.79086 4.79086 3 7 3H17C19.2091 3 21 4.79086 21 7V14.999C21 14.9997 21 15.0003 21 15.001ZM15 7C14.4477 7 14 7.44772 14 8C14 8.55228 14.4477 9 15 9H15.01C15.5623 9 16.01 8.55228 16.01 8C16.01 7.44772 15.5623 7 15.01 7H15Z"/></svg>',observer:"image.observe",command:"image.popup"},unwrap:{title:"## buttons.unwrap ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2.29289 2.29289C2.68342 1.90237 3.31658 1.90237 3.70711 2.29289L21.7071 20.2929C22.0976 20.6834 22.0976 21.3166 21.7071 21.7071C21.3166 22.0976 20.6834 22.0976 20.2929 21.7071L18 19.4142V20C18 20.5523 17.5523 21 17 21C16.4477 21 16 20.5523 16 20V18H8V20C8 20.5523 7.55228 21 7 21C6.44772 21 6 20.5523 6 20V18H4C3.44772 18 3 17.5523 3 17C3 16.4477 3.44772 16 4 16H6V8H4C3.44772 8 3 7.55228 3 7C3 6.44772 3.44772 6 4 6H4.58579L2.29289 3.70711C1.90237 3.31658 1.90237 2.68342 2.29289 2.29289ZM8 9.41421L14.5858 16H8V9.41421ZM17 3C17.5523 3 18 3.44772 18 4V6H20C20.5523 6 21 6.44772 21 7C21 7.55228 20.5523 8 20 8H18V13C18 13.5523 17.5523 14 17 14C16.4477 14 16 13.5523 16 13V8H11C10.4477 8 10 7.55228 10 7C10 6.44772 10.4477 6 11 6H16V4C16 3.44772 16.4477 3 17 3Z"/></svg>',command:"block.unwrap"},outset:{title:"## buttons.outset ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 4C6 3.44772 6.44772 3 7 3H17C17.5523 3 18 3.44772 18 4C18 4.55229 17.5523 5 17 5L7 5C6.44772 5 6 4.55228 6 4ZM3.58579 7.58579C3.96086 7.21071 4.46957 7 5 7H19C19.5304 7 20.0391 7.21071 20.4142 7.58579C20.7893 7.96086 21 8.46957 21 9V15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H5C4.46957 17 3.96086 16.7893 3.58579 16.4142C3.21071 16.0391 3 15.5304 3 15V9C3 8.46957 3.21071 7.96086 3.58579 7.58579ZM19 9H5L5 15H19V9ZM7 19C6.44772 19 6 19.4477 6 20C6 20.5523 6.44772 21 7 21H17C17.5523 21 18 20.5523 18 20C18 19.4477 17.5523 19 17 19H7Z"/></svg>',observer:"image.observe",command:"image.popupOutset"},wrap:{title:"## buttons.wrap-image ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3.58579 4.58579C3.96086 4.21071 4.46957 4 5 4H9C9.53043 4 10.0391 4.21071 10.4142 4.58579C10.7893 4.96086 11 5.46957 11 6V10C11 10.5304 10.7893 11.0391 10.4142 11.4142C10.0391 11.7893 9.53043 12 9 12H5C4.46957 12 3.96086 11.7893 3.58579 11.4142C3.21071 11.0391 3 10.5304 3 10V6C3 5.46957 3.21071 4.96086 3.58579 4.58579ZM9 6L5 6L5 10H9V6ZM13 7C13 6.44772 13.4477 6 14 6H20C20.5523 6 21 6.44772 21 7C21 7.55228 20.5523 8 20 8H14C13.4477 8 13 7.55228 13 7ZM13 11C13 10.4477 13.4477 10 14 10H20C20.5523 10 21 10.4477 21 11C21 11.5523 20.5523 12 20 12H14C13.4477 12 13 11.5523 13 11ZM3 15C3 14.4477 3.44772 14 4 14H20C20.5523 14 21 14.4477 21 15C21 15.5523 20.5523 16 20 16H4C3.44772 16 3 15.5523 3 15ZM3 19C3 18.4477 3.44772 18 4 18H20C20.5523 18 21 18.4477 21 19C21 19.5523 20.5523 20 20 20H4C3.44772 20 3 19.5523 3 19Z"/></svg>',observer:"image.observe",command:"image.popupWrap"},"move-up":{title:"## buttons.move-up ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.2929 4.29289C11.6834 3.90237 12.3166 3.90237 12.7071 4.29289L16.7071 8.29289C17.0976 8.68342 17.0976 9.31658 16.7071 9.70711C16.3166 10.0976 15.6834 10.0976 15.2929 9.70711L13 7.41421V19C13 19.5523 12.5523 20 12 20C11.4477 20 11 19.5523 11 19V7.41421L8.70711 9.70711C8.31658 10.0976 7.68342 10.0976 7.29289 9.70711C6.90237 9.31658 6.90237 8.68342 7.29289 8.29289L11.2929 4.29289Z"/></svg>',command:"block.moveUp"},"move-down":{title:"## buttons.move-down ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 4C12.5523 4 13 4.44772 13 5V16.5858L15.2929 14.2929C15.6834 13.9024 16.3166 13.9024 16.7071 14.2929C17.0976 14.6834 17.0976 15.3166 16.7071 15.7071L12.7071 19.7071C12.3166 20.0976 11.6834 20.0976 11.2929 19.7071L7.29289 15.7071C6.90237 15.3166 6.90237 14.6834 7.29289 14.2929C7.68342 13.9024 8.31658 13.9024 8.70711 14.2929L11 16.5858V5C11 4.44772 11.4477 4 12 4Z"/></svg>',command:"block.moveDown"},list:{title:"## buttons.list ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 6C6 5.44772 5.55228 5 5 5C4.44772 5 4 5.44772 4 6V6.01C4 6.56228 4.44772 7.01 5 7.01C5.55228 7.01 6 6.56228 6 6.01V6ZM9 5C8.44772 5 8 5.44772 8 6C8 6.55228 8.44772 7 9 7H20C20.5523 7 21 6.55228 21 6C21 5.44772 20.5523 5 20 5H9ZM9 11C8.44772 11 8 11.4477 8 12C8 12.5523 8.44772 13 9 13H20C20.5523 13 21 12.5523 21 12C21 11.4477 20.5523 11 20 11H9ZM8 18C8 17.4477 8.44772 17 9 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H9C8.44772 19 8 18.5523 8 18ZM5 11C5.55228 11 6 11.4477 6 12V12.01C6 12.5623 5.55228 13.01 5 13.01C4.44772 13.01 4 12.5623 4 12.01V12C4 11.4477 4.44772 11 5 11ZM6 18C6 17.4477 5.55228 17 5 17C4.44772 17 4 17.4477 4 18V18.01C4 18.5623 4.44772 19.01 5 19.01C5.55228 19.01 6 18.5623 6 18.01V18Z"/></svg>',command:"list.popup"},numberedlist:{title:"## buttons.numbered-list ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.38267 3.07612C6.75635 3.2309 6.99999 3.59554 6.99999 4V10C6.99999 10.5523 6.55227 11 5.99999 11C5.44771 11 4.99999 10.5523 4.99999 10V6.41421L4.7071 6.70711C4.31657 7.09763 3.68341 7.09763 3.29288 6.70711C2.90236 6.31658 2.90236 5.68342 3.29288 5.29289L5.29288 3.29289C5.57888 3.00689 6.009 2.92134 6.38267 3.07612ZM9.99999 6C9.99999 5.44771 10.4477 5 11 5H20C20.5523 5 21 5.44771 21 6C21 6.55228 20.5523 7 20 7H11C10.4477 7 9.99999 6.55228 9.99999 6ZM9.99999 12C9.99999 11.4477 10.4477 11 11 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H11C10.4477 13 9.99999 12.5523 9.99999 12ZM5.99999 15C5.73477 15 5.48042 15.1054 5.29288 15.2929C5.10535 15.4804 4.99999 15.7348 4.99999 16C4.99999 16.5523 4.55227 17 3.99999 17C3.44771 17 2.99999 16.5523 2.99999 16C2.99999 15.2043 3.31606 14.4413 3.87867 13.8787C4.44128 13.3161 5.20434 13 5.99999 13C6.79564 13 7.5587 13.3161 8.12131 13.8787C8.68392 14.4413 8.99999 15.2043 8.99999 16C8.99999 16.6051 8.73548 17.0689 8.47379 17.402C8.28592 17.6411 8.03874 17.8824 7.84515 18.0714C7.79485 18.1205 7.74818 18.166 7.7071 18.2071C7.68572 18.2285 7.66339 18.2489 7.64017 18.2682L6.76204 19H7.99999C8.55228 19 8.99999 19.4477 8.99999 20C8.99999 20.5523 8.55228 21 7.99999 21H3.99999C3.57897 21 3.20304 20.7363 3.05972 20.3404C2.91639 19.9445 3.03637 19.5013 3.35981 19.2318L6.32564 16.7602C6.37812 16.7081 6.42975 16.6576 6.47777 16.6106L6.4872 16.6014C6.54925 16.5407 6.605 16.4861 6.65796 16.4328C6.76524 16.3249 6.84297 16.2404 6.90119 16.1663C6.95852 16.0933 6.98291 16.0478 6.99308 16.0238C7.00043 16.0064 7.00009 16.0014 7 16.0002C7 16.0001 6.99999 16.0001 6.99999 16C6.99999 15.7348 6.89463 15.4804 6.7071 15.2929C6.51956 15.1054 6.26521 15 5.99999 15ZM11 18C11 17.4477 11.4477 17 12 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H12C11.4477 19 11 18.5523 11 18Z"/></svg>',command:"format.set"},bulletlist:{title:"## buttons.bullet-list ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 6C6 5.44772 5.55228 5 5 5C4.44772 5 4 5.44772 4 6V6.01C4 6.56228 4.44772 7.01 5 7.01C5.55228 7.01 6 6.56228 6 6.01V6ZM9 5C8.44772 5 8 5.44772 8 6C8 6.55228 8.44772 7 9 7H20C20.5523 7 21 6.55228 21 6C21 5.44772 20.5523 5 20 5H9ZM9 11C8.44772 11 8 11.4477 8 12C8 12.5523 8.44772 13 9 13H20C20.5523 13 21 12.5523 21 12C21 11.4477 20.5523 11 20 11H9ZM8 18C8 17.4477 8.44772 17 9 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H9C8.44772 19 8 18.5523 8 18ZM5 11C5.55228 11 6 11.4477 6 12V12.01C6 12.5623 5.55228 13.01 5 13.01C4.44772 13.01 4 12.5623 4 12.01V12C4 11.4477 4.44772 11 5 11ZM6 18C6 17.4477 5.55228 17 5 17C4.44772 17 4 17.4477 4 18V18.01C4 18.5623 4.44772 19.01 5 19.01C5.55228 19.01 6 18.5623 6 18.01V18Z"/></svg>',command:"format.set"},indent:{title:"## buttons.indent ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 6C8 5.44772 8.44772 5 9 5H20C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7H9C8.44772 7 8 6.55228 8 6ZM3.29289 7.29289C3.68342 6.90237 4.31658 6.90237 4.70711 7.29289L8.70711 11.2929C9.09763 11.6834 9.09763 12.3166 8.70711 12.7071L4.70711 16.7071C4.31658 17.0976 3.68342 17.0976 3.29289 16.7071C2.90237 16.3166 2.90237 15.6834 3.29289 15.2929L6.58579 12L3.29289 8.70711C2.90237 8.31658 2.90237 7.68342 3.29289 7.29289ZM13 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H13C12.4477 13 12 12.5523 12 12C12 11.4477 12.4477 11 13 11ZM8 18C8 17.4477 8.44772 17 9 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H9C8.44772 19 8 18.5523 8 18Z"/></svg>',command:"list.indent"},outdent:{title:"## buttons.outdent ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 6C12 5.44772 12.4477 5 13 5H20C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7H13C12.4477 7 12 6.55228 12 6ZM8.70711 7.29289C9.09763 7.68342 9.09763 8.31658 8.70711 8.70711L5.41421 12L8.70711 15.2929C9.09763 15.6834 9.09763 16.3166 8.70711 16.7071C8.31658 17.0976 7.68342 17.0976 7.29289 16.7071L3.29289 12.7071C2.90237 12.3166 2.90237 11.6834 3.29289 11.2929L7.29289 7.29289C7.68342 6.90237 8.31658 6.90237 8.70711 7.29289ZM10 12C10 11.4477 10.4477 11 11 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H11C10.4477 13 10 12.5523 10 12ZM12 18C12 17.4477 12.4477 17 13 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H13C12.4477 19 12 18.5523 12 18Z"/></svg>',command:"list.outdent"},dlist:{title:"## buttons.definition-list ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.5 5C5.36739 5 5.24021 5.05268 5.14645 5.14645C5.05268 5.24021 5 5.36739 5 5.5V7H6V5.5C6 5.36739 5.94732 5.24021 5.85355 5.14645C5.75979 5.05268 5.63261 5 5.5 5ZM8 5.5C8 4.83696 7.73661 4.20107 7.26777 3.73223C6.79893 3.26339 6.16304 3 5.5 3C4.83696 3 4.20107 3.26339 3.73223 3.73223C3.26339 4.20107 3 4.83696 3 5.5V10C3 10.5523 3.44772 11 4 11C4.55228 11 5 10.5523 5 10V9H6V10C6 10.5523 6.44772 11 7 11C7.55228 11 8 10.5523 8 10V5.5ZM10 6C10 5.44772 10.4477 5 11 5H20C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7H11C10.4477 7 10 6.55228 10 6ZM10 12C10 11.4477 10.4477 11 11 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H11C10.4477 13 10 12.5523 10 12ZM3 14C3 13.4477 3.44772 13 4 13H5.5C6.16304 13 6.79893 13.2634 7.26777 13.7322C7.73661 14.2011 8 14.837 8 15.5C8 16.044 7.82267 16.5698 7.50001 17C7.82267 17.4302 8 17.956 8 18.5C8 19.163 7.73661 19.7989 7.26777 20.2678C6.79893 20.7366 6.16304 21 5.5 21H4C3.44772 21 3 20.5523 3 20V14ZM5 18V19H5.5C5.63261 19 5.75978 18.9473 5.85355 18.8536C5.94732 18.7598 6 18.6326 6 18.5C6 18.3674 5.94732 18.2402 5.85355 18.1464C5.75978 18.0527 5.63261 18 5.5 18H5ZM5.5 16C5.63261 16 5.75978 15.9473 5.85355 15.8536C5.94732 15.7598 6 15.6326 6 15.5C6 15.3674 5.94732 15.2402 5.85355 15.1464C5.75979 15.0527 5.63261 15 5.5 15H5V16H5.5ZM10 18C10 17.4477 10.4477 17 11 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H11C10.4477 19 10 18.5523 10 18Z"/></svg>',command:"block.add"},hotkeys:{title:"## buttons.hotkeys ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3 8C3 7.44772 3.44772 7 4 7H20C20.5523 7 21 7.44772 21 8V16C21 16.5523 20.5523 17 20 17H4C3.44772 17 3 16.5523 3 16V8ZM4 5C2.34315 5 1 6.34315 1 8V16C1 17.6569 2.34315 19 4 19H20C21.6569 19 23 17.6569 23 16V8C23 6.34315 21.6569 5 20 5H4ZM7 14C7 13.4477 6.55228 13 6 13C5.44772 13 5 13.4477 5 14V14.01C5 14.5623 5.44772 15.01 6 15.01C6.55228 15.01 7 14.5623 7 14.01V14ZM6 9C6.55228 9 7 9.44772 7 10V10.01C7 10.5623 6.55228 11.01 6 11.01C5.44772 11.01 5 10.5623 5 10.01V10C5 9.44772 5.44772 9 6 9ZM11 10C11 9.44772 10.5523 9 10 9C9.44771 9 9 9.44772 9 10V10.01C9 10.5623 9.44771 11.01 10 11.01C10.5523 11.01 11 10.5623 11 10.01V10ZM14 9C14.5523 9 15 9.44772 15 10V10.01C15 10.5623 14.5523 11.01 14 11.01C13.4477 11.01 13 10.5623 13 10.01V10C13 9.44772 13.4477 9 14 9ZM19 10C19 9.44772 18.5523 9 18 9C17.4477 9 17 9.44772 17 10V10.01C17 10.5623 17.4477 11.01 18 11.01C18.5523 11.01 19 10.5623 19 10.01V10ZM18 13C18.5523 13 19 13.4477 19 14V14.01C19 14.5623 18.5523 15.01 18 15.01C17.4477 15.01 17 14.5623 17 14.01V14C17 13.4477 17.4477 13 18 13ZM10 13C9.44771 13 9 13.4477 9 14C9 14.5523 9.44771 15 10 15H14C14.5523 15 15 14.5523 15 14C15 13.4477 14.5523 13 14 13H10Z"/></svg>',command:"hotkeys.popup"},undo:{title:"## buttons.undo ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.70711 4.29289C10.0976 4.68342 10.0976 5.31658 9.70711 5.70711L7.41421 8H16C17.3261 8 18.5979 8.52678 19.5355 9.46447C20.4732 10.4021 21 11.6739 21 13C21 14.3261 20.4732 15.5979 19.5355 16.5355C18.5979 17.4732 17.3261 18 16 18H15C14.4477 18 14 17.5523 14 17C14 16.4477 14.4477 16 15 16H16C16.7956 16 17.5587 15.6839 18.1213 15.1213C18.6839 14.5587 19 13.7956 19 13C19 12.2044 18.6839 11.4413 18.1213 10.8787C17.5587 10.3161 16.7956 10 16 10H7.41421L9.70711 12.2929C10.0976 12.6834 10.0976 13.3166 9.70711 13.7071C9.31658 14.0976 8.68342 14.0976 8.29289 13.7071L4.29329 9.7075C4.29316 9.70737 4.29303 9.70724 4.29289 9.70711C4.29219 9.7064 4.29148 9.70569 4.29078 9.70498C4.19595 9.6096 4.12432 9.49986 4.07588 9.38278C4.02699 9.26488 4 9.13559 4 9C4 8.86441 4.02699 8.73512 4.07588 8.61722C4.12468 8.49927 4.19702 8.38877 4.29289 8.29289L8.29289 4.29289C8.68342 3.90237 9.31658 3.90237 9.70711 4.29289Z"/></svg>',command:"state.undo"},redo:{title:"## buttons.redo ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M15.2929 4.29289C14.9024 4.68342 14.9024 5.31658 15.2929 5.70711L17.5858 8H9C7.67392 8 6.40215 8.52678 5.46447 9.46447C4.52678 10.4021 4 11.6739 4 13C4 14.3261 4.52678 15.5979 5.46447 16.5355C6.40215 17.4732 7.67392 18 9 18H10C10.5523 18 11 17.5523 11 17C11 16.4477 10.5523 16 10 16H9C8.20435 16 7.44129 15.6839 6.87868 15.1213C6.31607 14.5587 6 13.7956 6 13C6 12.2044 6.31607 11.4413 6.87868 10.8787C7.44129 10.3161 8.20435 10 9 10H17.5858L15.2929 12.2929C14.9024 12.6834 14.9024 13.3166 15.2929 13.7071C15.6834 14.0976 16.3166 14.0976 16.7071 13.7071L20.7067 9.7075C20.7068 9.70737 20.707 9.70724 20.7071 9.70711C20.7078 9.7064 20.7085 9.70569 20.7092 9.70498C20.804 9.6096 20.8757 9.49986 20.9241 9.38278C20.973 9.26488 21 9.13559 21 9C21 8.86441 20.973 8.73512 20.9241 8.61722C20.8753 8.49927 20.803 8.38877 20.7071 8.29289L16.7071 4.29289C16.3166 3.90237 15.6834 3.90237 15.2929 4.29289Z"/></svg>',command:"state.redo"},toggle:{title:"## buttons.toggle ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M4 7C3.44772 7 3 7.44772 3 8C3 8.55228 3.44772 9 4 9H20C20.5523 9 21 8.55228 21 8C21 7.44772 20.5523 7 20 7H4ZM4 15C3.44772 15 3 15.4477 3 16C3 16.5523 3.44772 17 4 17H20C20.5523 17 21 16.5523 21 16C21 15.4477 20.5523 15 20 15H4Z"/></svg>',command:"control.popup"},duplicate:{title:"## buttons.duplicate ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 3C5.20435 3 4.44129 3.31607 3.87868 3.87868C3.31607 4.44129 3 5.20435 3 6V14C3 14.7956 3.31607 15.5587 3.87868 16.1213C4.44129 16.6839 5.20435 17 6 17H7V18C7 19.6569 8.34315 21 10 21H18C19.6569 21 21 19.6569 21 18V10C21 8.34315 19.6569 7 18 7H17V6C17 5.20435 16.6839 4.44129 16.1213 3.87868C15.5587 3.31607 14.7956 3 14 3H6ZM15 7V6C15 5.73478 14.8946 5.48043 14.7071 5.29289C14.5196 5.10536 14.2652 5 14 5H6C5.73478 5 5.48043 5.10536 5.29289 5.29289C5.10536 5.48043 5 5.73478 5 6V14C5 14.2652 5.10536 14.5196 5.29289 14.7071C5.48043 14.8946 5.73478 15 6 15H7V10C7 8.34315 8.34315 7 10 7H15ZM9 16V18C9 18.5523 9.44772 19 10 19H18C18.5523 19 19 18.5523 19 18V10C19 9.44772 18.5523 9 18 9H16H10C9.44772 9 9 9.44772 9 10V16Z"/></svg>',command:"block.duplicate"},trash:{title:"## buttons.delete ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10 2C9.46957 2 8.96086 2.21071 8.58579 2.58579C8.21071 2.96086 8 3.46957 8 4V6H5.01218H4.99004H4C3.44772 6 3 6.44772 3 7C3 7.55229 3.44772 8 4 8H4.07986L5.00034 19.0458C5.01222 19.8249 5.32687 20.5695 5.87867 21.1213C6.44128 21.6839 7.20434 22 7.99999 22H16C16.7956 22 17.5587 21.6839 18.1213 21.1213C18.6731 20.5695 18.9878 19.8249 18.9996 19.0458L19.9201 8H20C20.5523 8 21 7.55229 21 7C21 6.44772 20.5523 6 20 6H19.0099H18.9878H16V4C16 3.46957 15.7893 2.96086 15.4142 2.58579C15.0391 2.21071 14.5304 2 14 2H10ZM14 6V4L10 4L10 6H14ZM9 8H6.08679L6.99654 18.9169C6.99884 18.9446 6.99999 18.9723 6.99999 19C6.99999 19.2652 7.10535 19.5196 7.29289 19.7071C7.48042 19.8946 7.73478 20 7.99999 20H16C16.2652 20 16.5196 19.8946 16.7071 19.7071C16.8946 19.5196 17 19.2652 17 19C17 18.9723 17.0011 18.9446 17.0034 18.9169L17.9132 8H15H9ZM10 10C10.5523 10 11 10.4477 11 11V17C11 17.5523 10.5523 18 10 18C9.44772 18 9 17.5523 9 17V11C9 10.4477 9.44772 10 10 10ZM15 11C15 10.4477 14.5523 10 14 10C13.4477 10 13 10.4477 13 11V17C13 17.5523 13.4477 18 14 18C14.5523 18 15 17.5523 15 17V11Z"/></svg>',danger:!0,command:"block.remove"},table:{title:"## buttons.table ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5 4C4.73478 4 4.48043 4.10536 4.29289 4.29289C4.10536 4.48043 4 4.73478 4 5V9H9V4H5ZM5 2C4.20435 2 3.44129 2.31607 2.87868 2.87868C2.31607 3.44129 2 4.20435 2 5V19C2 19.7957 2.31607 20.5587 2.87868 21.1213C3.44129 21.6839 4.20435 22 5 22H19C19.7957 22 20.5587 21.6839 21.1213 21.1213C21.6839 20.5587 22 19.7957 22 19V5C22 4.20435 21.6839 3.44129 21.1213 2.87868C20.5587 2.31607 19.7957 2 19 2H5ZM11 4V9H20V5C20 4.73478 19.8946 4.48043 19.7071 4.29289C19.5196 4.10536 19.2652 4 19 4H11ZM20 11H11V20H19C19.2652 20 19.5196 19.8946 19.7071 19.7071C19.8946 19.5196 20 19.2652 20 19V11ZM9 20V11H4V19C4 19.2652 4.10536 19.5196 4.29289 19.7071C4.48043 19.8946 4.73478 20 5 20H9Z"/></svg>',observer:"table.observe",command:"block.add"},"cell-setting":{title:"## table.cell-setting ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 3C6.55228 3 7 3.44772 7 4V7.17157C7.4179 7.31933 7.80192 7.55928 8.12132 7.87868C8.68393 8.44129 9 9.20435 9 10C9 10.7956 8.68393 11.5587 8.12132 12.1213C7.80192 12.4407 7.4179 12.6807 7 12.8284V20C7 20.5523 6.55228 21 6 21C5.44772 21 5 20.5523 5 20V12.8284C4.5821 12.6807 4.19808 12.4407 3.87868 12.1213C3.31607 11.5587 3 10.7956 3 10C3 9.20435 3.31607 8.44129 3.87868 7.87868C4.19808 7.55928 4.5821 7.31933 5 7.17157V4C5 3.44772 5.44772 3 6 3ZM12 3C12.5523 3 13 3.44772 13 4V13.1716C13.4179 13.3193 13.8019 13.5593 14.1213 13.8787C14.6839 14.4413 15 15.2043 15 16C15 16.7957 14.6839 17.5587 14.1213 18.1213C13.8019 18.4407 13.4179 18.6807 13 18.8284V20C13 20.5523 12.5523 21 12 21C11.4477 21 11 20.5523 11 20V18.8284C10.5821 18.6807 10.1981 18.4407 9.87868 18.1213C9.31607 17.5587 9 16.7957 9 16C9 15.2043 9.31607 14.4413 9.87868 13.8787C10.1981 13.5593 10.5821 13.3193 11 13.1716V4C11 3.44772 11.4477 3 12 3ZM18 3C18.5523 3 19 3.44772 19 4V4.17157C19.4179 4.31933 19.8019 4.55927 20.1213 4.87868C20.6839 5.44129 21 6.20435 21 7C21 7.79565 20.6839 8.55871 20.1213 9.12132C19.8019 9.44072 19.4179 9.68067 19 9.82843V20C19 20.5523 18.5523 21 18 21C17.4477 21 17 20.5523 17 20V9.82843C16.5821 9.68067 16.1981 9.44072 15.8787 9.12132C15.3161 8.55871 15 7.79565 15 7C15 6.20435 15.3161 5.44129 15.8787 4.87868C16.1981 4.55927 16.5821 4.31933 17 4.17157V4C17 3.44772 17.4477 3 18 3ZM18 6C17.7348 6 17.4804 6.10536 17.2929 6.29289C17.1054 6.48043 17 6.73478 17 7C17 7.26522 17.1054 7.51957 17.2929 7.70711C17.4804 7.89464 17.7348 8 18 8C18.2652 8 18.5196 7.89464 18.7071 7.70711C18.8946 7.51957 19 7.26522 19 7C19 6.73478 18.8946 6.48043 18.7071 6.29289C18.5196 6.10536 18.2652 6 18 6ZM6 9C5.73478 9 5.48043 9.10536 5.29289 9.29289C5.10536 9.48043 5 9.73478 5 10C5 10.2652 5.10536 10.5196 5.29289 10.7071C5.48043 10.8946 5.73478 11 6 11C6.26522 11 6.51957 10.8946 6.70711 10.7071C6.89464 10.5196 7 10.2652 7 10C7 9.73478 6.89464 9.48043 6.70711 9.29289C6.51957 9.10536 6.26522 9 6 9ZM12 15C11.7348 15 11.4804 15.1054 11.2929 15.2929C11.1054 15.4804 11 15.7348 11 16C11 16.2652 11.1054 16.5196 11.2929 16.7071C11.4804 16.8946 11.7348 17 12 17C12.2652 17 12.5196 16.8946 12.7071 16.7071C12.8946 16.5196 13 16.2652 13 16C13 15.7348 12.8946 15.4804 12.7071 15.2929C12.5196 15.1054 12.2652 15 12 15Z"/></svg>',command:"table.cellSetting"},embed:{title:"## buttons.embed ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 6C5.73478 6 5.48043 6.10536 5.29289 6.29289C5.10536 6.48043 5 6.73478 5 7V11C5 11.2652 4.89464 11.5196 4.70711 11.7071L4.41421 12L4.70711 12.2929C4.89464 12.4804 5 12.7348 5 13V17C5 17.2652 5.10536 17.5196 5.29289 17.7071C5.48043 17.8946 5.73478 18 6 18C6.55228 18 7 18.4477 7 19C7 19.5523 6.55228 20 6 20C5.20435 20 4.44129 19.6839 3.87868 19.1213C3.31607 18.5587 3 17.7956 3 17V13.4142L2.29289 12.7071C1.90237 12.3166 1.90237 11.6834 2.29289 11.2929L3 10.5858V7C3 6.20435 3.31607 5.44129 3.87868 4.87868C4.44129 4.31607 5.20435 4 6 4C6.55228 4 7 4.44772 7 5C7 5.55228 6.55228 6 6 6ZM17 5C17 4.44772 17.4477 4 18 4C18.7956 4 19.5587 4.31607 20.1213 4.87868C20.6839 5.44129 21 6.20435 21 7V10.5858L21.7071 11.2929C22.0976 11.6834 22.0976 12.3166 21.7071 12.7071L21 13.4142V17C21 17.7957 20.6839 18.5587 20.1213 19.1213C19.5587 19.6839 18.7957 20 18 20C17.4477 20 17 19.5523 17 19C17 18.4477 17.4477 18 18 18C18.2652 18 18.5196 17.8946 18.7071 17.7071C18.8946 17.5196 19 17.2652 19 17V13C19 12.7348 19.1054 12.4804 19.2929 12.2929L19.5858 12L19.2929 11.7071C19.1054 11.5196 19 11.2652 19 11V7C19 6.73478 18.8946 6.48043 18.7071 6.29289C18.5196 6.10536 18.2652 6 18 6C17.4477 6 17 5.55228 17 5ZM12 8C12.5523 8 13 8.44772 13 9V11H15C15.5523 11 16 11.4477 16 12C16 12.5523 15.5523 13 15 13H13V15C13 15.5523 12.5523 16 12 16C11.4477 16 11 15.5523 11 15V13H9C8.44772 13 8 12.5523 8 12C8 11.4477 8.44772 11 9 11H11V9C11 8.44772 11.4477 8 12 8Z"/></svg>',observer:"embed.observe",command:"embed.popup"},quote:{title:"## buttons.quote ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.58579 5.58579C4.96086 5.21071 5.46957 5 6 5H9C9.53043 5 10.0391 5.21071 10.4142 5.58579C10.7893 5.96086 11 6.46957 11 7V13C11 14.5025 10.6219 15.8236 9.78098 16.8747C8.94259 17.9227 7.72684 18.5989 6.24262 18.9701C5.70684 19.1041 5.16387 18.7784 5.02988 18.2426C4.89588 17.7068 5.2216 17.1639 5.75738 17.0299C6.94016 16.7341 7.72441 16.2438 8.21927 15.6253C8.7116 15.0099 9 14.1645 9 13V12H6C5.46957 12 4.96086 11.7893 4.58579 11.4142C4.21071 11.0391 4 10.5304 4 10V7C4 6.46957 4.21071 5.96086 4.58579 5.58579ZM9 10V7L6 7L6 10H9ZM13.5858 5.58579C13.9609 5.21071 14.4696 5 15 5H18C18.5304 5 19.0391 5.21071 19.4142 5.58579C19.7893 5.96086 20 6.46957 20 7V13C20 14.5025 19.6219 15.8236 18.781 16.8747C17.9426 17.9227 16.7268 18.5989 15.2426 18.9701C14.7068 19.1041 14.1639 18.7784 14.0299 18.2426C13.8959 17.7068 14.2216 17.1639 14.7574 17.0299C15.9402 16.7341 16.7244 16.2438 17.2193 15.6253C17.7116 15.0099 18 14.1645 18 13V12H15C14.4696 12 13.9609 11.7893 13.5858 11.4142C13.2107 11.0391 13 10.5304 13 10V7C13 6.46957 13.2107 5.96086 13.5858 5.58579ZM18 10L18 7H15V10H18Z"/></svg>',command:"format.set"},layout:{title:"## buttons.layout ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2.58579 2.58579C2.96086 2.21071 3.46957 2 4 2H20C20.5304 2 21.0391 2.21071 21.4142 2.58579C21.7893 2.96086 22 3.46957 22 4V20C22 20.5304 21.7893 21.0391 21.4142 21.4142C21.0391 21.7893 20.5304 22 20 22H4C3.46957 22 2.96086 21.7893 2.58579 21.4142C2.21071 21.0391 2 20.5304 2 20V4C2 3.46957 2.21071 2.96086 2.58579 2.58579ZM13 20H20V4H13V20ZM11 4V20H4V4H11Z"/></svg>',command:"layout.popup"},wrapper:{title:"## buttons.wrapper ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5 6C4.73478 6 4.48043 6.10536 4.29289 6.29289C4.10536 6.48043 4 6.73478 4 7V17C4 17.2652 4.10536 17.5196 4.29289 17.7071C4.48043 17.8946 4.73478 18 5 18H19C19.2652 18 19.5196 17.8946 19.7071 17.7071C19.8946 17.5196 20 17.2652 20 17V7C20 6.73478 19.8946 6.48043 19.7071 6.29289C19.5196 6.10536 19.2652 6 19 6H5ZM2.87868 4.87868C3.44129 4.31607 4.20435 4 5 4H19C19.7957 4 20.5587 4.31607 21.1213 4.87868C21.6839 5.44129 22 6.20435 22 7V17C22 17.7957 21.6839 18.5587 21.1213 19.1213C20.5587 19.6839 19.7957 20 19 20H5C4.20435 20 3.44129 19.6839 2.87868 19.1213C2.31607 18.5587 2 17.7956 2 17V7C2 6.20435 2.31607 5.44129 2.87868 4.87868Z"/></svg>',command:"block.add"},todo:{title:"## buttons.todo ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.79289 3.79289C7.18342 3.40237 7.81658 3.40237 8.20711 3.79289C8.59763 4.18342 8.59763 4.81658 8.20711 5.20711L5.70711 7.70711C5.31658 8.09763 4.68342 8.09763 4.29289 7.70711L2.79289 6.20711C2.40237 5.81658 2.40237 5.18342 2.79289 4.79289C3.18342 4.40237 3.81658 4.40237 4.20711 4.79289L5 5.58579L6.79289 3.79289ZM10 6C10 5.44772 10.4477 5 11 5H20C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7H11C10.4477 7 10 6.55228 10 6ZM8.20711 9.79289C8.59763 10.1834 8.59763 10.8166 8.20711 11.2071L5.70711 13.7071C5.31658 14.0976 4.68342 14.0976 4.29289 13.7071L2.79289 12.2071C2.40237 11.8166 2.40237 11.1834 2.79289 10.7929C3.18342 10.4024 3.81658 10.4024 4.20711 10.7929L5 11.5858L6.79289 9.79289C7.18342 9.40237 7.81658 9.40237 8.20711 9.79289ZM10 12C10 11.4477 10.4477 11 11 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H11C10.4477 13 10 12.5523 10 12ZM8.20711 15.7929C8.59763 16.1834 8.59763 16.8166 8.20711 17.2071L5.70711 19.7071C5.31658 20.0976 4.68342 20.0976 4.29289 19.7071L2.79289 18.2071C2.40237 17.8166 2.40237 17.1834 2.79289 16.7929C3.18342 16.4024 3.81658 16.4024 4.20711 16.7929L5 17.5858L6.79289 15.7929C7.18342 15.4024 7.81658 15.4024 8.20711 15.7929ZM10 18C10 17.4477 10.4477 17 11 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H11C10.4477 19 10 18.5523 10 18Z"/></svg>',command:"format.set"},pre:{title:"## buttons.code-snippet ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.2425 3.02986C14.7783 3.16381 15.1041 3.70674 14.9701 4.24254L10.9701 20.2425C10.8362 20.7783 10.2933 21.1041 9.75746 20.9701C9.22167 20.8362 8.89591 20.2933 9.02986 19.7575L13.0299 3.75746C13.1638 3.22167 13.7067 2.89591 14.2425 3.02986ZM7.70711 7.29289C8.09763 7.68342 8.09763 8.31658 7.70711 8.70711L4.41421 12L7.70711 15.2929C8.09763 15.6834 8.09763 16.3166 7.70711 16.7071C7.31658 17.0976 6.68342 17.0976 6.29289 16.7071L2.29289 12.7071C1.90237 12.3166 1.90237 11.6834 2.29289 11.2929L6.29289 7.29289C6.68342 6.90237 7.31658 6.90237 7.70711 7.29289ZM16.2929 7.29289C16.6834 6.90237 17.3166 6.90237 17.7071 7.29289L21.7071 11.2929C22.0976 11.6834 22.0976 12.3166 21.7071 12.7071L17.7071 16.7071C17.3166 17.0976 16.6834 17.0976 16.2929 16.7071C15.9024 16.3166 15.9024 15.6834 16.2929 15.2929L19.5858 12L16.2929 8.70711C15.9024 8.31658 15.9024 7.68342 16.2929 7.29289Z"/></svg>',command:"block.add"},line:{title:"## buttons.line ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3 12C3 11.4477 3.44772 11 4 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H4C3.44772 13 3 12.5523 3 12Z"/></svg>',command:"block.add"},parent:{title:"## buttons.parent ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 6H16C16.5523 6 17 6.44772 17 7C17 7.55228 16.5523 8 16 8H9.41421L17.7071 16.2929C18.0976 16.6834 18.0976 17.3166 17.7071 17.7071C17.3166 18.0976 16.6834 18.0976 16.2929 17.7071L8 9.41421V16C8 16.5523 7.55228 17 7 17C6.44772 17 6 16.5523 6 16V7C6 6.44772 6.44772 6 7 6Z"/></svg>',command:"block.setParent"},code:{title:"## buttons.code ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.2425 3.02986C14.7783 3.16381 15.1041 3.70674 14.9701 4.24254L10.9701 20.2425C10.8362 20.7783 10.2933 21.1041 9.75746 20.9701C9.22167 20.8362 8.89591 20.2933 9.02986 19.7575L13.0299 3.75746C13.1638 3.22167 13.7067 2.89591 14.2425 3.02986ZM7.70711 7.29289C8.09763 7.68342 8.09763 8.31658 7.70711 8.70711L4.41421 12L7.70711 15.2929C8.09763 15.6834 8.09763 16.3166 7.70711 16.7071C7.31658 17.0976 6.68342 17.0976 6.29289 16.7071L2.29289 12.7071C1.90237 12.3166 1.90237 11.6834 2.29289 11.2929L6.29289 7.29289C6.68342 6.90237 7.31658 6.90237 7.70711 7.29289ZM16.2929 7.29289C16.6834 6.90237 17.3166 6.90237 17.7071 7.29289L21.7071 11.2929C22.0976 11.6834 22.0976 12.3166 21.7071 12.7071L17.7071 16.7071C17.3166 17.0976 16.6834 17.0976 16.2929 16.7071C15.9024 16.3166 15.9024 15.6834 16.2929 15.2929L19.5858 12L16.2929 8.70711C15.9024 8.31658 15.9024 7.68342 16.2929 7.29289Z"/></svg>',command:"inline.set",params:{tag:"code"}},underline:{title:"## buttons.underline ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 4C7.55228 4 8 4.44772 8 5V10C8 11.0609 8.42143 12.0783 9.17157 12.8284C9.92172 13.5786 10.9391 14 12 14C13.0609 14 14.0783 13.5786 14.8284 12.8284C15.5786 12.0783 16 11.0609 16 10V5C16 4.44772 16.4477 4 17 4C17.5523 4 18 4.44772 18 5V10C18 11.5913 17.3679 13.1174 16.2426 14.2426C15.1174 15.3679 13.5913 16 12 16C10.4087 16 8.88258 15.3679 7.75736 14.2426C6.63214 13.1174 6 11.5913 6 10V5C6 4.44772 6.44772 4 7 4ZM4 19C4 18.4477 4.44772 18 5 18H19C19.5523 18 20 18.4477 20 19C20 19.5523 19.5523 20 19 20H5C4.44772 20 4 19.5523 4 19Z"/></svg>',command:"inline.set",params:{tag:"u"}},highlight:{title:"## buttons.highlight ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7929 3.79289C13.5109 3.07492 14.4846 2.67157 15.5 2.67157C16.5154 2.67157 17.4891 3.07492 18.2071 3.79289C18.9251 4.51086 19.3284 5.48464 19.3284 6.5C19.3284 7.51536 18.9251 8.48913 18.2071 9.2071L17.2085 10.2057C17.2081 10.2061 17.2076 10.2066 17.2071 10.2071C17.2066 10.2076 17.2061 10.2081 17.2057 10.2085L9.20854 18.2057C9.20807 18.2061 9.20759 18.2066 9.20711 18.2071C9.20663 18.2076 9.20615 18.2081 9.20567 18.2085L7.70711 19.7071C7.51957 19.8946 7.26522 20 7 20H3C2.44772 20 2 19.5523 2 19V15C2 14.7348 2.10536 14.4804 2.29289 14.2929L12.7929 3.79289ZM12.5 6.91421L5.91421 13.5L8.5 16.0858L15.0858 9.5L12.5 6.91421ZM16.5 8.08579L13.9142 5.5L14.2071 5.2071C14.55 4.86421 15.0151 4.67157 15.5 4.67157C15.9849 4.67157 16.45 4.86421 16.7929 5.2071C17.1358 5.55 17.3284 6.01507 17.3284 6.5C17.3284 6.98493 17.1358 7.44999 16.7929 7.79289L16.5 8.08579ZM7.08579 17.5L4.5 14.9142L4 15.4142V18H6.58579L7.08579 17.5ZM16.2929 14.2929C16.4804 14.1054 16.7348 14 17 14H21C21.5523 14 22 14.4477 22 15V19C22 19.5523 21.5523 20 21 20H13C12.5955 20 12.2309 19.7564 12.0761 19.3827C11.9213 19.009 12.0069 18.5789 12.2929 18.2929L16.2929 14.2929ZM20 16H17.4142L15.4142 18H20V16Z"/></svg>',command:"inline.set",params:{tag:"mark"}},sup:{title:"## buttons.superscript ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M17.9565 3.09068C18.7281 2.88025 19.5517 2.98495 20.2461 3.38175C20.5899 3.57822 20.8917 3.8405 21.1342 4.1536C21.3767 4.4667 21.5551 4.82449 21.6593 5.20655C21.7635 5.5886 21.7914 5.98744 21.7415 6.38029C21.6915 6.77313 21.5647 7.1523 21.3682 7.49613C21.3352 7.55397 21.2964 7.60836 21.2526 7.6585L19.2037 9.99999H21C21.5523 9.99999 22 10.4477 22 11C22 11.5523 21.5523 12 21 12H17C16.6076 12 16.2515 11.7705 16.0893 11.4132C15.9272 11.0559 15.989 10.6368 16.2474 10.3415L19.6701 6.42985C19.7146 6.33455 19.7441 6.23275 19.7574 6.12807C19.7743 5.99576 19.7648 5.86144 19.7298 5.73278C19.6947 5.60411 19.6346 5.48362 19.5529 5.37818C19.4713 5.27273 19.3696 5.1844 19.2538 5.11824C19.02 4.9846 18.7426 4.94934 18.4828 5.02021C18.2229 5.09108 18.0019 5.26227 17.8682 5.49613C17.5942 5.97565 16.9834 6.14225 16.5038 5.86824C16.0243 5.59423 15.8577 4.98337 16.1317 4.50385C16.5285 3.80945 17.1849 3.30112 17.9565 3.09068ZM4.37528 6.21913C4.80654 5.87412 5.43584 5.94404 5.78084 6.3753L8.99998 10.3992L12.2191 6.3753C12.5641 5.94404 13.1934 5.87412 13.6247 6.21913C14.0559 6.56414 14.1259 7.19343 13.7808 7.62469L10.2806 12L13.7808 16.3753C14.1259 16.8066 14.0559 17.4359 13.6247 17.7809C13.1934 18.1259 12.5641 18.056 12.2191 17.6247L8.99998 13.6008L5.78084 17.6247C5.43584 18.056 4.80654 18.1259 4.37528 17.7809C3.94402 17.4359 3.8741 16.8066 4.21911 16.3753L7.71935 12L4.21911 7.62469C3.8741 7.19343 3.94402 6.56414 4.37528 6.21913Z"/></svg>',command:"inline.set",params:{tag:"sup"}},sub:{title:"## buttons.subscript ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.37528 6.21914C4.80654 5.87413 5.43584 5.94405 5.78084 6.37531L8.99998 10.3992L12.2191 6.37531C12.5641 5.94405 13.1934 5.87413 13.6247 6.21914C14.0559 6.56415 14.1259 7.19344 13.7808 7.6247L10.2806 12L13.7808 16.3753C14.1259 16.8066 14.0559 17.4359 13.6247 17.7809C13.1934 18.1259 12.5641 18.056 12.2191 17.6247L8.99998 13.6008L5.78084 17.6247C5.43584 18.056 4.80654 18.1259 4.37528 17.7809C3.94402 17.4359 3.8741 16.8066 4.21911 16.3753L7.71935 12L4.21911 7.6247C3.8741 7.19344 3.94402 6.56415 4.37528 6.21914ZM17.9565 12.0907C18.3386 11.9865 18.7374 11.9586 19.1303 12.0085C19.5231 12.0585 19.9023 12.1853 20.2461 12.3818C20.5899 12.5782 20.8917 12.8405 21.1342 13.1536C21.3767 13.4667 21.5551 13.8245 21.6593 14.2066C21.7635 14.5886 21.7914 14.9875 21.7415 15.3803C21.6915 15.7731 21.5647 16.1523 21.3682 16.4961C21.3352 16.554 21.2964 16.6084 21.2526 16.6585L19.2037 19H21C21.5523 19 22 19.4477 22 20C22 20.5523 21.5523 21 21 21H17C16.6076 21 16.2515 20.7705 16.0893 20.4132C15.9272 20.0559 15.989 19.6368 16.2474 19.3415L19.6701 15.4299C19.7146 15.3346 19.7441 15.2328 19.7574 15.1281C19.7743 14.9958 19.7648 14.8615 19.7298 14.7328C19.6947 14.6041 19.6346 14.4836 19.5529 14.3782C19.4713 14.2727 19.3696 14.1844 19.2538 14.1182C19.138 14.0521 19.0104 14.0094 18.878 13.9926C18.7457 13.9757 18.6114 13.9851 18.4828 14.0202C18.3541 14.0553 18.2336 14.1154 18.1282 14.1971C18.0227 14.2787 17.9344 14.3804 17.8682 14.4961C17.5942 14.9757 16.9834 15.1423 16.5038 14.8682C16.0243 14.5942 15.8577 13.9834 16.1317 13.5039C16.3282 13.16 16.5905 12.8583 16.9036 12.6158C17.2167 12.3733 17.5745 12.1949 17.9565 12.0907Z"/></svg>',command:"inline.set",params:{tag:"sub"}},removeinline:{title:"## buttons.clear-all-styles ##",position:"last",command:"inline.removeFormat"},heading:{title:"## buttons.heading ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 6C2 5.44772 2.44772 5 3 5H5C5.55228 5 6 5.44772 6 6C6 6.55228 5.55228 7 5 7V11H11V7C10.4477 7 10 6.55228 10 6C10 5.44772 10.4477 5 11 5H13C13.5523 5 14 5.44772 14 6C14 6.55228 13.5523 7 13 7V17C13.5523 17 14 17.4477 14 18C14 18.5523 13.5523 19 13 19H11C10.4477 19 10 18.5523 10 18C10 17.4477 10.4477 17 11 17V13H5V17C5.55228 17 6 17.4477 6 18C6 18.5523 5.55228 19 5 19H3C2.44772 19 2 18.5523 2 18C2 17.4477 2.44772 17 3 17V7C2.44772 7 2 6.55228 2 6ZM19.3827 9.07612C19.7564 9.2309 20 9.59554 20 10V18C20 18.5523 19.5523 19 19 19C18.4477 19 18 18.5523 18 18V12.4142L17.7071 12.7071C17.3166 13.0976 16.6834 13.0976 16.2929 12.7071C15.9024 12.3166 15.9024 11.6834 16.2929 11.2929L18.2929 9.29289C18.5789 9.0069 19.009 8.92134 19.3827 9.07612Z"/></svg>',command:"block.add"},text:{title:"## buttons.text ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5 6C5 5.44772 5.44772 5 6 5H18C18.5523 5 19 5.44772 19 6C19 6.55228 18.5523 7 18 7H13V18C13 18.5523 12.5523 19 12 19C11.4477 19 11 18.5523 11 18V7H6C5.44772 7 5 6.55228 5 6Z"/></svg>',command:"format.set"},h1:{title:"## buttons.heading ## 1",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 6C2 5.44772 2.44772 5 3 5H5C5.55228 5 6 5.44772 6 6C6 6.55228 5.55228 7 5 7V11H11V7C10.4477 7 10 6.55228 10 6C10 5.44772 10.4477 5 11 5H13C13.5523 5 14 5.44772 14 6C14 6.55228 13.5523 7 13 7V17C13.5523 17 14 17.4477 14 18C14 18.5523 13.5523 19 13 19H11C10.4477 19 10 18.5523 10 18C10 17.4477 10.4477 17 11 17V13H5V17C5.55228 17 6 17.4477 6 18C6 18.5523 5.55228 19 5 19H3C2.44772 19 2 18.5523 2 18C2 17.4477 2.44772 17 3 17V7C2.44772 7 2 6.55228 2 6ZM19.3827 9.07612C19.7564 9.2309 20 9.59554 20 10V18C20 18.5523 19.5523 19 19 19C18.4477 19 18 18.5523 18 18V12.4142L17.7071 12.7071C17.3166 13.0976 16.6834 13.0976 16.2929 12.7071C15.9024 12.3166 15.9024 11.6834 16.2929 11.2929L18.2929 9.29289C18.5789 9.0069 19.009 8.92134 19.3827 9.07612Z"/></svg>',command:"format.set"},h2:{title:"## buttons.heading ## 2",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 6C2 5.44772 2.44772 5 3 5H5C5.55228 5 6 5.44772 6 6C6 6.55228 5.55228 7 5 7V11H11V7C10.4477 7 10 6.55228 10 6C10 5.44772 10.4477 5 11 5H13C13.5523 5 14 5.44772 14 6C14 6.55228 13.5523 7 13 7V17C13.5523 17 14 17.4477 14 18C14 18.5523 13.5523 19 13 19H11C10.4477 19 10 18.5523 10 18C10 17.4477 10.4477 17 11 17V13H5V17C5.55228 17 6 17.4477 6 18C6 18.5523 5.55228 19 5 19H3C2.44772 19 2 18.5523 2 18C2 17.4477 2.44772 17 3 17V7C2.44772 7 2 6.55228 2 6ZM19 11C18.7348 11 18.4804 11.1054 18.2929 11.2929C18.1054 11.4804 18 11.7348 18 12C18 12.5523 17.5523 13 17 13C16.4477 13 16 12.5523 16 12C16 11.2043 16.3161 10.4413 16.8787 9.87868C17.4413 9.31607 18.2043 9 19 9C19.7957 9 20.5587 9.31607 21.1213 9.87868C21.6839 10.4413 22 11.2043 22 12C22 12.5095 21.8269 12.9956 21.6442 13.3786C21.4547 13.776 21.2129 14.1483 20.9883 14.4523L20.9769 14.4674L19.0297 17.001H21C21.5523 17.001 22 17.4487 22 18.001C22 18.5533 21.5523 19.001 21 19.001H17C16.6191 19.001 16.2713 18.7846 16.103 18.443C15.9346 18.1013 15.975 17.6936 16.2071 17.3916L19.3851 13.2564C19.5575 13.0223 19.7216 12.7639 19.839 12.5176C19.9646 12.2544 20 12.0815 20 12C20 11.7348 19.8946 11.4804 19.7071 11.2929C19.5196 11.1054 19.2652 11 19 11Z"/></svg>',command:"format.set"},h3:{title:"## buttons.heading ## 3",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 6C2 5.44772 2.44772 5 3 5H5C5.55228 5 6 5.44772 6 6C6 6.55228 5.55228 7 5 7V11H11V7C10.4477 7 10 6.55228 10 6C10 5.44772 10.4477 5 11 5H13C13.5523 5 14 5.44772 14 6C14 6.55228 13.5523 7 13 7V17C13.5523 17 14 17.4477 14 18C14 18.5523 13.5523 19 13 19H11C10.4477 19 10 18.5523 10 18C10 17.4477 10.4477 17 11 17V13H5V17C5.55228 17 6 17.4477 6 18C6 18.5523 5.55228 19 5 19H3C2.44772 19 2 18.5523 2 18C2 17.4477 2.44772 17 3 17V7C2.44772 7 2 6.55228 2 6ZM17.8519 9.22836C18.4001 9.0013 19.0033 8.94189 19.5853 9.05764C20.1672 9.1734 20.7018 9.45912 21.1213 9.87868C21.5409 10.2982 21.8266 10.8328 21.9424 11.4147C22.0581 11.9967 21.9987 12.5999 21.7716 13.1481C21.6417 13.4618 21.4601 13.7495 21.2361 14C21.4601 14.2505 21.6417 14.5382 21.7716 14.8519C21.9987 15.4001 22.0581 16.0033 21.9424 16.5853C21.8266 17.1672 21.5409 17.7018 21.1213 18.1213C20.7018 18.5409 20.1672 18.8266 19.5853 18.9424C19.0033 19.0581 18.4001 18.9987 17.8519 18.7716C17.3038 18.5446 16.8352 18.1601 16.5056 17.6667C16.1759 17.1734 16 16.5933 16 16C16 15.4477 16.4477 15 17 15C17.5523 15 18 15.4477 18 16C18 16.1978 18.0586 16.3911 18.1685 16.5556C18.2784 16.72 18.4346 16.8482 18.6173 16.9239C18.8 16.9996 19.0011 17.0194 19.1951 16.9808C19.3891 16.9422 19.5673 16.847 19.7071 16.7071C19.847 16.5673 19.9422 16.3891 19.9808 16.1951C20.0194 16.0011 19.9996 15.8 19.9239 15.6173C19.8482 15.4346 19.72 15.2784 19.5556 15.1685C19.3911 15.0587 19.1978 15 19 15C18.4477 15 18 14.5523 18 14C18 13.4477 18.4477 13 19 13C19.1978 13 19.3911 12.9414 19.5556 12.8315C19.72 12.7216 19.8482 12.5654 19.9239 12.3827C19.9996 12.2 20.0194 11.9989 19.9808 11.8049C19.9422 11.6109 19.847 11.4327 19.7071 11.2929C19.5673 11.153 19.3891 11.0578 19.1951 11.0192C19.0011 10.9806 18.8 11.0004 18.6173 11.0761C18.4346 11.1518 18.2784 11.28 18.1685 11.4444C18.0586 11.6089 18 11.8022 18 12C18 12.5523 17.5523 13 17 13C16.4477 13 16 12.5523 16 12C16 11.4067 16.1759 10.8266 16.5056 10.3333C16.8352 9.83994 17.3038 9.45543 17.8519 9.22836Z"/></svg>',command:"format.set"},h4:{title:"## buttons.heading ## 4",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 6C2 5.44772 2.44772 5 3 5H5C5.55228 5 6 5.44772 6 6C6 6.55228 5.55228 7 5 7V11H11V7C10.4477 7 10 6.55228 10 6C10 5.44772 10.4477 5 11 5H13C13.5523 5 14 5.44772 14 6C14 6.55228 13.5523 7 13 7V17C13.5523 17 14 17.4477 14 18C14 18.5523 13.5523 19 13 19H11C10.4477 19 10 18.5523 10 18C10 17.4477 10.4477 17 11 17V13H5V17C5.55228 17 6 17.4477 6 18C6 18.5523 5.55228 19 5 19H3C2.44772 19 2 18.5523 2 18C2 17.4477 2.44772 17 3 17V7C2.44772 7 2 6.55228 2 6ZM20.2898 9.04291C20.7115 9.17061 21 9.55933 21 10V15C21.5523 15 22 15.4477 22 16C22 16.5523 21.5523 17 21 17V18C21 18.5523 20.5523 19 20 19C19.4477 19 19 18.5523 19 18V17H16C15.6312 17 15.2923 16.797 15.1183 16.4719C14.9443 16.1467 14.9634 15.7522 15.1679 15.4453L19.1679 9.4453C19.4124 9.07864 19.868 8.91521 20.2898 9.04291ZM19 15V13.3028L17.8685 15H19Z"/></svg>',command:"format.set"},h5:{title:"## buttons.heading ## 5",command:"format.set"},h6:{title:"## buttons.heading ## 6",command:"format.set"},address:{title:"## buttons.address ##",command:"format.set"}},nested:[],nestedValue:[],nonparse:[],inlineGroups:{},tags:{denied:["font","html","head","link","title","body","meta","applet","marquee"],incode:["!DOCTYPE","!doctype","html","head","link","title","body","meta","textarea","style"],form:["form","input","button","select","textarea","legend","fieldset"],inline:["a","svg","span","strong","strike","b","u","em","i","code","del","ins","samp","kbd","sup","sub","mark","var","cite","small","abbr"],block:["pre","hr","ul","ol","li","p","h1","h2","h3","h4","h5","h6","dl","dt","dd","div","table","tbody","thead","tfoot","tr","th","td","blockquote","output","figcaption","figure","address","main","section","header","footer","aside","article","iframe","details"],parser:["pre","hr","ul","ol","p","h1","h2","h3","h4","h5","h6","table","address","blockquote","figure","iframe","form","dl","div","section","header","footer","article","main","aside"]},regex:{mp4video:/https?:\/\/\S+\.mp4/gi,youtube:/^https?\:\/\/(?:www\.youtube(?:\-nocookie)?\.com\/|m\.youtube\.com\/|youtube\.com\/)?(?:ytscreeningroom\?vi?=|youtu\.be\/|vi?\/|live|user\/.+\/u\/\w{1,2}\/|embed\/|watch\?(?:.*\&)?vi?=|\&vi?=|\?(?:.*\&)?vi?=)([^#\&\?\n\/<>"']*)/gi,vimeo:/(http|https)?:\/\/(?:www.|player.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/(?:[^/]*)\/videos\/|album\/(?:\d+)\/video\/|video\/|)(\d+)(?:\/[a-zA-Z0-9_-]+)?/gi,imageurl:/((https?|www)[^\s]+\.)(jpe?g|png|gif)(\?[^\s-]+)?/gi,aurl1:/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,aurl2:/(^|[^\/])(www\.[\S]+(\b|$))/gim}},l.lang.en={accessibility:{"help-label":"Rich text editor"},placeholders:{figcaption:"Type caption (optional)"},embed:{embed:"Embed",title:"Title",poster:"Poster image",caption:"Caption",description:"Paste any embed/html code or enter the url (vimeo or youtube video only)","responsive-video":"Responsive video"},image:{"tab-select":"Select","tab-upload":"Upload","tab-url":"Url","tab-props":"Props","alt-text":"Alt Text",link:"Link",src:"Src",width:"Width",height:"Height",caption:"Caption","link-in-new-tab":"Open link in new tab","url-placeholder":"Paste url of image...","upload-new-placeholder":"Drag to upload a new image<br>or click to select"},list:{"select-list":"Select list"},link:{link:"Link","edit-link":"Edit Link",unlink:"Unlink","link-in-new-tab":"Open link in new tab",text:"Text",url:"URL"},table:{width:"Width (px or %)",nowrap:"Nowrap","table-cell":"Table cell","select-table":"Select table","select-cell":"Select cell","cell-setting":"Cell setting","add-head":"Add head","remove-head":"Remove head","add-row-below":"Add row below","add-row-above":"Add row above","remove-row":"Remove row","add-column-after":"Add column after","add-column-before":"Add column before","remove-column":"Remove column","delete-table":"Delete table"},buttons:{add:"Add",insert:"Insert",save:"Save",cancel:"Cancel",delete:"Delete","ai-tools":"AI Tools","ai-image":"AI Image",html:"HTML",format:"Format",bold:"Bold",italic:"Italic",deleted:"Deleted","more-formatting":"More formatting",link:"Link","link-text":"Link Text",unlink:"Unlink",image:"Image",unwrap:"Unwrap",outset:"Outset","wrap-image":"Wrap image","move-up":"Move up","move-down":"Move down",list:"List","numbered-list":"Numbered list","bullet-list":"Bullet list",indent:"Indent",outdent:"Outdent","definition-list":"Definition list",hotkeys:"Hotkeys",undo:"Undo",redo:"Redo",toggle:"Toggle",duplicate:"Duplicate",table:"Table",embed:"Embed",quote:"Quote",layout:"Layout",wrapper:"Wrapper",todo:"Todo","code-snippet":"Code snippet",line:"Line",parent:"Parent",code:"Code",underline:"Underline",highlight:"Highlight",superscript:"Superscript",subscript:"Subscript","clear-all-styles":"Clear all styles",heading:"Heading",text:"Text",address:"Address"},colorpicker:{"remove-color":"Remove color","remove-background":"Remove background color",color:"Color",background:"Background","set-color":"Set color"},pathbar:{title:"Body"},layout:{"select-layout":"Select layout","select-column":"Select column","single-column":"Single column","two-columns":"Two columns","three-columns":"Three columns","four-columns":"Four columns"},outset:{"outset-none":"Outset none","outset-left":"Outset left","outset-both":"Outset both","outset-right":"Outset right"},wrap:{"wrap-none":"Wrap none","wrap-left":"Wrap left","wrap-center":"Wrap center","wrap-right":"Wrap right"},blocks:{address:"Address",cell:"Cell",column:"Column",dlist:"Definition List",embed:"Embed",figcaption:"Figcaption",heading:"Heading",image:"Image",wrapper:"Wrapper",layout:"Layout",line:"Line",list:"List",listitem:"Item",noneditable:"Noneditable",pre:"Pre",quote:"Quote",row:"Row",table:"Table",text:"Text",todo:"Todo",todoitem:"Item",mergetag:"Mergetag"},hotkeys:{"meta-shift-a":"Select text in the block","meta-a":"Select all blocks","meta-z":"Undo","meta-shift-z":"Redo","meta-shift-m":"Remove inline format","meta-b":"Bold","meta-i":"Italic","meta-u":"Underline","meta-h":"Superscript","meta-l":"Subscript","meta-k":"Link","meta-alt-0":"Normal text","meta-alt-1":"Heading 1","meta-alt-2":"Heading 2","meta-alt-3":"Heading 3","meta-alt-4":"Heading 4","meta-alt-5":"Heading 5","meta-alt-6":"Heading 6","meta-shift-7":"Ordered List","meta-shift-8":"Unordered List","meta-indent":"Indent","meta-outdent":"Outdent","meta-shift-backspace":"Delete block","meta-shift-o":"Add block","meta-shift-d":"Duplicate block","meta-shift-up":"Move line up","meta-shift-down":"Move line down"}};class h{constructor(t,e={},s=0){this.ajax=l.ajax,this.dom=l.dom,this.uuid=s,this.$win=this.dom(window),this.$doc=this.dom(document),this.$body=this.dom("body"),this.keycodes=l.keycodes,this.element=new p(t),this.app=this,this.disableMode=!1,this.readonlyMode=!1,this._core=["ajax","dom","uuid","keycodes","config","loc"],this._modules={container:X,source:pt,editor:xt,event:Ht,codemirror:et,placeholder:ot,block:te,blocks:ee,sync:dt,observer:at,scroll:ht,autosave:tt,input:mt,format:se,inline:gt,state:ct,progress:lt,hotkeys:it,image:oe,embed:ne,layout:le,list:pe,link:he,table:ce,ui:Vt,toolbar:Wt,extrabar:Zt,addbar:qt,context:Kt,control:Gt,path:Jt,statusbar:Xt,dropdown:Qt,command:Yt},this._plugins=[],this._props={},this._mode="default",this.started=!1,this.loaded=!1,this._start(e)}start(t={}){this._start(t,!0)}stop(){this.isStopped()||(this.eventBus.emit("app.before.stop"),this._iterate("stop"),this._iterate2("stop"),this.element.showElement(),this._plugins=[],this.started=!1,this.eventBus.emit("app.stop"),this.config.get("clicktoedit")&&(this.eventBus=new Dt(this),this._waitForClickToEdit()))}enable(){this.editor.enable(),this.ui.enable(),this.disableMode=!1}editable(){this.editor.editable(),this.ui.enable(),this.readonlyMode=!1}disable(){this.editor.disable(),this._disable(),this.disableMode=!0}readonly(){this.editor.readonly(),this._disable(),this.readonlyMode=!0}api(t,...e){if(!t)return;const s=t.split("."),i=s.pop();let r=this;for(const t of s){if(void 0===r[t])return;r=r[t]}return"function"==typeof r[i]?r[i](...e):void 0}create(t,...e){let s={selection:"TextRange",predefined:"ClassApplier",element:"ElementInspector",colorpicker:"ColorPicker",form:"UIForm",upload:"Uploader"}[t]||t;return s=this._toPascalCase(s),"function"==typeof l[s]?new l[s](this,...e):this._create(t,...e)}_toPascalCase(t){return t.replace(/-([a-z])/g,((t,e)=>e.toUpperCase())).replace(/^./,(t=>t.toUpperCase()))}_create(t,...e){let[s,i]=t.includes(".")?t.split("."):["class",t],r=l.mapping[s]?.[i];if(!r){if("block"!==s)throw new Error(`The ${s} "${i}" does not exist.`);console.warn(`${s} "${i}" not found`),i="wrapper",r=l.mapping.block[i]}const a=new r.proto;Object.assign(a,{_name:i,app:this,uuid:this.uuid,keycodes:this.keycodes,dom:this.dom,ajax:this.ajax,$win:this.$win,$doc:this.$doc,$body:this.$body,lang:this.lang,opts:this.opts});const n=a.init?.(...e);return n||a}destroy(){this.sync.destroy(),this.stop(),this.eventBus.emit("app.destroy"),this.element.dataset(l.namespace,!1),this._clearInstance()}on(t,e){this.eventBus.on(t,e)}emit(t,e){return this.eventBus.emit(t,e)}emitHtml(t,e){return this.eventBus.emitHtml(t,e)}broadcast(t,e){return this.eventBus.emit(t,e)}broadcastHtml(t,e){return this.eventBus.emitHtml(t,e)}has(t){return this[t]||this._plugins[t]}isStarted(){return this.started}isStopped(){return!this.started}isDisabled(){return this.disableMode}isReadonly(){return this.readonlyMode}isMode(t){return this._mode===t}isProp(t){return this.getProp(t)}setMode(t){this._mode=t}setProp(t,e){this._props[t]=e}getLayout(){return!!this.editor&&this.editor.getLayout()}getEditor(){return!!this.editor&&this.editor.getEditor()}getMode(){return this._mode}getProp(t){return this._props[t]}removeProp(t){delete this._props[t]}_start(t={},e=!1){this._initializeConfig(t),this._initializeCoreComponents(),this._initModes(),!e&&this.config.is("clicktoedit")?this._waitForClickToEdit():this._init()}_disable(){this.source.close(),this.ui.disable(),this.ui.close(),this.block.unset(),this.blocks.unset();new L(this.app).remove()}_initModes(){this.config.is("nocontainer")&&this.config.extend(this.config.get("modes.nocontainer")),this.config.is("css")&&this.setMode("iframe")}_initializeConfig(t){this.config=new st(this,t),this.opts=this.config}_initializeCoreComponents(){this.loc=new rt(this,this.config.get("lang")),this.lang=this.loc,this.eventBus=new Dt(this),this.page=new nt(this)}_waitForClickToEdit(){this.element.one("click.rx-clicktoedit",(()=>{const t=new C(this);this.eventBus.emit("clicktoedit.before.start"),t.save(!0),this._init(),t.restore(),this.editor.click(),this.eventBus.emit("clicktoedit.start"),this.editor.setBlurOther()}))}_init(){this._bindEventsFromConfig(),this.eventBus.emit("app.before.start"),this.element.hideElement(),Object.keys(this._modules).forEach((t=>{this[t]=new this._modules[t](this)})),this._injectDependencies(),this._iterate("init"),this._iterate2("init"),this._iterate("start"),this._iterate2("load"),this._iterate("load");let t=setInterval((()=>{this.loaded&&(clearInterval(t),this._iterate("loaded"))}),100);this.started=!0,this.eventBus.emit("app.start"),this.element.off("click.rx-clicktoedit"),this._buildReadonly(),this._buildDisabled()}_bindEventsFromConfig(){let t=this.config.get("events")||this.config.get("subscribe");if(t)for(const[e,s]of Object.entries(t)){e.split(" ").forEach((t=>{"function"==typeof s&&this.eventBus.on(t,s)}))}}_injectDependencies(){Object.keys(this._modules).forEach((t=>{this._core.forEach((e=>{this[t][e]=this[e]}))}))}_iterate2(t){Object.keys(this._modules).forEach((e=>{const s=this[e],i=s?.[t];"function"==typeof i&&i.apply(s)}))}_iterate(t){if(void 0!==l.mapping.plugin){let e=this.opts.get("plugins");for(let s=0;s<e.length;s++){let i=e[s];void 0!==l.mapping.plugin[i]&&("init"===t&&this._plugins.push(i),this._iterateItem("plugin",i,t))}}}_iterateItem(t,e,s){"init"===s?this[e]=this.create(t+"."+e):this._call(this[e],s)}_call(t,e){"function"==typeof t[e]&&t[e].apply(t)}_buildDisabled(){this.disableMode=this.opts.get("disabled")||this.element.isDisabled(),this.disableMode&&this.disable()}_buildReadonly(){this.readonlyMode=this.opts.get("readonly")||this.element.isReadonly(),this.readonlyMode&&this.readonly()}_clearInstance(){let t=l.instances.indexOf(this.uuid);t>-1&&l.instances.splice(t,1)}}class p extends r{constructor(t){super(t)}isTextarea(){return this.tag("textarea")}isDisabled(){return null!==this.attr("disabled")}isReadonly(){return null!==this.attr("readonly")}hideElement(){this.isTextarea()&&this.addClass("rx-visually-hidden")}showElement(){this.isTextarea()&&this.removeClass("rx-visually-hidden")}setHtml(t){this.isTextarea()?this.val(t):this.html(t)}getHtml(){return this.isTextarea()?this.val():this.html()}getName(){return this.attr("name")}getPlaceholder(){return this.attr("placeholder")}}class c{constructor(t){this.app=t,this.config=t.config,this.maxLength=this.config.get("link.size"),this.linkTarget=this.config.get("paste.linkTarget"),this.https=this.config.get("https"),this.urlPattern=/(?:https?|ftp):\/\/[^\s/$.?#].[^\s]*|www\.[^\s/$.?#].[^\s]*/gi,this.imagePattern=/\.(jpeg|jpg|png|gif)$/i,this.excludeTags=new Set(["figure","html","form","pre","div","span","svg","path","video","object","iframe","source","code","a","img","link","script"])}format(t){if(!this.config.is("paste.autoparse"))return t;const e=new Z(this.app);t=e.storeComments(t);const s=(new DOMParser).parseFromString(t,"text/html");this._traverseNodes(s.body);return t=`<html>${(s.head?.innerHTML?`<head>${s.head.innerHTML}</head>`:"")+`<body>${s.body.innerHTML.replace(/&amp;/g,"&")}</body>`}</html>`,t=e.restoreComments(t)}_traverseNodes(t){if(t.nodeType===Node.ELEMENT_NODE){if(this.excludeTags.has(t.tagName.toLowerCase()))return;Array.from(t.childNodes).forEach((t=>this._traverseNodes(t)))}else if(t.nodeType===Node.TEXT_NODE&&t.textContent.trim())this._processTextNode(t);else if(t.nodeType===Node.COMMENT_NODE)return}_processTextNode(t){const e=this._replaceContent(t.textContent);if(e!==t.textContent){const s=document.createElement("div");s.innerHTML=e;const i=document.createDocumentFragment();for(;s.firstChild;)i.appendChild(s.firstChild);t.parentNode.replaceChild(i,t)}}_replaceContent(t){return t.replace(this.urlPattern,(t=>{const e=this._addProtocolIfNeeded(t);return this._isImageUrl(e)?this._createImageTag(e):this._createLinkTag(e,t)}))}_addProtocolIfNeeded(t){const e=/^(https?|ftp):\/\//.test(t);return this.https&&!e?`https://${t}`:this.https||e?t:`http://${t}`}_isImageUrl(t){return this.imagePattern.test(t)}_createImageTag(t){return`<img src="${t}">`}_createLinkTag(t,e){e=e.replace(/^https?:\/\/(www\.)?/,"").replace(/^www\./,""),this.maxLength&&e.length>this.maxLength&&(e=`${e.substring(0,this.maxLength)}...`);return`<a href="${t}"${this.linkTarget?` target="${this.linkTarget}"`:""}>${e}</a>`}}l.Autoparse=c;class d{constructor(t,e,s={},i,r){this.app=t,this.loc=t.loc,this.dom=t.dom,this.config=t.config,this.name=e,this.toolbar=i,this.container=r||null,this._initializeProps(s),this._checkObserve()&&this._checkPermissions()&&(this.toolbarType=this._buildToolbarType(),this.$button=this._createButton(),this.container&&this._buildPosition())}isButton(){return!!this.$button}observe(){this._checkObserve()&&this.update({title:this.title,classname:this.classname,command:this.command,icon:this.icon})}trigger(t,e){if(t.preventDefault(),t.stopPropagation(),this.$button.hasClass("rx-in-dropdown"))return this.app.dropdown.close(),void this._hideTooltip();let s=e||this.$button.data("toolbar");s&&this.app.ui.setState({button:this,type:s}),this.app.api(this.command,this.params,this,this.name,t),this._hideTooltip()}getName(){return this.name}getCommand(){return this.command}getType(){return this.toolbar}getProp(t){return this[t]}getRect(){return this.$button.rect()}getTemplate(){return this.template}getElement(){return this.$button}getIconElement(){return this.$button.find(".rx-button-icon")}getTitleElement(){return this.$button.find(".rx-button-title")}getShortcutElement(){return this.$button.find(".rx-button-shortcut")}getIcon(){const t=this.getIconElement();return t.length?t.html():""}getTitle(){return this.title}getTitleText(){return this.getTitleElement().text()}setState({disabled:t,pressed:e,active:s}={}){void 0!==t&&(this.disabled=t,this.$button.toggleClass("disabled",t)),void 0!==e&&(this.pressed=e,this.$button.toggleClass("pressed",e),e&&this._clearDisabled()),void 0!==s&&(this.active=s,this.$button.toggleClass("active",s),s&&this._clearDisabled())}setCommand(t){this.update({command:t})}setTitle(t){this.update({title:t})}setIcon(t){this.update({icon:t})}setProp(t,e){this[t]=e}setColor(t){this._getSvg().attr("fill",t)}setBackground(t){const e=new T(this.app).getInvertedColor(t);this.$button.addClass("rx-button-icon-color"),this.getIconElement().css({"background-color":t}),this._getSvg().attr("fill",e)}resetColor(){this._getSvg().removeAttr("fill")}resetBackground(){this.$button.removeClass("rx-button-icon-color"),this.getIconElement().css("background-color",""),this._getSvg().removeAttr("fill")}update({name:t,command:e,icon:s,title:i,shortcut:r,disabled:a,active:n,classname:o,html:l,toolbar:h,position:p}={}){void 0!==t&&(this.name=t),void 0!==e&&(this.command=e),void 0!==s&&(s=this._getIconCode(s),this.icon=s,this.getIconElement().html(s)),void 0!==i&&(this.title=i,this.getTitleElement().html(i),this._updateTooltip()),void 0!==r&&this.getShortcutElement().html(r),void 0!==o&&(this.classname=o,this.$button.addClass(o)),void 0!==l&&(this.html=l,this.$button.html(this.icon?`<span class="rx-button-icon">${this.icon}</span>${l}`:l)),void 0!==h&&(this.toolbar=h),void 0!==p&&(this.position=p),void 0!==a&&this.setState({disabled:a}),void 0!==n&&this.setState({active:n})}_initializeProps(t){this.props=t,this.params=t.params,this.command=t.command||null,this.icon=t.icon||null,this.color=t.color||null,this.title=t.title||"",this.classname=t.classname||"",this.html=t.html||"",this.shortcut=t.shortcut||"",this.position=t.position||null,this.text=t.text||!1,this.danger=t.danger||!1,this.template=t.template||!1,this.observer=t.observer||!1,this.tooltip=!1!==t.tooltip,this.disabled=t.disabled||!1,this.pressed=!1,this.active=t.active||!1}_getIconCode(t){return this.config.is("buttons.icons")&&this.config.is("buttons.icons."+this.name)&&(t=this.config.get("buttons.icons."+this.name)),t}_getSvg(){return this.$button.find("svg path")}_buildPosition(){this.position?this._positionButton(this.position):this.container.append(this.$button)}_positionButton(t){const e=Object.hasOwn(t,"after")?"after":"before",s=Object.hasOwn(t,"first"),i=t[e];if("first"===t)this.container.prepend(this.$button);else if("last"===t)this.container.append(this.$button);else if("object"==typeof t){if(this._findPosition(this.name).length>0)return;const t=this._findPosition(i);t?t[e](this.$button):this.container[s?"prepend":"append"](this.$button)}}_findPosition(t){return(Array.isArray(t)?t:[t]).map((t=>this.container.find(`[data-name="${t}"]`))).find((t=>t.length))||!1}_checkPermissions(){const t=this.app.block.get();return!(t&&!t.isAllowedButton(this.name,this.props))}_checkObserve(){if(this.observer){let t=this._fetchUpdatedObject();if(!t)return!1;this._initializeProps(t)}return!0}_fetchUpdatedObject(){const t=this.app.api(this.observer,this.props,this.name,this.toolbar);return t||!1}_buildToolbarType(){return["toolbar","extrabar"].includes(this.toolbar)?"toolbar":"dropdown"!==this.toolbar&&this.toolbar}_createButton(){const t="rx-dropdown-item"===this.classname?this.dom("<span>"):this.dom('<a href="#" role="button" tabindex="-1">');t.addClass("rx-button"),t.addClass(this.classname),this.toolbar&&t.addClass("rx-button-"+this.toolbar);let e="";return this.icon&&(this.icon=this._getIconCode(this.icon),e+=`<span class="rx-button-icon">${this.icon}</span>`),this.title&&(this.title=this.loc.parse(this.title),e+=`<span class="rx-button-title">${this.title}</span>`,t.attr("aria-label",this.title)),this.shortcut&&(e+=`<span class="rx-button-shortcut">${this.shortcut}</span>`),this.html&&(e=this.html),t.html(e),t.toggleClass("disabled",this.disabled),t.toggleClass("active",this.active),t.toggleClass("rx-button-danger",this.danger),t.toggleClass("rx-button-text",this.text),t.data({name:this.name,toolbar:this.toolbarType}),t.dataset("instance",this),t.on("mouseenter",this._showTooltip.bind(this)),t.on("mouseleave",this._hideTooltip.bind(this)),t.on("dragstart",(t=>t.preventDefault())),t.on("click",(t=>{!this.disabled&&this.command?this.trigger(t):t.preventDefault()})),t}_showTooltip(){if(!this.title||!this.tooltip||this.disabled||this.$button.hasClass("pressed")||this.$button.closest(".rx-dropdown, .rx-control").length)return;const t=this.dom('<span class="rx-tooltip">');t.text(this.title),this.app.page.getBody().append(t);const{offset:e,dimensions:s}=this._getButtonDetails(this.$button),i=this._getTooltipDimensions(t),r=this._calculateTooltipPosition(this.$button,e,s,i);t.css({top:`${r.top}px`,left:`${r.left}px`,"z-index":this._calculateTooltipZIndex()}),this.tooltipElement=t}_getButtonDetails(t){return{offset:t.offset(),dimensions:{width:t.width(),height:t.height()}}}_getTooltipDimensions(t){return{width:t.outerWidth(),height:t.outerHeight()}}_calculateTooltipPosition(t,e,s,i){const r=this.app.editor.getRect();let a=e.top+s.height+2,n=e.left;return r.right<n+i.width&&(n=e.left+s.width-i.width),"context"===t.attr("data-toolbar")?a=e.top-i.height-2:this.app.dropdown.isPositionTop()&&(a=e.top+s.height+2),{top:a,left:n}}_hideTooltip(){this.tooltipElement&&(this.tooltipElement.remove(),this.tooltipElement=null)}_updateTooltip(){this.tooltipElement&&this.tooltipElement.text(this.title)}_calculateTooltipZIndex(){return this.app.isProp("fullscreen")?10002:1060}_clearDisabled(){this.$button.toggleClass("disabled",!1),this.disabled=!1}}l.Button=d;class g{constructor(t,e){this.app=t;const s=e.which,i=!e.ctrlKey&&!e.metaKey&&(s>=48&&s<=57||s>=65&&s<=90||[186,187,188,189,190,191,192,219,220,221,222].includes(s));this.rules={ctrl:e.ctrlKey||e.metaKey,shift:e.shiftKey,alt:e.altKey,select:(e.ctrlKey||e.metaKey)&&!e.altKey&&65===s,"select-block":(e.ctrlKey||e.metaKey)&&e.shiftKey&&!e.altKey&&65===s,enter:13===s,space:32===s,esc:27===s,tab:9===s&&!e.altKey&&!e.ctrlKey&&!e.metaKey,delete:46===s,backspace:8===s,alpha:i,arrow:-1!==[37,38,39,40].indexOf(s),left:37===s,right:39===s,up:38===s,down:40===s,"left+right":37===s||39===s,"up+left":38===s||37===s,"down+right":40===s||39===s}}is(...t){return t.some((t=>this.rules[t]))}}l.KeyAnalyzer=g;class u{constructor(t){this.app=t,this.config=t.config,this.dom=t.dom}parse(t=null){const e=this.dom(t)||this.app.getLayout(),s=this.config.get("classes");s&&["tags","blocks"].forEach((t=>{const i=s[t];if(i){const s=this._buildSelector(t,i);e.find(s).each((e=>this._applyClass(e,t)))}}))}_buildSelector(t,e){const s=Object.keys(e);return"tags"===t?s.join(","):s.map((t=>`[data-rx-type="${t}"]`)).join(",")}_applyClass(t,e){const s="tags"===e?t.tag():t.attr("data-rx-type"),i=this.config.get(`classes.${e}`);i[s]&&t.addClass(i[s])}}l.ClassApplier=u;class m{constructor(t){this.app=t}getContent(t){const e=this._determineContentType(t),s=t.getData(e),i=new V(this.app);return"text/plain"===e?i.escapeHtml(s):s}setContent(t,e,s=null){const i=t.clipboardData;e=this._cleanSvgWhitespace(e),e=this._prepareHtmlForClipboard(e),s=this._prepareTextForClipboard(e,s),i.setData("text/html",e),i.setData("text/plain",s)}isPlainText(t){const e=t.getData("text/plain"),s=t.getData("text/html");return!(s&&s.trim())&&null!==e}isPlainHtml(t){const e=t.getData("text/plain");return/<\/?[a-z][\s\S]*>/i.test(e)}_cleanSvgWhitespace(t){return t.replace(/(\s*)<svg([^>]*?)>([\s\S]*?)<\/svg>(\s*)/g,((t,e,s,i)=>" <svg"+s+">"+i.trim()+"</svg> "))}_determineContentType(t){return this.isPlainText(t)?"text/plain":"text/html"}_prepareHtmlForClipboard(t){return'<meta type="rx-editor"/>'+(t=new F(this.app).unparse(t,{clipboard:!0}))}_prepareTextForClipboard(t,e){const s=new T(this.app);return e||s.getTextFromHtml(t,{nl:!0})}}l.Clipboard=m;class f{constructor(t,e){this.app=t,this.dom=t.dom,this.uuid=t.uuid,this.loc=t.loc,this.config=t.config,this.$colorpicker=null,this.$dropdown=null,this.input=!1,e.$toggle?this.build(e):this.create(e)}build(t){return this.$colorpicker=this._createContainer("rx-colorpicker"),this._initialize(t,this.$colorpicker),this.app.page.getBody().append(this.$colorpicker),this._setPosition(),this._bindGlobalEvents(),this.$colorpicker}create(t){return this.$dropdown=this._createContainer("rx-dropdown-box"),this._initialize(t,this.$dropdown),this.app.page.getDoc().off(".rx-colorpicker"),this._bindMouseLeaveCheck(),this.$dropdown}getContainer(){return this.params.$toggle?this.$colorpicker:this.$dropdown}isOpen(){return!!this.$colorpicker}close(){this.app.page.getBody().find(`.rx-colorpicker-${this.uuid}`).remove(),this.app.scroll.getTarget().off(".rx-colorpicker"),this.app.page.getDoc().off(".rx-colorpicker"),this.$colorpicker=null}_createContainer(t){return this.dom(`<div class="${t} ${t}-${this.uuid}">`)}_bindGlobalEvents(){this.app.scroll.getTarget().on("resize.rx-colorpicker scroll.rx-colorpicker",this._setPosition.bind(this)),this.app.page.getDoc().on("click.rx-colorpicker",this.close.bind(this)),this._bindMouseLeaveCheck()}_bindMouseLeaveCheck(){this.app.page.getDoc().on("mousemove.rx-colorpicker",(t=>{const e=this.getContainer().find(".rx-swatches");if(!(e.length&&e.get().contains(t.target))){const e=this.dom(t.target).closest(".rx-dropdown-layer[data-color]");if(e.length){const t=e.data("type"),s=e.attr("data-color");this._resetColorByType(e,s,t)}}}))}_setPosition(){const t=this.params.$toggle.offset(),e=t.left+this.params.$toggle.width();this.$colorpicker.css({top:`${t.top}px`,left:`${e}px`}),this.$colorpicker.toggle(t.left),this.app.ui.buildDepth("colorpicker",this.$colorpicker)}_initialize(t,e){this.params={$toggle:null,colors:[],method:null,style:{},name:"color",tabs:!1,instant:!1,set:null,input:!1,remove:null,...t},this.currentColor=this.params.style.color||null,this.currentBackgroundColor=this.params.style.background||null,this.params.tabs?this._buildTabs(e):this._buildLayer(this.params.name,e)}_buildTabs(t){const e=this.dom('<div class="rx-colorpicker-tabs">');this.params.tabs.forEach(((s,i)=>{const r=this.dom('<a href="#">').attr("data-tab",s).addClass(`rx-colorpicker-tab rx-colorpicker-tab-${s}`).html(this.loc.get(`colorpicker.${s}`)).toggleClass("active",0===i).on("click.rx-colorpicker-tab",this._switchTab.bind(this));e.append(r),this._buildLayer(s,t,0!==i)})),t.prepend(e)}_buildLayer(t,e,s=!1){const i=this.dom(`<div class="rx-dropdown-layer rx-dropdown-layer-${t}" data-type="${t}">`);i.append(this._buildColorPicker(t)),this._addInputField(i,t),this._addRemoveButton(i,t),i.toggle(!s),e.append(i)}_switchTab(t){t.preventDefault(),t.stopPropagation();const e=this.dom(t.target),s=e.closest(".rx-dropdown-box"),i=e.attr("data-tab");s.find(".rx-dropdown-layer").each((t=>{const e=t.data("type"),s=t.attr("data-color");this._resetColorByType(t,s,e)})),this._updateActiveTab(s,i)}_updateActiveTab(t,e){t.find(".rx-dropdown-layer").hide(),t.find(".rx-colorpicker-tab").removeClass("active"),t.find(`.rx-dropdown-layer-${e}`).show(),t.find(`.rx-colorpicker-tab[data-tab="${e}"]`).addClass("active")}_getCurrentColor(t){return"color"===t?this.currentColor||"":this.currentBackgroundColor||""}_buildColorPicker(t){const e=this.dom(`<div class="rx-dropdown-color-box rx-dropdown-box-${t}">`),s=this.dom('<div class="rx-swatches">').toggleClass("rx-swatches-wrap",this.config.get("colorpicker.wrap")).css("max-width",this.config.get("colorpicker.width")||"");return Object.entries(this.params.colors).forEach((([e,i])=>{const r=this.dom('<div class="rx-swatches-colors">').toggleClass("rx-swatches-colors-row",this.config.get("colorpicker.row"));i.forEach(((s,i)=>{const a=this._createSwatch(s,t,`${e}-${i}`);r.append(a)})),s.append(r)})),e.append(s),e}_createSwatch(t,e,s){return this.dom('<a href="#" tabindex="-1" class="rx-swatch">').attr({rel:t,"data-rule":e,title:s}).addClass(this.config.get("colorpicker.size")?`rx-swatch-size-${this.config.get("colorpicker.size")}`:"").toggleClass("rx-color-contrast",["#fff","#ffffff"].includes(t)).toggleClass("active","color"===e&&t===this.currentColor||"background"===e&&t===this.currentBackgroundColor).css({background:t}).on("click",this._applyColor.bind(this)).on("mouseover",this._previewColor.bind(this))}_addInputField(t,e){if(!this.params.input)return;const s=this.dom(`<input type="text" class="rx-form-input rx-form-input-${e}">`).val(this._getCurrentColor(e)),i=this.dom('<button class="rx-form-button">&rarr;</button>').attr("data-rule",e).on("click",(()=>this._applyInputColor(s,e))),r=this.dom('<div class="rx-form-flex">').append(s,i),a=this.dom('<div class="rx-form-box">').append(this.dom('<label class="rx-form-label">').html(this.loc.get("colorpicker.set-color"))).append(r);t.append(a),this.input=!0}_addRemoveButton(t,e){if(!this.params.remove?.[e])return;const s={position:"last",title:this.loc.get(`colorpicker.remove-${e}`),command:this.params.remove[e]},i=new d(this.app,"remove",s,"dropdown");t.append(i.getElement())}_previewColor(t){const e=this.dom(t.target).closest("a"),s=e.data("rule"),i=e.attr("rel"),r=e.closest(".rx-dropdown-layer");if(this.params.instant&&this._applyInstantColor(s,i),!this.input)return;const a=r.find(`.rx-form-input-${s}`);r.attr("data-color")||r.attr("data-color",a.val()||"empty"),a.val(i)}_applyColor(t){t.preventDefault(),t.stopPropagation();const e=this.dom(t.target).closest("a"),s=e.attr("rel"),i=e.data("rule"),r={[i]:s};this._executeCallback(s,{tag:"span",style:r})}_applyInstantColor(t,e){const s={[t]:e};this._executeCallback(e,{tag:"span",style:s},!0)}_applyInputColor(t,e){let s=t.val().trim();if(!s)return;s=new T(this.app).normalizeColor(s),this.app.inline.restoreOffset();const i={[e]:s};this._executeCallback(s,{tag:"span",style:i})}_executeCallback(t,e,s=!1,i=!1){this.$dropdown&&this.$dropdown.off(".rx-colorpicker"),this.$colorpicker&&this.$colorpicker.off(".rx-colorpicker"),this.params.method?this.params.method(t,s,i):this.app.api(this.params.set,e,s,i)}_resetLayerColor(t){const e=this.dom(t.target).closest(".rx-dropdown-layer[data-color]");if(!e.length)return;const s=e.data("type"),i=e.attr("data-color");this._resetColorByType(e,i,s)}_resetColor(t){const e=this.dom(t.target).closest(".rx-dropdown-layer");if(!e.length)return;const s=e.data("type"),i=e.attr("data-color");this._resetColorByType(e,i,s)}_resetColorByType(t,e,s){if(!e)return;const i="empty"===e?"":e;this.params.instant&&this._applyInstantColor(s,i),t.removeAttr("data-color"),this.input&&t.find(`.rx-form-input-${s}`).val(i)}}l.ColorPicker=f;class b{constructor(t){this.app=t,this.dom=t.dom}create(t){return this.isFragment(t)?t:this._buildFragment(t)}isFragment(t){return!(!t||"object"!=typeof t||!t.frag)}insert(t){const e=new L(this.app).getRange();e&&(this._clearRangeIfCollapsed(e),this._insertIntoRange(t,e))}_buildFragment(t){const e=this._createContainer(t),s=document.createDocumentFragment();let i=e.firstChild,r=e.lastChild;for(;e.firstChild;)s.appendChild(e.firstChild);return{frag:s,first:i,last:r,nodes:Array.from(s.childNodes)}}_createContainer(t){const e=this.dom("<div>");return"string"==typeof t?e.html(t):e.append(this.dom(t).clone(!0)),e.get()}_clearRangeIfCollapsed(t){if(t.collapsed){const e=t.startContainer;3!==e.nodeType&&"BR"===e.tagName&&e.remove()}else t.deleteContents()}_insertIntoRange(t,e){e.insertNode(t.frag||t)}}l.Fragment=b;class _{constructor(t){this.app=t,this.dom=t.dom,this.page=t.page}get(t){const e=this._getNode(t),s=this._getSelection();if(!s||!s.rangeCount||!e.contains(s.anchorNode))return!1;const i=s.getRangeAt(0),r=this._cloneRangeForNode(i,e).toString().length,a=i.startContainer,n=new K(this.app);let o=!1;if(s.isCollapsed&&1===a.nodeType&&""===a.innerText.trim()){const t=n.getDataBlock(a),e=t.dataget("instance");if(""===t.html().trim()&&e&&e.isType(["heading","text","listitem","pre","address"])){const t=new T(this.app).createInvisibleChar();a.appendChild(t),o=!0}}const l=o?1:0;return{start:r+l,end:r+i.toString().length+l,empty:o}}set(t,e){const s=this._getNode(e),i=this._createRangeForOffset(t,s),r=this._getSelection();r&&(r.removeAllRanges(),r.addRange(i))}_getNode(t){return t?this.dom(t).get():this.app.getLayout().get()}_getSelection(){return this?.page?.getWinNode()?.getSelection()??!1}_createRangeForOffset(t,e){const s=this.page.getDocNode().createRange();s.setStart(e,0),s.collapse(!0);let i=0,r=!1;const a=e=>{if(3===e.nodeType){const a=i+e.length;if(!r&&t.start>=i&&t.start<=a&&(s.setStart(e,t.start-i),r=!0),r&&t.end>=i&&t.end<=a)return s.setEnd(e,t.end-i),!0;i=a}else for(let t=0;t<e.childNodes.length;t++)if(a(e.childNodes[t]))return!0;return!1};return a(e),s}_cloneRangeForNode(t,e){const s=t.cloneRange();return s.selectNodeContents(e),s.setEnd(t.startContainer,t.startOffset),s}}l.Offset=_;class C{constructor(t){this.app=t,this.dom=t.dom,this.page=t.page,this.config=t.config}create(t="start"){return this._buildMarker(t)}createHtml(t="start"){return this._buildMarker(t).outerHTML}insert(t=!1){this.remove();const e=new L(this.app);t&&e.set(window.getSelection());const s=e.getRange();if(!s)return;const i=e.isCollapsed(),r=this._buildMarker("start"),a=this._buildMarker("end"),n=s.cloneRange();this._insertMarkers(s,n,r,a,i),e.updateRange(s)}save(t=!1){this.insert(t)}restore(){const t=this.find("start"),e=this.find("end");if(!t)return;const s=new L(this.app);let i=this._restoreSelection(t,e);this._cleanUpMarkers(t,e),this.app.editor.setWinFocus(),s.setRange(i)}find(t=!1){const e=this.app.getLayout();if(!e)return!1;let s={start:this._getMarkerById(e,"start"),end:this._getMarkerById(e,"end")};return t?s[t]:s}findMarkerById(t,e="start"){let s=this.dom(t).find(`#rx-selection-marker-${e}`);return 0!==s.length&&s.get()}replaceToText(t){return new T(this.app).wrap(t,(t=>{t.find("#rx-selection-marker-start").replaceWith("---marker-start---"),t.find("#rx-selection-marker-end").replaceWith("---marker-end---")}))}replaceToMarker(t){const e=this._buildMarker("start").outerHTML,s=this._buildMarker("end").outerHTML;return t.replace("---marker-start---",e).replace("---marker-end---",s)}remove(){this._remove(this.find("start")),this._remove(this.find("end"))}_insertMarkers(t,e,s,i,r){r||(e.collapse(!1),e.insertNode(i)),e.setStart(t.startContainer,t.startOffset),e.collapse(!0),e.insertNode(s),t.setStartAfter(s),r||t.setEndBefore(i)}_restoreSelection(t,e){const s=this.page.getDocNode().createRange(),i=this._getNextNode(t),r=this._getPreviousNode(e);return this._setRangeBasedOnMarkers(s,t,e,i,r),s}_cleanUpMarkers(t,e){this._remove(t),this._remove(e)}_getMarkerById(t,e){let s=t.find(`#rx-selection-marker-${e}`);return 0!==s.length&&s.get()}_remove(t){if(t){const e=this._getParent(t);t.remove(),e?.normalize()}}_buildMarker(t="start"){return this.dom("<span>").attr("id",`rx-selection-marker-${t}`).addClass("rx-selection-marker").html(this.config.get("markerChar")).get()}_getParent(t){const e=this.dom(t).closest(["p","h1","h2","h3","h4","h5","h6","pre","div","address","li","ul","ol","dl","td","th","blockquote"].join(","));return 0!==e.length&&e.get()}_getNextNode(t){return(!t.nextSibling||3!==t.nextSibling.nodeType||""!==t.nextSibling.textContent.replace(/[\n\t]/g,""))&&t.nextSibling}_getPreviousNode(t){return!!t&&t.previousSibling}_setRangeBasedOnMarkers(t,e,s,i,r){s?i&&"rx-selection-marker-end"===i.id?(t.selectNodeContents(e),t.collapse(!1),t.setStart(i,0)):(t.setStartAfter(e),s&&t.setEndBefore(s)):i?(t.selectNodeContents(i),t.collapse(!0)):(t.selectNodeContents(e),t.collapse(!1))}}l.Marker=C;class v{constructor(t){this.app=t,this.dom=t.dom,this.config=t.config,this.page=t.page}set(t,e){const s=new L(this.app),i=this._resolveNode(t),r=this.page.getDocNode().createRange();e&&i&&this._isInPage(i)&&(this.app.editor.setWinFocus(),this._isInline(i)&&this._isNoneditable(i)&&(e=this._adjustTypeForNonEditable(e)),this[{start:"_setStart",end:"_setEnd",before:"_setBefore",after:"_setAfter"}[e]](r,i),s.setRange(r),this._setBlock(i))}is(t,e,s,i,r){const a=this._resolveNode(t),n=this.page.getWinNode().getSelection();if(!a||!n.isCollapsed)return!1;const o=this._getPosition(a,i,r),l=this._getSize(a,s,i);return this._comparePositionWithType(o,l,e)}get(t){let e="middle";return e=this.is(t,"start")?"start":e,e=this.is(t,"end")?"end":e,e}_resolveNode(t){return this.dom(t).get()}_adjustTypeForNonEditable(t){return"start"===t?"before":"end"===t?"after":t}_comparePositionWithType(t,e,s){return"end"===s?t===e:"start"===s&&0===t}_setStart(t,e){this._setRangeStartToNodeStart(t,e),this._isEmptyLink(e)?this._insertInvisibleNodeBetween(t):this._handleInlineNodeAtStart(t,e)}_setRangeStartToNodeStart(t,e){t.setStart(e,0),t.collapse(!0)}_handleInlineNodeAtStart(t,e){let s=this._getInlineInside(e);s?this._setRangeStartInline(t,s):this._isInline(e)&&this._insertInvisibleNode(t)}_setRangeStartInline(t,e){let s=new K(this.app).getInlines(e)[0];t.selectNodeContents(s),t.collapse(!0)}_setEnd(t,e){let s=e.lastChild;if(s&&this._isInline(s)){1===s.childNodes.length&&1===s.childNodes[0].nodeType&&["svg","br"].includes(s.childNodes[0].tagName.toLowerCase())?this._setAfter(t,s):(t.selectNodeContents(s),t.collapse(!1))}else{if(this._isLink(e))return void(this._isEmptyLink(e)?(t.setStart(e,0),t.collapse(!0),this._insertInvisibleNodeBetween(t)):this._insertInvisibleNode(t,e,"append"));t.selectNodeContents(e),t.collapse(!1)}}_setBefore(t,e){t.setStartBefore(e),t.collapse(!0),this._isInline(e)&&this._insertInvisibleNode(t,e)}_setAfter(t,e){t.setStartAfter(e),t.collapse(!0);let s=3!==e.nodeType&&e.tagName.toLowerCase();(this._isInline(e)||"br"===s||"svg"===s)&&this._insertInvisibleNode(t)}_setBlock(t){if(this._isInline(t)){const t=new L(this.app).getBlockControlled(),e=this.dom(t).dataget("instance");t&&!e.isInline()&&(this.app.block.set(e),this.app.observer.observe(),this.app.editor.setFocus())}}_insertInvisibleNodeBetween(t){const e=new T(this.app),s=e.createInvisibleChar(),i=document.createTextNode(""),r=e.createInvisibleChar();t.insertNode(s),t.insertNode(i),t.insertNode(r),t.selectNodeContents(i),t.collapse(!1)}_insertInvisibleNode(t,e,s=!1){let i=!1;const r=new T(this.app).createInvisibleChar();e?s?(e.appendChild(r),i=!0):e.parentNode.insertBefore(r,e):t.insertNode(r),t.selectNodeContents(r),t.collapse(i)}_getInlineInside(t){let e=t.firstChild;for(;e&&3===e.nodeType&&""===e.nodeValue.trim();)e=e.nextSibling;for(;e&&this._isInline(e);){let t=e.firstChild;for(;t&&3===t.nodeType&&""===t.nodeValue.trim();)t=t.nextSibling;if(!t||!this._isInline(t))return e;e=t}return this._isInline(e)?e:null}_getSize(t,e,s){const i=3===t.nodeType;let r;return e&&0!==e.length?r=this._removeSpecifiedBlocks(t,e):(r=i?t.textContent:t.innerHTML,r=i||!1===s?r:r.trim()),this._trimmed(r,i,s).length}_removeSpecifiedBlocks(t,e){const s=this.dom(t).clone(),i=e.join(",");return s.find(i).remove(),s.html().trim()}_getPosition(t,e,s){let i=this.page.getWinNode().getSelection();if(0===i.rangeCount)return!1;let r=i.getRangeAt(0),a=r.cloneRange(),n=document.createElement("div"),o=3===t.nodeType;a.selectNodeContents(t),a.setEnd(r.endContainer,r.endOffset),n.appendChild(a.cloneContents());let l=o||!1===e?n.innerHTML:n.innerHTML.trim(),h=this._adjustForBr(l,s);return l=this._trimmed(l,o,e),l.length+h}_adjustForBr(t,e){let s=/<\/?br\s?\/?>$/i.test(t);return e&&s?1:0}_trimmed(t,e,s){const i=new T(this.app);return!1===s?t.replace(/\n$/g,""):(""===(t=(t=(t=i.removeInvisibleChars(t)).replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,"")).replace(/\s+/g," "))||e||(t=t.replace(/\s$/,"")),t)}_isInline(t){return new K(this.app).is(t,"inline")}_isLink(t){return 1===t.nodeType&&"A"===t.tagName}_isEmptyLink(t){return this._isLink(t)&&""===t.innerHTML}_isInPage(t){return t&&t.nodeType&&this.page.getDocNode().body.contains(t)}_isNoneditable(t){return"false"===t.getAttribute("contenteditable")}}l.Caret=v;class y{constructor(t,e=!0){this.defaults={cleanBreakline:!0},this.setting=!1!==e&&("object"==typeof e?{...this.defaults,...e}:this.defaults),this.app=t,this.dom=t.dom,this.config=t.config,this.remStart="#####replace",this.remEnd="#####",this.tags=["pre","hr","ul","ol","p","h1","h2","h3","h4","h5","h6","table","address","blockquote","style","script","figure","iframe","form","dl","div","form","audio","figcaption","object","select","input","textarea","picture","button","article","footer","aside","section","option","map","area","math","fieldset","legend","hgroup","nav","details","menu","summary"],this.tags=[...this.tags,...l.customTags],this.xmlTags=[]}parse(t){return this.setting?(t=this._parse(t),this._parseTable(t)):t}parseLayers(t){return new T(this.app).wrap(t,(t=>{this._parseElementsByType(t,"wrapper"),this._parseElementsByType(t,"column")}))}_parse(t,e=!1){const s=new Z(this.app),i=this.config.get("breakline"),r=i||e?"sdivtag":this.config.get("markup"),a=e?"tbr":"br";let n=[];return t=this._handleSelfClosingXmlTags(t),t=this._storeXmlTags(t),t=this._storeTags(t,n),t=s.store(t,"svg"),t=s.storeComments(t),t=this._addLineBreaksAroundMarkers(t),t=this._cleanHtml(t,i),t=this._wrapInTags(t,r),t=this._middleClean(t,r,i),t=this._restoreTags(t,n),t=s.restore(t,"svg"),t=s.restoreComments(t),t=this._restoreXmlTags(t),t=this._finalClean(t,r,a,i)}_parseTable(t){return new T(this.app).wrap(t,(t=>{t.find("td, th").each((t=>this._parseCell(t)))}))}_parseCell(t){const e=this.dom(t),s=this._parse(e.html(),"table");e.html(s)}_parseElementsByType(t,e){t.find('[data-rx-type="'+e+'"]').each((t=>{const e=this._parse(t.html());t.html(e)}))}_storeTags(t,e){return new T(this.app).wrap(t,(t=>{t.find(this.tags.join(", ")).each(((t,s)=>{this._replaceTag(t,s,e)}))}))}_addLineBreaksAroundMarkers(t){return t.replace(/([^\n\s])\s*#####replace(\d+)#####xparagraphmarkerz/g,"$1\n#####replace$2#####xparagraphmarkerz").replace(/(xparagraphmarkerz)\s*([^\n\s])/g,"$1\n$2").replace(/([^\n\s])\n#####replace(\d+)#####xparagraphmarkerz/g,"$1\n#####replace$2#####xparagraphmarkerz").replace(/\n\s+/g,"\n")}_cleanHtml(t,e){return t=t.trim(),t=(t=this._trimLinks(t)).replace(/xparagraphmarkerz(?:\r\n|\r|\n)$/g,"").replace(/xparagraphmarkerz$/g,"").replace(/xparagraphmarkerz(?:\r\n|\r|\n)/g,"\n").replace(/xparagraphmarkerz/g,"\n"),t=e?t.replace(/<br\s?\/?>(?:\r\n|\r|\n)/gi,"xbreakmarkerz\n").replace(/<br\s?\/?>/gi,"xbreakmarkerz\n").replace(/xbreakmarkerz\n<\//gi,"xbreakmarkerz</"):t.replace(/<br\s?\/?><br\s?\/?>$/gi,"").replace(/[\n]+/g,"\n").replace(/<br\s?\/?><br\s?\/?>/g,"\n")}_wrapInTags(t,e){const s=t.split("\n");let i="";for(let t=0,r=s.length;t<r;t++)i+=`<${e}>${s[t].trim()}</${e}>\n`;return i.replace(/\n$/,"")}_middleClean(t,e,s){return t=(t=(t=(t=t.replace(/\n$/,"")).replace(new RegExp("<"+e+">\\s+#####","gi"),"#####")).replace(new RegExp("<"+e+">#####","gi"),"#####")).replace(new RegExp("#####</"+e+">","gi"),"#####"),t=s?t.replace(/xbreakmarkerz/gi,"<br>"):t}_finalClean(t,e,s,i){return i&&(t=(t=t.replace(new RegExp("<"+e+"></"+e+">","gi"),"<"+e+"><br></"+e+">")).replace(/<\/?br\s?\/?><\/div>/gi,"</div>")),t=t.replace(/<(p|h1|h2|h3|h4|h5|h6|li|td|th)(.*?)>[\s\n]*<\/\1>/gi,"<$1$2></$1>"),this._is("cleanBreakline")&&(t=t.replace(/<p(.*?)><\/?br\s?\/?><\/p>/gi,"<p$1></p>")),t=(t=(t=(t=(t=(t=t.replace(/<div(.*?)><\/?br\s?\/?><\/div>/gi,"<div$1></div>")).replace(/<\/?br\s?\/?><\/div>/gi,"</div>")).replace(/<\/?br\s?\/?><\/li>/gi,"</li>")).replace(new RegExp("<sdivtag>","gi"),'<div data-rx-tag="'+s+'">')).replace(new RegExp("sdivtag","gi"),"div")).replace(/<\/([^>]+)><div data-rx-tag/g,"</$1>\n<div data-rx-tag"),i&&(t=t.replace(/<\/?br\s?\/?><\/div>/gi,"</div>")),t}_restoreTags(t,e){for(let s=0;s<e.length;s++){const i=e[s].replace(/\$/gi,"&#36;");t=t.replace(this.remStart+s+this.remEnd,i)}return t}_handleSelfClosingXmlTags(t){const e=this.config.get("paragraphizer.selfClosingXmlTags");return e?(e.forEach((e=>{const s=new RegExp(`</${e}>`,"gi");t=t.replace(s,"")})),e.forEach((e=>{const s=new RegExp(`(<${e}[^>]*?>)`,"gi");t=t.replace(s,"$1</"+e+">")})),t):t}_storeXmlTags(t){return this.xmlTags=[],t.replace(/<([a-zA-Z0-9_-]+:[a-zA-Z0-9_-]+)([^>]*?)>(.*?)<\/\1>/gis,(t=>{const e=this.xmlTags.length;return this.xmlTags.push({tag:t}),`${this.remStart}xml${e}${this.remEnd}`}))}_restoreXmlTags(t){return this.xmlTags.forEach(((e,s)=>{let i=e.tag;t=t.replace(`${this.remStart}xml${s}${this.remEnd}`,i)})),t}_replaceTag(t,e,s){const i=t.get(),r=document.createTextNode(`${this.remStart}${e}${this.remEnd}xparagraphmarkerz`);s.push(i.outerHTML),i.parentNode.replaceChild(r,i)}_trimLinks(t){return new T(this.app).wrap(t,(t=>{t.find("a").each((t=>{t.html(t.html().trim())}))}))}_is(t){return this.setting[t]}}l.Paragraphizer=y;class k{constructor(t,e,s,i,r){s&&(this.app=t,this.dom=t.dom,this.control=e,this.$control=i,this.instance=r,this.$button=s.getElement(),this.$button.on("click.rx-reorder-button",this._pressStop.bind(this)),this.$button.on("mousedown.rx-reorder-button touchstart.rx-reorder-button",this._press.bind(this)))}_pressStop(t){t.stopPropagation(),t.preventDefault(),clearTimeout(this.dragTimeout),this.$button.removeClass("rx-in-dragging")}_press(t){t.stopPropagation(),t.preventDefault(),this.touchStartTime=(new Date).getTime(),this.isDragging=!1,this.dragTimeout=setTimeout((()=>{this.isDragging=!0,this._startDragging()}),200),this.$button.on("touchend.rx-reorder-button mouseup.rx-reorder-button",this._checkTap.bind(this))}_checkTap(t){const e=(new Date).getTime()-this.touchStartTime,s=new T(this.app);e<200&&!this.isDragging&&(clearTimeout(this.dragTimeout),this._pressStop(t),s.isMobileDevice()&&this.control.trigger()),this.$button.off("touchend.rx-reorder-button mouseup.rx-reorder-button",this._checkTap.bind(this))}_startDragging(){this.$button.addClass("rx-in-dragging"),this._bindWindowEvents()}_bindWindowEvents(){this.app.page.getWin().on("mouseup.rx-reorder-button touchend.rx-reorder-button",this._release.bind(this)),this.app.page.getWin().on("mousemove.rx-reorder-button touchmove.rx-reorder-button",this._move.bind(this))}_release(t){this.$button.hasClass("rx-handle")&&(this._resetDragState(),this._setCaretAfterRelease())}_resetDragState(){this.$button.removeClass("rx-handle rx-in-dragging"),this.app.page.getWin().off(".rx-reorder-button"),this.app.observer.trigger=!0,this.oldY=0,this.dragging=!1,this._trashDragItem(),this.app.control.updatePosition(),this.$control.show(),this.app.ui.closeTooltip(),this.app.emit("reorder.release")}_setCaretAfterRelease(){setTimeout((()=>{this.app.block.set(this.instance,"start",!0),this.app.event.trigger=!0}),1)}_move(t){if(t.preventDefault(),!this.$button.hasClass("rx-in-dragging"))return;this.$button.hasClass("rx-handle")||this._initializeDrag(t),this.app.dropdown.close();const e=this._calculateDeltaY(t.pageY),s=this._getDirection(e);this._moveItem(this.$dragItem,e),this.oldY=t.pageY,this._handleAutoScroll(t.pageY,s);const i=this._getContainer();this._placeItem(i)}_initializeDrag(t){const e=this.instance.getBlock().get();this.$button.addClass("rx-handle"),this.dragging=!0,this.$dragItem=this._makeDragItem(e,t.target),this.$control.hide(),this.app.event.trigger=!1}_getDirection(t){return t>0?"up":t<0&&"down"}_calculateDeltaY(t){return 0===this.oldY?0:this.oldY-t}_handleAutoScroll(t,e){const{topStop:s,bottomStop:i,topEdge:r,bottomEdge:a}=this._getScrollBoundaries();this._isScrollUp(t,s,r,e)?this._scroll(-10):this._isScrollDown(t,i,a,e)&&this._scroll(10)}_getContainer(){const t=this.instance.getClosest(["list","todo","cell","column","wrapper"]);return t?t.getBlock():this.app.editor.getLayout()}_getScrollBoundaries(){const t=this.app.editor.getRect(),e=this.app.page.getDoc().scrollTop();let s=e>t.top?e+40:t.top+40,i=this.app.page.getWin().height()+e-40,r=t.top,a=t.top+this.app.editor.getEditor().height();if(this.app.scroll.isTarget()){const n=this.app.scroll.getTarget(),o=n.offset();r=o.top,s=e>t.top?o.top+40:s,a=o.top+n.height(),i=a-40}return{topStop:s,bottomStop:i,topEdge:r,bottomEdge:a}}_isScrollUp(t,e,s,i){return"up"===i&&t<e&&t>s}_isScrollDown(t,e,s,i){return"down"===i&&t>e&&t<s}_placeItem(t){const e=t.children(),s=e.length;for(let t=0;t<s;t++){const s=e.eq(t).get(),i=this.dom(s);s!==this.$clickItem.get()&&(this._isOver(i)&&this._swapItems(s))}}_isOver(t){const e=this.$dragItem.offset().top,s=t.offset(),i=t.height();return e>s.top&&e<s.top+i}_scroll(t){const e=this.app.scroll.isTarget()?this.app.scroll.getTarget():this.app.page.getWin(),s=e.scrollTop();e.scrollTop(s+t)}_swapItems(t){const e=this.$dragItem.offset().top,s=this.$clickItem,i=this.dom(t),r=i.offset(),a=i.height()/2;i[a+r.top>e?"before":"after"](s)}_moveItem(t,e){const s=t.offset().top-e;t.css("top",`${s}px`),this.$control.css("top",`${s}px`)}_makeDragItem(t){this._trashDragItem();const e=this.dom(t),s=e.offset(),i=this.app.editor.getTheme();this.$clickItem=e,this.$clickItem.addClass("rx-drag-active");const r=e.clone();r.removeClass("rx-drag-active rx-element-active"),r.css({"font-family":e.css("font-family"),"font-size":e.css("font-size"),"line-height":e.css("line-height"),margin:0,padding:0});const a=this.dom("<div>").addClass("rx-dragging");return a.append(r),a.attr("rx-data-theme",i),a.css({opacity:.95,position:"absolute","z-index":999,left:s.left+"px",top:s.top+"px",width:e.width()+"px"}),this.app.page.getFrameBody().append(a),a}_trashDragItem(){this.$dragItem&&this.$clickItem&&(this.$clickItem.removeClass("rx-drag-active"),this.$clickItem=null,this.$dragItem.remove(),this.$dragItem=null)}}l.Reorder=k;class w{constructor(t){this.app=t,this.cleanlevel=0,this.encoder=new V(this.app)}parse(t,e){return this.format(t,e)}format(t,e){t=this.encoder.encodeAttrSings(t);const s=[];t=t.replace(/<pre\b[^>]*>[\s\S]*?<\/pre>/gi,(t=>{const e=`__PRE_BLOCK_${s.length}__`;return s.push(t),e}));const i=["li",..."email"===e?["style","meta"]:[]],r=["li"],a=["p","ul","ol","li","div","h1","h2","h3","h4","h5","h6","blockquote","figure","figcaption","table","thead","tbody","tfoot","tr","td","th","dl","dt","dd",..."email"===e?["title","head","body"]:[]];this.lineBefore=new RegExp(`^<(/?${i.join("|/?")}|${r.join("|")})[ >]`),this.lineAfter=new RegExp(`^<(/?${i.join("|/?")}|/${r.join("|/")})[ >]`),this.newLevel=new RegExp(`^</?(${a.join("|")})[ >]`);const n=t.length;let o=null,l=null,h="",p="",c=0,d=0,g="";for(;c<n;c++){if(d=c,-1===t.substr(c).indexOf("<"))return g+=t.substr(c),this.finish(g,s);for(;d<n&&"<"!==t.charAt(d);)d++;for(c!==d&&(p=t.substr(c,d-c),p.match(/^\s{2,}$/g)||("\n"===g.charAt(g.length-1)?g+=this.getTabs():"\n"===p.charAt(0)&&(g+="\n"+this.getTabs(),p=p.replace(/^\s+/,"")),g+=p)),o=d;d<n&&">"!==t.charAt(d);)d++;let e;if(h=t.substr(o,d-o),c=d,"!--"===h.substr(1,3)){if(!h.match(/--$/)){for(;"--\x3e"!==t.substr(d,3);)d++;d+=2,h=t.substr(o,d-o),c=d}"\n"!==g.charAt(g.length-1)&&(g+="\n"),g+=this.getTabs(),g+=h+">\n"}else"!"===h[1]?g=this.placeTag(h+">",g):"?"===h[1]?g+=h+">\n":e===h.match(/^<(script|style|pre)/i)?(e[1]=e[1].toLowerCase(),h=this.cleanTag(h),g=this.placeTag(h,g),l=String(t.substr(c+1)).toLowerCase().indexOf("</"+e[1]),l&&(p=t.substr(c+1,l),c+=l,g+=p)):(h=this.cleanTag(h),g=this.placeTag(h,g))}return g=this.finish(g,s),g.replace(/\n\s*<pre/gi,"\n<pre")}_restorePreBlocks(t,e){let s=t;return e.forEach(((t,e)=>{s=s.replace(`__PRE_BLOCK_${e}__`,t)})),s}getTabs(){let t="";for(let e=0;e<this.cleanlevel;e++)t+="    ";return t}finish(t,e){this.cleanlevel=0,t=t.replace(/\n\s*\n/g,"\n").replace(/^[\s\n]+|[\s\n]+$/g,"").replace(/<li(.*?)>\s*/gi,"<li$1>").replace(/<(p|h1|h2|h3|h4|h5|h6|li|td|th)(.*?)>\s*<\/\1>/gi,"<$1$2></$1>").replace(/\s*<\/li>/gi,"</li>").replace(/<script(.*?)>\n<\/script>/gi,"<script$1><\/script>").replace(/\n(.*?)<link(.*?)><style/gi,"\n$1<link$2>\n$1<style").replace(/><link/gi,">\n<link").replace(/><\/head/gi,">\n</head>");let s=this.encoder.decodeAttrSings(t);return s=this._restorePreBlocks(s,e),s}cleanTag(t){let e,s="",i="";const r=(t=(t=(t=t.replace(/\n/g," ")).replace(/\s{2,}/g," ")).replace(/^\s+|\s+$/g," ")).match(/(\s*\/)$/);for(r&&(i=r[1],t=t.replace(/\s*\/+$/,""));e=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/.exec(t);)e[2]?s+=e[1].toLowerCase()+"="+e[2]:e[1]&&(s+=e[1].toLowerCase()),s+=" ",t=t.substr(e[0].length);return s.replace(/\s*$/,"")+i+">"}placeTag(t,e){const s=this.newLevel.test(t);return(this.lineBefore.test(t)||s)&&(e=e.trimEnd()+"\n"),s&&"/"===t.charAt(1)&&this.cleanlevel--,e.endsWith("\n")&&(e+=this.getTabs()),s&&"/"!==t.charAt(1)&&this.cleanlevel++,e+=t,(this.lineAfter.test(t)||s)&&(e=e.trimEnd()+"\n"),e}}l.Tidy=w;class x{static defaults={type:"image",box:!1,url:!1,cover:!0,name:"file",data:!1,multiple:!0,placeholder:!1,progress:!0,hidden:!0,target:!1,success:!1,error:!1,remove:!1,trigger:!1,input:!1};constructor(t,{element:e=!1,params:s={},trigger:i=null}){this.app=t,this.dom=t.dom,this.ajax=t.ajax,this.config=t.config,this.progress=t.progress,this.eventname="rx-upload",this.p={...x.defaults,...s,trigger:i},e&&this._build(e)}send(t,e=t?.dataTransfer?.files){const s=this._buildFormData(e),i=new T(this.app);"base64"===this.config.get("image.upload")?this._convertFilesToBase64(e,(e=>{this.complete(e,t)})):this._sendData(t,e,i.extendData(s,this.p.data))}complete(t,e){t?.error?(this._setStatus("error"),this.p.error&&this.app.api(this.p.error,t,e)):(this._removeStatus(),this._trigger(t),this.p.success&&this.app.api(this.p.success,t,e)),setTimeout((()=>this.progress.hide()),500)}setImage(t){this.p.input||(this.$image?.remove(),this.$removeBtn?.remove(),""===t?this.$placeholder?.show():(this.$placeholder?.hide(),this._buildImage(t),this.p.remove&&this._buildRemove()))}_build(t){this.$element=this.dom(t),this.$element.tag("input")?this._buildByInput():this._buildByBox()}_buildByInput(){this.$input=this.$element,this.p.box?(this._buildBox(),this._buildPlaceholder()):this.p.input=!0,this._buildAccept(),this._buildMultiple(),this._buildEvents()}_buildByBox(){this._buildInput(),this._buildAccept(),this._buildMultiple(),this._buildBox(),this._buildPlaceholder(),this._buildEvents()}_buildBox(){this.$box=this.dom("<div>").addClass("rx-form-upload-box"),this.$element.before(this.$box),this.p.cover||this.$box.addClass("rx-form-upload-cover-off"),this.p.hidden&&this.$element.hide()}_buildPlaceholder(){this.p.placeholder&&(this.$placeholder=this.dom("<span>").addClass("rx-form-upload-placeholder").html(this.p.placeholder),this.$box.append(this.$placeholder))}_buildImage(t){this.$image=this.dom("<img>").attr("src",t),this.$box.append(this.$image),this.p.input||(this.$box.off(`click.${this.eventname}`),this.$image.on(`click.${this.eventname}`,this._click.bind(this)))}_buildRemove(){this.$removeBtn=this.dom("<span>").addClass("rx-upload-remove").on("click",this._removeImage.bind(this)),this.$box.append(this.$removeBtn)}_buildInput(){this.$input=this.dom("<input>").attr({type:"file",name:this.p.name}),this.$input.hide(),this.$element.before(this.$input)}_buildAccept(){if("image"===this.p.type){const t=this.config?.get("image.types")?.join(",")||"";this.$input.attr("accept",t)}}_buildMultiple(){this.p.multiple?this.$input.attr("multiple","multiple"):this.$input.removeAttr("multiple")}_buildEvents(){[["click",this._click.bind(this)],["drop",this._drop.bind(this)],["dragover",this._dragover.bind(this)],["dragleave",this._dragleave.bind(this)]].forEach((([t,e])=>{this.$box?.on(`${t}.${this.eventname}`,e)})),this.$input.on(`change.${this.eventname}`,this._change.bind(this))}_removeImage(t){t?.preventDefault(),t?.stopPropagation(),this.$image?.remove(),this.$removeBtn?.remove(),this.$placeholder?.show(),this.p.input||this.$box.on(`click.${this.eventname}`,this._click.bind(this)),t&&this.p.remove&&this.app.api(this.p.remove,t)}_buildFormData(t){const e=new FormData,s=this.p.name;return"single"===this.p.multiple?e.append(s,t[0]):this.p.multiple?Object.values(t).forEach((t=>e.append(`${s}[]`,t))):e.append(`${s}[]`,t[0]),e}_sendData(t,e,s){const{url:i}=this.p;"function"==typeof i?i(this,{data:s,files:e,e:t}):(this.progress.show(),this.ajax.post({url:i,data:s,before:i=>{if(this.app.broadcast("upload.before.send",{xhr:i,data:s,files:e,e:t}).isStopped())return this.progress.hide(),!1},success:e=>this.complete(e,t),error:e=>this.complete(e,t)}))}_setStatus(t){!this.p.input&&this.p.box&&(this._removeStatus(),this.$box.addClass(`rx-form-upload-${t}`))}_removeStatus(){!this.p.input&&this.p.box&&["hover","error"].forEach((t=>this.$box.removeClass(`rx-form-upload-${t}`)))}_click(t){t.preventDefault(),this.$input.click()}_change(t){this.send(t,this.$input.get().files)}_drop(t){t.preventDefault(),this.send(t)}_dragover(t){t.preventDefault(),this._setStatus("hover")}_dragleave(t){t.preventDefault(),this._removeStatus()}_trigger(t){if(this.p.trigger?.instance&&this.p.trigger?.method&&t?.url){const{instance:e,method:s}=this.p.trigger;e[s]?.(t.url)}}_convertFilesToBase64(t,e){const s=Array.from(t).map((t=>new Promise(((e,s)=>{if(!t.type.startsWith("image/"))return void e(null);const i=new FileReader;i.onload=()=>{this._convertToWebP(i.result,(s=>{e({name:t.name.replace(/\.\w+$/,".webp"),url:s,base64:!0})}))},i.onerror=s,i.readAsDataURL(t)}))));Promise.all(s).then((t=>{e(t.filter(Boolean))}))}_convertToWebP(t,e){const s=new Image;s.onload=()=>{const t=document.createElement("canvas");t.width=s.width,t.height=s.height;t.getContext("2d").drawImage(s,0,0),t.toBlob((t=>{const s=new FileReader;s.onloadend=()=>e(s.result),s.readAsDataURL(t)}),"image/webp",.8)},s.src=t}}l.Uploader=x;class T{constructor(t){this.app=t,this.dom=t.dom,this.config=t.config}isMobileDevice(){const t="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,e=navigator.userAgent.toLowerCase();return t||/mobile|android|iphone|ipad|tablet|blackberry|phone/i.test(e)}isFirefox(){return/firefox/i.test(navigator.userAgent)}createInvisibleChar(){return document.createTextNode(this.config.get("markerChar"))}searchInvisibleChars(t){return t.search(/^\uFEFF$/g)}removeInvisibleChars(t){return t.replace(/\uFEFF/g,"")}wrap(t,e){t=this._sanitizeImages(t);const s=this.dom("<div>").html(t);e(s);const i=s.html();return s.remove(),this._restoreImageSrcs(i)}_sanitizeImages(t){return t.replace(/<img\s+[^>]*?>/gi,(t=>{let e=t;return e=e.replace(/\s+src=(["'])(.*?)\1/i,' data-state-src="$2"'),e=e.replace(/\s+srcset=(["'])(.*?)\1/i,' data-state-srcset="$2"'),e}))}_restoreImageSrcs(t){return t.replace(/<img\b([^>]*?)data-state-src=["']([^"']+)["']([^>]*?)>/gi,'<img$1src="$2"$3>').replace(/<img\b([^>]*?)data-state-srcset=["']([^"']+)["']([^>]*?)>/gi,'<img$1srcset="$2"$3>')}isEmptyHtml(t,e){const s=new W(this.app);return t=(t=(t=(t=(t=(t=(t=(t=(t=s.removeInvisibleChars(t.trim())).replace(/^&nbsp;$/gi,"1")).replace(/&nbsp;/gi,"")).replace(/<\/?br\s?\/?>/g,"")).replace(/\s/g,"")).replace(/^<p>\s\S<\/p>$/i,"")).replace(/<hr(.*?[^>])>$/i,"hr")).replace(/<iframe(.*?[^>])>$/i,"iframe")).replace(/<source(.*?[^>])>$/i,"source"),t=s.removeComments(t),e&&(t=t.replace(/<p[^>]*><\/p>/gi,"").replace(/<div[^>]*><\/div>/gi,"")),""===(t=(t=(t=t.replace(/<[^/>]><\/[^>]+>/gi,"")).replace(/<[^/>]><\/[^>]+>/gi,"")).trim())}isLine(t,e){if(this.config.is("breakline"))return!1;const s=this.dom("<div>").html(t),i=this.config.get("tags.block"),r=0===s.find([...i,"img"].join(",")).length,a=/div><br\s?\/?><div/i.test(t),n=/<br\b[^>]*>\s*<br\b[^>]*>/i.test(t);return(!this.isPlainText(t)||!/\n\n/.test(t))&&(!n&&!a&&((!r||"paste"!==e||!/\n\n/.test(t))&&r))}isPlainText(t){const e=this.config.get("tags.block");return!new RegExp(`</?(${e.join("|")})\\b[^>]*>`,"i").test(t)}decodeEntities(t){const e=document.createElement("textarea");return e.innerHTML=t,e.value}extractHtmlFromCaret(t){const e=this.dom(t).get(),s=new L(this.app).getRange();if(s){const t=s.cloneRange();return t.selectNodeContents(e),t.setStart(s.endContainer,s.endOffset),t.extractContents()}return null}getTextFromHtml(t,e={}){const s=new Z(this.app),i=new V(this.app);e={br:!1,nl:!1,trimlines:!0,images:!1,links:!1,decode:!0,...e},t=s.store(t,"code"),e.links&&(t=s.store(t,"links")),e.images&&(t=s.store(t,"images")),t=this._cleanHtml(t);const r=this.dom("<div>").html(t);return t=this.getText(r.get()),e.trimlines&&(t=t.split("\n").map((t=>t.trim())).join("\n")),t=this._normalizeNewlines(t,e),t=s.restore(t,"code"),e.links&&(t=s.restore(t,"links")),e.images&&(t=s.restore(t,"images")),e.decode&&(t=i.decodeEntitiesInsidePreAndCode(t),t=i.decodeEntities(t)),(t=this._removeUnwantedTags(t,e)).trim()}getText(t){if(t.nodeType===Node.TEXT_NODE)return t.nodeValue;let e="";for(const s of t.childNodes)e+=this.getText(s);const s=t.nodeType===Node.ELEMENT_NODE?getComputedStyle(t).getPropertyValue("display"):"";return(/^block|list/.test(s)||["BR","HR"].includes(t.tagName))&&(e+="\n"),e}findTodoItemTag(){return this.dom("<div>").html(this.config.get("todo.templateContent")).children().first().tag()}isOnlySvgContent(t){t=this._getNode(t);const e=Array.from(t.childNodes);let s=!1;for(let t of e)if(3===t.nodeType){if(""!==t.nodeValue.trim())return!1;if(s)return!1}else if(1===t.nodeType)if("svg"===t.tagName.toLowerCase())s=!0;else{if("span"!==t.tagName.toLowerCase()||1!==t.children.length||"svg"!==t.firstElementChild.tagName.toLowerCase())return!1;s=!0}return s}hasSvgAt(t,e){t=this._getNode(t);const s="start"===e?Array.from(t.childNodes):Array.from(t.childNodes).reverse();for(let t of s)if(3===t.nodeType){if(""!==t.nodeValue.trim())return!1}else if(1===t.nodeType)return("svg"===t.tagName.toLowerCase()||"span"===t.tagName.toLowerCase()&&1===t.children.length&&"svg"===t.firstElementChild.tagName.toLowerCase())&&t;return!1}parseMarkdown(t){const e=/^(#{1,6})\s+(.*)$/,s=/!\[([^\]]*)\]\(([^)\s]+)(?:\s+"([^"]+)")?\)/g,i=/\[([^\]]+)\]\(([^)\s]+)(?:\s+"([^"]+)")?\)/g;return t.split("\n").map((t=>{const r=t.match(e);if(r){const t=r[1].length;return`<h${t}>${r[2]}</h${t}>`}return t=(t=(t=t.replace(/^(\-|\d\.)\s?(.*)$/g,((t,e,s)=>{const i="-"===e?"ul":"ol";return`<${i}><li>${s}</li></${i}>`}))).replace(s,((t,e,s,i)=>`<img src="${s}" alt="${e}"${i?` title="${i}"`:""}>`))).replace(i,((t,e,s,i)=>`<a href="${s}"${i?` title="${i}"`:""}>${e}</a>`))})).join("\n").replace(/<\/ul>\n<ul>|<\/ol>\n<ol>/g,"")}extendArrayWithoutDuplicates(t,e){return[...new Set([...t,...e])]}extendArray(t,e=[]){return[...t,...e]}removeFromArrayByValue(t,e){const s=Array.isArray(e)?e:[e];return t.filter((t=>!s.includes(t)))}cssToObject(t){return t?Object.fromEntries([...t.matchAll(/([\w-]+)\s*:\s*([^;]+)/g)].map((([t,e,s])=>[e.trim(),this._normalizeCssValue(e,s.trim())]))):{}}getInvertedColor(t){t=this._normalizeHexInput(t,"#ffffff"),t=this._removeHash(t);const[e,s,i]=this._hexToRgb(t);return.299*e+.587*s+.114*i>186?"black":"white"}normalizeColor(t){return t?(t=this.convertRgbToHex(t),t=this.convertShortHexToLong(t)):t}convertRgbToHex(t){if(!/^rgb/i.test(t))return t;const e=t.match(/^rgba?[\s+]?\((\d+),\s*(\d+),\s*(\d+)/i);return e?`#${[e[1],e[2],e[3]].map((t=>parseInt(t,10).toString(16).padStart(2,"0"))).join("")}`:""}convertShortHexToLong(t){return 3===(t=this._removeHash(t)).length?`#${[...t].map((t=>t+t)).join("")}`:`#${t}`}replaceRgbToHex(t){return t.replace(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/g,((t,e,s,i)=>`#${[e,s,i].map((t=>parseInt(t,10).toString(16).padStart(2,"0"))).join("")}`))}escapeRegExp(t){return t.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")}escapeBackslash(t){return t.replace(/\//g,"/")}extendData(t,e){for(let s in e)t="elements"===s?this._extendDataElements(t,e[s]):this._setData(t,s,e[s]);return t}getRandomId(t=12){const e="abcdefghijklmnopqrstuvwxyz0123456789";return Array.from({length:t},(()=>e.charAt(Math.floor(36*Math.random())))).join("")}_getNode(t){return this.dom(t).get()}_extendDataElements(t,e){return this.dom(e).each((e=>{if(e.tag("form"))Object.entries(e.serialize(!0)).forEach((([e,s])=>{t=this._setData(t,e,s)}));else{const s=e.attr("name")||e.attr("id");t=this._setData(t,s,e.val())}})),t}_setData(t,e,s){return t instanceof FormData?t.append(e,s):t[e]=s,t}_normalizeCssValue(t,e){if(e=(e="string"==typeof e?e.replace(/'/g,'"'):e).trim().replace(/;$/,""),/color|background/.test(t)&&(e=this.convertRgbToHex(e).toLowerCase()),/family/.test(t)&&(e=e.replace(/"/g,"")),"border"===t){const t=e.match(/rgb\((.*?)\)/gi);t&&(e=e.replace(t[0],this.convertRgbToHex(t[0])))}return e}_normalizeHexInput(t,e){return t||e}_removeHash(t){return t.startsWith("#")?t.slice(1):t}_hexToRgb(t){return[parseInt(t.slice(0,2),16),parseInt(t.slice(2,4),16),parseInt(t.slice(4,6),16)]}_cleanHtml(t){return t.replace(/\n\s+<span/gi," <span").replace(/span>\n\s+/gi,"span> ").replace(/<(ul|ol)>\s+<li>/gi,"<$1><li>").replace(/<li[^>]*>\n/gi,"<li$1>").replace(/<p[^>]*>(\s+|)<\/p>/gi,"xemptyz").replace(/<!--[\s\S]*?-->/gi,"").replace(/<style[\s\S]*?style>/gi,"").replace(/<script[\s\S]*?script>/gi,"").replace(/<\/(div|li|dt|dd|td|p|H[1-6])>\n?/gi,"</$1>\n").replace(/&(lt|gt);/gi,"x$1z")}_normalizeNewlines(t,e){return t=t.replace(/[\n]+/g,"\n").replace(/xemptyz/g,"\n").replace(/x(lt|gt)z/gi,"&$1;"),e.br?t=t.replace(/\n/g,"<br>\n").replace(/<br\s?\/?>\n?$/gi,""):e.nl||(t=t.replace(/\n/gi," ")),t}_removeUnwantedTags(t,e){return e.images||(t=t.replace(/<img[\s\S]*?>/gi,"").replace(/<a[^>]*>(\s+|)<\/a>/gi,"")),t.replace(/<pre[^>]*>/g,"").replace(/<code[^>]*>/g,"").replace(/<\/pre>\n?/g,"").replace(/<\/code>/g,"")}}l.Utils=T,l.add("mixin","block",{commonDefaults:{uid:{getter:"getUid",setter:"setUid"},time:{getter:"getTime",setter:"setTime",trigger:"updateTime"},id:{getter:"getId",setter:"setId"},style:{getter:"getStyle",setter:"setStyle"},classname:{getter:"getClassname",setter:"setClassname"},attrs:{getter:"getAttrs",setter:"setAttrs"},placeholder:{getter:"getPlaceholder",setter:"setPlaceholder"},noneditable:{getter:"getNoneditable",setter:"setNoneditable"}},init(t,e,s){t instanceof r||t instanceof Element?(this.element=t,this.params=e):this.params=t,this.renderDataBlock=s,this.params=this.params?this.params:{},this.start&&this.start(),this.render()},render(){if(this._createData(this.params),this.element?(this.$block=this.dom(this.element),this.parse&&this.parse()):(this.element=this.create(),this.$block=this.element,this.build&&this.build()),this.data.build(),!1===this.renderDataBlock)return;let t=this.$block.attr("data-rx-attrs");t&&(t=t.replace(/'/g,'"'),this.setAttrs(JSON.parse(t)),this.$block.removeAttr("data-rx-attrs")),this._renderInlineBlocks(),this.$block.dataset("instance",this),this.$block.attr("data-rx-type",this.getType()),this.isInline()&&this.$block.attr("data-rx-inline",!0),this.isEditable()?this.$block.attr("contenteditable",!0):!1===this.isEditable()&&this.$block.attr("contenteditable",!1),(this.isNondeletable()||this.isNondeletableParent())&&this.$block.attr("contenteditable",!1),this.isFocusable()&&this.$block.attr("data-rx-focusable",!0)},trigger(t){let e=this._buildTriggers();for(let[t,s]of Object.entries(e)){1===s.trigger.split(".").length?this[s.trigger].apply(this):this.app.api(s.trigger,this)}},isAllowedButton(t,e){let s=e.blocks,i=this.getType();if(void 0===e.blocks)return!0;if(s.except&&-1!==s.except.indexOf(i))return!1;if(s.all){if(!0===s.all||"all"===s.all)return!0;if("editable"===s.all&&this.isEditable())return!0;if("first-level"===s.all&&this.isFirstLevel())return!0;if("noneditable"===s.all&&this.isType("noneditable"))return!0}return!(!Array.isArray(s.types)||-1===s.types.indexOf(i))},isFocusable(){return void 0!==this.props.focusable},isInline(){return this.props.inline},isEditable(){return this.props.editable},isNondeletable(){return this.$block.attr("data-noneditable")},isNondeletableParent(){return 0!==this.$block.closest("[data-noneditable=true]").length},isType(t){return-1!==(Array.isArray(t)?t:[t]).indexOf(this.props.type)},isFigure(){return"figure"===this.getTag()},isFirstLevel(){return this.$block.attr("data-rx-first-level")},isEmpty(t,e){return this._isEmpty(this.$block,t,e)},isParent(){return this.props.parent},isLastElement:()=>!0,isAllSelected(){if(this.isEditable()){return new L(this.app).isFullySelected(this.$block)}return!0},isCaretStart(){const t=new v(this.app),e=new L(this.app);let s,i,r;return this.isType(["list","todo"])?!e.is()||(s=e.getCurrent(),i=this.dom(s).closest("li"),r=i.prevElement(),0===r.length&&t.is(this.$block,"start")):!this.isEditable()||t.is(this.$block,"start")},isCaretEnd(){const t=new v(this.app);return this.isType("address")?t.is(this.$block,"end",!1,!0,!1):!this.isEditable()&&!this.isType(["todo","list"])||t.is(this.$block,"end")},isReorder(){return!1!==this.props.reorder},isContext(){return this.props.context},hasTime(){return this.$block.attr("data-time")},hasUid(){return this.$block.attr("data-uid")},findPreviousElement(){const t=this.app.editor.getLayout().get();let e=this.$block.get(),s=e.previousElementSibling;for(;!s&&e.parentElement;)e=e.parentElement,s=e.previousElementSibling;return s&&t.contains(s)?this.dom(s)?.dataget("instance"):null},findNextElement(){const t=this.app.editor.getLayout().get();let e=this.$block.get(),s=e.nextElementSibling;for(;!s&&e.parentElement;)e=e.parentElement,s=e.nextElementSibling;return s&&t.contains(s)?this.dom(s)?.dataget("instance"):null},getTitle(){let t=this.getType(),e=this.lang.get("blocks"),s=this.$block.attr("data-title");return s=void 0!==e[t]?e[t]:s,s=s||t.charAt(0).toUpperCase()+t.slice(1),s},getProp(t){return void 0!==this.props[t]?this.props[t]:null},getType(){return this.props.type},getTag(){return this.$block.tag()},getBlock(){return this.$block},getJson(){return this.data.getData(!0)},getOuterHtml(){return this.$block.outer()},getHtml(){return this.$block.html()},getPlainText(){return this._getPlainText(this.$block)},getOffset(){return this.$block.offset()},getFirstLevel(){let t=this.$block.closest("[data-rx-first-level]").last();return 0!==t.length&&t.dataget("instance")},getClosest(t){let e=this.$block.parent().closest(this._buildTraverseSelector(t));return 0!==e.length&&e.dataget("instance")},getNextParent(){let t=this.isType("todoitem")?this.getClosest(["todo"]):this.getClosest(["table","wrapper","layout"]),e=!1;return t&&(e=t.getNext()),e},getPrevParent(){let t=this.isType("todoitem")?this.getClosest(["todo"]):this.getClosest(["table","wrapper","layout"]),e=!1;return t&&(e=t.getPrev()),e},getParent(){let t,e=this.props.parent;return t=void 0!==e?this.$block.parent().closest(this._buildTraverseSelector(e)):this.$block.parent().closest("[data-rx-type]"),!(!t||0===t.length)&&t.dataget("instance")},getFirst(t){t=t?"="+t:"";let e=this.$block.find("[data-rx-type"+t+"]").first();return 0!==e.length&&e.dataget("instance")},getLast(t){t=t?"="+t:"";let e=this.$block.find("[data-rx-type"+t+"]").last();return 0!==e.length&&e.dataget("instance")},getNext(t){let e=this.$block.nextElement();return!(0===e.length||!e.is(this._buildTraverseSelector(t)))&&e.dataget("instance")},getPrev(t){let e=this.$block.prevElement();return!(0===e.length||!e.is(this._buildTraverseSelector(t)))&&e.dataget("instance")},getControl(){return!this.isInline()&&this.props.control},getToolbar(){return this.props.toolbar},getExtrabar(){return this.props.extrabar},getButtons(t){return this.props[t]},getPlaceholder(){return this.$block.attr("data-placeholder")},getId(){return this.$block.attr("id")},getStyle(){const t=new T(this.app),e=this.$block.attr("style"),s=t.cssToObject(e);return this.isType("column")&&delete s["flex-basis"],0!==Object.keys(s).length?s:null},getAttrs(){const t={};if(this.params.attrs)for(let e of Object.keys(this.params.attrs))t[e]=this.$block.data(e);else{const e=this.$block.get();for(const s of e.attributes)if(s.name.startsWith("data-")&&!s.name.startsWith("data-rx-")){t[s.name.slice(5)]=s.value}}return 0!==Object.keys(t).length?t:null},getAttr(t){return this.params.attrs&&this.params.attrs[t]?this.params.attrs[t]:null},getClassname(t){if(t){for(let[e,s]of Object.entries(t))if(this.$block.hasClass(s))return e;return"none"}{const t=new Set(["rx-block-placeholder","rx-block-focus","rx-layout-grid","rx-block-control-focus","data-rx-parsed","data-rx-first-level","data-rx-inline","data-rx-focusable"]),e=this.$block.get().classList?[...this.$block.get().classList].filter((e=>!t.has(e))).join(" "):this.$block.attr("class");return e&&e.trim()?e:null}},getContent(){let t=this.$block.clone();return t=this.unparseInlineBlocks(t),t=this.unparseInlineStyle(t),t.html().trim()},getChildren(){let t,e=this.$block.children(),s=[];return e.each((function(e){t=e.dataget("instance"),t&&s.push(t.getJson())})),s},getUid(){return this.$block.attr("data-uid")},getTime(){let t=this.$block.attr("data-time");return!0===t||!1===t?null:t},getData(t){return this.data.getData(t)},getNoneditable(){return this.$block.data("noneditable")},get(t){return this.data.get(t)},set(t,e){this.data.set(t,e)},setData(t){this.data.setData(t)},setEmpty(t){if(this.isType("todoitem"))this.$content.html("");else{if(t){let t=this.$block.find(this.opts.get("tags.inline").join(",")).first();if(0!==t.length)return void t.html("")}this.$block.html("")}},setContent(t){this.$block.html(t)},setId(t){this._setAttr(this.$block,"id",t)},setStyle(t){const e=new R(this.app);this.$block.css(t),""===this.$block.attr("style")&&this.$block.removeAttr("style"),e.cacheElementStyle(this.$block)},setClassname(t,e){e&&this._removeObjClasses(e),"none"!==t&&this.$block.addClass(t)},setAttr(t,e){this.params.attrs=this.params.attrs||{},this.params.attrs[t]=e,this.$block.attr(t,e,!0)},setAttrs(t){if(t)for(let[e,s]of Object.entries(t))this.setAttr(e,s)},setUid(t){this._setAttr(this.$block,"data-uid",t)},setTime(t){this._setAttr(this.$block,"data-time",t)},setPlaceholder(t){this._setAttr(this.$block,"data-placeholder",t)},setCaret(t){new v(this.app).set(this.$block,t)},setNoneditable(t){this._setAttr(this.$block,"data-noneditable",t)},updateTime(){this.hasTime()&&this.setTime((new Date).getTime())},generateUid:()=>Date.now().toString(36)+Math.floor(Math.pow(10,12)+9*Math.random()*Math.pow(10,12)).toString(36),duplicate(t){let e=this.getType(),s=this.$block.clone();s.removeClass("rx-block-focus"),s.removeAttr("data-rx-type"),this._renderInsideClone(s),t&&s.html("");let i=this.app.create("block."+e,s);return this._renderInlineBlocks(i.getBlock(),!0),i},duplicateEmpty(){return this.duplicate(!0)},removeAttr(t){this.params.attrs&&this.params.attrs[t]&&delete this.params.attrs[t],this.$block.removeAttr(t)},removeData(t){this.data.remove(t)},removeCaption(){this.figcaption&&(this.$figcaption.remove(),this.figcaption=!1,this.$figcaption=!1)},remove(t){let e=this.getType(),s=!!this.isInline()&&this.getParent();(t=l.extend({},{traverse:!1,broadcast:!1},t)).traverse?this._removeTraverse():(this.app.broadcast("block.before.remove",{type:e,instance:this}),this.$block.remove(),s&&this.app.block.set(s)),t.broadcast&&this.app.broadcast("block.remove",{type:e})},removeClasses(t){this._removeObjClasses(t)},insert(t){this._compositionCutting();const e=new E(this.app);let s={instance:!1,position:"after",caret:!1,remove:!0,type:"add",current:this};t=l.extend({},s,t);let i=e.insert(t);return"add"===t.type&&this.app.broadcast("block.add",{inserted:i}),this._isIOS()&&i.getBlock().focus(),i},insertEmpty(t){return(t=t||{}).instance=this.app.block.create(),this.insert(t)},_compositionCutting(){if(!this._isIOS())return;const t=document.activeElement;document.querySelector("#rxCompositionCutter"+this.uuid).focus({preventScroll:!0}),t.focus({preventScroll:!0})},_isIOS(){const t=navigator.userAgent||navigator.vendor||window.opera;return/iPad|iPhone|iPod/.test(t)&&!window.MSStream},change(t,e){let s=t.getBlock();this.$block.after(s),this.$block.remove(),this.app.editor.build(),this.app.block.set(s),!1!==e&&this.app.broadcast("block.change",{instance:t})},move(t){let e,s="up"===t?this.getPrev():this.getNext(),i="up"===t?"before":"after";s&&(this.isEditable()&&this.app.editor.save(this.getBlock()),e=s.getBlock(),e[i](this.getBlock()),this.app.block.set(this,!1,!0),this.isEditable()&&this.app.editor.restore(!1))},appendNext(){let t=this.getNext();if(!t)return;let e,s,i=t.getHtml(),r=this.getType(),a=t.getType(),n=!0,o=!0,l=!0;if(!t.isNondeletable())if(t.isEmpty())t.remove();else{if(this.isEmpty())return this.remove(),void this.app.block.set(t,"start");if("pre"===r&&"pre"!==a&&(i=t.getPlainText()),"list"===a)if("list"===r){var h=t.getBlock().children();this.$block.append(h),n=!1,o=!0}else i=this._appendListHtml(t.getBlock(),i),o=t.isEmpty();if(n){if("dlist"===a&&"dlist"===r)return s=t.getBlock().children(),this.$block.append(s),void t.remove();"dlist"===a?i=this._appendDlistHtml(i):"todo"===a?(e=t.getFirstItem(),i=t.getFirstContent().html(),e.remove(),o=t.isEmpty()):"pre"===a?(i=t.getContent(),l=!1):"quote"===a&&(i=t.getPlainText()),this._insertHtml(i,l)}o&&t.remove()}},appendToPrev(){const t=new v(this.app);let e,s=this.getPrev(),i=s.getType(),r=this.getHtml(),a=this.getType(),n=!0,o=!0,l=!0;if(!s.isNondeletable()){if(this.isEmpty())return this.remove(),void this.app.block.set(s,"end");if(s.isEmpty())s.remove();else{if("pre"!==a&&"pre"===i&&(r=this.getPlainText()),"list"===a)if("list"===i){var h=this.getBlock().children();this.app.block.set(s,"end"),s.getBlock().append(h),n=!1,o=!0}else r=this._appendListHtml(this.getBlock(),r),o=this.isEmpty();if("dlist"===a&&(r=this._appendDlistHtml(r)),n){if(l="todo"!==i&&l,l="pre"!==i&&l,"dlist"===a&&"dlist"===i)return e=this.$block.children(),s.getBlock().append(e),t.set(e.first(),"start"),void this.remove();"quote"===a&&(r=this.$block.text()),this.app.block.set(s,"end"),this._insertHtml(r,l)}o&&this.remove()}}},parseItems(t,e){this.$block.find(t).each(function(t){t.attr("data-rx-type")||this.app.create("block."+e,t)}.bind(this))},parseCaption(){let t=this.$block.find("figcaption");0!==t.length&&(this.figcaption=this.app.create("block.figcaption",t),this.$figcaption=this.figcaption.getBlock())},unparseInlineBlocks:t=>(t.find("[data-rx-inline]").removeAttr("data-rx-type data-rx-inline contenteditable tabindex").removeClass("rx-block-focus"),""===t.attr("class")&&t.removeAttr("class"),t),unparseInlineStyle:t=>(t.find("[data-rx-style-cache]").removeAttr("data-rx-style-cache"),t),_buildCaption(t){if(this.isFigure()&&t){let e=this.$block.find("figcaption");0!==e.length?(this.figcaption=this.app.create("block.figcaption",e,{content:t}),this.$figcaption=this.figcaption.getBlock()):(this.figcaption=this.app.create("block.figcaption",{content:t}),this.$figcaption=this.figcaption.getBlock(),this.$block.append(this.$figcaption))}},_buildTraverseSelector(t){let e;return e=Array.isArray(t)?"[data-rx-type="+t.join("],[data-rx-type=")+"]":"[data-rx-type"+(t=t?"="+t:"")+"]",e},_buildTriggers(){let t=l.extend(!0,{},l.triggers),e=this.data.dump();for(let[s,i]of Object.entries(e))i.trigger&&(t[s]={trigger:i.trigger});return t},_setAttr(t,e,s){""===s?t.removeAttr(e):t.attr(e,s)},_createData(t){this.data=new $(this,this.defaults,this.commonDefaults,t)},_createInstance(t,e){return this.app.create("block."+t,e)},_renderInlineBlocks(t,e){this.isType("noneditable")||(t=t||this.$block).find("["+this.opts.get("dataBlock")+"]").each(function(t){if(!e&&t.attr("data-rx-type"))return;let s=t.attr(this.opts.get("dataBlock"));this.app.create("block."+s,t)}.bind(this))},_renderInsideClone(t){t.find("[data-rx-type]").each((t=>{let e=t.attr("data-rx-type");this.app.create("block."+e,t)}))},_isEmpty(t,e,s){let i=this.dom(t),r=i.text();const a=new T(this.app);let n=i.find("br").length,o=i.find("svg").length;if(r=a.removeInvisibleChars(r),r=r.replace(/\r?\n/g,""),e&&(r=r.trim()),s&&""===r){if(0!==i.find(this.opts.get("tags.inline").join(",")).first().length)return!1}return""===r&&0===o&&n<2},_insertHtml(t,e){const s=new v(this.app),i=new L(this.app),r=new E(this.app),a=i.getInlineTop();!1!==e&&a&&s.set(a,"after"),r.insertHtml(t,"start")},_appendListHtml(t,e){const s=new W(this.app),i=t.find("li").first();return e=(e=(e=i.html().trim()).replace(/<\/li>/gi,"</li><br>")).replace(/<(ul|ol)/gi,"<br><$1"),e=(e=(e=s.removeTags(e,["ul","ol","li"])).trim()).replace(/<br\s?\/?>$/gi,""),i.remove(),e},_appendDlistHtml(t){return new T(this.app).wrap(t,function(t){t.find("dt, dd").unwrap()}.bind(this))},_getPlainText(t){const e=new C(this.app),s=new T(this.app);let i=t.html();return i=e.replaceToText(i),i=s.getTextFromHtml(i,{nl:!0}),i=e.replaceToMarker(i),i},_buildObjClasses(t){let e=[];for(let s of Object.values(t))e.push(s);return e},_removeObjClasses(t){let e=this._buildObjClasses(t);this.$block.removeClass(e.join(" ")),this.$block.removeEmptyAttr("class")},_removeTraverse(){let t=this.getNext(),e=this.getPrev(),s=this.getClosest(["wrapper","todo","list"]),i=this.getClosest(["column","cell"]);if(this.$block.remove(),s&&s.isEmpty(!0)&&(t=s.getNext(),e=s.getPrev(),s.remove()),i&&i.isEmpty(!0)){let t=this.app.block.create();return i.insert({instance:t,position:"append"}),void this.app.block.set(t,"start")}t?this.app.block.set(t,"start"):e?this.app.block.set(e,"end"):this.app.block.unset()}});class ${constructor(t,e,s,i){this.block=t,this.data=l.extend(!0,e,s),this._initializeData(i)}build(){Object.entries(this.data).forEach((([t,e])=>{e.value&&e.setter&&"function"==typeof this.block[e.setter]&&this.block[e.setter](e.value)}))}dump(){return this.data}is(t){return!!this.get(t)}get(t){return this.data[t]?.value}set(t,e){this.data[t]||(this.data[t]={}),this.data[t].value=e}add(t,e){Array.isArray(this.data[t])||(this.data[t]=[]),this.data[t].push(e)}remove(t){delete this.data[t]}setData(t){Object.entries(t).forEach((([t,e])=>{this.data[t]&&this.data[t].setter&&this.block[this.data[t].setter](e)}))}getData(t){let e={type:this.block.getType()};return Object.entries(this.data).forEach((([s,i])=>{if((!0===t||"items"!==s&&"children"!==s)&&(t&&"getHtml"===i.getter&&"text"===s&&(i.getter="getContent"),i.getter&&"function"==typeof this.block[i.getter])){let t=this.block[i.getter].apply(this.block);null!==t&&(e[s]=t)}})),e}getValues(){return Object.entries(this.data).filter((([,t])=>void 0!==t.value)).reduce(((t,[e,s])=>(t[e]=s.value,t)),{})}_initializeData(t){t&&Object.entries(t).forEach((([t,e])=>{this.set(t,e)}))}}l.BlockData=$;class E{constructor(t){this.app=t,this.dom=t.dom,this.config=t.config}set(t){return this.insert(t,"set")}setEmpty(){this.app.editor.getLayout().html("")}insert(t,e){let s;if(this.params={target:!1,position:!1,html:"",clean:!1,parse:!0,current:!1,instance:!1,caret:!1,remove:!0,type:!1,paragraphize:!0,...t},this.params.html&&(this.params.html=this.app.broadcastHtml("editor.before.insert",this.params.html)),this.app.container.setFocus(),"set"===e||this.app.editor.isSelectAll()){s=new S(this.app,this.params).setContent()}else if(this.params.instance){s=new I(this.app,this,this.params).insert()}else{const t=new B(this.app,this,this.params);s="<br>"===this.params.html.trim()?this.insertBreakline():t.insert()}return s&&this.app.broadcast("editor.insert",{inserted:s}),setTimeout((()=>this.app.observer.observe()),0),s}insertNode(t,e,s){if(s){const e=new L(this.app).getNodes({type:"inline"});if(0!==e.length)return this._splitInline(e,t)}return this._insertFragment({node:this.dom(t).get()},e)}insertHtml(t,e){return this._insertFragment({html:t},e)}insertText(t,e,s=!1){const i=new L(this.app),r=new v(this.app),a=new T(this.app),n=this.app.block.get();if(!n||!n.isEditable())return this.insert({html:t,caret:e});if(i.is()){const n=s?t:a.getTextFromHtml(t,{nl:!0}),o=i.getRange(),l=this._findSelectionMarker(o);if(l){const t=document.createTextNode(n);return l.replaceWith(t),r.set(t,e||"end"),this.app.context.close(),t}const h=document.createTextNode(n);return o.deleteContents(),o.insertNode(h),r.set(h,e||"end"),this.app.context.close(),h}}insertNewline(t="after",e=!1){const s=e?"\n\n":"\n",i=document.createTextNode(s);return this._insertFragment({node:i},t)}insertBreakline(t="after",e=!0){const s=new L(this.app),i=s.getNodes({type:"inline"});return e&&s.isCollapsed()&&i.length?this._splitInline(i,document.createElement("br")):this._insertFragment({node:document.createElement("br")},t)}insertPoint(t){const e=new T(this.app),s=new v(this.app),i=new L(this.app),r=e.createInvisibleChar(),{clientX:a,clientY:n}=t,o=this.app.page.getDocNode();let l;if(o.caretPositionFromPoint){const t=o.caretPositionFromPoint(a,n);l=i.getRange()||o.createRange(),l.setStart(t.offsetNode,t.offset),l.collapse(!0),l.insertNode(r)}else o.caretRangeFromPoint&&(l=o.caretRangeFromPoint(a,n),l.insertNode(r));s.set(r,"after")}detectPosition(t,e){if(e)return e;const s=new v(this.app);return""===t.text().trim()||s.is(t,"end")?"after":s.is(t,"start")?"before":"split"}_findSelectionMarker(t){const e=t.startContainer,s=e.nodeType===Node.ELEMENT_NODE?e:e.parentElement;return s&&"SPAN"===s.tagName&&s.classList.contains("rx-selection-marker")&&/^rx-selection-marker-/.test(s.id)?s:null}_splitInline(t,e){const s=new G(this.app),i=new v(this.app),r=s.split(t[0]);return r.before(e),""===r.html()?(i.set(r,"after"),r.remove()):i.set(r,"start"),this.dom(e)}_insertFragment({html:t,fragment:e,node:s},i){const r=new b(this.app),a=new v(this.app),n=t||e?r.create(t||e):null;if(n?r.insert(n):s&&r.insert(s),i){const t=s||("start"===i?n?.first:n?.last);t&&a.set(t,i)}const o=s||n?.nodes;return Array.isArray(o)&&o.forEach((t=>{const e=this.dom(t);if(!e.dataget("instance")){const t=e.attr("data-rx-type");t&&this.app.create(`block.${t}`,e)}})),this.app.context.close(),this.dom(o)}_cleanUpPart(t){t.find(".rx-block-focus").removeClass("rx-block-focus rx-block-control-focus"),t.removeClass("rx-block-focus rx-block-control-focus")}}l.Insertion=E;class S{constructor(t,e){this.app=t,this.dom=t.dom,this.config=t.config,this.utils=new T(t),this.params=e}setContent(){let{html:t,caret:e}=this.params;t=new q(this.app).sanitize(t);const s=this.utils.isEmptyHtml(t),i=this.utils.isLine(t);this.params.html=i?this.app.block.createHtml(t):t;const r=this._cleanHtml(this.params.html),a=this._parseHtml(r),n=this.dom(a),o=this.dom(a).first(),l=this.dom(a).last();if(this._setEditorContent(a),e){const t="start"===e?o:l;setTimeout((()=>{this.app.block.set(t,e)}),0)}return s&&this.app.broadcast("editor.empty"),this.app.editor.build(),this.app.broadcast("editor.set",{inserted:n}),n}_cleanHtml(t){const e=new O(this.app);new V(this.app);return this.params.clean?e.clean(t):t}_parseHtml(t){const e=new N(this.app);return this.params.parse?e.parse(t,{type:this._getParseType(),nodes:!0,paragraphize:this.params.paragraphize}):e.build(t).get().childNodes}_getParseType(){return this.utils.isLine(this.params.html)?"line":"html"}_setEditorContent(t){const e=this.app.editor.getLayout();this.app.editor.unsetSelectAll(),e.html(""),e.append(t)}}class B{constructor(t,e,s){this.app=t,this.dom=t.dom,this.config=t.config,this.p=s,this.utils=new T(this.app),this.insertion=e}insert(){const t=this.p.current||this.app.block.get();if(t&&t.isNondeletable())this.app.block.set(t);else{if("string"!=typeof this.p.html&&(this.p.html=this.dom(this.p.html).outer()),this.p.html=this._isOnlyListItems(this.p.html)?`<ul>${this.p.html}</ul>`:this.p.html,this.isEmpty=this.utils.isEmptyHtml(this.p.html),this.isLine=this.utils.isLine(this.p.html,this.p.type),this.isLine&&this.config.is("paste.paragraphizeLines")){this.isLine=!1;const t=new y(this.app);this.p.html=t.parse(this.p.html)}if(!this.isEmpty){if(this.p.target)return this._createEmptyBlock(),this._insertToTarget();if(this.app.blocks.is())return this._createEmptyBlock(),this.app.context.close(),this._insertToBlocks();if(!t)return this._createEmptyBlock(),this._insertToEditor();if(!this._isTableToTable(t,this.p.html)){if(this._isListToList(t,this.p.html))return this._insertToList(t);if(t&&(t.isEditable()||t.isType("quote")||t.isInline())){if(this.isEmpty)return;return this._insertToOneEditable(t)}return t&&!t.isEditable()?(this._createEmptyBlock(),this._insertToOneNotEditable(t)):null}}}}_insertToTarget(){const t=this.p.position||"after",e=this.dom(this.p.target);this.p.html=this._clean(this.p.html);const s=this._parse(this.p.html),i=this.dom(s),r=this._getLastNode(s);return e[t](s),this.p.remove?e.fadeOut(500,(()=>{e.remove(),this.app.block.set(r,"end",!1,!0)})):this.app.block.set(r,"end",!1,!0),this.app.editor.build(),i}_insertToBlocks(){const t=new L(this.app);this.p.html=this._clean(this.p.html);const e=this._parse(this.p.html),s=this.dom(e),i=this._getLastNode(e);if(this.isLine)this.insertion._insertFragment({fragment:e});else{t.truncate(),this.app.context.close();const s=this.app.blocks.get({last:!0,selected:!0,instances:!0}),i=s.getBlock();s.isType("listitem")&&this._isListToList(s,this.p.html)?i.before(this.dom(e).children()):i.before(e)}return this.app.editor.build(),this.app.block.set(i,"end"),s}_insertToEditor(){let t="top"===this.config.get("addPosition")?"before":"after",e="top"===this.config.get("addPosition")?this.app.blocks.get({first:!0,instances:!0}):this.app.blocks.get({last:!0,instances:!0});this.p.html=this._clean(this.p.html);const s=this._parse(this.p.html),i=this.dom(s),r=this._getLastNode(s);return"top"===this.config.get("addPosition")?(e=this.app.blocks.get({first:!0,instances:!0}),t="before"):(e=this.app.blocks.get({last:!0,instances:!0}),t="after"),e.getBlock()[t](s),this.app.scroll.scrollTo(r),this.app.editor.build(),this.app.block.set(r,"end"),i}_insertToList(t){const e=new L(this.app),s=t.getBlock();this.p.html=this._clean(this.p.html);const i=this._parse(this.p.html),r=this.dom(i),a=this._getLastNode(i);if(t.isType("list"))s.append(r.children());else{const t=this.insertion.detectPosition(s);e.truncate(),this.app.context.close(),"split"===t?this.insertion._insertFragment({fragment:i}):s[t](r.children())}return this.app.editor.build(),this.app.block.set(a,"end"),r.children()}_insertToOneEditable(t){const e=new v(this.app),s=new L(this.app);this.p.html=this._clean(this.p.html),this.p.html=this._cleanSpecial(this.p.html,t);const i=this._parse(this.p.html);let r=this.dom(i);const a=this._getLastNode(i),n=t.getBlock();return t.isInline()&&!t.isEditable()&&(e.set(t.getBlock(),"after"),t.remove()),r=this.isLine?this._insertLineNodes(t,i):this._insertBlockNodes(t,n,i,s),this.app.editor.build(),this.isLine?e.set(a,"end"):this.app.block.set(a,"end"),r}_insertLineNodes(t,e){const s=this.p.caret||"end";if(t.isType("todoitem")){const t=this.dom("<div>").append(e);return this.dom(this._insertFragment._insertFragment({html:t.text()},s))}let i=this.dom(e).find("li");if(t.isType("listitem")&&i.length){const t=i.html();return this.dom(this.insertion._insertFragment({html:t},s))}return this.dom(this.insertion._insertFragment({fragment:e},s))}_insertBlockNodes(t,e,s,i){const r=this.dom(s);let a=this.p.position,n=!1;if(this.utils.isEmptyHtml(e.html())||i.isAll(t.getBlock())?(n="input"!==this.p.type,a="after"):a=a||this.insertion.detectPosition(e,a),n||(i.truncate(),this.app.context.close()),"split"===a){const t=new G(this.app).split(e);t.before(s),this.insertion._cleanUpPart(t)}else e[a](s);return n&&t.remove(),r}_insertToOneNotEditable(t){this.p.html=this._clean(this.p.html);const e=this._parse(this.p.html),s=this.dom(e),i=this._getLastNode(e);let r=t.getBlock();return t.isType(["cell","row","column"])?r.html(e):r.after(e),this.app.editor.build(),this.app.block.set(i,"end"),s}_createEmptyBlock(){this.isLine&&(this.p.html=this.app.block.createHtml(this.p.html))}_clean(t){const e=new O(this.app);return t=this.p.clean?e.clean(t):t}_cleanSpecial(t,e){const s=new W(this.app),i=new z(this.app),r=e.getType();let a=["address","figcaption","quote","todoitem","dlist"].includes(r),n=!1;return"list"===r||"listitem"===r?(a=!0,n=["ul","ol","li"]):"pre"===r&&(a=!0),"heading"===r&&(t=(t=t.replace(/<b[^>]*>/gi,"")).replace(/<\/b>/gi,"")),a&&(this.isLine=!0,"pre"===r?t=s.removeBreakline(t):"list"!==r&&"listitem"!==r&&(t=i.addBrToBlocks(t)),t=(t=s.removeBlockTags(t,!1,n)).replace(/<br\s?\/?>\n?$/gi,"")),t}_parse(t){const e=new N(this.app);return this.p.parse?e.parse(t,{type:this.isLine?"line":"html",nodes:!0,paragraphize:this.p.paragraphize}):e.build(t).get().childNodes}_isListToList(t,e){let s=this.dom("<div>").html(e);return s.find("meta").remove(),s.find("b").unwrap(),s=s.children().first(),0!==s.length&&(t.isType(["list","listitem"])&&["ul","ol"].includes(s.tag()))}_isTableToTable(t,e){return t.getClosest("table")&&0!==this.dom("<div>").html(e).find("table").length}_getFirstNode(t){return this.dom(t).first()}_getLastNode(t){return this.dom(t).last()}_isOnlyListItems(t){const e=(new DOMParser).parseFromString(`<ul>${t}</ul>`,"text/html"),s=Array.from(e.querySelector("ul").children);return s.length>0&&s.every((t=>"LI"===t.tagName))}}class I{constructor(t,e,s){this.app=t,this.dom=t.dom,this.config=t.config,this.p=s,this.caret=new v(this.app),this.splitter=new G(this.app),this.insertion=e}insert(){const t=this.p.current||this.app.block.get();if(t&&t.isNondeletable())this.app.block.set(t);else{if(this.p.caret=this.p.instance.isType(["table","quote","layout"])?"start":this.p.caret||"end",!t)return this._insertNotSelected();if(t.isEditable()&&(this.p.position=this.insertion.detectPosition(t.getBlock(),this.p.position)),!this._isTableToTable(t))return this._insertInstance(t)}}_insertNotSelected(){const t="top"===this.config.get("addPosition")?"before":"after",e=this.app.blocks.get({["before"===t?"first":"last"]:!0,instances:!0}),s=e.getBlock(),i=this.p.instance.getBlock();let r;if(this.p.instance.isInline())r=this.app.block.create().getBlock(),r.append(i);else if(this.p.instance.isType("list")&&e.isType("list")){const t=this.p.instance.getItems();e.getBlock().append(t)}return s[t](r||i),this._rebuildAndSetCaret(i),this.p.instance}_insertInstance(t){const e=this.p.instance.getBlock();let s=t.getBlock(),i=this.p.position,r=!1,a=!1;if("duplicate"===this.p.type)return s.after(e),this._finalizeInsert(e);if(this._isListInsert(t))return this._insertList(t);if(this.p.instance.isInline()?({position:i,$current:s,remove:r}=this._handleInlineInsert(t,s,i)):t.isInline()?(i="split",this.caret.set(s,"after"),s=s.parent().closest("[data-rx-type]"),r=!0):({position:i,$current:s,action:a}=this._handleBlockInsert(t,s,i)),"split"===i)this._splitAndInsert(s,e,a);else if("fragment"===i){const t=new L(this.app).getBlockControlled();if(t){const e=this.dom(t).dataget("instance");if(e&&e.isInline()){new v(this.app).set(t,"after")}}this.insertion._insertFragment({node:e.get()},"start")}else s[i||"after"](e);return r&&t.remove(),this.p.remove&&t.isEditable()&&t.isEmpty()&&t.remove(),this._finalizeInsert(e)}_isTableToTable(t){return this.p.instance.isType("table")&&(t.isType("table")||t.getClosest("table"))}_isListInsert(t){return this.p.instance.isType("list")&&t.isType("listitem")}_insertList(t){const e=this.p.instance.getItems();if(1===e.length&&""===e[0]){const e=this.p.instance.getBlock();t.getBlock().append(e)}else{this.splitter.split(t.getBlock()).prepend(e)}return this.p.instance}_handleInlineInsert(t,e,s){let i;return t.isInline()?s="after":t.isEditable()?s="fragment":(s="after",i=this.app.block.create().getBlock(),i.append(this.p.instance.getBlock())),{position:s,$current:i||e,remove:!1}}_handleBlockInsert(t,e,s){let i=!1;return t.isType(["cell","column"])?s=this.p.position||"prepend":t.isType(["row","figcaption"])?(s="split"===s?"after":s,e=t.getParent().getBlock()):t.isType("todo")?s=this._handleTodoInsert(t):t.isType("quote")?s=this._handleQuoteInsert(t):t.isType("listitem")?(({position:s,action:i}=this._handleListItemInsert(t)),e=t.getBlock().parents("ul, ol").last()):t.isType("list")&&"split"===s&&(i="list-empty"),{position:s,$current:e,action:i}}_handleTodoInsert(t){return this.p.instance.isType("todoitem")?"append":this.p.instance.isType("todo")?(this.p.instance.getBlock().contents(),"append"):"after"}_handleQuoteInsert(t){return t.isCaretStart()?"before":t.isCaretEnd()?"after":"split"}_handleListItemInsert(t){let e="split";return t.getParentTopInstance().isCaretStart()?e="before":t.getParentTopInstance().isCaretEnd()&&(e="after"),{position:e,action:"list-normalize"}}_splitAndInsert(t,e,s){const i=this.splitter.split(t);i.before(e),"list-empty"===s?i.find("li").first().remove():"list-normalize"===s&&this._normalizeList(i),this.insertion._cleanUpPart(i)}_normalizeList(t){const e=t.find("li").first(),s=e.clone();if(s.find("ol, ul").remove(),!s.text().trim()){const s=e.find("ol, ul").first().children();s.find("ul, ol").each((t=>{t.removeAttr("data-rx-type"),this.app.create("block.list",t)})),t.find("li").each((t=>{t.removeAttr("data-rx-type"),this.app.create("block.listitem",t)})),e.before(s),e.remove()}}_finalizeInsert(t){return this._rebuildAndSetCaret(t),this.p.instance}_rebuildAndSetCaret(t){this.app.editor.build(),this.p.caret&&setTimeout((()=>{this.app.block.set(t,this.p.caret),this.app.scroll.scrollTo(t)}),0)}}class L{constructor(t){this.app=t,this.dom=t.dom,this.page=t.page,this.editor=t.editor,this.sel=this._getSelection(),this.range=new H(this.app,this),this.elements=new A(this.app,this)}getRange(){return this.range.get(this.sel)}setRange(t){this.range.update(t)}updateRange(t,e){this.range.update(t,e)}isCollapsed(){return this.range.isCollapsed()}isBackwards(){return this.range.isBackwards()}isCursorInFirstOrLastLine(){return this.range.isCursorInFirstOrLastLine()}truncate(){this.range.truncate()}getCurrent(){return this.elements.current()}getParent(){return this.elements.parent()}getClosest(t){return this.elements.closest(t)}getElement(t){return this.elements.element(t)}getInline(t){return this.elements.inline(t)}getInlineTop(t,e){return this.elements.inlineTop(t,e)}getBlock(t){return this.elements.block(t)}getBlockControlled(t){return this.elements.controlled(t)}getNodes(t){return this.elements.nodes(t)}set(t){this.sel=t}get(){return this._getSelection()}getPosition(t){const e=this.getRange();return e?this._getRangePosition(e,t):{top:0,left:0,right:0,bottom:0,width:0,height:0}}getText(t,e,s){if(!this.sel)return"";let i=this.getRange();return i?this._getRangeText(i,t,e,s):this.sel.toString()}getHtml(){if(!this.sel)return"";let t=this.getRange();return t?this._getRangeHtml(t):""}getCursorContext(t="after"){if(!this.sel)return!1;const e=this.getRange();let s=e.startContainer,i=e.startOffset;if(s.nodeType===Node.TEXT_NODE){const e=s.textContent.length;if("before"===t&&0===i)return s.previousSibling;if("after"===t&&i===e-1)return s.nextSibling}return!1}contains(t){const e=this.getCurrent();return!!e&&this._node(t).contains(e)}is(t){if(void 0===t)return!!this.sel;return this.getNodes().includes(this._node(t))}isAll(t){if(this.isCollapsed())return!1;const e=t?this._node(t):this.editor.getLayout().get(),s=!t||this.is(e),i=this.getRange();return s&&e.textContent&&e.textContent.trim().length===i.toString().trim().length}select(t){const e=t?this._node(t):this.editor.getLayout().get();if(!e)return;const s=this.page.getDocNode().createRange();s.selectNodeContents(e),this.setRange(s)}remove(){this.sel&&(this.sel.removeAllRanges(),this.sel=!1)}collapse(t="start"){this.sel&&!this.isCollapsed()&&("start"===t?this.sel.collapseToStart():this.sel.collapseToEnd())}isFullySelected(t){return this.isAll(t)}update(){return this.sel}_getSelection(){const t=this?.page?.getWinNode()?.getSelection()??!1;return t.rangeCount>0&&this.dom(t.anchorNode).closest(".rx-editor").length>0&&t}_node(t){return this.dom(t).get()}_getRangePosition(t,e){let s={};if(t.startContainer===t.endContainer&&this.isAll(t.startContainer))s=t.getBoundingClientRect();else{if(t=t.cloneRange(),"end"===e)0!==t.endOffset?t.setStart(t.endContainer,t.endOffset):t.endContainer.previousElementSibling&&t.setStart(t.endContainer.previousElementSibling.firstChild,1);else{const e=t.startOffset-1;t.setStart(t.startContainer,e<0?0:e)}s=t.getBoundingClientRect()}return{top:s.top,bottom:s.bottom,left:s.left,right:s.right,width:s.right-s.left,height:s.bottom-s.top}}_getRangeText(t,e,s,i){const r=t.cloneRange();return i=i?this._node(i):this.editor.getLayout().get(),s=void 0===s?1:s,"before"===e?(r.collapse(!0),r.setStart(i,0),!0===s?r.toString():r.toString().slice(-s)):"after"===e?(r.selectNodeContents(i),r.setStart(t.endContainer,t.endOffset),!0===s?r.toString():r.toString().slice(0,s)):r.toString()}_getRangeHtml(t){const e=document.createElement("div");return e.appendChild(t.cloneContents()),e.innerHTML.replace(/<p><\/p>$/i,"")}}l.TextRange=L;class A{constructor(t,e){this.app=t,this.page=t.page,this.editor=t.editor,this.dom=t.dom,this.selection=e,this.sel=e.sel}current(){return!!this.sel&&this.sel.anchorNode}parent(){const t=this.current();return!!t&&t.parentNode}closest(t){const e=this.current(),s=this.dom(e).closest(t);return 0!==s.length&&s.get()}element(t){return this._findElement(t,"element")}inline(t){return this._findElement(t,"inline")}inlineTop(t,e){const s=t?this._node(t):this.current();return this._findInlineParent(s,e)}block(t){return this._findElement(t,"block")}controlled(t){let e=t?this._node(t):this.current();for(;e;){if(e.nodeType===Node.ELEMENT_NODE&&e.getAttribute("data-rx-type"))return e;e=e.parentNode}return!1}nodes(t){if(!this.sel)return[];const e=this.selection.getRange();let s=this.editor.isSelectAll()?[...this.editor.getLayout().get().getElementsByTagName("*")]:this._collectNodes(e,t?.partial);return s=[...new Set(s)],s.length?this._filter(s,e,t):s}_node(t){return this.dom(t).get()}_findElement(t,e){if(!this.sel)return!1;let s=t||this.current();s=this._node(s);const i=new K(this.app);for(;s;){if(i.is(s,e))return s;s=s.parentNode}return!1}_findInlineParent(t,e){let s=null;const i=new K(this.app);for(;t&&(t.nodeType!==Node.ELEMENT_NODE||!i.is(t,"inline")||(s=t,t.tagName.toLowerCase()!==e));)t=t.parentNode;return s}_collectNodes(t,e){const s=[],i=t.startContainer.childNodes[t.startOffset]||t.startContainer,r=t.endContainer.childNodes[t.endOffset]||t.endContainer,a=t.commonAncestorContainer,n=t=>3===t.nodeType,o=t=>a.contains(t.parentNode),l=t=>{if("TR"===t.tagName){const e=this.dom(t).closest("table").get();s.includes(e)||s.push(e)}else s.push(t)};let h;if(this.editor.isEditor(i)||s.push(i),e)for(n(i)&&s.unshift(this.selection.getBlock(i)),h=i;h&&h!==a&&(n(h)||o(h))&&(l(h),h!==r);h=this._nextNode(h));else{for(h=i.parentNode;h&&!this.editor.isEditor(h)&&(s.push(h),h!==a);h=h.parentNode);for(s.reverse(),h=i;h;h=this._nextNode(h)){if(!n(h)&&"TR"===h.tagName){const t=this.dom(h).closest("table").get();s.includes(t)||s.push(t)}if(!n(h)&&!o(h))break;if(l(h),h===r)break}}return s}_nextNode(t){if(t.firstChild)return t.firstChild;for(;t;){if(t.nextSibling)return t.nextSibling;t=t.parentNode}}_filter(t,e,s){const i=new Set,r=this._sanitizeText(this.selection.getText()),a=new K(this.app);return t.forEach((t=>{if(this.editor.isEditor(t))return;let n=!0;s&&(n=s.types?this._filterByTypes(n,s,t,a):n,n=s.selected?this._filterBySelected(n,s,t,e,r):n,n=s.tags?this._filterByTags(n,s,t):n,n=s.type?this._filterByType(n,s,t,a):n,"inline"===s.type&&a.is(t,"inline")&&t.parentNode&&a.is(t.parentNode,"inline")&&i.add(t.parentNode)),n&&i.add(t)})),Array.from(i)}_filterByTags(t,e,s){const i=void 0!==s.tagName;return(!i||i&&-1===e.tags.indexOf(s.tagName.toLowerCase()))&&(t=!1),t}_filterBySelected(t,e,s,i,r){return!0!==e.selected||this._isTextInRange(i,s)?"inside"===e.selected&&(t=1===s.nodeType&&"A"===s.tagName||this._textMatches(s,r)):t=!1,t}_filterByType(t,e,s,i){let r=!1===e.inline?"block-data-not-inline":e.type;return"inline"===e.type?(e.link?i.is(s,e.type)||(t=!1):(1===s.nodeType&&"A"===s.tagName||!i.is(s,e.type))&&(t=!1),e.buttons&&i.is(s,e.type,!1)&&(t=!0)):i.is(s,r)||(t=!1),t}_filterByTypes(t,e,s,i){let r=i.getType(s);return-1===e.types.indexOf(r)&&(t=!1),t}_sanitizeText(t){return t?t.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"):""}_textMatches(t,e){const s=new T(this.app),i=9!==t.nodeType?s.removeInvisibleChars(t.textContent):"";return e===i||i.includes(e)}_isTextInRange(t,e){const s=this.page.getDocNode().createTreeWalker(e,NodeFilter.SHOW_TEXT,(t=>NodeFilter.FILTER_ACCEPT),!1);let i,r,a;for(;a=s.nextNode();)i||(i=a),r=a;const n=t.cloneRange();return i?(n.setStart(i,0),n.setEnd(r,r.length)):n.selectNodeContents(e),t.compareBoundaryPoints(Range.START_TO_START,n)<=0&&t.compareBoundaryPoints(Range.END_TO_END,n)>=0}}class H{constructor(t,e){this.app=t,this.page=t.page,this.selection=e}get(t=this.selection.sel){return!!(t&&t.rangeCount>0)&&t.getRangeAt(0)}set(t){const e=this.page.getWinNode().getSelection();this.update(t,e)}update(t,e){e||(e=this.selection.sel||this.page.getWinNode().getSelection()),e.removeAllRanges(),e.addRange(t)}truncate(){const t=this.get();t&&!this.isCollapsed()&&t.deleteContents()}isCollapsed(){let t=this.get();return!this.selection.sel||!t||this.selection.sel.isCollapsed||0===t.toString().length}isBackwards(){return!(!this.selection.sel||this.selection.sel.isCollapsed)&&this._isSelectionBackwards(this.selection.sel)}isCursorInFirstOrLastLine(){const t=this.page.getWinNode().getSelection();if(!t.rangeCount)return{isFirstLine:!1,isLastLine:!1};const e=t.getRangeAt(0),s=this.page.getDocNode(),i=s.createRange();i.setStart(e.startContainer,0),i.setEnd(e.startContainer,e.startOffset);const r=i.getClientRects();if(!r.length)return{isFirstLine:!1,isLastLine:!1};const a=s.createRange();a.setStart(e.endContainer,e.endOffset),a.setEnd(e.endContainer,e.endContainer.length||e.endContainer.childNodes.length);const n=a.getClientRects();if(!n.length)return{isFirstLine:!1,isLastLine:!1};const o=r[0].top,l=n[n.length-1].bottom,{top:h,bottom:p}=e.getBoundingClientRect();return{isFirstLine:h<=o,isLastLine:p>=l}}_isSelectionBackwards(t){const e=this.page.getDocNode().createRange();e.setStart(t.anchorNode,t.anchorOffset),e.setEnd(t.focusNode,t.focusOffset);const s=e.collapsed;return e.detach(),s}}class N{constructor(t){this.app=t,this.dom=t.dom,this.config=t.config,this.block=t.block,this.element=t.element,this.defaults={type:"html",start:!1,nodes:!1,state:!1,paragraphize:this.config.get("paragraphize")},this.parsedAttr="data-rx-type",this.utils=new T(this.app),this.cleaner=new O(this.app),this.storage=new Z(this.app),this.encoder=new V(this.app),this.transformer=new U(this.app),this.remover=new W(this.app),this.modifier=new z(this.app),this.cache=new R(this.app),this.sanitizer=new q(this.app),this.inspector=new K(this.app)}build(t){return this._buildNodes(t)}parse(t,e={}){this.defaults=l.extend(!0,this.defaults,e);let s=this._getParser(this.defaults.type).parse(t,this.defaults);return"json"!==this.defaults.type&&(s=this._buildResult(s)),s}clean(t,e){const s=this.config.get("templateSyntax");s&&(this.config.set("clean.comments",!1),t=this.storage.storeTemplateSyntax(t,s)),this.app.has("email")&&(t=this.app.email.parseBlocks(t)),t=(t=this.config.is("clean.comments")?this.remover.removeComments(t):t).replace(/¤t/gi,"&current"),t=this.cleaner.cleanAttributes(t),e&&e.start&&this.element.isTextarea()&&(t=this.storage.storeComments(t),t=this.encoder.encodeCode(t),t=this.storage.restoreComments(t)),t=this.sanitizer.sanitize(t),t=this.transformer.convertVideo(t),t=this.transformer.convertForms(t),t=this.transformer.convertFrames(t),t=this.transformer.convertSvgSpan(t);let i=this.config.get("nonparse");for(let e=0;e<i.length;e++)t=this.storage.store(t,i[e]);t=this.storage.store(t,"embed"),t=this.storage.store(t,"svg"),t=this.storage.store(t,"noparse"),t=this.remover.removeTags(t,this.config.get("tags.denied")),t=this.remover.removeDoctype(t),t=this.remover.removeTagsWithContent(t,["script","style"]),t=this.remover.removeEmptySpans(t),t=this.modifier.addHttps(t),t=this.remover.removeBlockTagsInside(t,["li","dt","dd","address"]),t=this.cache.cacheStyle(t);for(let e=0;e<i.length;e++)t=this.storage.restore(t,i[e]);if(t=this.storage.restore(t,"embed"),t=this.storage.restore(t,"noparse"),t=this.storage.restore(t,"svg"),this.utils.isEmptyHtml(t))t=this.block.createHtml();else{t=new y(this.app,e.paragraphize).parse(t)}return t=t.replace(/<div>\s*<\/div>/gi,"<div></div>")}replaceTags(t){const e=this.config.get("replaceTags");if(!e)return t;const s=Object.keys(e);return"string"==typeof t?t=this.utils.wrap(t,(t=>t.find(s.join(",")).each((t=>{t.replaceTag(e[t.tag()])})))):t.find(s.join(",")).each((t=>{t.replaceTag(e[t.tag()])})),t}_getParser(t){switch(t){case"json":return new P(this.app,this);case"line":return new M(this.app,this);default:return new D(this.app,this)}}_buildResult(t){if(this.defaults.nodes){let e=this._buildNodes(t);this.app.has("email")&&(e=this.app.email.parse(e)),t=e.get().childNodes}return t}_buildNodes(t){const e=this.dom("<div>").html(t);return e.find(`[${this.parsedAttr}]`).each(this._buildNode.bind(this)),e}_buildNode(t){const e=t.attr(this.parsedAttr);this.app.create("block."+e,t)}}l.Parser=N;class D{constructor(t,e){this.app=t,this.dom=t.dom,this.config=t.config,this.parser=e,this.parsedAttr=e.parsedAttr,this.utils=new T(this.app),this.classApplier=new u(this.app),this.inspector=new K(this.app),this.paragraphizer=new y(this.app,this.parser.defaults.paragraphize),this.nested=this.config.get("nested"),this.nestedValue=this.config.get("nestedValue"),this.layoutGridClass=this.config.get("layout.grid"),this.columnClass=this.config.get("layout.column")}parse(t,e){return this.defaults=e,t=t.trim(),t=this.app.emitHtml("editor.before.parse",t),this.utils.isEmptyHtml(t)?t=this.app.block.createHtml():(t=this.parser.clean(t,this.defaults),t=this._parseBlocks(t),t=this.parser.replaceTags(t),t=this.paragraphizer.parseLayers(t),t=this._parseLayersNodes(t)),this.app.emitHtml("editor.parse",t)}_parseBlocks(t){return this.utils.wrap(t,(t=>{this._parseElements(t),this.classApplier.parse(t)}))}_parseElements(t){const e=this.inspector.getBlocks(t);for(const t of e)this._parseNode(t)}_parseNode(t){const e=this.dom(t),s=e.tag(),i=this._parseType(e,s);i&&e.attr(this.parsedAttr,i);const r=this.nested.indexOf(i);if(-1!==r){const t=this.nestedValue[r];!0===t?this._parseElements(e):e.find(t).each(this._parseElements.bind(this))}}_parseType(t,e){let s,i=this.config.get("dataBlock");return s=t.attr(this.parsedAttr)?t.attr(this.parsedAttr):t.attr(i)?t.attr(i):this._parseTypeByTag(t,e),s}_parseTypeByTag(t,e){let s;switch(e){case"p":s="text",this._isImageBlock(t,"p")&&(s="image");break;case"figure":s="embed",this._isImageBlock(t,"figure")?s="image":this._hasChild(t,"pre")?s="pre":this._hasChild(t,"blockquote")&&(s="quote");break;case"div":s="wrapper",this._isLayoutBlock(t,"div")?s="layout":this._isColumnBlock(t,"div")?s="column":this._isImageBlock(t,"div")?s="image":this._isTextBlock(t)&&(s="text");break;case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":s="heading";break;case"blockquote":s="quote";break;case"table":s="table";break;case"pre":s="pre";break;case"hr":s="line";break;case"dl":s="dlist";break;case"address":s="address";break;case"ul":case"ol":s="list",this._isTodo(t)&&(s="todo");break;default:s="wrapper"}return s}_parseLayersNodes(t){return this.utils.wrap(t,(t=>{t.find("[data-rx-tag]").each(this._parseLayersDataTag.bind(this)),t.find("[data-rx-type=wrapper],[data-rx-type=column]").each((t=>{this._parseElements(t),this.classApplier.parse(t)}))}))}_parseLayersDataTag(t){if(!t.attr("data-rx-type")){let e="text";this._isImageBlock(t,"div")&&(e="image",t.removeAttr("data-rx-tag")),t.attr(this.parsedAttr,e)}}_isLayoutBlock(t){return this.layoutGridClass&&t.hasClass(this.layoutGridClass)}_isColumnBlock(t){return"layout"===t.parent().data("rx-type")||this.columnClass&&t.hasClass(this.columnClass)}_isImageBlock(t,e){let s=t.find("img, picture");if(0===s.length||"div"===e&&0!==s.closest("figure").length)return;let i=s.first(),r=s.first().parent(),a=r,n=0!==r.length&&r.tag();return n&&["a","span"].includes(n)&&(i=r,a=r.parent()),!(a.get(0)!==t.get(0)||i.prevElement().length||"figure"!==e&&i.nextElement().length)}_isTextBlock(t){return 0===this.inspector.getBlocks(t).length&&!this.inspector.is(t.children().first(),"block")}_isTodo(t){if(!this.config.is("todo"))return!1;const e=this.config.get("todo.template"),s=this.config.get("todo.templateItem"),i=this.config.get("todo.templateItemDone");let r=t.children().first();if(0!=r.length){let t=s.replace(/\s/g,""),a=r.html();if(e)return this._checkToTemplateMatch(e,a);{let e=a.startsWith(s)||a.startsWith(t),r=a.startsWith(i);if(e||r)return!0}}return!1}_checkToTemplateMatch(t,e){return new RegExp("^"+t.replace(/\$checked/g,"\\[(x| )\\]").replace(/\$content/g,"(.*)")+"$").test(e)}_hasChild(t,e){if("pre"===e){if(0!==t.find("pre").length)return!0}else if("blockquote"===e){let e=t.find("blockquote");if(0===t.find("script").length&&0!==e.length)return!0}}}l.ParserHtml=D;class P{constructor(t,e){this.app=t,this.dom=t.dom,this.config=t.config,this.parser=e,this.parsedAttr=e.parsedAttr,this.classApplier=new u(this.app),this.nonparse=this.config.get("nonparse")}parse(t,e){this.defaults=e;const s=this._render(this.dom("<div>"),t.blocks);this.classApplier.parse(s);let i=this.defaults.nodes?s.children():s.html();return this.parser.replaceTags(i)}_render(t,e,s=!0){for(const i of e){const e=this.app.create("block."+i.type,i,s).getBlock(),r=this._shouldRenderBlock(i,s);i.children&&this._render(e,i.children,r),t.append(e)}return t}_shouldRenderBlock(t,e){return!this.nonparse.includes(t.type)&&!1!==e&&void 0}}l.ParserJson=P;class M{constructor(t,e){this.app=t,this.dom=t.dom,this.config=t.config,this.parser=e,this.parsedAttr=e.parsedAttr,this.utils=new T(this.app),this.encoder=new V(this.app),this.remover=new W(this.app),this.modifier=new z(this.app),this.transformer=new U(this.app),this.sanitizer=new q(this.app)}parse(t,e){return this.defaults=e," "===t?t="&nbsp;":(t=this.app.emitHtml("editor.before.parse",t),t=this._parseInlineBlocks(t),t=this._clean(t),t=this.app.emitHtml("editor.parse",t)),t}_clean(t){return t=this.remover.removeTags(t,this.config.get("tags.denied")),t=this.remover.removeTagsWithContent(t,["script","style"]),t=this.sanitizer.sanitize(t),t=this.remover.removeEmptySpans(t),t=this.modifier.addHttps(t),t=this.transformer.convertSvgSpan(t),t=this.parser.replaceTags(t)}_parseInlineBlocks(t){return this.utils.wrap(t,(t=>{t.find("["+this.config.get("dataBlock")+"]").each((t=>{if(!t.attr("data-rx-type")){const e=t.attr(this.config.get("dataBlock"));this.app.create("block."+e,t)}}))}))}}l.ParserLine=M;class F{constructor(t){this.app=t,this.config=t.config,this.defaults={type:"html",state:!1,clipboard:!1},this.parsedAttr="data-rx-type"}unparse(t,e={}){return this.defaults=l.extend(!0,this.defaults,e),this._unparse(t.trim())}unparseClasses(t){return t.removeClass(["rx-block-placeholder","rx-block-focus","rx-block-meta-focus","rx-block-control-focus","rx-layout-grid","rx-nowrap","rx-collapsed","rx-hidden","rx-drag-active"].join(" ")),t}_unparse(t){const e=new Z(this.app),s=new V(this.app),i=new T(this.app),r=this.config.get("templateSyntax");return t=t.trim(),t=this.app.emitHtml("editor.before.unparse",t),this.app.has("email")&&!this.defaults.clipboard&&(t=this.app.email.unparseBlocks(t)),i.isEmptyHtml(t)?"":(t=this._applyCleaners(t),t=this._applyParsers(t),r&&(t=e.restoreTemplateSyntax(t,r)),t="<p></p>"===t?"":t,this.app.has("email")&&(t=this.app.email.unparse(t)),t=(t=s.decodeSpecialCharsInAttributes(t)).replace(/&amp;/g,"&").replace(/&quot;(.*?)&quot;/gi,"'$1'"),t=i.replaceRgbToHex(t),t=this.app.emitHtml("editor.unparse",t),t=this._handleSelfClosingXmlTags(t),this.defaults.clipboard,t)}_handleSelfClosingXmlTags(t){const e=this.config.get("paragraphizer.selfClosingXmlTags");return e?(e.forEach((e=>{const s=new RegExp(`<(${e})([^>]*?)></\\1>`,"gi");t=t.replace(s,"<$1$2 />")})),t):t}_applyCleaners(t){const e=new U(this.app),s=new W(this.app),i=new R(this.app),r=new Z(this.app),a=new z(this.app);return t=e.revertForms(t),t=e.revertFrames(t),t=r.store(t,"noneditable"),t=r.store(t,"embed"),t=a.addNofollow(t),t=s.removeMarkers(t),t=s.removeInvisibleChars(t),t=r.restore(t,"noneditable"),t=r.restore(t,"embed"),t=i.recacheStyle(t),t=s.removeEmptyAttrs(t,["style","class","rel","alt","title"])}_applyParsers(t){const e=new W(this.app),s=new N(this.app),i=this.config.get("classes");if(t=s.replaceTags(t),t=this._unparseAllTags(t),t=this._unparseDataType(t),t=this._unparseDataTag(t),t=e.removeEmptyAttrs(t,["style","class","rel","alt","title"]),i){const e=new T(this.app),s=new u(this.app);t=e.wrap(t,(t=>{s.parse(t)}))}return t}_unparseAllTags(t){return new T(this.app).wrap(t,(t=>{t.find(".rx-ai-main, .rx-inserted-node, #rx-image-resizer").remove(),t.find("*").removeAttr("contenteditable data-gramm_editor data-rx-cont-width data-offset-empty data-structure"),this.config.is("image.states")||t.find("img").removeAttr("data-image")}))}_unparseDataType(t){const e=new T(this.app),s=new W(this.app);return e.wrap(t,(t=>{const e=t.find(`[${this.parsedAttr}]`);!0!==this.defaults.state&&e.removeClass("rx-block-state"),e.removeAttr("tabindex data-rx-parsed data-rx-width data-rx-first-level data-rx-inline data-rx-focusable"),this.unparseClasses(e),e.each((t=>this._unparseByType(t))),e.removeAttr(this.parsedAttr),t.find("figcaption").removeAttr(`${this.parsedAttr} data-placeholder`).each((t=>s.removeEmptyTag(t)))}))}_unparseByType(t){const e=t.attr(this.parsedAttr);"embed"===e&&this._unparseEmbed(t),"todo"===e&&this._unparseTodo(t)}_unparseDataTag(t){const e=new T(this.app);return e.wrap(t,(t=>{t.find("[data-rx-tag]").each((t=>{const s=t.attr("data-rx-tag");t.removeAttr("data-rx-tag"),["style","class"].forEach((e=>{""===t.attr(e)&&t.removeAttr(e)})),t.get(0).attributes.length||this._unwrapNode(t,s,e)}))}))}_unwrapNode(t,e,s){s.isEmptyHtml(t.html())?t.html("<br>").unwrap():"tbr"===e||"BR"===t.get(0).lastChild?.tagName?t.unwrap():t.append("<br>").unwrap()}_unparseEmbed(t){const e=decodeURI(t.attr("data-embed-content")),s=t.find(`.${this.config.get("embed.classname")}`);s.html(e),t.removeAttr("data-embed-content");const i=s.find("video");if(i.length){const t=s.closest("figure");0===t.find("figcaption").length&&(t.after(i),t.remove())}}_unparseTodo(t){const e=new T(this.app).findTodoItemTag(),s=this.config.get("todo.templateItem"),i=this.config.get("todo.templateItemDone"),r=this.config.get("todo.template");t.find("li").each((t=>{const a="0"===t.attr("data-checked")?s:i;t.find(`[${this.parsedAttr}]`).removeAttr(this.parsedAttr),t.removeAttr("data-checked");const n=t.find(e).html();let o=`${a} ${n}`;r&&(o=r.replace(/\$checked/gi,a).replace(/\$content/gi,n)),t.html(o)}))}}l.Unparser=F;class O{constructor(t){this.app=t,this.dom=t.dom,this.config=t.config,this.event=t.event,this.utils=new T(this.app),this.storage=new Z(this.app),this.remover=new W(this.app),this.encoder=new V(this.app),this.cache=new R(this.app),this.docParser=new j(this.app)}clean(t){t=this.app.emitHtml("editor.before.clean",t);const e=this._isPages(t),s=this._isHtmlMsWord(t),i=this._isEditor(t),r=this._isGDocs(t),{pasteTags:a,inlineTags:n,formTags:o,deniedTags:l}=this._getTagsConfig(),h=[...a,...n,...o];if(t=this.storage.store(t,"embed"),t=this.storage.store(t,"svg"),t=this.storage.store(t,"picture"),t=this._unwrapBlockLinks(t),t=this.remover.removeDoctype(t),t=this.remover.removeTags(t,l).trim(),t=this.remover.removeFragmentEmptyTags(t),t=this.remover.removeComments(t),t=this.remover.removeTagsWithContent(t,["script","style"]),t=this.remover.removeSpanNbsp(t),t=(t=this.transformTodoListItems(t)).replace(/div><br\s?\/?><div/gi,"div><br><br><div"),t=e?this.docParser.cleanPages(t):t,t=r?this.docParser.cleanGDocs(t):t,!i&&this.config.is("paste.stripAttr")){const e=this.config.get("paste.stripAttr.allowedAttributes"),s=this.config.get("paste.stripAttr.allowedClasses");t=this.remover.removeAllAttributes(t,{allowedAttributes:e,allowedClasses:s})}t=this.encoder.encodePhp(t);const p=i?[...h,"div"]:h;t=this.remover.removeTagsExcept(t,p),t=s?this.docParser.cleanMsWord(t):t;const c=this._removeClassesAttrs(t,i);return t=c.html,c.flag||(t=this.storage.restore(t,"embed")),t=this.storage.restore(t,"svg"),t=this.storage.restore(t,"picture"),t=i?this.cache.cacheStyle(t):this.remover.removeStyleAttr(t),t=this.remover.removeEmptyInlines(t),t=this.remover.removeEmptySpans(t),t=this._cleanEmptyBlocks(t,i),t=this._fixGmailListPaste(t),t=this._tidyCleanUp(t),this.app.emitHtml("editor.clean",t)}transformTodoListItems(t){const e=document.createElement("template");e.innerHTML=t;const s=e.content,i=this.app.config,r=i.get("todo.templateItem")||"[ ]",a=i.get("todo.templateItemDone")||"[x]";return s.querySelectorAll("li[data-checked]").forEach((t=>{const e="1"===t.getAttribute("data-checked")?a:r,s=t.querySelector("div"),i=e+" "+(s?s.textContent.trim():t.textContent.trim());t.innerHTML=i,t.removeAttribute("data-checked")})),e.innerHTML}cleanAttributes(t){const e=(new DOMParser).parseFromString(t,"text/html");return e.querySelectorAll("*").forEach((t=>{[...t.attributes].forEach((e=>{if('"'===e.name)return;const s=e.value.replace(/\s*\n\s*/g," ").trim();t.setAttribute(e.name,s)}))})),e.body.innerHTML}_isEditor(t){return t.match(new RegExp('meta\\stype="rx-editor"',"i"))}_isGDocs(t){return-1!==t.search(/docs-internal-guid/i)}_isPages(t){return t.match(/name="Generator"\scontent="Cocoa\sHTML\sWriter"/i)}_isHtmlMsWord(t){return t.match(/class="?Mso|style="[^"]*\bmso-|style='[^'']*\bmso-|w:WordDocument/i)}_getTagsConfig(){return{pasteTags:this.config.get("paste.blockTags"),inlineTags:this.config.get("paste.inlineTags"),formTags:this.config.get("paste.formTags"),deniedTags:this.config.get("tags.denied")}}_cleanEmptyBlocks(t,e){return t=t.replace(/<figure[^>]*><\/figure>/gi,"").replace(/<p>&nbsp;<\/p>/gi,"<p></p>").replace(/<p><br\s?\/?><\/p>/gi,"<p></p>"),e||this.config.is("paste.keepEmptyLines")||(t=t.replace(/<p[^>]*><\/p>/gi,"")),t}_fixGmailListPaste(t){return t.replace(/^<li/gi,"<ul><li").replace(/<\/li>$/gi,"</li></ul>").replace(/<br\s?\/?><\/li>/gi,"</li>").replace(/<span><br\s?\/?>{1,2}<\/span>/gi,"").replace(/<br\s?\/?><br\s?\/?>$/gi,"")}_tidyCleanUp(t){return this.utils.wrap(t,(t=>{t.find(".Apple-converted-space").unwrap(),t.find("ul, ol").each(this._placeListToItem.bind(this)),t.find("li p").unwrap()}))}_unwrapBlockLinks(t){return this.utils.wrap(t,(t=>{t.find("a").each((t=>{t.find("p, div, h1, h2, h3, h4, h5, h6, section, article, table, ul, ol, blockquote, figure, aside, pre").length&&t.replaceWith(t.html())}))}))}_placeListToItem(t){let e=t.get(),s=e.previousSibling;if(s&&"LI"===s.tagName){let t=this.dom(s);t.find("p").unwrap(),t.append(e)}}_removeClassesAttrs(t,e){let s=!1;const i=this.config.get("paste.keepClass"),r=this.config.get("paste.keepAttrs"),a=i.length?i.join(","):"",n=r.length?r.join(","):"";return!e&&this.event.isPasteEvent()&&(t=this.storage.restore(t,"embed"),s=!0),e||(t=this.utils.wrap(t,(t=>{const e=t.find("*");e.not(a).each((t=>t.removeAttr("class"))),e.not(n).each((t=>{if(t.data("keep-style"))return t.attr("data-rx-style-cache",t.attr("style")),void t.removeAttr("data-keep-style");const e=t.get();Array.from(e.attributes).forEach((t=>{this._isRemovableAttribute(t.name,e)&&e.removeAttribute(t.name)}))}))}))),{html:t,flag:s}}_isRemovableAttribute(t,e){const s="IMG"===e.tagName&&["src","srcset","alt","data-state-src","data-state-srcset"].includes(t)||"A"===e.tagName&&["href","target"].includes(t);return"class"!==t&&"dir"!==t&&!t.startsWith("data-")&&!s}store(t,e){return this.storage.store(t,e)}restore(t,e){return this.storage.restore(t,e)}cacheElementStyle(t){this.cache.cacheElementStyle(t)}}l.Cleaner=O;class R{constructor(t){this.app=t,this.config=t.config;const e=this.config.get("tags");this.selector=[...e.block,"img",...e.inline].join(",")}cacheStyle(t){return this._transformStyle(t,this.cacheElementStyle.bind(this))}cacheElementStyle(t){const e=t.attr("style");e?t.attr("data-rx-style-cache",e.replace(/"/g,"")):t.removeAttr("data-rx-style-cache")}recacheStyle(t){return this._transformStyle(t,this._recacheElementStyle.bind(this),"[data-rx-style-cache]")}_transformStyle(t,e,s=this.selector){return new T(this.app).wrap(t,(t=>{t.find(s).each(e)}))}_recacheElementStyle(t){const e=t.attr("data-rx-style-cache");e&&t.attr("style",e).removeAttr("data-rx-style-cache")}}l.CleanerCache=R;class j{constructor(t){this.app=t,this.dom=t.dom,this.config=t.config,this.utils=new T(t)}cleanPages(t){return t=(t=t.replace(/\sclass="s[0-9]"/gi,"")).replace(/\sclass="p[0-9]"/gi,"")}cleanGDocs(t){return this.utils.wrap(t,(t=>{t.find("h1, h2, h3, h4, h5, h6").each((t=>{t.find("span").unwrap()}))})).replace(/ dir="[^>]*"/gi,"").replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2").replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3").replace(/<span[^>]*(font-style:\s?italic;\s?font-weight:\s?(bold|600|700)|font-weight:\s?(bold|600|700);\s?font-style:\s?italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$4</i></b>").replace(/<span[^>]*font-style:\s?italic[^>]*>([\w\W]*?)<\/span>/gi,"<i>$1</i>").replace(/<span[^>]*font-weight:\s?(bold|600|700)[^>]*>([\w\W]*?)<\/span>/gi,"<b>$2</b>")}cleanMsWord(t){t=(t=(t=(t=(t=(t=t.replace(/<!--[\s\S]+?-->/gi,"")).trim()).replace(/<(!|script[^>]*>.*?<\/script(?=[>\s])|\/?(\?xml(:\w+)?|meta|link|style|\w:\w+)(?=[\s/>]))[^>]*>/gi,"")).replace(/<(\/?)s>/gi,"<$1strike>")).replace(/&nbsp;/gi," ")).replace(/<span\s+style\s*=\s*"\s*mso-spacerun\s*:\s*yes\s*;?\s*"\s*>([\s\u00a0]*)<\/span>/gi,((t,e)=>e.length>0?e.replace(/./," ").slice(Math.floor(e.length/2)).split("").join(" "):"")),t=(t=this.utils.wrap(t,(t=>{t.find("p").each((t=>{let e=/mso-list:\w+ \w+([0-9]+)/.exec(t.attr("style"));e&&t.attr("data-listLevel",parseInt(e[1],10))})),this._parseWordLists(t),t.find("[align]").removeAttr("align"),this.config.is("paste.keepNameAttr")||t.find("[name]").removeAttr("name");const e=this.config.get("paste.keepWordFormatting")||{},s=Array.isArray(e.styles)?e.styles:[];t.find("span").each((t=>{const e=t.attr("style")||"";if(/mso-list:Ignore/.test(e)||""===t.html().trim())t.remove();else if(s.length>0){const i={};if(e.split(";").forEach((t=>{let[e,r]=t.split(":");e&&r&&(e=e.trim().toLowerCase(),r=r.trim(),s.includes(e)&&(i[e]=r))})),Object.keys(i).length>0){const e=Object.entries(i).map((([t,e])=>`${t}: ${e}`)).join("; ");t.attr("style",e),Array.from(t.get().attributes).forEach((e=>{"style"!==e.name&&t.removeAttr(e.name)})),t.attr("data-keep-style",!0)}else t.unwrap()}else t.unwrap()})),t.find("[style]").each((t=>{t.data("keep-style")||t.removeAttr("style")})),t.find("[class^='Mso']").removeAttr("class"),t.find("a").filter((t=>!t.attr("href"))).unwrap()}))).replace(/<p><img(.*?)>/gi,"<p><img$1></p><p>").replace(/<li>·/gi,"<li>"),this.config.is("paste.keepEmptyLines")||(t=t.replace(/<p[^>]*><\/p>/gi,""));let e="",s=(t=(t=t.trim()).replace(/\/(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)>\s+<(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)/gi,"/$1>\n<$2")).split(/\n/),i=s.length;for(let t=0;t<i;t++){let i=""!==s[t]&&-1===s[t].search(/>$/)?" ":"\n";e+=s[t]+i}return e=e.trim(),e}_parseWordLists(t){let e=0,s=null,i=null,r=null;t.find("p").each((t=>{let a=t.attr("data-listLevel");if(null===a&&t.hasClass("MsoListParagraphCxSpMiddle")&&(a=1),null!==a){let n=t.text(),o=/^\s*\w+\./.test(n)?"<ol></ol>":"<ul></ul>";if(t.hasClass("MsoListParagraphCxSpFirst")||t.hasClass("MsoNormal")?(i=this.dom(o),t.before(i)):a>e&&0!==e&&(r=this.dom(o),s.append(r),i=r),a<e){let t=e-a+1;for(let e=0;e<t;e++)i=i.parent()}t.find("span").first().unwrap(),s=this.dom("<li>"+t.html().trim()+"</li>"),i||(t.before(o),i=t.prev()),i.append(s),t.remove(),e=a}else i=null,e=0}))}}l.CleanerDocumentParser=j;class V{constructor(t){this.app=t,this.config=t.config,this.selector="pre code, pre, code"}escapeHtml(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}encodeEntities(t){return this.decodeEntities(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}encodePhp(t){return t.replace(/<\?(php)?/g,"&lt;?$1").replace(/\?>/g,"?&gt;")}decodeEntitiesOutsidePreAndCode(t){const e=[],s="%%%PLACEHOLDER%%%";return(t=>{const e=document.createElement("textarea");return e.innerHTML=t,e.value})(t=t.replace(/<(pre|code)\b[^>]*>[\s\S]*?<\/\1>/gi,(t=>{const i=e.length;return e.push(t),`${s}${i}%%%`}))).replace(new RegExp(`${s}(\\d+)%%%`,"g"),((t,s)=>e[Number(s)]))}decodeEntitiesInsidePreAndCode(t){const e=t=>{const e=document.createElement("textarea");return e.innerHTML=t,e.value};return t=(t=t.replace(/<pre\b([^>]*)>([\s\S]*?)<\/pre>/gi,((t,s,i)=>`<pre${s}>${e(i)}</pre>`))).replace(/<code\b([^>]*)>([\s\S]*?)<\/code>/gi,((t,s,i)=>`<code${s}>${e(i)}</code>`))}encodeCode(t){return t=t.replace(/<\/code--><\/code><\/pre><code>/gi,"</code></pre>").replace(/<\/pre-->/gi,"</pre>").replace(/=-->/gi,"=>"),t=(t=(t=(t=this.encodeAttrSings(t)).replace(/<\s/gi,"&lt; ").replace(/<([^>]+)</gi,"&lt;$1<").replace(/<(.*?)>/gi,"xtagstartz$1xtagendz")).replace(/xtagstartzpre(.*?)xtagendz/g,"<pre$1>").replace(/xtagstartzcode(.*?)xtagendz/g,"<code$1>").replace(/xtagstartz\/codextagendz/g,"</code>").replace(/xtagstartz\/prextagendz/g,"</pre>")).replace(/&lt;!--\?(php)?/gi,"&lt;?$1").replace(/\?--&gt/g,"?&gt;").replace(/<!--\?(php)?/gi,"&lt;?$1").replace(/\?-->/g,"?&gt;"),t=(t=this._encodeCode(t)).replace(/xtagstartz([\w\W]*?)xtagendz/g,"<$1>").replace(/xtagstartz\/(.*?)xtagendz/g,"</$1>"),t=this.decodeAttrSings(t)}_encodeCodeContent(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}encodeAttrSings(t){return t.replace(/="(.*?)"/g,(t=>t.replace(/</g,"xlesssignz").replace(/>/g,"xmoresignz")))}decodeAttrSings(t){return t.replace(/xlesssignz/g,"<").replace(/xmoresignz/g,">")}decodeEntities(t){return t.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&")}decodeHref(t){return t.replace(/href="(.*?)&amp;(.*?)"/g,'href="$1&$2"')}decodeSpecialCharsInAttributes(t){return t.replace(/<([a-z][a-z0-9]*)\b([^>]*)>/gi,((t,e,s)=>`<${e}${s.replace(/(["'])(?:(?=(\\?))\2.)*?\1/g,(t=>t.replace(/&amp;/g,"&")))}>`))}_encodeCode(t){return new T(this.app).wrap(t,(t=>{t.find(this.selector).each((t=>this._encodeNode(t)))}))}_encodeNode(t){let e=t.get();if(t.tag("pre")&&"CODE"===e.firstChild?.tagName)return;let s=e.innerHTML.replace(/xtagstartz/g,"<").replace(/xtagendz/g,">");"CODE"===e.tagName&&"PRE"!==e.parentNode.tagName?e.textContent=this.encodeEntities(s):e.textContent=this._encodeNodeHtml(this.decodeEntities(s))}_encodeNodeHtml(t){const e=this.config.get("pre.spaces");return t=t.replace(/&nbsp;/g," ").replace(/<br\s?\/?>/g,"\n"),e?t.replace(/\t/g,new Array(e+1).join(" ")):t}}l.CleanerEncoder=V;class z{constructor(t){this.app=t,this.config=t.config}addNofollow(t){const e=new T(this.app);return this.config.is("link.nofollow")?e.wrap(t,(t=>{t.find("a").attr("rel","nofollow")})):t}addHttps(t){return this.config.is("https")?t.replace(/(href|src|srcset)="http:\/\//gi,'$1="https://'):t}addBrToBlocks(t){return t.replace(/<\/(div|li|dt|dd|td|p|h[1-6])>\n?/gi,"</$1><br>")}}l.CleanerModifier=z;class W{constructor(t){this.app=t,this.config=t.config,this.utils=new T(this.app),this.tags=this.config.get("tags"),this.blockListTags=this.utils.removeFromArrayByValue(this.tags.block.concat(),["ul","ol","li"]),this.inlines=this.utils.removeFromArrayByValue(this.tags.inline,"a")}removeDoctype(t){return t.replace(new RegExp("<!doctype[^>]*>","gi"),"")}removeFragmentEmptyTags(t){return t.startsWith("\x3c!--StartFragment--\x3e")?t=(t=t.replace(/<p><\/p>/g,"")).replace(/^<!--StartFragment-->(?:<span[^>]*>\s*){1,2}([\s\S]*?)(?:<\/span>\s*){1,2}$/,"\x3c!--StartFragment--\x3e$1"):t}removeComments(t){return(t=(t=t.replace(/<!--StartFragment-->/g,"")).replace(/<!--EndFragment-->/g,"")).replace(/<!--[\s\S]*?-->\n?/g,"")}removeInvisibleChars(t){return t.replace(/\uFEFF/g,"")}removeMarkers(t){return this.utils.wrap(t,(t=>{t.find(".rx-plus-button").remove(),t.find(".rx-pastemarker").removeClass("rx-pastemarker"),t.find(".rx-pasteitems").removeClass("rx-pasteitems"),t.find(".rx-selection-marker").remove()}))}removeEmptySpans(t){return this.utils.wrap(t,(t=>{t.find("span").each(this.removeEmptySpan.bind(this))}))}removeSpanNbsp(t){return this.utils.wrap(t,(t=>{t.find("span").each((t=>{"&nbsp;"===t.html()&&t.html(" ").unwrap()}))}))}removeAllAttributes(t,e){const s={a:["href","target"],img:["src","srcset","alt","data-state-src","data-state-srcset"]},i=e.allowedAttributes||[],r=e.allowedClasses||[];return t=this.utils.wrap(t,(t=>{t.find("*").each((t=>{const e=new Set(s[t.tag()]||[]),a=t.get();Array.from(a.attributes).forEach((t=>{if("class"===t.name){const t=a.className.split(/\s+/).filter((t=>r.includes(t.toLowerCase())));t.length>0?a.className=t.join(" "):a.removeAttribute("class")}else if(!e.has(t.name)){if(i&&i.includes(t.name))return;a.removeAttribute(t.name)}}))}))}))}removeEmptyInlines(t){return this.utils.wrap(t,(t=>{t.find(this.tags.inline.join(",")).each(this.removeEmptyTag.bind(this))}))}removeEmptyAttrs(t,e){return this.utils.wrap(t,(t=>{for(var s=0;s<e.length;s++)t.find("["+e[s]+'=""]').removeAttr(e[s])}))}removeEmptyTag(t){let e=t.html().trim();0===t.get().attributes.length&&""===e&&t.unwrap()}removeEmptySpan(t){0===t.get().attributes.length&&t.unwrap()}removeTags(t,e){const s=e?/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi:/(<([^>]+)>)/gi,i=e?(t,s)=>-1===e.indexOf(s.toLowerCase())?t:"":"";return t.replace(s,i)}removeTagsWithContent(t,e){return this.utils.wrap(t,(t=>{t.find(e.join(",")).remove()}))}removeTagsExcept(t,e){return t.replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,((t,s)=>e.includes(s.toLowerCase())?t:""))}removeBlockTags(t,e,s){let i=[...this.tags.block];return s&&(i=this.utils.removeFromArrayByValue(i,s)),e&&(i=this.utils.extendArray(i,e)),this.removeTags(t,i)}removeBlockTagsInside(t,e){return this.utils.wrap(t,(t=>{t.find(e.join(",")).each(this._removeBlockTagsInside.bind(this))}))}removeInlineStyles(t){return this.utils.wrap(t,(t=>{t.find(this.inlines.join(",")).removeAttr("style")}))}removeStyleAttr(t,e){return e=e||"",this.utils.wrap(t,(t=>{t.find("*").not("[data-rx-style-cache]"+e).removeAttr("style")}))}removeBreakline(t){return t.replace(/<br\s?\/?>/gi,"")}_removeBlockTagsInside(t){let e=t.tag("li")?this.blockListTags:this.tags.block;t.find(e.join(",")).append("<br>").unwrap()}}l.CleanerRemover=W;class Z{constructor(t){this.app=t,this.dom=t.dom,this.stored={},this.storedIndex=0,this.storedComments=[],this._selectors={code:["pre","code"],embed:["figure"],picture:["picture"],noneditable:[`[${t.opts.get("dataBlock")}=noneditable]`],noparse:["[data-noparse]"],images:["img"],svg:["svg"],links:["a"],lists:["ul","ol"],headings:["h1","h2","h3","h4","h5","h6"]}}store(t,e){return this._processStorage(t,e,this._selectors[e],this._store.bind(this))}storeComments(t){let e=t.match(/<!--([\w\W]*?)-->/gi);return e?(t=this.store(t,"code"),e.forEach(((e,s)=>{t=t.replace(e,`#####xstarthtmlcommentzz${s}xendhtmlcommentzz#####`),this.storedComments.push(e)})),this.restore(t,"code")):t}storeTemplateSyntax(t,e){return Object.entries(e).forEach((([e,s])=>{const i=`ts__${e}`;t=t.replace(new RegExp(`${s[0]}(.*?)${s[1]}`,"gi"),`\x3c!--${i}$1${i}--\x3e`)})),t}restore(t,e){const s=this.stored[e];return s?(s.forEach(((s,i)=>{t=t.replace(`####_${e}${i}_####`,s)})),t):t}restoreComments(t){return this.storedComments.forEach(((e,s)=>{const i=e.replace(/\$/g,"&#36;");t=t.replace(`#####xstarthtmlcommentzz${s}xendhtmlcommentzz#####`,i)})),t}restoreTemplateSyntax(t,e){const s=new T(this.app);return Object.entries(e).forEach((([e,i])=>{const r=`ts__${e}`;t=t.replace(new RegExp(`\x3c!--${r}(.*?)${r}--\x3e`,"gi"),s.escapeBackslash(i[0])+"$1"+s.escapeBackslash(i[1]))})),t.replace(/\{\{&gt;/gi,"{{>")}_processStorage(t,e,s,i){return s.forEach((s=>{const r=this._getElementsFromHtml(t,s);t=i(t,e,r)})),t}_store(t,e,s){return s.length?(this.stored[e]=this.stored[e]||[],s.forEach((s=>{this.stored[e][this.storedIndex]=s,t=t.replace(s,`####_${e}${this.storedIndex}_####`),this.storedIndex++})),t):t}_getElementsFromHtml(t,e){const s=[],i=document.createElement("template");i.innerHTML=t;return i.content.querySelectorAll(e).forEach((t=>{s.push(t.outerHTML)})),s}}l.CleanerStorage=Z;class U{constructor(t){this.app=t}convertForms(t){return this._transform(t,"form",this._convertForm)}convertVideo(t){return this._transform(t,"video",this._convertVideo)}convertFrames(t){return this._transform(t,"iframe",this._convertFrame)}convertSvgSpan(t){return this._transform(t,"svg",this._convertSvgSpan)}revertForms(t){return this._transform(t,".rx-div-form",this._revertForm)}revertFrames(t){return this._transform(t,".rx-figure-iframe",this._revertFrame)}revertSvgSpan(t){return this._transform(t,"svg",this._revertSvgSpan)}_transform(t,e,s){return new T(this.app).wrap(t,(t=>{t.find(e).each((t=>s(t)))}))}_convertForm(t){t.replaceTag("div").addClass("rx-div-form")}_convertVideo(t){t.closest("figure").length||t.wrap("<figure>")}_convertFrame(t){t.closest("figure").length||t.wrap("<figure>").parent().addClass("rx-figure-iframe")}_convertSvgSpan(t){const e=t.parent();e.is("span")&&e.attr("contenteditable",!1)}_revertForm(t){t.replaceTag("form").removeClass("rx-div-form")}_revertFrame(t){0!==t.get().attributes.length||t.find("figcaption, div").length?t.removeClass("rx-figure-iframe"):t.unwrap()}_revertSvgSpan(t){const e=t.parent();e.is("span")&&e.removeAttr("contenteditable")}}l.CleanerTransformer=U;class q{constructor(t){this.app=t}sanitize(t){const e=(new DOMParser).parseFromString(t,"text/html").body,s=e.querySelectorAll("*");for(const t of s)t.hasAttribute("src")&&this._sanitizeSrc(t),"A"===t.tagName&&t.hasAttribute("href")&&this._sanitizeHref(t),t.hasAttribute("srcdoc")&&t.removeAttribute("srcdoc"),this._removeEventAttributes(t);return e.innerHTML}_sanitizeSrc(t){const e=t.getAttribute("src");if(!e)return;const s=e.trim().toLowerCase();(s.startsWith("javascript:")||!["IMG"].includes(t.tagName)&&s.startsWith("data:"))&&t.setAttribute("src","")}_sanitizeHref(t){const e=t.getAttribute("href");if(!e)return;e.trim().toLowerCase().startsWith("javascript:")&&t.setAttribute("href","")}_removeEventAttributes(t){const e=t.attributes;for(let s=e.length-1;s>=0;s--){const i=e[s];/^on/i.test(i.name)&&t.removeAttribute(i.name)}}}l.Sanitizer=q;class K{constructor(t){this.app=t,this.dom=t.dom,this.config=t.config,this.editor=t.editor,this.blockTags=this.config.get("tags.block"),this.inlineTags=this.config.get("tags.inline")}is(t,e,s=!0){const i="text"===e?t:this._node(t),r={inline:()=>this._isElement(i)&&this._isInlineTag(i.tagName,s&&i),"block-data":()=>this._isElement(i)&&i.hasAttribute("data-rx-type"),"block-data-not-inline":()=>this._isElement(i)&&i.hasAttribute("data-rx-type")&&!i.hasAttribute("data-rx-inline"),"block-first":()=>this._isElement(i)&&i.hasAttribute("data-rx-first-level"),block:()=>this._isElement(i)&&this._isBlockTag(i.tagName),element:()=>this._isElement(i),text:()=>"string"==typeof i&&!/^\s*<(\w+|!)[^>]*>/.test(i)||this._isTextNode(i),list:()=>this._isElement(i)&&["ul","ol"].includes(i.tagName.toLowerCase()),heading:()=>this._isElement(i)&&["h1","h2","h3","h4","h5","h6"].includes(i.tagName.toLowerCase())};return!!r[e]&&r[e]()}isTool(t){return this.dom(t).closest(".rx-in-tool").length>0}isType(t,e){return e==this.getType(t)}isTag(t,e){return this._node(t).tagName.toLowerCase()===e}isEmpty(t){let e=this._node(t);return!e||(3===e.nodeType?!e.textContent.trim().replace(/\n/,""):!e.innerHTML)}isElementVisibleInScroll(t){const e=this.editor.getEditor(),s=this.dom(e).get().getBoundingClientRect(),i=this.dom(t).get().getBoundingClientRect();return i.top>=s.top&&i.bottom<=s.bottom}getInlines(t,e){if(!t)return[];let s=this._node(t);s.nodeType===Node.TEXT_NODE&&(s=s.parentNode);const i=[];for(;s;){if(s.nodeType===Node.ELEMENT_NODE&&this.is(s,"inline")){if(s.tagName.toLowerCase()===e)break;i.push(s)}s=s.parentNode}return i}getType(t){return this.dom(t).attr("data-rx-type")}getDataBlock(t,e){const s=e?`[data-rx-type=${e}]`:"[data-rx-type]",i=this.dom(t).closest(s);return!!i.length&&i}getFirstLevel(t){return this.dom(t).closest("[data-rx-first-level]")}getBlocks(t,e){const s=this._node(t);let i=e||this.config.get("tags.parser");i=[...i,...l.customTags];const r=Array.from(s.childNodes).filter((t=>1===t.nodeType&&i.includes(t.tagName.toLowerCase())));return r}hasAttrs(t,e){const s=this.dom(t);return Object.entries(e).every((([t,e])=>s.attr(t)===e))}hasStyle(t,e){if(!e)return!1;const s=this.dom(t);return Object.entries(e).every((([t,e])=>{const i=s.css(t);return this._normalizeValue(t,i)===this._normalizeValue(t,e)}))}hasParent(t,e){return 0!==this.dom(t).closest("[data-rx-type="+e+"]").length}compareStyle(t,e){const s=new T(this.app),i=this.dom(t),r=s.cssToObject(i.attr("style"));return Object.keys(r).length===Object.keys(e).length&&Object.entries(e).every((([t,e])=>{const s=r[t];return void 0!==s&&this._normalizeValue(t,s)===this._normalizeValue(t,e)}))}_node(t){return this.dom(t).get()}_isTag(t){return void 0!==t&&t}_isTextNode(t){return t&&3===t.nodeType}_isBlockTag(t){return this.blockTags.includes(t.toLowerCase())}_isInlineTag(t,e){return this.inlineTags.includes(t.toLowerCase())&&(!e||!this.dom(e).hasClass("email-button"))}_isElement(t){return t&&t.nodeType&&1===t.nodeType}_normalizeValue(t,e){const s=new T(this.app);return e=(e=(e="string"==typeof e?e.replace(/'/g,'"'):e)||"").trim().replace(/;$/,""),(t.includes("color")||t.includes("background"))&&(e=(e=s.convertRgbToHex(e)).toLowerCase()),t.includes("family")&&(e=e.replace(/"/g,"")),e}}l.ElementInspector=K;class G{constructor(t){this.app=t,this.dom=t.dom}split(t,e=!0){const s=new K(this.app),i=new T(this.app),r=this.dom(t),a=this.dom(t).get().tagName.toLowerCase(),n=i.extractHtmlFromCaret(t),o=this.dom(`<${a}>`);r.cloneAttrs(o),11===n.nodeType?o.append(this.dom(n)):o.append(n),e&&r.after(o);const l=r.get().childNodes,h=l[l.length-1];s.is(h,"inline")&&(h.innerHTML.trim()||h.remove());const p=s.getType(o);if(p){this.app.create("block."+p,o)}return r.html().trim()||r.remove(),o}}l.ElementSplitter=G;class J{constructor(t,e,s,i){this.app=t,this.dom=t.dom,this.page=t.page,this.loc=t.loc,this.uuid=t.uuid,this.scroll=t.scroll,this.config=t.config,this.name=e,this.setter=i.getSetter(),this.form=i,this.obj=this._observe(s),this.obj&&this._build()}getType(){return this.obj.type}getElement(){return this.$tool}getInput(){return this.$input}getValue(){return this.$input.val().trim()}setValue(t){this.$input.val(t)}setFocus(){this.$input.focus()}trigger(t){this.setValue(t),this._triggerApi()}_build(){this._buildTool(),this._buildLabel(),this._buildInputElement(),this._buildInput&&this._buildInput(),this._applyProps(),this._buildEvents()}_buildTool(){this.$tool=this.dom("<div>").addClass("rx-form-item"),this.obj.hidden&&this.$tool.hide(),this.obj.auto&&this.$tool.css("flex","auto")}_buildLabel(){if(this.obj.label&&"checkbox"!==this.getDefaults().type){if(this.$label=this.dom("<label>").addClass("rx-form-label").html(this.loc.parse(this.obj.label)),this.obj.hint){const t=this.dom("<span>").addClass("rx-form-hint").html(`(${this.loc.parse(this.obj.hint)})`);this.$label.append(t)}this.$tool.append(this.$label)}}_buildInputElement(){this.$input=this.dom(`<${this.getDefaults().tag}>`).addClass(`rx${this.getDefaults().classname}`).attr({name:this.name,type:this.getDefaults().type,"data-type":this.obj.type}),this.$tool.append(this.$input)}_buildEvents(){const t=this._getEventTypes();t.length>0&&this.$input.on(t,this._catchSetter.bind(this))}_applyProps(){this.obj.placeholder&&this.$input.attr("placeholder",this.loc.parse(this.obj.placeholder)),this.obj.width&&this.$input.css("width",this.obj.width),this.obj.classname&&this.$input.addClass(this.obj.classname)}_getEventTypes(){const t=this.getDefaults().type;return"checkbox"===t||"select"===t?"change":"number"===t?"input blur change":this.setter?"input blur":""}_observe(t){return t.observer?this.app.api(t.observer,t,this.name):t}_catchSetter(t){"keydown"===t.type&&13!==t.which||(t.preventDefault(),this._triggerApi())}_triggerApi(){this.setter&&this.app.api(this.setter,this.form)}}l.ToolCheckbox=class extends J{getDefaults(){return{tag:"input",type:"checkbox",classname:"-form-checkbox"}}getValue(){return this.$input.val()}_buildInput(){if(this.$box=this.dom("<label>").addClass("rx-form-checkbox-label"),this.$box.append(this.$input),this.obj.text){const t=this.dom("<span>").html(this.loc.parse(this.obj.text));this.$box.append(t)}this.$tool.append(this.$box)}};l.ToolColor=class extends J{getDefaults(){return{tag:"input",type:"text",classname:"-form-input"}}setValue(t){const e=t||"#ffffff";this.$input.val(t||""),this.$toggle.css("background-color",e)}_buildInput(){this.$item=this.dom('<div class="rx-form-color-container">'),this.$toggle=this.dom('<div class="rx-form-color-toggle">'),this.$item.append(this.$input),this.$item.append(this.$toggle),this.$tool.append(this.$item),this.$input.on("keyup blur",this._changeColor.bind(this)),this.$toggle.on("click",this._toggleColorpicker.bind(this))}_changeColor(){const t=this._getColorValue(this.$input.val());this.$toggle.css("background-color",t)}_setColor(t,e){e||this.colorpicker.close(),t=this._getColorValue(t),this.trigger(t)}_getColorValue(t){return new T(this.app).normalizeColor(t)}_toggleColorpicker(t){if(t.preventDefault(),t.stopPropagation(),this.colorpicker&&this.colorpicker.isOpen())return this.colorpicker.close();this.colorpicker=new f(this.app,{$toggle:this.$toggle,colors:this.config.get("colors"),instant:!0,style:{color:this.getValue()},method:function(t,e){this._setColor(t,e)}.bind(this)})}};l.ToolInput=class extends J{getDefaults(){return{tag:"input",type:"text",classname:"-form-input"}}};l.ToolNumber=class extends J{getDefaults(){return{tag:"input",type:"number",classname:"-form-input"}}_buildInput(){this.$input.attr({min:0}).css("max-width","100px"),this.$tool.append(this.$input)}};l.ToolSelect=class extends J{getDefaults(){return{tag:"select",classname:"-form-select"}}_buildInput(){for(const[t,e]of Object.entries(this.obj.options)){const s=this.dom("<option>").val(t).html(this.loc.parse(e));this.$input.append(s)}this.$tool.append(this.$input)}};l.ToolTextarea=class extends J{getDefaults(){return{tag:"textarea",classname:"-form-textarea"}}setFocus(){this.$input.focus(),this.$input.get().setSelectionRange(0,0),this.$input.scrollTop(0)}_buildInput(){this.obj.rows&&this.$input.attr("rows",this.obj.rows),this.$input.attr("data-gramm_editor",!1),this.$tool.append(this.$input)}};l.ToolUpload=class extends J{getDefaults(){return{tag:"input",type:"hidden",classname:"-form-input"}}setValue(t){t=t||"",this.upload&&this.upload.setImage(t),this.$input.val(t)}_buildInput(){this.$tool.append(this.$input),this._buildUpload()}_buildUpload(){this.$upload=this.dom("<input>").attr("type","file"),this.$tool.append(this.$upload);const t=this.obj.trigger?{instance:this,method:"trigger"}:{};this.upload=new x(this.app,{element:this.$upload,params:this.obj.upload,trigger:t})}};l.ToolButton=class extends J{getDefaults(){return{tag:"button",type:"button",classname:"-form-button"}}_buildInput(){this.$input.attr("data-role",this.obj.role),this.$input.attr("data-command",this.obj.command),this.$input.html(this.loc.parse(this.obj.text||this.obj.title)),this.obj.role&&this.$input.addClass("rx-form-button-"+this.obj.role),this.obj.push&&this.$tool.css("margin-left","auto"),this.obj.dismiss?this.$input.on("click",(t=>{t.preventDefault(),this.app.dropdown.restoreSelection(),this.app.dropdown.close()})):this.obj.command&&this.$input.on("click",(t=>{t.preventDefault(),this.app.dropdown.restoreSelection(),this.app.api(this.obj.command,this.form)}))}};class X{constructor(t){this.app=t}init(){this.manager=new Y(this.app),this.focusManager=new Q(this.app,this.manager),this.buildBSModal()}stop(){this.app.editor.destroy(),this.manager.removeAllContainers()}get(t){return this.manager.getContainer(t)}toggleFocus(){this.manager.toggleFocus()}setFocus(){this.focusManager.setFocus()}setBlur(){this.focusManager.setBlur()}hasFocus(){return this.focusManager.hasFocus()}isExternal(t){return this.manager.getTarget(t)}buildBSModal(){this.config.set("bsmodal",!!this.manager.getContainer("main").closest(".modal-dialog").length)}}class Q{constructor(t,e){this.app=t,this.manager=e,this.blurClass="rx-in-blur",this.focusClass="rx-in-focus"}setFocus(){this.manager.getContainer("main").swapClass(this.blurClass,this.focusClass)}setBlur(){this.manager.getContainer("main").swapClass(this.focusClass,this.blurClass)}hasFocus(){return this.manager.getContainer("main").hasClass(this.focusClass)}}class Y{constructor(t){this.app=t,this.uuid=t.uuid,this.dom=t.dom,this.config=t.config,this.element=t.element,this.elements=["toolbox","statusbar"],this.$body=t.page.getBody(),this.$container=null,this.containers={},this.targets={},this._initializeContainers()}createMainContainer(){this.$container=this.dom("<div>").attr("rx-uuid",this.uuid).addClass(`rx-container rx-container-${this.uuid}`).addClass(this.config.is("nocontainer")?"":"rx-main-container"),this.config.is("structure")&&this.$container.addClass("rx-main-wym"),this.element.after(this.$container)}removeAllContainers(){Object.values(this.containers).forEach((t=>t.remove())),this.$container&&this.$container.remove(),this.containers={},this.targets={}}getContainer(t){return"main"===t?this.$container:this.containers[t]}getTarget(t){return this.targets[t]}toggleFocus(){(this.config.is("toolbar.sharedTarget")||this.config.is("statusbar.sharedTarget"))&&this.elements.forEach((t=>{const e=this.$body.find(`.rx-${t}-external`),s=this.$body.find(`.rx-${t}-external.rx-${t}-container-${this.uuid}`);e.hide(),s.show()}))}_initializeContainers(){this.createMainContainer(),this._buildContainers(this.$container,this.config.get("containers.main")),this.elements.forEach((t=>this._buildExternal(t)))}_buildContainers(t,e){e.forEach((e=>{const s=this._createContainer(e,t);this.containers[e]=s,this._buildNestedContainers(e,s)}))}_createContainer(t,e){const s=this._getExternalTarget(t);s&&(this.targets[t]=s,e=s);const i=this.dom("<div>").addClass(`rx-${t}-container rx-${t}-container-${this.uuid}`);return s&&i.toggleClass(`rx-${t}-external`,this.getTarget(t)),this._getTargetElement(e).append(i),i}_getExternalTarget(t){return"toolbox"===t?this.config.get("toolbar.target"):"toolbar"!==t&&this.config.get(`${t}.target`)}_getTargetElement(t){return t?this.dom(t):this.$container}_buildNestedContainers(t,e){const s=this.config.get(`containers.${t}`);s&&this._buildContainers(e,s)}_buildExternal(t){if("toolbox"===t&&!this.config.is("toolbar.sharedTarget"))return;if("statusbar"===t&&!this.config.is("statusbar.sharedTarget"))return;this.$body.find(`.rx-${t}-external`).hide().first().show()}}class tt{constructor(t){this.app=t,this.config=t.config,this.intervalId=null,this._initAutosave()}send(){this.config.is("autosave.url")&&!this.config.is("autosave.interval")&&this._send()}_initAutosave(){if(!this.config.is("autosave.url")||!this.config.is("autosave.interval"))return;const t=this.config.get("autosave.interval");t&&"number"==typeof t&&t>0&&(this.intervalId=setInterval((()=>this._send()),t))}_send(){const t=this._getName(),e=this.config.get("autosave.url"),s=this.config.get("autosave.method"),i=this.config.get("autosave.data"),r=this._buildData(t,i);this._ajaxRequest(s,e,r,t)}_getName(){const t=this.config.get("autosave.name");if(t)return t;let e=this.app.element.getName();return e||`content${this.app.uuid}`}_buildData(t,e){const s=new T(this.app);let i={};return i[t]=this.app.element.getHtml(),s.extendData(i,e)}_ajaxRequest(t,e,s,i){this.ajax.request(t,{url:e,data:s,before:t=>this._beforeSend(t,i,s),success:t=>this._complete(t,i,s)})}_beforeSend(t,e,s){return!this.app.broadcast("autosave.before.send",{xhr:t,name:e,data:s}).isStopped()}_complete(t,e,s){const i=t&&t.error?"autosave.error":"autosave.send";this.app.broadcast(i,{name:e,data:s,response:t})}}class et{constructor(t){this.app=t,this.cm=!1}create(t){if(!this._isCodemirrorAvailable())return;const e=this._getCodemirrorConfig(),s=this._getCodemirrorInstance();return this.cm=s.fromTextArea(this._getElement(t.el),e),this._setAdditionalOptions(t),this.cm}destroy(){this.cm&&(this.cm.toTextArea(),this.cm=!1)}val(t){return this._isCodemirrorAvailable()&&this.cm?this.cm.getValue():t}_isCodemirrorAvailable(){return this.config.get("codemirror")}_getCodemirrorConfig(){const t=this.config.get("codemirror");return"object"==typeof t?t:{}}_getCodemirrorInstance(){return this.config.get("codemirrorSrc")||CodeMirror}_getElement(t){return this.dom(t).get()}_setAdditionalOptions(t){t.height&&this.cm.setSize(null,t.height),t.focus&&this.cm.focus()}}class st{constructor(t,e,s=!1){this.app=t,this.element=t.element,this.config={},this._init(s,e)}dump(){return this.config}is(t){let e=this.get(t);return void 0!==e&&!1!==e&&null!==e}set(t,e){t.split(".").reduce(((t,s,i,r)=>t[s]=i===r.length-1?e:t[s]||{}),this.config)}get(t){return t.split(".").reduce(((t,e)=>t?.[e]),this.config)}extend(t){this.opts=l.extend(!0,{},this.config,t)}remove(t){let e=t.split("."),s=e.pop();delete e.reduce(((t,e)=>t[e]||{}),this.config)[s]}_init(t,e){const s=t?"defaults"in t?t.defaults:{}:l.opts,i=l.extend(!0,{},s),r=l.extend(!0,i,l.settings),a=this._parseDataAttributes();this._updateObject(r,a);const n=l.extend(!0,{},r,a,e);this.config=l.extend(!0,n,e),this._configureTranslations(this.config)}_configureTranslations(t){const e=t.localization||t.translations;e&&l.addLang(e)}_updateObject(t,e){Object.keys(t).forEach((s=>{const i=s.toLowerCase();e.hasOwnProperty(i)&&("object"==typeof t[s]&&null!==t[s]&&"object"==typeof e[i]?this._updateObject(t[s],e[i]):t[s]=e[i])}))}_parseDataAttributes(){const t=this.element.get(),e={};return Array.from(t.attributes).forEach((t=>{t.name.startsWith("data-")&&this._processAttribute(t,e)})),e}_processAttribute(t,e){const s=t.name.slice(5).split("-");let i=e;s.forEach(((e,r)=>{r===s.length-1?i[e]=this._parseValue(t.value):i=this._getOrCreateNextLevel(i,e)}))}_parseValue(t){try{return JSON.parse(t)}catch(e){try{const e=t.replace(/(\w+)\s*:/g,'"$1":').replace(/:\s*([\w\[\]{]+)\s*/g,': "$1"').replace(/'/g,'"');return JSON.parse(e)}catch(e){return t}}}_getOrCreateNextLevel(t,e){return t[e]&&"object"==typeof t[e]&&!Array.isArray(t[e])||(t[e]={}),t[e]}}class it{constructor(t){this.app=t,this.triggered=!1}init(){this._initializeHotkeysConfig(),this.hotkeys=this.config.get("hotkeys"),this.hotkeysKeys=this._getHotkeysMap(),this.hotkeysShiftNums=this._getShiftedKeysMap()}add(t,e){this.hotkeys[t]=e}remove(t){this.config.set("hotkeys",this._removeKeyFromObject(t,this.config.get("hotkeys"))),this.config.set("hotkeysBase",this._removeKeyFromObject(t,this.config.get("hotkeysBase")))}popup(t,e){const s=this._getMetaKey();let i={},r=this._buildPopupItems(i,0,this.config.get("hotkeysBase"),s,"base");this._buildPopupItems(i,r,this.config.get("hotkeys"),s),this.app.dropdown.create("hotkeys",{items:i,passive:!0}),this.app.dropdown.open(t,e)}handle(t){return this.triggered=!1,!1===this.hotkeys?(this._disableDefaultShortcuts(t),!0):((t.ctrlKey||t.metaKey||t.shiftKey||t.altKey)&&Object.entries(this.hotkeys).forEach((([e,s])=>{this._buildHotkeyHandler(t,e,s)})),this.triggered)}_disableDefaultShortcuts(t){!t.ctrlKey&&!t.metaKey||66!==t.which&&73!==t.which||t.preventDefault()}_initializeHotkeysConfig(){this.config.is("hotkeysRemove")&&this.config.get("hotkeysRemove").forEach((t=>this.remove(t))),this.config.is("hotkeysAdd")&&Object.entries(this.config.get("hotkeysAdd")).forEach((([t,e])=>{this.config.set("hotkeys."+t,e)}))}_getHotkeysMap(){return{8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"}}_getShiftedKeysMap(){return{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|"}}_removeKeyFromObject(t,e){return Object.keys(e).reduce(((s,i)=>(i!==t&&(s[i]=e[i]),s)),{})}_getMetaKey(){return/Mac|iPhone|iPod|iPad/i.test(navigator.platform)?"Cmd":"Ctrl"}_buildPopupItems(t,e,s,i,r="custom"){return Object.entries(s).forEach((([s,a])=>{const n="base"===r?a:a.title,o="base"===r?s.replace("meta",i):a.name.replace("meta",i);t[e++]={title:n,classname:"rx-dropdown-item",shortcut:this._formatKeyDisplay(o,i)}})),e}_formatKeyDisplay(t,e){return t.split("+").map((t=>{const e=-1===t.search(/&/)?t.toUpperCase():t;return"Cmd"===t||"Ctrl"===t?`<span class="rx-hk-meta">${t}</span>`:"alt"===t?'<span class="rx-hk-alt">Alt</span>':"shift"===t?'<span class="rx-hk-shift">Shift</span>':`<span>${e}</span>`})).join("+")}_buildHotkeyHandler(t,e,s){e.split(",").forEach((e=>{"string"!=typeof e||Object.prototype.hasOwnProperty.call(s,"trigger")||this._handleHotkey(t,e.trim(),s)}))}_handleHotkey(t,e,s){const i=this.hotkeysKeys[t.keyCode],r=91!==t.which&&String.fromCharCode(t.which).toLowerCase();let a=this._getModifiers(t,["meta","ctrl","alt","shift"],i);const n=this._buildPossibleKeys(a,i,r);e=e.toLowerCase().split(" ");for(const i of e)if(n[i])return t.preventDefault(),this.triggered=!0,void this.app.api(s.command,s.params,t,!0)}_getModifiers(t,e,s){return e.reduce(((e,i)=>(t[i+"Key"]&&s!==i&&(e+=i+"+"),e)),93===t.keyCode?"meta+":"")}_buildPossibleKeys(t,e,s){const i={};return e&&(i[t+e]=!0),s&&(i[t+s]=!0,i[t+this.hotkeysShiftNums[s]]=!0,"shift+"===t&&(i[this.hotkeysShiftNums[s]]=!0)),i}}class rt{constructor(t,e){this.language=e,this.translations=l.lang[this.language]||l.lang.en}dump(){return this.translations}has(t){return""!==this.get(t)}set(t){l.extend(!0,l.lang,t),this._init()}get(t){let e=this._fetchFromVars(t)||"en"!==this.language&&this._fetchFromDefaultLang(t);return!1===e?t:void 0===e?"":e}parse(t){return"string"!=typeof t?t:this._replaceLanguageVariables(t)}_fetchFromVars(t){return this._getValue(t,this.translations)}_fetchFromDefaultLang(t){return this._getValue(t,l.lang.en)}_replaceLanguageVariables(t){let e=t.match(/## (.*?) ##/g);return e&&e.forEach((e=>{let s=e.replace(/## /g,"").replace(/ ##/g,"");t=t.replace(e,this.get(s))})),t}_getValue(t,e){return t.split(".").reduce(((t,e)=>t&&t[e]),e)}}class at{constructor(t){this.app=t,this.styles={},this.observer=null,this.trigger=!0}build(){if(!window.MutationObserver)return;const t=this.app.editor.getLayout().get();this.observer=this._createObserver(t),this.observer.observe(t,{attributes:!0,subtree:!0,childList:!0,characterData:!0,characterDataOldValue:!0})}stop(){this.observer&&this.observer.disconnect(),this.trigger=!0}setTrigger(t){this.trigger=t}addKeys(t,e,s){this.config.set(`active.${t}.${e}`,s)}getKeys(){return this.styles={},this._collectActiveKeys()}getStyles(){return this.styles}observeUnset(){this._resetActiveStates()}observe(){if(!this._shouldObserveToolbars())return;this.styles={};let t=this._collectActiveKeys();this._resetActiveStates(),t.length&&this.app.ui.setActiveKeys(["toolbar","extrabar","context"],t,this.styles)}_shouldObserveToolbars(){return this.config.is("toolbar")||this.config.is("extrabar")||this.app.context.isOpen()}_createObserver(t){return new MutationObserver((e=>{this._handleMutation(e[e.length-1],t)}))}_handleMutation(t,e){"attributes"===t.type&&t.target===e||this.trigger&&(this.app.broadcast("observer.change"),this.app.editor.adjustHeight(),this.app.placeholder.trigger(),this.app.block.trigger(t),this.app.blocks.trigger(t),this.app.sync.trigger())}_collectActiveKeys(){const t=this.app.block.get();new L(this.app);if(!t)return[];const e=this._collectObservedTags(t),s=this._collectInstanceTypes(t);let i=[...this._getKeysForTags(e,t),...this._getKeysForTypes(t,s),...s];const r=this.config.get("active.rules");return r&&Object.entries(r).forEach((([e,s])=>{if(s(t.getBlock().get()))i.push(e);else{const t=i.indexOf(e);-1!==t&&i.splice(t,1)}})),i}_collectInstanceTypes(t){if(!t)return[];const e=[];if(["table","layout","wrapper"].forEach((s=>{t.getClosest(s)&&e.push(s)})),t.isType("todoitem")&&e.push("todo"),t.isType("listitem")){const s=t.getParentTopInstance();s&&e.push(s.getTag())}return e}_collectObservedTags(t){const e=new L(this.app);let s=e.is()?e.getNodes({type:"inline",selected:"inside",link:!0,buttons:!0}):[];!e.is()&&t&&t.isType("image")&&t.getLinkElement()&&(s=[t.getLinkElement().get(0)]);let i=t?[t.getTag()]:[];return s.length&&(i=[...i,...this._collectInlineTags(s)]),i}_collectInlineTags(t){const e=new T(this.app),s=[];return t.forEach((t=>{const i=e.cssToObject(t.getAttribute("style"));i.color&&(this.styles.color=i.color),i.background&&(this.styles.background=i.background),s.push(t.tagName.toLowerCase())})),s}_getKeysForTags(t,e){const s=this.config.get("tags.inline"),i=this.config.get("active.tags");return t.reduce(((t,r)=>{if(!e.isEditable()&&s.includes(r))return t;const a=i[r];return a?t.concat(a):t}),[])}_getKeysForTypes(t,e){if(!t)return[];return[...this.config.get("active.blocks")[t.getType()]||[],...e]}_resetActiveStates(){this.app.toolbar.unsetActive(),this.app.extrabar.unsetActive(),this.app.context.unsetActive()}}class nt{constructor(t){this.app=t,this.dom=t.dom,this.$win=this.dom(window),this.$doc=this.dom(document),this.$body=this.dom("body")}getWin(){return this._isIframeMode()?this.getFrameWin():this.$win}getWinNode(){return this._isIframeMode()?this.getFrameWinNode():this.$win.get()}getDoc(t=!0){return this._isIframeMode()&&t?this.getFrameDoc():this.$doc}getDocNode(){return this._isIframeMode()?this.getFrameDocNode():this.$doc.get()}getBody(){return this.$body}getFrameBody(){return this._isIframeMode()?this.getFrameDoc().find("body"):this.$body}getFrameHead(){return this.getFrameDoc().find("head")}getFrameDoc(){return this.dom(this.getFrameDocNode())}getFrameDocNode(){const t=this._getEditorNode();return t&&t.contentWindow?t.contentWindow.document:null}getFrameWin(){return this.dom(this.getFrameWinNode())}getFrameWinNode(){const t=this._getEditorNode();return t&&t.contentWindow?t.contentWindow:null}_isIframeMode(){return this.app.isMode("iframe")}_getEditorNode(){return this.app.getEditor()?.get()}}class ot{constructor(t){this.app=t,this.placeholderClass="rx-placeholder",this.observerTimer=null}build(){const t=this.config.get("placeholder"),e=this.app.element.getPlaceholder()||t;e&&this._setEditorPlaceholder(e)}handleClick(t){this._isPlaceholderClicked(t)&&(t.preventDefault(),t.stopPropagation(),this.app.editor.setFocus("start",!1))}trigger(){this.$editor=this.app.editor.getLayout(),this.app.editor.isEmpty()?this.show():this.hide()}set(t){this._setEditorPlaceholder(t)}toggle(){clearTimeout(this.observerTimer),this.observerTimer=setTimeout((()=>this.trigger()),10)}show(){this.$editor.addClass(this.placeholderClass)}hide(){this.$editor.removeClass(this.placeholderClass)}_isPlaceholderClicked(t){return this.dom(t.target).hasClass(this.placeholderClass)}_setEditorPlaceholder(t){this.app.editor.getLayout().attr("placeholder",t)}}class lt{constructor(t){this.app=t,this.$progress=null,this.$progressBar=null}stop(){this.hide()}show(t){this.hide(),this._createProgressElements();(t&&"boolean"!=typeof t?t:this.app.page.getBody()).append(this.$progress)}hide(){this.$progress&&(this.$progress.remove(),this.$progress=null,this.$progressBar=null)}_createProgressElements(){this.$progress=this.dom("<div>").addClass("rx-editor-progress").attr("id","rx-progress"),this.$progressBar=this.dom("<span>"),this.$progress.append(this.$progressBar)}}class ht{constructor(t){this.app=t,this.config=t.config,this.dom=t.dom,this.scrolltop=null,this.reserved=null}save(){this.scrolltop=this.getTarget().scrollTop()}restore(){null!==this.scrolltop&&(this.getTarget().scrollTop(this.scrolltop),this.scrolltop=null)}getScrollTop(){return this.getTarget().scrollTop()}isTarget(){return this.config.is("scrollTarget")}resetTarget(){this.reserved&&(this.config.set("scrollTarget",this.reserved!==window&&this.reserved),this.reserved=null)}setTarget(t){this.reserved=this.config.get("scrollTarget")||window,this.config.set("scrollTarget",t)}getTarget(){return this.dom(this.config.get("scrollTarget")||window)}getVisibility(t=0){const e=this.app.container.get("main").get(),s=this.getTarget().get(),i=e.getBoundingClientRect();let r,a,n;s===window?(r=window.scrollY,a=window.innerHeight,n=0):(r=s.scrollTop,a=s.clientHeight,n=s.getBoundingClientRect().top);const o=this._getOffsetTop(e,s),l=o+i.height,h=r+a;return{isTopVisible:o>=r&&o<=h-t,isBottomVisible:l>=r+t&&l<=h,isTopEdge:a<=i.top+t,isBottomEdge:a<=i.bottom,top:o+r,bottom:a-o+r}}_getOffsetTop(t,e){let s=0,i=t;for(;i&&i!==e;)s+=i.offsetTop,i=i.offsetParent;return s}scrollTo(t,e=60){if(t=this.dom(t),!this._isScrollVisible(t)){const s=t.offset().top-e,i=this.getTarget();i.scrollTop(s),setTimeout((()=>i.scrollTop(s)),1)}}_isScrollVisible(t,e=null){const s=this.dom(t).offset().top,i=e||this.getTarget();return s<=i.scrollTop()+i.height()}}class pt{constructor(t){this.app=t,this.eventname="rx-source-events"}init(){this.$source=this.dom("<textarea>").addClass("rx-source").attr("data-gramm_editor",!1),this.app.container.get("source").append(this.$source)}setContent(t){this.$source.val(t)}getContent(){let t=this.$source.val();return this.app.codemirror.val(t)}getElement(){return this.$source}getSource(){return this.$source}update(t){this.app.editor.setSource(t)}is(){const t=this.app.container.get("source");return t&&t.length&&"none"!==t.css("display")}toggle(){this.is()?this.close():this.open()}open(){const t=this.app.container.get("editor"),e=this.app.container.get("source");this.app.broadcast("source.before.open");let s=this.app.editor.getContent(!0);const i=this._adjustHeight(t);this._prepareSource(s),this._toggleView(t,e,!0),this._initializeCodemirror(i),this._setUIState(!0),this._setHeight(),this.app.broadcast("source.open")}close(){if(!this.is())return;this.app.broadcast("source.before.close");const t=this.app.container.get("editor"),e=this.app.container.get("source"),s=this.getContent();this.app.codemirror.destroy(),this._toggleView(t,e,!1),this.app.editor.setContent({html:s,caret:"start"}),this._setUIState(!1),this.app.broadcast("source.close")}_adjustHeight(t){const e=this._getMinHeight(),s=Math.max(this.$source.get().scrollHeight,e);return this.$source.css("height","auto").css("height",`${s}px`),Math.max(t.height(),e)}_getMinHeight(){return parseInt(this.config.get("minHeight"))}_prepareSource(t){this.$source.val(t).on(`focus.${this.eventname}`,this._handleFocus.bind(this)).on(`input.${this.eventname}`,this._handleChanges.bind(this)).on(`keydown.${this.eventname}`,this.app.event.handleTextareaTab.bind(this)),this.app.blocks.unset(),this.app.block.unset(),this.app.editor.deselectAll()}_toggleView(t,e,s){s?(t.hide(),e.show()):(e.hide(),t.show())}_initializeCodemirror(t){const e=this.app.codemirror.create({el:this.$source,height:t,focus:!0});e&&(e.setSize("100%","100%"),e.on("change",this._handleChanges.bind(this)),e.on("focus",this._handleFocus.bind(this)))}_setUIState(t){t?(this.app.ui.close(),this.app.ui.disable(),this.app.toolbar.enableSticky(),this.app.toolbar.setToggled("html"),this.app.extrabar.setToggled("html")):(this.app.ui.enable(),this.app.toolbar.unsetToggled("html"),this.app.extrabar.unsetToggled("html"))}_handleFocus(){this.app.editor.setFocus()}_handleChanges(t){const e=this.getContent();this.update(e),this._setHeight(),this.app.broadcast("source.change",{e:t})}_setHeight(){this.$source.get().style.height="auto",this.$source.get().style.height=`${this.$source.get().scrollHeight}px`}}class ct{constructor(t){this.app=t,this.storage=!1,this.undoStorage=[],this.redoStorage=[]}load(){this.clear(),this.app.isMode("iframe")?this.app.on("editor.ready",this.loadInitialState.bind(this)):this.loadInitialState()}stop(){this.clear()}get(){return this.undoStorage}clear(){this.storage=!1,this.undoStorage=[],this.redoStorage=[]}trigger(){const t=this._createState();t&&this._addStateToUndo(t)}add(t){if(this._isSpecialKeyEvent(t)||!this.app.observer.trigger)return;const e=this._createState();e&&this._updateCurrentState(e)}listen(t){return this._isUndo(t)?(t.preventDefault(),this.undo(),!0):!!this._isRedo(t)&&(t.preventDefault(),this.redo(),!0)}undo(){if(!this._hasUndo())return;const t=this._getPreviousUndoState();if(t){if(this._isToolMode())return void this.undoStorage.push(t);this._saveRedoState(),this._rebuildEditor(t,"undo")}}redo(){if(!this._hasRedo())return;const t=this.redoStorage.pop();if(t){if(this._isToolMode())return void this.redoStorage.push(t);this._addStateToUndo(t),this._rebuildEditor(t,"redo"),this.undoStorage.splice(this.undoStorage.length-1,1)}}loadInitialState(){const t=this._createState();t&&(this.undoStorage.push(t),this.storage=t)}_isSpecialKeyEvent(t){return t&&(t.ctrlKey||t.metaKey||this._isUndo(t)||this._isRedo(t))}_updateCurrentState(t){const e=this.undoStorage.length-1;e>=0&&(this.undoStorage[e]=t)}_addStateToUndo(t){const e=this.undoStorage[this.undoStorage.length-1];void 0!==e&&e.html===t.html||(this.undoStorage.push({html:t.html,offset:t.offset,synced:!0}),this._trimUndoStorage())}_trimUndoStorage(){const t=this.config.get("state.limit");this.undoStorage.length>t&&(this.undoStorage=this.undoStorage.slice(-t))}_getPreviousUndoState(){const t=this.undoStorage.length-2;return-1!==t&&this.undoStorage.splice(t+1,1),this.undoStorage[t]}_saveRedoState(){const t=this._createState();if(t){const e=this.config.get("state.limit");this.redoStorage.push(t),this.redoStorage=this.redoStorage.slice(0,e)}}_parseHtml(t){return new N(this.app).parse(t,{type:"html",nodes:!0})}_restoreEditorContent(t,e){this.app.editor.getLayout().html(t),this.app.editor.build(),this.app.has("email")&&this.app.email._build(!0)}_restoreEmailOptions(t){this.app.has("email")&&(this.app.email.reset(),this.app.email.setOptions(t.emailOptions))}_restoreFocus(t){const e=new _(this.app),s=this.app.editor.getLayout().find(".rx-block-state");0!==s.length?setTimeout((()=>{this.app.block.set(s),e.set(t.offset,s),s.removeClass("rx-block-state")}),1):!1===t.offset?this.app.editor.setFocus("start",!1):(e.set(t.offset),this.app.event.setMultipleBlocks())}_rebuildEditor(t,e){this.app.ui.close();const s=this._parseHtml(t.html);this._restoreEmailOptions(t),this._restoreEditorContent(s,t),this._restoreFocus(t),setTimeout((()=>{this.app.observer.observe(),this.app.broadcast(`state.${e}`,t)}),2)}_isUndo(t){return(t.ctrlKey||t.metaKey)&&90===t.which&&!t.shiftKey&&!t.altKey}_isRedo(t){return(t.ctrlKey||t.metaKey)&&(90===t.which&&t.shiftKey||89===t.which)}_hasUndo(){return 0!==this.undoStorage.length}_hasRedo(){return 0!==this.redoStorage.length}_getEditorContent(){if(this.app.has("email"))return this.app.email.getContent();if("json"===this.app.editor.getContentType()){this.app.blocks.get({instances:!0}).forEach((t=>{if(t){const e=t.getAttrs();e&&t.getBlock().attr("data-rx-attrs",JSON.stringify(e))}}))}return this.app.editor.getLayout().html()}_getEmailOptions(){return this.app.has("email")?this.config.get("email"):null}_getOffset(){const t=new _(this.app),e=this.app.block.get(),s=!(!e||!e.isEditable())&&e.getBlock();return this.app.blocks.is()?t.get():t.get(s)}_createState(){if(this._isToolMode())return!1;const t=this._getOffset();let e=this._getEditorContent();if(!this.app.blocks.is()){e=new T(this.app).wrap(e,function(t){t.find(".rx-block-focus").addClass("rx-block-state")}.bind(this))}return{html:new F(this.app).unparse(e,{state:!0}),offset:t,emailOptions:this._getEmailOptions()}}_isToolMode(){return this.app.editor.getLayout().find(".rx-in-tool").length>0}}class dt{constructor(t){this.app=t,this.syncedHtml="",this.typingTimer=null}build(){this.syncedHtml=this.app.element.getHtml()}destroy(){this._clearTypingTimer()}trigger(){this.config.is("sync")&&(this._clearTypingTimer(),this.typingTimer=setTimeout((()=>this.update()),this.config.get("syncDelay")))}update(){const t=this._getHtml();this._needsSync(t)&&this._sync(t)}invoke(){let t=this._getHtml();this.syncedHtml=t,this._sync(t)}_needsSync(t){return this.syncedHtml!==t&&(this.syncedHtml=t,!0)}_clearTypingTimer(){this.typingTimer&&clearTimeout(this.typingTimer)}_getHtml(){const t=new F(this.app),e=this.app.editor.getHtml();return t.unparse(e)}_sync(t){const e=this.app.broadcast("editor.before.change",{html:t});if(e.isStopped())return;const s=e.get("html");this.app.editor.setOutput(s),this.app.editor.setSource(s),this.app.autosave.send(),this.app.state.trigger(),this.app.broadcast("editor.change",e)}}class gt{constructor(t){this.app=t,this.offset=!1,this.count=0}init(){this.popupManager=new ut(this.app)}popup(t,e){this.popupManager.popup(t,e)}set(t,e,s){if(!0!==s&&this.app.block.isTool())return;let i=this.dom([]);const r=new L(this.app),a=new _(this.app);if(!0!==e&&this.app.dropdown.close(),this.params=t||{},this.instant=e,this.offset=a.get(),this.params.style){let t={};for(let[e,s]of Object.entries(this.params.style)){let i=e.replace(/([A-Z])/g," $1");i=i.split(" ").join("-").toLowerCase(),t[i]=s}this.params.style=t}return r.getRange()?(this.params.tag=this._replaceTags(),i=r.isCollapsed()?this._formatCollapsed():this._formatUncollapsed(),this.offset=a.get(),this.app.context.updatePosition(),this.app.broadcast("inline.set",{$nodes:i}),this.app.sync.trigger(),this.app.observer.observe(),i):void 0}remove(t){const e=new L(this.app),s=new R(this.app);let i=e.getNodes({type:"inline",link:!0}),r=e.getInlineTop();if(e.isCollapsed()&&r){const t=new v(this.app);let e=r.tagName.toLowerCase(),s=this._insertSplit(r,e);t.set(s,"before")}else{if(this.app.editor.save(),t.style){let e=Array.isArray(t.style)?t.style:[t.style];for(let t=0;t<i.length;t++){let r=this.dom(i[t]),a=i[t].tagName.toLowerCase();r.removeAttr("data-rx-style-cache");for(let t=0;t<e.length;t++)r.css(e[t],"");""===r.attr("style")&&r.removeAttr("style"),s.cacheElementStyle(r),"span"===a&&0===i[t].attributes.length&&r.unwrap()}}else if(t.classname)for(let e=0;e<i.length;e++){let s=this.dom(i[e]),r=i[e].tagName.toLowerCase();s.removeClass(t.classname),""===s.attr("class")&&s.removeAttr("class"),"span"===r&&0===i[e].attributes.length&&s.unwrap()}this.app.editor.restore(),this.app.observer.observe()}}removeFormat(){this.app.dropdown.close();let t=this.app.block.get();const e=new L(this.app);let s;if(!t)return;let i=t.getBlock();this.app.editor.save(i);let r=e.getNodes({type:"inline",link:!0});for(let t=0;t<r.length;t++)s=this.dom(r[t]),"A"!==r[t].tagName?s.attr("data-rx-type")||s.unwrap():s.removeAttr("style data-rx-style-cache");this.app.editor.restore(),this.app.observer.observe()}restoreOffset(){if(this.offset){new _(this.app).set(this.offset)}}_formatCollapsed(){let t;const e=new L(this.app),s=new v(this.app),i=new T(this.app),r=(new _(this.app),new K(this.app));let a=e.getInline(),n=e.getInlineTop(!1,this.params.tag),o=r.getInlines(a),l=this.dom(a),h=this._getTags(),p=this._isSameTag(a,h),c=this._isSameTag(n,h),d=!(!this.params||!this.params.caret)&&this.params.caret;if(this.app.editor.save(),a)if(a&&i.isEmptyHtml(a.innerHTML))if(p)this._isParams()?this._hasAllSameParams(a)?(s.set(a,d||"after"),l.remove()):this._hasSameClassname(a)?(this.instant||this.app.editor.restore(),t=this._setStyle(a)):this._hasSameStyle(a)?(this.instant||this.app.editor.restore(),t=this._setClassname(a)):(this.instant||this.app.editor.restore(),t=this._setParams(a)):(s.set(a,d||"after"),l.remove());else if(this._hasCommonTags(o,h)){let t=this._findMatchingIndex(o,h);const e=o.splice(t,1)[0];this.dom(e).unwrap(),o.reverse(),s.set(o[o.length-1],"start")}else t=this._insertInline(this.params.tag,d),t=this._setParams(t);else a&&(p?this._isParams()?this._hasAllSameParams(a)?this._makeSplit(a,d):this._hasSameClassname(a)?(t=this._insertInline(this.params.tag,d),t=this._setStyle(t)):this._hasSameStyle(a)?(t=this._insertInline(this.params.tag,d),t=this._setClassname(t)):(t=this._insertInline(this.params.tag,d),t=this._setParams(t)):this._makeSplit(a,d):c?this._isParams()?this._hasAllSameParams(n)?this._makeSplit(n,d,a):this._hasSameClassname(n)?(t=this._insertInline(this.params.tag,d),t=this._setStyle(t)):this._hasSameStyle(n)?(t=this._insertInline(this.params.tag,d),t=this._setClassname(t)):(t=this._insertInline(this.params.tag,d),t=this._setParams(t)):this._makeSplit(n,d,a):(t=this._insertInline(this.params.tag,d),t=this._setParams(t)));else t=this._insertInline(this.params.tag,d),t=this._setParams(t),this.app.editor.save(t,"inline");return this.app.editor.resetSaved(),this.dom(t)}_formatUncollapsed(){const t=new L(this.app),e=new v(this.app);let s=!1,i=this.app.editor.isSelectAll(),r=this.dom(t.getNodes({type:"block",partial:!0})),a=t.getNodes({type:"inline"});if(this.app.editor.save(),this._convertTags(r,a),this.app.editor.restore(),this.app.editor.save(),this._convertToStrike(a),this.app.editor.restore(),this.app.page.getDocNode().execCommand("strikethrough"),this.app.editor.save(),s=this._revertToInlines(r),this.app.editor.restore(),this._clearEmptyStyle(),this.app.editor.save(),s.each(this._applyParams.bind(this)),this.app.editor.restore(),r.each((function(t){t.get().normalize()})),this.app.editor.save(),this._revertTags(r),this.app.editor.restore(),this.params.caret){let t=s.last();e.set(t,this.params.caret)}return i&&this.app.editor.selectAll(),s}_isParams(){return this.params.style||this.params.classname}_applyParams(t){let e=t.tag(),s=this._getTags(),i=t.parent();0!==i.length&&this._isSameTag(i.get(),s)&&i.text()===t.text()?this._applyParamsToNode(i,e):this._applyParamsToNode(t,e)}_applyParamsToNode(t,e){t.removeAttr("data-rx-style-cache"),""===t.attr("class")&&t.removeAttr("class"),0===t.get().attributes.length?this._isParams()&&"span"===this.params.tag?(this._setParams(t),this._clearSpanInside(t)):"span"===e&&t.unwrap():this._isParams()&&(this._setParams(t),this._clearSpanInside(t))}_setParams(t){return t=this._setClassname(t),t=this._setStyle(t)}_setClassname(t){let e=this.dom(t);if(this.params.classname){if(this.params.group){let t="inlineGroups."+this.params.group,s=!!this.config.is(t)&&this.config.get(t);s&&e.removeClass(s.join(" "))}else e.removeAttr("class");e.addClass(this.params.classname)}return e.get()}_setStyle(t){const e=this.dom(t),s=new R(this.app);return this.params.style&&(e.css(this.params.style),s.cacheElementStyle(e)),e.get()}_hasAllSameParams(t){return this._hasSameClassname(t)&&this._hasSameStyle(t)}_hasSameClassname(t){let e=this.dom(t);return!!e.attr("class")&&(!this.params.classname||e.hasClass(this.params.classname))}_hasSameStyle(t){const e=this.dom(t),s=new K(this.app);return!this.params.style||s.compareStyle(e,this.params.style)}_hasCommonTags(t,e){return e.some((e=>t.some((t=>t.tagName.toLowerCase()===e))))}_findMatchingIndex(t,e){return t.findIndex((t=>e.some((e=>t.tagName.toLowerCase()===e))))}_makeSplit(t,e,s){const i=new v(this.app),r=new K(this.app);let a=i.is(t,"end"),n=t;if(s){n=a?t:this._insertSplit(t);let e=r.getInlines(s,this.params.tag),o=e[0].cloneNode();o.innerHTML="";let l=o,h=l,p=e.length-1;e.reverse();for(let t=0;t<p;t++)o=e[t].cloneNode(),o.innerHTML="",this.dom(l).append(o),h=o;let c=a?"after":"before";this.dom(n)[c](l),i.set(h,"start")}else a?e="after":n=this._insertSplit(t),i.set(n,e||"before")}_insertSplit(t,e){const s=new T(this.app);let i=this.dom(t),r=s.extractHtmlFromCaret(t),a=this.dom("<"+(e||this.params.tag)+" />"),n=document.createElement("div");return n.appendChild(r),i.cloneAttrs(a),a.append(n.innerHTML),i.after(a),a}_insertInline(t,e){return new E(this.app).insertNode(document.createElement(t),e||"start")}_isSameTag(t,e){return t&&-1!==e.indexOf(t.tagName.toLowerCase())}_getTags(){let t=[this.params.tag];return"b"===this.params.tag||"strong"===this.params.tag?t=["b","strong"]:"i"!==this.params.tag&&"em"!==this.params.tag||(t=["i","em"]),t}_replaceTags(){let t=this.config.get("replaceTags")[this.params.tag];return t||this.params.tag}_convertToStrike(t){const e=new T(this.app);let s,i,r,a,n=new L(this.app).getText().replace(/[-[\]/{}()*+?.\\^$|]/g,"$&"),o=this._getTags(),l=!1;for(let h=0;h<t.length;h++)if(s=t[h],i=this.dom(s),r=t[h].tagName.toLowerCase(),a=this._hasAllSameParams(s),"a"===r&&"span"===this.params.tag&&this._isFullySelected(s,n)){let t=e.cssToObject(i.attr("style"));i.addClass("rx-inline-convertable"),i.removeAttr("data-rx-style-cache"),t&&t["text-decoration"]&&i.attr("data-rx-inline-line",t["text-decoration"])}else-1!==o.indexOf(r)&&("span"===this.params.tag&&this._isFullySelected(s,n)?(i.addClass("rx-inline-convertable"),i.removeAttr("data-rx-style-cache")):a&&"a"!==this.params.tag?this._replaceToStrike(i):"span"===this.params.tag?(this.params.style&&this._hasSameStyle(i)&&(l=!0),this.params.classname&&this._hasSameClassname(i)&&(l=!0),l?(i.addClass("rx-inline-convertable"),i.removeAttr("data-rx-style-cache")):i.addClass("rx-inline-unconvertable")):a||this._replaceToStrike(i))}_convertInlineBlocks(t){t.find("[data-rx-inline]").each((function(t){!0===t.attr("contenteditable")&&t.addClass("rx-inlineblock-editable").attr("contenteditable",!1)}))}_convertTag(t,e){let s;this.params.tag!==t?e.find(t).each((function(e){s=e.replaceTag("span"),s.addClass("rx-convertable-"+t)})):"del"===this.params.tag&&e.find(t).replaceTag("strike")}_convertTags(t){const e=new T(this.app);this._convertTag("del",t),this._convertTag("u",t),this._convertTag("a",t),this._convertInlineBlocks(t),t.find("span").each((function(t){let s=e.cssToObject(t.attr("style"));s&&s["text-decoration"]&&(t.css("text-decoration",""),t.attr("data-rx-convertable-style",s["text-decoration"]),t.addClass("rx-convertable-restore-style"))}))}_replaceToStrike(t){t.replaceWith((t=>this.dom("<strike>").append(t.contents())))}_revertInlineBlocks(t){t.find(".rx-inlineblock-editable").removeClass("rx-inlineblock-editable").attr("contenteditable",!0)}_revertTag(t,e){e.find("span.rx-convertable-"+t).replaceTag(t).removeAttr("class")}_revertTags(t){this._revertTag("a",t),this._revertTag("u",t),this._revertTag("del",t),this._revertInlineBlocks(t)}_revertToInlines(t){let e=this.dom([]);return"u"!==this.params.tag&&t.find("u").unwrap(),t.each((function(t){t.find("*").each((function(t){t.get().style.textDecorationLine&&(t.css("text-decoration-line",""),t.wrap("<u>"),""===t.attr("style")&&t.removeAttr("style"))}))})),t.find(".rx-inline-convertable").each(function(t){t.find("strike").each((function(e){t.text()===e.text()&&e.unwrap()})),t.removeClass("rx-inline-convertable");let s=!0;t.hasClass("rx-convertable-a")&&((t=t.replaceTag("a")).removeClass("rx-convertable-a"),s=!1);let i=t.attr("data-rx-inline-line");i&&(t.css("text-decoration",i),t.removeAttr("data-rx-inline-line")),t.removeEmptyAttr("class"),s&&this._hasAllSameParams(t)?t.unwrap():e.add(t)}.bind(this)),t.find("span.rx-inline-unconvertable").each(function(t){t.removeClass("rx-inline-unconvertable"),t.removeEmptyAttr("class")}.bind(this)),t.find("span.rx-convertable-restore-style").each((function(t){t.removeClass("rx-convertable-restore-style");let e=t.attr("data-rx-convertable-style");e&&"null"!==e&&t.css("text-decoration",e),t.removeAttr("data-rx-convertable-style")})),t.find("strike").each(function(t){t=t.replaceTag(this.params.tag),e.add(t)}.bind(this)),e}_clearEmptyStyle(){let t,e=new L(this.app).getNodes({type:"inline"}),s=0,i=e.length,r=0;for(;s<i;s++)if(this._clearEmptyStyleAttr(e[s]),t=e[s].childNodes,t)for(;r<t.length;r++)this._clearEmptyStyleAttr(t[r])}_clearEmptyStyleAttr(t){3!==t.nodeType&&""===t.getAttribute("style")&&t.removeAttribute("style")}_clearSpanInside(t){t.find("span").each(function(t){if(this.params.classname&&t.removeAttr("class"),this.params.style)for(let e of Object.keys(this.params.style))t.css(e,"");""===t.attr("class")&&t.removeAttr("class"),""===t.attr("style")&&t.removeAttr("style"),0===t.get().attributes.length&&t.unwrap()}.bind(this))}_isFullySelected(t,e){const s=new T(this.app),i=s.removeInvisibleChars(t.textContent);return e===i||-1!==e.search(new RegExp("^"+s.escapeRegExp(i)+"$"))}}class ut{constructor(t){this.app=t,this.config=t.config,this.dropdown=t.dropdown,this.observer=t.observer}popup(t,e){const s=[...this.config.get("popups.inline")],i=this.config.get("inlineItems"),r=this.observer.getKeys();Object.values(i||{}).forEach((t=>{t.command="inline.set"})),this.dropdown.create("inline",{items:s,extend:i,keys:r,type:"inlinebar"}),this.dropdown.open(t,e)}}class mt{constructor(t){this.app=t,this.config=t.config}handle(t){const e=t.get("e"),s=e.which,i=new g(this.app,e),r=new yt(this.app,e,s),a={enter:new vt(this.app,e,s),space:new kt(this.app,e,s),tab:new wt(this.app,e,s),arrow:new _t(this.app,e,s),delete:new Ct(this.app,e,s),backspace:new Ct(this.app,e,s),alpha:new bt(this.app,e,s)};r.handleEvent(e)||Object.keys(a).forEach((t=>{i.is(t)&&a[t].handleEvent(e)}))}}class ft{constructor(t,e,s){this.app=t,this.dom=t.dom,this.config=t.config,this.key=s,this.analyzer=new g(this.app,e)}_trimInvisibleChar(t,e,s){const i="left"===e?"before":"after",r=new L(this.app),a=new _(this.app),n=r.getCurrent();if(this._isInvisibleChar(r,n,i))if("left"===e)this._removeChar(n,/\uFEFF/g);else if(s&&n?.nextSibling)this._removeChar(n.nextSibling,/\uFEFF/g);else if("right"===e)return t.preventDefault(),this._adjustOffset(a,1),!0}_removeChar(t,e){if(!t)return;const s=t.textContent.replace(e,"");this.dom(t).replaceWith(s)}_adjustOffset(t,e){const s=t.get();t.set({start:s.start+e,end:s.end+e})}_isInvisibleChar(t,e,s){const i=new T(this.app),r=t.getText(s);return 3===e?.nodeType&&0===i.searchInvisibleChars(r)}_traverseNext(t,e){this._traverse(t,e,"getNext","getNextParent","start")}_traversePrev(t,e){this._traverse(t,e,"getPrev","getPrevParent","end")}_traverse(t,e,s,i,r){const a=e[s]();if(a)return t.preventDefault(),void this.app.block.set(a,r);const n=e[i]();if(n)return t.preventDefault(),void this.app.block.set(n,r);this.analyzer.is("down+right")&&e.insertEmpty({position:"after",caret:"start",type:"input"})}}class bt extends ft{handleEvent(t){const e=this.app.block.get();if(e&&e.isType("cell")){e.setEmpty();const t=e.getFirstElement();this.app.block.set(t,"start")}else if(e.isEditable())e&&e.isEditable()&&e.getClosest("cell")&&this.app.control.updatePosition();else{const t=new v(this.app),s=e.insertEmpty({position:"after",type:"input"});t.set(s.getBlock(),"start"),e.remove({broadcast:!0}),this.app.image.observeStates()}this._handleEndOfLink(),this.app.observer.observe()}_handleEndOfLink(){const t=new L(this.app).getInline(),e=new v(this.app);t&&"A"===t.tagName&&e.is(t,"end")&&e.set(t,"end")}}class _t extends ft{handleEvent(t){this.analyzer.is("ctrl")&&this.analyzer.is("up")?this._handleArrowCtrl(t):this.analyzer.is("shift","alt","ctrl")||this._handleArrow(t)}_handleArrowCtrl(t){const e=new L(this.app);this.app.editor.unsetSelectAll(),e.remove(),this.app.editor.setFocus("start")}_handleArrow(t){if(this._handleSelectAll(t))return;if(this._handleMultipleSelection(t))return;const e=this.app.block.get();e&&(this._handleInvisibleChar(e,t)||this._handleBlockMethod(e,t)||this._handleFirefoxFix(e,t)||this._handleNonEditableBlock(e,t)||this._handleEditableBlock(e,t))}_handleInvisibleChar(t,e){const s=this.analyzer.is("left","right"),i=this.analyzer.is("left")?"left":"right";if(t.isEditable()&&s&&this._trimInvisibleChar(e,i))return!0}_handleBlockMethod(t,e){return!!t.handleArrow&&(t.handleArrow(e,this.key,this.analyzer),!0)}_handleNonEditableBlock(t,e){if(!t.isEditable()||t.isType(["todo","list"])){return(this.analyzer.is("up+left")?this._traversePrev:this._traverseNext).call(this,e,t),!0}}_handleEditableBlock(t,e){if(!t.isEditable())return!1;if(this.analyzer.is("down+right")&&t.isCaretEnd()){const s=t.getClosest("table");if(s){e.preventDefault();const t=s.getNext();if(t)this.app.block.set(t,"start");else{const t=this.app.block.create();s.insert({instance:t,position:"after",type:"input"})}return!0}{let s=t.getNext();if(s)return e.preventDefault(),this.app.block.set(s,"start"),!0;for(s=t.getBlock().nextElement();s;){if(s.attr("data-rx-type"))return e.preventDefault(),this.app.block.set(s,"start"),!0;s=0===s.nextElement().length?null:s.nextElement()}}}else if(this.analyzer.is("up+left")&&t.isCaretStart()){let s=t.getPrev();if(s)return e.preventDefault(),this.app.block.set(s,"end"),!0;for(s=t.getBlock().prevElement();s;){if(s.attr("data-rx-type"))return e.preventDefault(),this.app.block.set(s,"end"),!0;s=0===s.prevElement().length?null:s.prevElement()}}return!1}_handleFirefoxFix(t,e){const s=new T(this.app),i=new L(this.app),{isFirstLine:r,isLastLine:a}=i.isCursorInFirstOrLastLine();if(s.isFirefox())if(this.analyzer.is("up")&&r){const s=t.findPreviousElement();if(s?.isType("text")&&s.isEmpty())return e.preventDefault(),this.app.block.set(s,"start"),!0}else if(this.analyzer.is("down")&&a){const s=t.findNextElement();if(s?.isType("text")&&s.isEmpty())return e.preventDefault(),this.app.block.set(s,"start"),!0}return!1}_handleSelectAll(t){if(!this.app.editor.isSelectAll())return!1;t.preventDefault();const e=this.analyzer.is("down+right"),s=this.app.blocks.get({last:e,first:!e}),i=e?"end":"start";return this.app.editor.unsetSelectAll(),this.app.block.set(s,i),!0}_handleMultipleSelection(t){if(!this.app.blocks.is())return!1;t.preventDefault();const e=this.analyzer.is("down+right"),s=this.app.blocks.get({last:e,first:!e,selected:!0});return new L(this.app).collapse(e?"end":"start"),this.app.block.set(s),this.app.context.close(),!0}}class Ct extends ft{handleEvent(t){const e=this.app.block.get();e&&e.isNondeletable()||this._handleColumn(e,t)||this._handleEditorEmpty(t)||this._handleMultipleSelection(t)||this._handleInvisibleChar(e,t)||this._handleInlineDeletion(t,e)||e&&(this._handleBlockMethod(e,t)||this._handleInlineBlockDeletion(t,e)||this._handleNonEditableBlockDeletion(t,e)||this._handleEditableBlockDeletion(t,e)||(this.app.observer.observe(),this.app.image.observeStates()))}_handleBlockMethod(t,e){return!!t.handleDelete&&(t.handleDelete(e,this.key,this.analyzer),this.app.image.observeStates(),!0)}_handleInlineDeletion(t,e){const s=new L(this.app).getInline();if(!s)return!1;const i=new T(this.app).removeInvisibleChars(s.innerHTML);if(1===i.length){if(t.preventDefault(),"A"===s.tagName){const t=s.nextSibling,e=s.previousSibling;s.remove(),this._removeTrailingSpace(e,t),this.app.observer.observe()}else s.innerHTML="";return!0}return 0===i.length&&(t.preventDefault(),s.remove(),this.app.observer.observe(),!0)}_removeTrailingSpace(t,e){if(t&&t.nodeType===Node.TEXT_NODE&&/\s$/.test(t.nodeValue)&&this.analyzer.is("backspace")&&(t.nodeValue=t.nodeValue.replace(/\s+$/,"")),e&&e.nodeType===Node.TEXT_NODE&&e.nodeValue.startsWith(" ")){const t=this.analyzer.is("backspace")?" ":"";e.nodeValue=e.nodeValue.replace(/^\u00A0+/,t)}}_handleInvisibleChar(t,e){const s=this.analyzer.is("delete"),i=this.analyzer.is("backspace")?"left":"right";if(t&&t.isEditable()&&this._trimInvisibleChar(e,i,s))return!0}_handleMultipleSelection(t){if(!this.app.blocks.is())return!1;t.preventDefault();const e=this.app.blocks.get({first:!0,selected:!0});return new L(this.app).truncate(),this.app.block.set(e,"end"),this.app.block.get().appendNext(),this.app.context.close(),this.app.image.observeStates(),!0}_handleEditorEmpty(t){return!!this.app.editor.isEmpty()&&(t.preventDefault(),!0)}_handleColumn(t,e){return!(!t||!t.isType("column"))&&(e.preventDefault(),!0)}_handleInlineBlockDeletion(t,e){if(!e.isInline())return!1;const s=new v(this.app),i=e.getBlock(),r=i.parent().closest("[data-rx-type]");return!(e.isEditable()&&!e.isAllSelected())&&(t.preventDefault(),s.set(i,"after"),e.remove(),this.app.block.set(r),this.app.context.close(),!0)}_handleNonEditableBlockDeletion(t,e){if(e&&e.isEditable())return!1;t.preventDefault();const s=e.getNext(),i=e.getPrev(),r=e.getType(),a=e.getClosest(["column","cell"]);if("image"===r){const t={url:e.getSrc(),id:e.getId(),uid:e.getDataImage()};this.app.image.setImageState(e,t,!1),this.app.broadcast("image.remove",t)}if(e.remove({broadcast:!0}),a&&a.isEmpty(!0)){const t=this.app.block.create();return a.insert({instance:t,position:"append"}),this.app.block.set(t,"start"),!0}return this._setNextOrPreviousBlock(s,i),!0}_setNextOrPreviousBlock(t,e){t?this.app.block.set(t,"start"):e?this.app.block.set(e,"end"):this.app.editor.isEmpty()?this.app.editor.setEmpty():this.app.block.unset()}_handleEditableBlockDeletion(t,e){if(!e&&e.isEditable())return!1;const s=this.analyzer.is("backspace"),i=this.analyzer.is("delete"),r=new L(this.app);return e.isAllSelected()?(t.preventDefault(),e.isType("quote")?this.app.block.remove():e.setEmpty(),this.app.context.close(),!0):!!this._handleDeleteAtEdges(t,e,s,i)||!r.isCollapsed()&&(t.preventDefault(),r.truncate(),this.app.context.close(),!0)}_handleDeleteAtEdges(t,e,s,i){const r=e.getNext(),a=e.getPrev();return i&&e.isCaretEnd()?(this._handleDeleteAtEnd(t,e,r),!0):!(!s||!e.isCaretStart())&&(this._handleBackspaceAtStart(t,e,a),!0)}_handleDeleteAtEnd(t,e,s){if(t.preventDefault(),s)s.isEditable()||s.isType(["list","todo"])?"pre"===s.getType()&&e.isEmpty()?e.remove({broadcast:!0}):e.appendNext():this._setBlockAndRemoveIfEmpty(e,s);else{e.getClosest(["column","cell"])&&t.preventDefault()}this.app.context.close()}_handleBackspaceAtStart(t,e,s){const i=new L(this.app),r=new v(this.app),a=new T(this.app),n=i.getCursorContext("before");if(n&&["SPAN","SVG"].includes(n.tagName))return t.preventDefault(),r.set(n,"after"),void n.remove();if(a.isOnlySvgContent(e.getBlock()))return t.preventDefault(),void e.setEmpty();if(t.preventDefault(),s)return s.isEditable()||s.isType(["list","todo"])?"pre"===s.getType()&&e.isEmpty()?e.remove({broadcast:!0}):(e.appendToPrev(),this.app.control.updatePosition()):this._setBlockAndRemoveIfEmpty(e,s,"force"),void this.app.context.close();{const s=e.getBlock().prevElement();if(e.getClosest(["column","cell"]))return void t.preventDefault();if(s)return t.preventDefault(),void s.remove()}}_setBlockAndRemoveIfEmpty(t,e,s="start"){this.app.block.set(e,s),t.isEmpty()&&t.remove({broadcast:!0})}}class vt extends ft{handleEvent(t){this.analyzer.is("shift")||"br"===this.config.get("enterKey")?this._handleShiftEnter(t):this._handleEnter(t)}_handleEnter(t){const e=this.app.block.get();this._handleSpecialCases(e,t)||this._handleMultipleSelection(t)||e&&(this._handleNonDeletable(e,t)||this._handleInline(e,t)||this._handleEditable(e,t)||this._handleNonEditable(e,t)||this._handleBlockMethod(e,t)||e.isEditable()&&this._handleCustomTags(e,t))}_handleShiftEnter(t){const e=this.app.block.get();if(!this._handleMultipleSelectionShift(t)&&!this._deleteInsideSelection(t)&&e)if(e.isInline())this._handleInline(e,t);else if(e.isEditable()){t.preventDefault();new E(this.app).insertBreakline()}else t.preventDefault(),this._insertAfter(e)}_handleCustomTags(t,e){if(e.preventDefault(),t.isEmpty()||t.isCaretStart()||t.isCaretEnd()){const e=t.isCaretStart()?"before":"after";t.insertEmpty({position:e,caret:"start",remove:!1,type:"input"})}else{const e=new G(this.app).split(t.getBlock());this.app.block.set(e,"start")}}_handleBlockMethod(t,e){return!!t.handleEnter&&(t.handleEnter(e,this.key,this.analyzer),this.app.image.observeStates(),!0)}_handleSpecialCases(t,e){const s=new L(this.app).getRange();if(s&&"A"===s.startContainer.tagName&&"A"===s.endContainer.tagName){e.preventDefault();return new v(this.app).set(s.startContainer,"after"),s.startContainer.remove(),!0}return!(!t||!t.isType("column"))&&(e.preventDefault(),t.insertEmpty({position:"prepend",caret:"start",type:"input"}),!0)}_handleMultipleSelection(t){if(!this.app.blocks.is())return!1;const e=this.app.blocks;if(!e.is())return!1;t.preventDefault();const s=e.get({last:!0,selected:!0});return new L(this.app).truncate(),setTimeout((()=>{this.app.block.set(s),this.app.image.observeStates()}),0),!0}_handleMultipleSelectionShift(){const t=this.app.blocks;if(!t.is())return!1;e.preventDefault();const s=t.get({first:!0,selected:!0}),i=new L(this.app),r=new E(this.app),a=new v(this.app);return i.truncate(),a.set(s,"end"),r.insertBreakline(),!0}_handleNonDeletable(t,e){return!!(t.isNondeletable()||!t.isInline()&&this._deleteInsideSelection(e))}_handleInline(t,e){if(!t.isInline())return!1;e.preventDefault();const s=new v(this.app);return(!t.isEditable()||t.isEditable()&&t.isAllSelected())&&(s.set(t.getBlock(),"after"),t.remove()),!0}_handleEditable(t,e){if(!t.isEditable())return!1;const s=new L(this.app),i=new E(this.app);if(t.isAllSelected())e.preventDefault(),t.setEmpty();else{if(s.isCollapsed())return!1;e.preventDefault(),t.isType("pre")?i.insertNewline():i.insertBreakline()}return!0}_handleNonEditable(t,e){return!t.isEditable()&&(e.preventDefault(),t.isType("list")?this._handleList(t):t.isType("cell")?this._handleCell(t):this._insertAfter(t),!0)}_handleList(t){const e=t.getBlock().closest("li");0===e.length?t.insertEmpty({position:"after",caret:"start",type:"input"}):(t.remove(),this.app.block.set(e,"end"))}_handleCell(t){t.getBlock().html("");const e=this.app.block.create();t.getBlock().append(e.getBlock()),this.app.editor.build(),this.app.block.set(e.getBlock(),"start")}_insertAfter(t){t.insertEmpty({position:"after",caret:"start",type:"input"}),this.app.image.observeStates()}_deleteInsideSelection(t){const e=new L(this.app),s=new v(this.app);if(!e.isCollapsed()){const i=e.getNodes({type:"block"});if(i.length>1)return t.preventDefault(),e.truncate(),s.set(i[0],"end"),!0}return!1}}class yt extends ft{handleEvent(t){return this._isAllSelected()?this._clearEditor(t):this.analyzer.is("select-block")?this._handleSelectBlock(t):this.analyzer.is("select")?this._handleSelectAll(t):void 0}_handleSelectAll(t){t.preventDefault();const e=this.app.block.get();if(e){const t=e.getClosest("cell"),s=!!t&&t.getClosest("table"),i=new L(this.app);if(s&&!i.isAll(s.getBlock())){if(t&&i.isAll(t.getBlock()))return this.app.block.set(s),!0;if(t)return i.select(t.getBlock()),!0}}return this.app.editor.setSelectAll(),this.app.context.open(t),!0}_handleSelectBlock(t){const e=this.app.block.get();if(!e||!e.isEditable())return;t.preventDefault();const s=this._getTargetForInstance(e);new L(this.app).select(s),this.app.context.open(t)}_getTargetForInstance(t){return t.isType("todoitem")?t.getContentItem():t.isType("quote")?t.getCurrentItem():t.getBlock()}_isAllSelected(){return this.app.editor.isSelectAll()&&this.analyzer.is("enter","delete","backspace","alpha","space")}_clearEditor(t){return this.analyzer.is("alpha","space")||t.preventDefault(),this.app.editor.setEmpty(),this.app.statusbar.updatePosition(),!0}}class kt extends ft{handleEvent(t){this.analyzer.is("shift")?this._handleShiftSpace(t):this._handleSpace(t)}_handleSpace(t){const e=this.app.block.get();this._handleSpecialCases(t,e)||this._handleMultipleSelection(t)||e&&(this._handleBlockMethod(e,t)||this._handleInlineBlock(t,e)||this._handleEditableBlock(t,e)||this._handleNonEditableBlock(t,e))}_handleShiftSpace(t){const e=this.app.block.get();this._handleMultipleSelectionWithInsertion(t)||e&&(e.isInline()||this._handleShiftEditableBlock(t,e))}_handleNonEditableBlock(t,e){if(e.isEditable())return!1;if(t.preventDefault(),!e.isType("cell"))return!1;{e.getBlock().html("");const t=this.app.block.create();e.getBlock().append(t.getBlock()),this.app.editor.build(),this.app.block.set(t.getBlock(),"start")}return!0}_handleEditableBlock(t,e){return!(!e.isEditable()||!e.isAllSelected())&&(t.preventDefault(),e.setEmpty(),!0)}_handleShiftEditableBlock(t,e){const s=new E(this.app);if(e.isEditable()){if(e.isAllSelected())return t.preventDefault(),e.setEmpty(),!0;if(!e.isType("pre"))return t.preventDefault(),s.insertHtml("&nbsp;","end"),!0}return!1}_handleInlineBlock(t,e){if(!e.isInline())return!1;if(!e.isEditable()||e.isEditable()&&e.isAllSelected()){t.preventDefault();new v(this.app).set(e.getBlock(),"after"),e.remove()}return!0}_handleBlockMethod(t,e){return!!t.handleSpace&&(t.handleSpace(e,this.key,this.analyzer),this.app.image.observeStates(),!0)}_handleSpecialCases(t,e){return!(!e||!e.isType(["column","embed"]))&&(t.preventDefault(),!0)}_handleMultipleSelection(t){if(!this.app.blocks.is())return!1;t.preventDefault();const e=this.app.blocks.get({first:!0,selected:!0}),s=new v(this.app);return new L(this.app).truncate(),s.set(e,"end"),this.app.image.observeStates(),!0}_handleMultipleSelectionWithInsertion(t){if(!this.app.blocks.is())return!1;t.preventDefault();const e=this.app.blocks.get({first:!0,selected:!0}),s=new L(this.app),i=new E(this.app),r=new v(this.app);return s.truncate(),r.set(e,"end"),i.insertHtml("&nbsp;","end"),!0}}class wt extends ft{handleEvent(t){this.config.is("tab.key")&&this._handleTab(t)}_handleTab(t){const e=this.app.block.get();this._handleMultipleSelection(t)||this._handleTableCellOrColumn(e,t)||this._handleBlockMethod(e,t)||this._handleTabAsSpaces(e,t)||e&&this._traverseNext(t,e)}_handleTabAsSpaces(t,e){if(!t||!this.config.is("tab.spaces")||!t.isEditable())return!1;e.preventDefault();const s=this.config.get("tab.spaces"),i=Array(s+1).join(" ");return new E(this.app).insertNode(document.createTextNode(i),"end"),!0}_handleBlockMethod(t,e){return!(!t||!t.handleTab)&&!!t.handleTab(e,this.key,this.analyzer)}_handleMultipleSelection(t){if(!this.app.blocks.is())return!1;t.preventDefault();const e=new L(this.app),s=this.app.blocks.get({last:!0,selected:!0});return e.collapse("end"),this.app.block.set(s),this.app.context.close(),!0}_handleTableCellOrColumn(t,e){if(!t)return!1;const s=t.getParent("cell");if(s&&s.handleTab&&s.handleTab(e,this.key,this.analyzer))return!0;const i=t.getParent("column");return!!(i&&i.handleTab&&i.handleTab(e,this.key,this.analyzer))}}class xt{constructor(t){this.app=t,this.rawhtml=""}init(){this.theme=new Bt(this.app),this.app.theme=this.theme,this.focusManager=new $t(this.app,this),this.selectionManager=new Et(this.app,this),this.buildStrategy=this.app.isMode("default")?new At(this.app,this):new Lt(this.app,this),this.buildStrategy.build()}stop(){this._removeOverlay(),this.theme.stop(),this.buildStrategy.stop(),this._restoreDivElement()}load(){!this.app.isMode("iframe")&&this.config.is("focus")&&this.setFocus(this.config.get("focus"))}click(){const t=new L(this.app).getBlockControlled();setTimeout((()=>{this.app.block.set(t)}),1)}readonly(){this.app.event.pause(),this._toggleEditableState(!1)}disable(){this.$editor.addClass("rx-editor-disabled"),this._createOverlay()}editable(){this._toggleEditableState(!0),this.app.event.run()}enable(){this.$editor.removeClass("rx-editor-disabled"),this._removeOverlay()}destroy(){this._restoreTextareaAttributes(),this.theme.destroy(),this.buildStrategy.destroy()}build(){const t=new u(this.app);this.app.blocks.build(),this.app.embed.build(),this.app.image.observeStates(),t.parse(this.$editor),this.app.observer.observe()}save(t,e=!1){this.selectionManager.save(t,e)}restore(t){this.selectionManager.restore(t)}resetSaved(){this.selectionManager.reset()}focus(){this.getLayout().focus({preventScroll:!0})}hasFocus(){return this.focusManager.hasFocus()}getTheme(){return this.theme.get()}getLayout(){return this.app.isMode("iframe")?this.$layout:this.$editor}getEditor(){return this.$editor}getRect(){return this.$editor.rect()}getWidth(){return this.$editor.width()}getHtml(){return this.getLayout().html()}getEmail(t){return this.app.has("email")?this.app.email.getEmail(t):this.getContent()}getContent(t){return this.content.getContent(t)}getJson(){let t={};return this.app.has("email")?t=this.app.email.getJson():(t=this.getSourceJson()||{},t.blocks=this.content.getJson()),t}getSourceJson(){return this.config.get("data")}getSource(){return this.$source.val()}getRawHtml(){return this.rawhtml}getContentType(){return this.content.getType()}setTheme(t){this.theme.set(t)}setContent(t){if(this.app.has("email"))this.app.email.setContent(t);else{new E(this.app).set(t)}}setJson(t){this.config.set("data",t),this.app.has("email")?this.app.email.setJson(t):(this.content.set(t,"json"),this.build())}setHtml(t){this.getLayout().html(t)}setEmpty(t=!0){const e=this.app.block.create();new E(this.app).setEmpty(),this.getLayout().append(e.getBlock()),this.build(),this.setFocus("end"),t&&this.app.broadcast("editor.empty")}setFocus(t,e=!0){this.focusManager.setFocus(t,e)}setBlurOther(){this.focusManager.setBlurOther()}setBlur(t){this.focusManager.setBlur(t)}deselectAll(){this.selectionManager.deselectAll()}selectAll(t,e=!0){this.selectionManager.selectAll(t,e)}setSource(t){this.$source.val(t)}setOutput(t){if(!this.config.is("output"))return;const e=this.config.get("output"),s=this.dom(e);["textarea","input"].includes(s.tag())?s.val(t):s.html(t)}setWinFocus(){this.app.isMode("iframe")&&this.app.page.getWin().focus()}insertContent(t){new E(this.app).insert(t)}isSelectAll(){return this.$editor.hasClass("rx-select-all")}isEmpty(){const t=new T(this.app),e=this.getLayout().html();return t.isEmptyHtml(e,!0)}isEditor(t){return this.dom(t).get()===this.getLayout().get()}adjustHeight(){this.app.isMode("iframe")&&this.$editor&&!this.app.isStopped()&&setTimeout((()=>{this.$editor.height(this.app.page.getFrameBody().height())}),1)}unsetSelectAll(){this.deselectAll()}setSelectAll(t,e){this.selectAll(t,e)}_createOverlay(){this.$overlay=this.dom("<div>").addClass("rx-editor-overlay"),this.app.container.get("main").append(this.$overlay)}_removeOverlay(){this.$overlay&&this.$overlay.remove()}_restoreDivElement(){this.app.element.isTextarea()||(this.$editor.removeClass("rx-editor rx-empty rx-editor-breakline "+this.config.get("classname")),this.$editor.removeAttr("style dir"),this.buildStrategy.restore(),this.$editor.html(this.getContent()))}_restoreTextareaAttributes(){this.app.element.isTextarea()||(this.$editor.removeClass("rx-editor rx-editor-"+this.uuid+" rx-empty rx-editor-breakline rx-editor-disabled rx-placeholder"),this.$editor.removeAttr("contenteditable data-gramm_editor"),this.app.container.get("main").before(this.$editor))}_toggleEditableState(t){const e=t?"removeClass":"addClass";this.getLayout().attr("contenteditable",t),this.$editor[e]("rx-editor-readonly"),t?this.getLayout().find("[rx-readonly=true]").each((t=>{t.removeAttr("rx-readonly").attr("contenteditable",!0)})):this.getLayout().find("[contenteditable=true]").each((t=>{t.attr("rx-readonly",!0).attr("contenteditable",!1)}))}}class Tt{constructor(t){this.app=t,this.editor=t.editor,this.source=t.source,this.element=t.element,this.config=t.config,this.sourceType=this._determineSourceType(),this.type=this.config.is("data")?"json":"html",this.content=this._getElementContent(),this._broadcastBeforeLoad(),this._parseContent(),this._unparseContent()}getSourceType(){return this.sourceType}getType(){return this.type}getContent(t){let e;return this.app.source.is()?e=this.app.source.getContent():(e=this.editor.getHtml(),e=this._unparse(e)),t&&(e=this._tidyContent(e)),e}getJson(){const t=[];return this.editor.getLayout().children("[data-rx-type]").each((e=>{const s=e.dataget("instance");t.push(s.getJson())})),t}set(t,e="html"){this.content=t,this.type=e,this._parseContent(),this._unparseContent()}isJson(){return"json"===this.type}_determineSourceType(){return this.config.is("content")?"content":this.config.is("data")?"data":"element"}_unparse(t){return new F(this.app).unparse(t)}_tidyContent(t){return new w(this.app).format(t)}_parseContent(){const t=new N(this.app).parse(this.content,{type:this.type,start:!0,nodes:!0});this.editor.setHtml(t)}_unparseContent(){const t=this._unparse(this.editor.getHtml());this.source.setContent(t),!this.isJson()&&this.element.isTextarea()&&this.editor.setSource(t)}_broadcastBeforeLoad(){const t=this.app.broadcast("editor.before.load",{html:this.content});this.content=t.get("html")}_getElementContent(){return this.config.is("content")?this.config.get("content"):this.config.is("data")?this.config.get("data"):this.app.element.getHtml()}}class $t{constructor(t,e){this.app=t,this.editor=e,this.container=t.container,this.source=t.source,this.block=t.block,this.blocks=t.blocks,this.path=t.path,this.ui=t.ui}hasFocus(){return this.container.hasFocus()}setFocus(t,e=!0){t?(this._setFocusWithPosition(t),e&&this.app.broadcast("editor.focus")):!1!==t&&this._setFocusWithoutPosition()}setBlurOther(){l.instances.forEach((t=>{t!==this.app&&t.editor&&t.editor.setBlur()}))}setBlur(t){if(!this.hasFocus()||!this.editor.getEditor())return;this.app.broadcast("editor.before.blur",{e:t}).isStopped()?t&&t.preventDefault():(this.container.setBlur(),this.editor.getEditor().removeClass("rx-select-all"),this._clearSelection(),this.app.broadcast("editor.blur",{e:t}))}_setFocusWithPosition(t){const e=!0===t?"start":t,s="start"===e?this.blocks.get({first:!0}):this.blocks.get({last:!0});this.block.set(s,e),this.container.setFocus()}_setFocusWithoutPosition(){this.hasFocus()||(this.setBlurOther(),this.container.setFocus(),this.container.toggleFocus(),this.app.broadcast("editor.focus"))}_clearSelection(){this.source.is()||(this.block.unset(),this.blocks.unset(),this.ui.close(),this.path.build(),this.ui.unset())}}class Et{constructor(t,e){this.app=t,this.dom=t.dom,this.editor=e,this.block=t.block,this.blocks=t.blocks,this.savedSelection=null,this.savedInline=null}save(t,e=!1){if("inline"===e)return void(this.savedInline=t);const s=new _(this.app),i=this.block.get();!1!==t&&(t=i&&!this.blocks.is()?i.getBlock():this.editor.getLayout()),this.savedSelection={el:t,offset:s.get(t)}}restore(t){this.savedSelection&&(this.editor.setWinFocus(),this.savedInline?this._restoreInlineCaret():this._restoreBlockSelection(t),this._clearSavedSelection())}reset(){this._clearSavedSelection()}selectAll(t,e=!0){if(this.editor.isSelectAll())return;const s=new L(this.app);this.editor.getEditor().addClass("rx-select-all"),t=t||this.blocks.get({firstLevel:!0}),this.block.unset(),this.blocks.set(t),s.select(this.editor.getLayout()),e&&this.app.broadcast("editor.select")}deselectAll(){this.editor.isSelectAll()&&(this.editor.getEditor().removeClass("rx-select-all"),this.block.unset(),this.blocks.unset(),this.app.broadcast("editor.deselect"),this.app.broadcast("editor.unselect"))}_restoreInlineCaret(){const t=new v(this.app);this.savedInline.innerHTML="",t.set(this.savedInline,"start")}_restoreBlockSelection(t){const{el:e,offset:s}=this.savedSelection;if(this.dom(e).dataget("instance")&&!1!==t&&this.block.set(e),e&&s){e.focus();this.app.create("offset").set(s,e)}}_clearSavedSelection(){this.savedSelection=null,this.savedInline=null}}class St{constructor(t){this.app=t,this.loc=t.loc,this.uuid=t.uuid,this.dom=t.dom,this.container=t.container,this.$editor=t.editor.getEditor(),this._assignAriaAttributes(),this._prependAccessibilityLabel()}destroy(){this.$editor.removeAttr("aria-labelledby role")}_assignAriaAttributes(){this.$editor.attr({"aria-labelledby":`rx-voice-${this.uuid}`,role:"presentation"})}_prependAccessibilityLabel(){const t=this.loc.get("accessibility.help-label"),e=this._createAccessibilityLabel(t);this.container.get("main").prepend(e)}_createAccessibilityLabel(t){return this.dom("<span>").attr({id:`rx-voice-${this.uuid}`,"aria-hidden":!1}).addClass("rx-voice-label").html(t)}}class Bt{constructor(t){this.app=t,this.config=t.config,this.ui=t.ui,this.page=t.page,this.container=t.container,this.dataAttr="rx-data-theme",this._initialize()}stop(){this._removeTheme()}destroy(){this._removeMediaQueryListener()}set(t){this._applyTheme(t),this._broadcastThemeChange(t)}get(){return this.container.get("main").attr(this.dataAttr)}_initialize(){const t=this._getInitialTheme(),e=this.config.get("theme");this.config.set("globalTheme",t),"auto"===e?(this._addMediaQueryListener(),this.set(t)):this.set(e)}_getInitialTheme(){return this._getStoredTheme()?this._getStoredTheme():this._detectSystemTheme()}_getStoredTheme(){return localStorage.getItem("theme")}_detectSystemTheme(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}_applyTheme(t){if("auto"===t&&(t=this._getInitialTheme()),this.container.get("main").attr(this.dataAttr,t),this.ui.updateTheme(t),this.app.isMode("iframe")){const e=this.config.get("themeAttr"),s=this.page.getFrameBody().closest("html");s.attr(this.dataAttr,t),e&&s.attr(e,t)}}_broadcastThemeChange(t){this.app.broadcast("editor.theme",t)}_removeTheme(){if(this.container.get("main").removeAttr(this.dataAttr),this.app.isMode("iframe")){const t=this.config.get("themeAttr"),e=this.page.getFrameBody().closest("html");e.removeAttr(this.dataAttr),t&&e.removeAttr(t)}}_changeThemeOnSystemPreference(){const t=this._detectSystemTheme();this.set(t)}_addMediaQueryListener(){this._mediaQuery().addEventListener("change",this._changeThemeOnSystemPreference.bind(this))}_removeMediaQueryListener(){this._mediaQuery().removeEventListener("change",this._changeThemeOnSystemPreference.bind(this))}_mediaQuery(){return window.matchMedia("(prefers-color-scheme: dark)")}}class It{constructor(t,e){this.app=t,this.editor=e,this.dom=t.dom,this.uuid=t.uuid,this.page=t.page,this.element=t.element,this.config=t.config,this.container=t.container,this.observer=t.observer,this.saved=!1}build(){throw new Error("Method build() must be implemented")}stop(){this.inputComposition.remove()}destroy(){this.a11y.destroy()}restore(){!this.element.isTextarea()&&this.saved&&(this.editor.$editor.attr("style",this.saved.style),this.editor.$editor.attr("dir",this.saved.dir))}_saveElementStyles(){this.element.isTextarea()||(this.saved={style:this.element.attr("style"),dir:this.element.attr("dir")})}_setContainerStyles(){this.config.is("container.border")||this.container.get("main").css("border","none")}_setupDraggable(){this._buildDraggable()}_buildVisibility(){this.editor.$editor.css("visibility","visible")}_buildInputComposition(){this.inputComposition=this.dom('<input type="text" id="rxCompositionCutter'+this.uuid+'" style="position: fixed; left: -9000px; z-index: -1000; width: 1px; height: 1px;" />'),this.page.getFrameBody().append(this.inputComposition)}_buildContent(){this.editor.rawhtml=this.element.getHtml().trim(),this.editor.content=new Tt(this.app)}_buildBlurClass(){this.config.get("clicktoedit")?this.container.setFocus():this.container.setBlur()}_buildAccessibility(){this.a11y=new St(this.app)}_buildEditable(){this.app.getLayout().attr("contenteditable",!0)}_buildDraggable(){this.page.getBody().find("[data-rx-drop-id]").each((t=>{t.attr("draggable",!0),t.on("dragstart",(t=>{const e=this.dom(t.target).attr("data-rx-drop-id");t.dataTransfer.setData("item",e)}))}))}}class Lt extends It{build(){this._buildInputComposition(),this._buildElement(),this._buildBlurClass(),this._buildAccessibility(),this._buildStartHtml()}_buildElement(){this.editor.$editor=this._createIframe(),this.editor.$source=this.element,this._appendEditorToContainer(),this._setupIframeLoadHandler()}_createIframe(){const t=this.dom("<iframe>").addClass("rx-editor-frame").css({visibility:"hidden",margin:"0 auto",padding:"0"});return this.config.is("maxHeight")||t.attr("scrolling","no"),t}_appendEditorToContainer(){this.container.get("editor").append(this.editor.$editor)}_setupIframeLoadHandler(){this.editor.$editor.on("load",this._onload.bind(this))}_buildOptions(){const t=this.config.dump();this._saveElementStyles(),this._setEditorAttributesAndStyles(t),this._setContainerStyles()}_setEditorAttributesAndStyles({dir:t,width:e="100%",padding:s,minHeight:i,maxHeight:r,notranslate:a,spellcheck:n,grammarly:o}){const l=this.element.attr("dir")||t;this.editor.$layout.attr("dir",l).css({"max-width":e,padding:s,"min-height":i,"max-height":r,overflow:r?"auto":null}),this.config.is("tabindex")&&this.editor.$editor.attr("tabindex",this.config.get("tabindex")),a&&this.editor.$layout.addClass("notranslate"),n||this.editor.$layout.attr("spellcheck",!1),o||this.editor.$layout.attr("data-gramm_editor",!1)}_buildLayout(){const t=this.page.getFrameBody();this.editor.$layout=t.children().first(),this._applyLayoutClasses(),t.css("height","auto")}_applyLayoutClasses(){const t=this.config.get("classname");this.editor.$layout.attr("dir",this.config.get("dir")).addClass("rx-editor rx-editor-"+this.uuid+" rx-empty"),this.config.is("breakline")&&this.editor.$layout.addClass("rx-editor-breakline"),this.config.is("structure")&&this.editor.$layout.addClass("rx-editor-wym"),this.config.is("nostyle")||this.editor.$layout.addClass(t)}_buildStartHtml(){const t=this._generateHtmlDocument();this._writeCode(t)}_generateHtmlDocument(){const t=this._createDoctype(),e=this._buildCustomJs(),s=`<div class="${this.config.get("classname")}"></div>`;return`${t}<html${this.config.is("frame.lang")?` lang="${this.config.get("frame.lang")}"`:""}${this.config.is("frame.dir")?` dir="${this.config.get("frame.dir")}"`:""}><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">${e}</head><body style="padding: 0; margin: 0; width: 100%;">${s}${this._createScripts()}</body></html>`}_buildCustomJs(){return this.config.is("custom.js")?this._processScripts(this.config.get("custom.js"),!0):""}_createDoctype(){return`${this.config.get("doctype")}\n`}_createScripts(){return this.config.is("custom.js")?this._processScripts(this.config.get("custom.js")):""}_processScripts(t,e=!1){return t.flatMap((t=>this._normalizeScript(t))).filter((t=>t.head===e)).map((t=>this.dom("<script>").attr("src",t.src).outer())).join("")}_normalizeScript(t){return"string"==typeof t?{src:t,head:!1}:"object"!=typeof t||null===t||Array.isArray(t)?[]:t}_writeCode(t){const e=this.page.getDocNode();e.open(),e.write(t),e.close()}_onload(){this._buildLayout(),this._buildOptions(),this._buildContent(),this._buildEditable(),this._loaded()}_loaded(){this._initializeApp(),this._buildVisibility(),this._buildEditorCss(),this._buildCustomCss(),this._setupDraggable(),this._adjustOnResize(),this._finalizeLoading()}_initializeApp(){const{app:t}=this.app;t.event.build(),t.placeholder.build(),t.placeholder.trigger(),t.blocks.build(),t.sync.build(),t.embed.build(),t.image.observeStates()}_buildEditorCss(){const t=this.config.get("css")+this.config.get("cssFile");this._buildCssLink(t)}_buildCustomCss(){this.config.is("custom.css")&&this.config.get("custom.css").forEach((t=>this._buildCssLink(t)))}_buildCssLink(t){const e=this.config.is("csscache")?"":(t.includes("?")?"&":"?")+(new Date).getTime(),s=this.dom("<link>").attr({class:"rx-css",rel:"stylesheet",href:t+e});this.page.getFrameHead().append(s)}_adjustOnResize(){this.page.getWin().on("resize.rx-editor-frame",this.editor.adjustHeight.bind(this))}_finalizeLoading(){this.app.loaded=!0,this.app.broadcast("editor.load"),this.editor.adjustHeight(),setTimeout((()=>{if(this.app.isStopped())return;this.editor.adjustHeight(),this.editor.getEditor().focus(),this.editor.setFocus(this.config.get("focus")),this.observer.build(),this.app.broadcast("editor.ready");new IntersectionObserver((t=>{t.forEach((t=>{t.isIntersecting&&this.editor.adjustHeight()}))}),{threshold:0}).observe(this.editor.$editor.get())}),500),setTimeout((()=>this.editor.adjustHeight()),3e3)}}class At extends It{build(){this._initializeBuild(),this._finalizeBuild()}_initializeBuild(){this._buildInputComposition(),this._buildElement(),this._buildOptions(),this._buildBlurClass(),this._buildAccessibility(),this._buildEditable(),this._buildContent()}_finalizeBuild(){this._load()}_buildElement(){const t=this.container.get("editor"),e=this.element.isTextarea(),s=this.config.get("classname"),i=!(this.config.is("nostyle")&&"rx-content"===s);this.editor.$editor=e?this.dom("<div>"):this.element,this.editor.$source=e?this.element:this.dom("<textarea>").hide(),this._addEditorClasses(i),this._addEditorToContainer(t,e)}_addEditorClasses(t){t&&this.editor.$editor.addClass(this.config.get("classname")),this.config.is("breakline")&&this.editor.$editor.addClass("rx-editor-breakline"),this.config.is("structure")&&this.editor.$editor.addClass("rx-editor-wym"),this.editor.$editor.addClass(`rx-editor rx-editor-${this.uuid} rx-empty`)}_addEditorToContainer(t,e){t.append(this.editor.$editor),e||t.append(this.editor.$source)}_buildOptions(){const t=this.config.dump(),{dir:e,width:s="100%",padding:i,minHeight:r,maxHeight:a,notranslate:n,spellcheck:o,grammarly:l}=t;this._saveElementStyles(),this._setEditorAttributesAndStyles({dir:e,width:s,padding:i,minHeight:r,maxHeight:a,notranslate:n,spellcheck:o,grammarly:l}),this._setContainerStyles()}_setEditorAttributesAndStyles({dir:t,width:e,padding:s,minHeight:i,maxHeight:r,notranslate:a,spellcheck:n,grammarly:o}){const l={"max-width":this.config.is("nocontainer")?null:e,padding:this.config.is("nocontainer")?null:s,"min-height":i||null,"max-height":r||null,overflow:r?"auto":null};this.editor.$editor.css(l),this._setEditorAttributes(t,a,n,o)}_setEditorAttributes(t,e,s,i){this.config.is("tabindex")&&this.editor.$editor.attr("tabindex",this.config.get("tabindex")),this.editor.$editor.attr("dir",this.element.attr("dir")||t),e&&this.editor.$editor.addClass("notranslate"),s||this.editor.$editor.attr("spellcheck",!1),i||this.editor.$editor.attr("data-gramm_editor",!1)}_load(){try{this._loaded()}catch(t){throw t}}_loaded(){this._initializeApp(),this._setupDraggable(),this._broadcastLoadEvent()}_initializeApp(){const{app:t}=this.app;t.event.build(),t.placeholder.build(),t.placeholder.trigger(),t.blocks.build(),t.sync.build(),t.embed.build(),t.observer.build(),t.image.observeStates()}_broadcastLoadEvent(){this.app.loaded=!0,this.app.broadcast("editor.load")}}class Ht{constructor(t){this.app=t,this.eventTrigger=!0,this.eventPause=!1,this.eventMouseDown=!1,this.eventDoubleClick=!1,this.eventTripleClick=!1,this.eventPaste=!1,this.eventTabFocus=!1,this.eventImageDrag=!1,this.preventName="rx-prevent-events"}init(){this.eventStrategy=this.app.isMode("default")?new jt(this.app,this):new Rt(this.app,this)}build(){const t=setInterval((()=>{this.app.isStarted()&&!this.app.isReadonly()&&(this._stopLinkEvents(),this.eventStrategy.start(),clearInterval(t))}),1)}stop(){this._offPreventEvents(),this.eventStrategy.stop()}run(){this._setPause(!1),this._stopLinkEvents(),this.eventStrategy.start()}pause(){this._setPause(!0),this.eventStrategy.stop(),this._offPreventEvents()}isPaused(){return this.eventPause}isPasteEvent(){return this.eventPaste}isTrigger(){return this.eventTrigger}isTabFocus(){return this.eventTabFocus}isMouseDown(){return this.eventMouseDown}isImageDrag(){return this.eventImageDrag}isDoubleClick(){return this.eventDoubleClick}isTripleClick(){return this.eventTripleClick}isToolClick(t){return 0!==this.dom(t.target).closest(".rx-in-tool").length&&(this.app.block.setTool(!0),!0)}isEditorClick(t){return!!this.app.editor.isEditor(t.target)&&(t.preventDefault(),!0)}isEditorFocus(){return!this.app.dropdown.isOpen()&&!this.app.source.is()&&(this.app.block.is()||this.app.blocks.is()||this.app.editor.isSelectAll())}isOutsideEditor(t){const e=this.dom(t.target),s=["-dropdown-","-form-","-toolbar-container-","-source-container-","-control-","-context-","-pathbar-"].map((t=>`.rx${t}${this.uuid}`)).join(",");return!e.closest(`${s}, .rx-option-list, .rx-editor-${this.uuid}`).length}isEditorContainer(t){const e=this.app.isMode("iframe")?"editor":"container";return 0!==this.dom(t.target).closest(`.rx-${e}-${this.uuid}`).length}setStrategyMouseUp(t){this.eventStrategy.isPopupMouseUp=t}setPasteEvent(t){this.eventPaste=t}setTrigger(t){this.eventTrigger=t}setImageDrag(t){this.eventImageDrag=t}setMouseDown(t){this.eventMouseDown=t?{type:this.app.editor.isEditor(t.target)?"editor":"block",event:t}:t}setDoubleClick(t){this.eventDoubleClick=t}setTripleClick(t){this.eventTripleClick=t}setTabFocus(t){this.eventTabFocus=t}setMultipleBlocks(){this.selector=new Nt(this.app,this),this.selector.setMultiple()}getImageDrag(t){return this.eventImageDrag}getMouseDown(){return this.eventMouseDown}checkTabFocus(t){this.setTabFocus("Tab"===t.key)}checkPopupsOpen(t){this.app.dropdown.isOpen()&&this.app.dropdown.close()}checkPanelKeys(t){const e=t.which;return!(!this.app.dropdown.isOpen()||!this.app.dropdown.isPanel()||"Enter"!==t.key&&![37,38,39,40].includes(e))&&(t.preventDefault(),!0)}handleTextareaTab(t){if(9!==t.keyCode)return!0;t.preventDefault();let e=t.target,s=e.value,i=e.selectionStart;e.value=s.substring(0,i)+"    "+s.substring(e.selectionEnd),e.selectionStart=e.selectionEnd=i+4}_setPause(t){this.eventPause=t}_stopLinkEvents(){this.app.editor.getLayout().on(`click.${this.preventName} dblclick.${this.preventName}`,this._stopLinkEvent.bind(this))}_stopLinkEvent(t){this.dom(t.target).closest("a").length&&t.preventDefault()}_offPreventEvents(){this.app.editor.getLayout().off(`.${this.preventName}`)}_removeDrag(){this.app.editor.getLayout().find(".rx-draggable-placeholder").remove()}}class Nt{constructor(t,e){this.app=t,this.dom=t.dom,this.event=e,this.block=t.block,this.blocks=t.blocks,this.editor=t.editor}handleMouseUp(t){const e=new L(this.app),s=this.dom(t.target).closest("svg");if(s.length){const t=s.parent("span");return void new v(this.app).set(t.length?t:s,"after")}const i=this._getBlockFromTarget(t.target),r=i.dataget("instance");let a=e.getRange()?this._normalizeBlocks(e.getNodes({partial:!0})):r?[r]:[];if(e.isCollapsed()&&(a=[a[a.length-1]]),r&&r.isType("image"))this.blocks.is()&&!i.hasClass("rx-block-meta-focus")?this._setOne(t,e):this._setOne(!1,e,i);else if(this.event.isMouseDown()){const t=this.event.getMouseDown();"block"===t.type?1===a.length||this.event.isDoubleClick()||this.event.isTripleClick()?this._setOne(t.event,e):this._setMultiple(t.event,e,a):1===a.length?this._setOne(!1,e,a[0]):this._setMultiple(!1,e,a)}else this.event.isEditorClick(t)&&e.isCollapsed()?this._setByCoords(t):e.isCollapsed()||1===a.length?this._setOne(t,e):a.length>1&&this._setMultiple(t,e,a)}setByClick(t){let e=!1;(this.event.isDoubleClick()||this.event.isTripleClick())&&(e=this._getBlockFromTarget(t.target));const s=new L(this.app);this._setOne(t,s,e)}setMultiple(){const t=new L(this.app),e=t.getNodes({type:"block",partial:!0});this._setMultiple(!1,t,e)}_setMultiple(t,e,s){this.editor.setFocus(),this.editor.deselectAll();const i=new K(this.app),r=!!t&&this._getBlockFromTarget(t.target);e.isFullySelected()?this._handleFullSelection(e):s.length>1&&this._handleMultipleBlocks(i,s,r)}_setOne(t,e,s=!1){this.editor.setFocus();const i=s?this.dom(s):this._getBlockFromTarget(t.target);if(i.length){const t=i.dataget("instance"),s=(!t||!t.isEditable())&&"force",r=!1!==s;this.editor.setFocus(),this.block.set(i,s,r),t&&t.isType("image")?this.app.broadcast("image.click",{instance:t,data:t.getData()}):t&&t.isType("embed")&&this.app.broadcast("embed.click",{instance:t,content:t.getContent()});const a=e.getInline();a&&"A"===a.tagName&&this.app.broadcast("link.click",{element:this.dom(a)}),t.isAllSelected()&&e.select(i.get())}}_setByCoords(t){const e=this.blocks.get({firstLevel:!0}),s=[],i=[];let r=!1;e.each((t=>{const e=t.get().getBoundingClientRect();s.push([e.x,e.y,e.y+e.height])})),s.forEach(((e,s)=>{const a=t.clientY,n=t.clientX;if(e[1]<a&&a<e[2])return void(r=s);const o=Math.hypot(e[0]-n,e[1]-a);i.push(o)}));const a=!1!==r?r:i.indexOf(Math.min(...i)),n=e.eq(a);this.editor.setFocus(),this.block.set(n,"start")}_setMultipleBlocks(t){this.block.unset(),this.blocks.set(t)}_setSingleBlock(t){this.block.set(t),this.blocks.unset()}_handleMultipleBlocks(t,e,s){this._checkInside(t,e,"quote")?(s=t.getDataBlock(s,"quote"),this._setSingleBlock(s)):this._checkInside(t,e,"noneditable")?(s=t.getDataBlock(s,"noneditable"),this._setSingleBlock(s)):this._setMultipleBlocks(e)}_handleFullSelection(t){const e=this.blocks.get({firstLevel:!0}),s=t.getNodes({type:"block-first"});e.length===s.length&&this.editor.selectAll(e)}_checkInside(t,e,s){return e.every((e=>t.hasParent(e,s)))}_normalizeBlocks(t){const e=t.map((t=>{let e=this.dom(t);return e.attr("data-rx-type")||(e=e.closest("[data-rx-type]")),e.get()}));return[...new Set(e)]}_getBlockFromTarget(t){return this.dom(t).closest("[data-rx-type]")}}class Dt{constructor(t){this.app=t,this.events={}}on(t,e){this.events[t]||(this.events[t]=[]),this.events[t].push(e)}emit(t,e={}){const s=new Mt(this.app,t,e);if(this.events[t])for(const e of this.events[t]){const t=e.call(this.app,s);if(void 0!==t&&s.set("result",t),s.isStopped())break}return this._broadcastPlugins(t,s),s}emitHtml(t,e){if("string"!=typeof e)throw new Error("emitHtml expects an HTML string as the third argument.");if(this.events[t]){for(const s of this.events[t]){const t=s.call(this.app,e);void 0!==t&&(e=t)}return e}this.count=0;const s=new Mt(this.app,t,{html:e});return this._broadcastPlugins(t,s),0!==this.count?s.get("html"):e}_broadcastPlugins(t,e){this.app._plugins.forEach((s=>{this.count++;const i=this.app[s],{subscribe:r}=i;r&&Object.entries(r).forEach((([s,r])=>{s.split(",").map((t=>t.trim())).forEach((s=>{s===t&&("string"==typeof r?i[r](e):r.call(i,e))}))}))}))}}class Pt{constructor(t,e){this.app=t,this.event=e,this.config=t.config,this.block=t.block,this.blocks=t.blocks,this.editor=t.editor,this.image=t.image,this.control=t.control,this.context=t.context,this.placeholder=t.placeholder}getPasteType(t){const e=t.clipboardData;let s=e.getData("text/html"),i=e.getData("text/plain"),r=e.getData("text/rtf"),a="";return s?a=r?"html+rtf":"html":i?a="text":r&&(a="rtf"),a}handlePaste(t){t.preventDefault();const e=t.clipboardData,s=new m(this.app),i=new E(this.app),r=new T(this.app),a=new W(this.app),n=new c(this.app),o=new V(this.app);let l=s.getContent(e);const h=e.getData("URL"),p=e.getData("text/rtf"),d=this.block.get(),g=s.isPlainHtml(e);let u=s.isPlainText(e);"text"===this.getPasteType(t)&&(l=o.encodeEntities(l));let f=!1,b=!0,_=!0;if(this._handleImagePaste(t,e))return;this.event.setPasteEvent(!0);const C=this.app.broadcast("editor.before.paste",{e:t,html:l});if(C.isStopped())return void this.event.setPasteEvent(!1);if(C.has("isPlainText")&&(u=C.get("isPlainText")),l=C.get("html"),l=h&&""!==h?h:l,this.config.is("paste.plaintext")?(b=!1,_=!1,l=r.getTextFromHtml(l,{br:!0})):d&&"pre"===d.getType()&&!this.editor.isSelectAll()?(f=!0,b=!1,_=!1,l=r.getTextFromHtml(l,{nl:!0,trimlines:!1,decode:!1})):this.config.is("paste.clean")||(b=!1),l=this.config.is("paste.links")?l:a.removeTags(l,["a"]),l=this.config.is("paste.images")?l:a.removeTags(l,["img"]),""===l)return void this.event.setPasteEvent(!1);if(p){const t=this._findLocalImages(l);l=this._replaceLocalImages(l,t,this._extractImagesFromRtf(p))}l=b?n.format(l):l,g||!u||f||(l=l.replace(/\n/g,"<br>")),_&&(l=this._convertMarkdownToHtml(l));const v=!!this.app.editor.isSelectAll()&&"end",y=i.insert({type:"paste",html:l,clean:b,parse:_,caret:v});this.config.is("image.upload")&&this.image.parseInserted(y),this.placeholder.toggle(),this.app.broadcast("editor.paste",y),this.event.setPasteEvent(!1)}handleCopy(t){this._handleClipboardAction(t,"copy")}handleCut(t){this._handleClipboardAction(t,"cut")}_convertMarkdownToHtml(t){return t.replace(/(?:^|\n|<br\s*\/?>)(\s*-\s+.+(?:\n|<br\s*\/?>)*)/gi,(t=>{const e=t.split(/(?:\n|<br\s*\/?>)/).filter((t=>t.trim().startsWith("-"))).map((t=>{const e=t.replace(/^\s*-\s+/,"").trim();return e?`<li>${e}</li>`:""})).join("");return e?`<ul>${e}</ul>`:t}))}_handleImagePaste(t,e){const s=this.image.insertFromClipboard(t,e);return this.config.is("image")&&this.config.is("image.upload")&&s}_handleClipboardAction(t,e){const s=new m(this.app),i=new L(this.app),r=this.block.get();let a={};if(r&&r.isEditable()&&i.isCollapsed())return;if(t.preventDefault(),this.editor.isSelectAll()){const t=this.editor.getLayout().children();let e=this.editor.getLayout().html();1===t.length&&"P"===t.eq(0).get().tagName&&(e=t.eq(0).html()),a={html:e,remove:"all"}}else this.blocks.is()?a={html:i.getHtml(),remove:"content"}:r&&r.isEditable()?a=this._copyFromEditable(e,r,i):r&&(a=this._copyFromNonEditable(e,r));const n=this.app.broadcast("editor.before."+e,{e:t,html:a.html});if(n.isStopped())return;"cut"===e&&this._cutDeleteContent(a,i);new V(this.app);const o=new T(this.app);let l=n.get("html"),h=o.getTextFromHtml(l,{nl:!0});return s.setContent(t,l,h),this.app.broadcastHtml("editor."+e,l)}_cutDeleteContent(t,e){this.context.close(),"instance"===t.remove?t.instance.remove({broadcast:!0,traverse:!0}):"all"===t.remove?this.editor.setEmpty():!1!==t.remove&&e.truncate(),"all"!==t.remove&&this.app.editor.isEmpty()&&this.editor.setEmpty()}_copyFromEditable(t,e,s){const i=e.getType();let r=s.getHtml(),a="content";if("figcaption"===i||"cell"===i||"paragraph"===i)a="content";else if(e.isAllSelected())r=e.getHtml(),a="instance";else if("list"===i){var n=e.getTag();r=s.getHtml(),-1!==r.search(/<li/gi)&&(-1===r.search(/^<li/g)&&(r="<li>"+r+"</li>"),r="<"+n+">"+r+"</"+n+">")}return{html:r,remove:a,instance:e}}_copyFromNonEditable(t,e){return{html:e.getOuterHtml(),remove:"cut"===t&&"instance",instance:e}}_findLocalImages(t){const e=new T(this.app),s=[];return e.wrap(t,(function(t){t.find("img, v\\:imagedata").each((function(t){const e=t.attr("src"),i=t.attr("data-state-src");-1===e?.search(/^file:\/\//)&&-1===i?.search(/^file:\/\//)||s.push(e||i)}))})),s}_extractImagesFromRtf(t){if(!t)return[];const e=/{\\pict[\s\S]+?\\bliptag-?\d+(\\blipupi-?\d+)?({\\\*\\blipuid\s?[\da-fA-F]+)?[\s}]*?/,s=new RegExp("(?:("+e.source+"))([\\da-fA-F\\s]+)\\}","g"),i=t.match(s),r=[];if(!i)return[];for(let t=0;t<i.length;t++){let s=!1;-1!==i[t].indexOf("\\pngblip")?s="image/png":-1!==i[t].indexOf("\\jpegblip")&&(s="image/jpeg"),s&&r.push({hex:i[t].replace(e,"").replace(/[^\da-fA-F]/g,""),type:s})}return r}_convertHexToBase64(t){return btoa(t.match(/\w{2}/g).map((function(t){return String.fromCharCode(parseInt(t,16))})).join(""))}_replaceLocalImages(t,e,s){if(e.length===s.length)for(let i=0;i<e.length;i++){let r="data:"+s[i].type+";base64,"+this._convertHexToBase64(s[i].hex);const a=this._escapeRegExp(e[i]);t=t.replace(new RegExp('data-state-src="'+a+'"',"g"),'data-src="'+r+'"')}return t}_escapeRegExp(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}}class Mt{constructor(t,e,s={}){this.app=t,this.eventName=e,this.data=s instanceof Mt?s.dump():s,this._isStopped=!1}stop(){this._isStopped=!0}isStopped(){return this._isStopped}is(...t){return t.some((t=>this.data.hasOwnProperty(t)))}has(t){return void 0!==this.data[t]}get(t){return this.data.hasOwnProperty(t)?this.data[t]:null}set(t,e){this.data[t]=e}dump(){return this.data}getName(){return this.eventName}}class Ft{constructor(t,e){this.app=t,this.event=e,this.dom=t.dom,this.image=t.image,this.config=t.config,this.observer=t.observer,this.editor=t.editor,this.block=t.block,this.blocks=t.blocks,this.imageDrag=!1}handleDrop(t){const e=t.dataTransfer,s=e.getData("item"),i=this.config.get("draggable"),r=this.config.is("image")&&this.config.is("image.upload"),a=this.config.get("filelink.upload")&&e.files?.length;s?this._handleItemDrop(t,i[s]):r&&e.files?.length?(t.preventDefault(),this.image.drop(t,e)):a?(t.preventDefault(),this.app.filelink.drop(t,e)):this._handleHtmlDrop(t,e),this._finalizeDrop()}_handleItemDrop(t,e){t.preventDefault(),(e=e||this._getDropItemHtml(t.dataTransfer.getData("item")))&&this._drop(t,e,"after",!1)}_handleHtmlDrop(t,e){let s=e.getData("text/html").trim()||e.getData("Text");const i=this._drop(t,s);if(this.event.isImageDrag()&&i.length){i.dataget("instance").change(this.event.getImageDrag(),!1)}}_getDropItemHtml(t){return this.dom(`[data-rx-drop-item=${t}]`).html().trim()}_finalizeDrop(){this.event._removeDrag(),this.event.setImageDrag(!1),this.observer.setTrigger(!0),this.editor.setFocus()}_drop(t,e,s,i=!0){const r=new E(this.app),a=new c(this.app),n=new T(this.app),o=this._getDropTarget(t.target,s);this.block.set(o),s||r.insertPoint(t);let l=!0,h=!0;const p=this.block.get();if(p&&p.isType("pre")&&!this.editor.isSelectAll()&&(l=!1,h=!1,e=n.getTextFromHtml(e,{nl:!0,trimlines:!1})),!1===i&&(l=!1,e=a.format(e)),""!==e)return e=l?a.format(e):e,r.insert({html:e,clean:l,parse:h,position:s})}_getDropTarget(t,e){const s=new K(this.app),i="after"===e?s.getFirstLevel(t):s.getDataBlock(t);return 0===i.length?this.blocks.get({first:!0}):i}}class Ot{constructor(t,e){this.app=t,this.event=e,this.config=t.config,this.dom=t.dom,this.uuid=t.uuid,this.keycodes=t.keycodes,this.eventname="rx-events",this.isPopupMouseUp=!1,this.dragoverEvent=!1,this.selector=new Nt(this.app,this.event),this.dropHandler=new Ft(this.app,this.event),this.clipboardHandler=new Pt(this.app,this.event)}onmouseup(t){setTimeout((()=>{!this.event.isTrigger()||this.event.isToolClick(t)||this.isPopupMouseUp||(this.selector.handleMouseUp(t),this._observeAndContext(t),this.app.state.add(t),this.app.broadcast("editor.mouseup",{e:t}))}),0)}onmousedown(t){setTimeout((()=>{this.event.isTrigger()&&!this.event.isToolClick(t)&&(this.event.setMouseDown(t),this.isPopupMouseUp||this.app.dropdown.close(),this.app.placeholder.handleClick(t),this.app.broadcast("editor.mousedown",{e:t}))}),0)}ontouchstart(t){this.event.isTrigger()&&this.app.state.add(t)}onmouseover(t){this.event.isTrigger()&&(this.app.page.getBody().find(".rx-tooltip").remove(),this.app.broadcast("editor.mouseover",{e:t}))}onkeyup(t){if(!this.event.isTrigger()||this.app.dropdown.isOpen()&&!this.app.dropdown.isPanel())return;if(this.app.broadcast("editor.keyup",{e:t}).isStopped())return void t.preventDefault();this.config.is("command")&&this.app.command.build(t);const e=t.which,{DOWN:s,UP:i,BACKSPACE:r,LEFT:a,RIGHT:n,ENTER:o}=this.keycodes;[s,i].includes(e)&&this._handleArrowKeys(),e===r&&this.app.editor.isEmpty()&&this.app.editor.setEmpty(!1),[a,n,s,i].includes(e)&&this.app.observer.observe(),e===o&&this._scrollOnEnter()}ondrop(t){if(!this.event.isTrigger()||!this.config.is("drop"))return t.preventDefault();if(this.app.broadcast("editor.drop",{e:t}).isStopped())return t.preventDefault();this.dropHandler.handleDrop(t)}ondragstart(t){if(!this.event.isTrigger())return;const e=this.dom(t.target).closest("[data-rx-first-level]"),s=new K(this.app);0!==e.length&&s.isType(e,"image")&&this.event.setImageDrag(e.dataget("instance")),this.app.broadcast("editor.dragstart",{e:t})}ondragover(t){if(this.event.isTrigger()){if(t.preventDefault(),this.dragoverEvent=!0,this.app.observer.setTrigger(!1),this.event._removeDrag(),t.dataTransfer.types.includes("item")){const e=this.dom(t.target).closest("[data-rx-type]");if(e.length){const t=this.dom("<div>").addClass("rx-draggable-placeholder");e.after(t)}}this.app.broadcast("editor.dragover",{e:t})}}ondragleave(t){this.event.isTrigger()&&(t.preventDefault(),this.dragoverEvent=!0,this.app.observer.setTrigger(!0),this.event._removeDrag(),this.app.broadcast("editor.dragleave",{e:t}))}ondocmousedown(t){this.event.isTrigger()&&(this.isPopupMouseUp=!!this.dom(t.target).closest(`.rx-dropdown-${this.uuid}`).length,this.app.broadcast("document.mousedown",{e:t}))}onwinfocus(){const t=this.app.block.get();t&&!t.isEditable()&&setTimeout((()=>{new L(this.app).remove()}),0)}_onfocus(t){this.event.isTabFocus()&&!this.app.editor.hasFocus()&&(this.app.editor.setFocus("start"),this.event.setTabFocus(!1))}_onpaste(t){this.event.isEditorFocus()&&this.clipboardHandler.handlePaste(t)}_oncopy(t){this.event.isEditorFocus()&&this.clipboardHandler.handleCopy(t)}_oncut(t){this.event.isEditorFocus()&&this.clipboardHandler.handleCut(t)}_onkeydown(t){if(!this._shouldHandleKeyEvent())return;let e=this.app.broadcast("editor.keydown",{e:t});if(e.isStopped())return t.preventDefault();const s=t.key,i=new L(this.app);this.event.checkPanelKeys(t)||this._handleInlineCaretMove(t,s,i)||this._handleEscapeKey(t,s,i)||(this.app.context.close(),this._handleEnterKey(t,s)||this.app.state.listen(t)||this.app.hotkeys.handle(t)||this.event.isToolClick(t)||this.app.input.handle(e))}_onclick(t){this.event.isTrigger()&&(this.app.broadcast("editor.click",{e:t}),2!==t.detail||this.event.isToolClick(t)||setTimeout((()=>{this.event.setDoubleClick(!0),this.selector.setByClick(t)}),0),3!==t.detail||this.event.isToolClick(t)||setTimeout((()=>{this.event.setTripleClick(!0),this.selector.setByClick(t)}),0))}_ondockeydown(t){this.event.isTrigger()&&!this.app.block.isTool()&&(this.app.broadcast("document.before.keydown",{e:t}),this.event.checkTabFocus(t),"Escape"===t.key&&this.event.checkPopupsOpen(t),this.event.checkPanelKeys(t)||this.event.isOutsideEditor(t)||this.app.broadcast("document.keydown",{e:t}))}_observeAndContext(t){setTimeout((()=>{this.app.context.open(),this.app.observer.observe(),this.event.setMouseDown(!1),this.event.setTripleClick(!1)}),1)}_shouldHandleKeyEvent(){return!(!this.event.isTrigger()||this.app.dropdown.isOpen()||this.app.source.is()||!this.app.editor.hasFocus())}_handleInlineCaretMove(t,e,s){const i=new v(this.app),r=s.getInline();return!(!r||!i.is(r,"end")||"ArrowRight"!==e||"block"===r.style.display)&&(t.preventDefault(),i.set(r,"after"),!0)}_handleEnterKey(t,e){return!this.config.is("enterKey")&&"Enter"===e&&(t.preventDefault(),!0)}_handleEscapeKey(t,e,s){if("Escape"===e&&this.app.context.isOpen()){if(t.preventDefault(),s.collapse(),this.app.context.close(),this.app.blocks.is()){const t=this.app.blocks.get({selected:!0,first:!0,instances:!0});this.app.blocks.unset(),this.app.block.set(t)}return!0}return"Escape"===e&&(this.app.block.unset(),this.app.blocks.unset(),s.remove()),!1}_handleArrowKeys(){const t=new L(this.app).getBlockControlled();t&&!this.app.block.is(t)&&this.app.block.set(t)}_scrollOnEnter(){setTimeout((()=>{const t=new K(this.app),e=this.app.block.get();if(!e)return;const s=e.getBlock(),i=t.isElementVisibleInScroll(s),r=this.app.editor.getEditor().get();i||r.scrollTo({top:r.scrollHeight-r.clientHeight,behavior:"smooth"})}),10)}_bindEvents(t,e,s){e.forEach((e=>{t.on(`${e}.${this.eventname}`,(t=>{const i=`on${s}${e}`;"function"==typeof this[i]&&this[i](t)}))}))}_unbindEvent(...t){t.forEach((t=>t.off("."+this.eventname)))}}class Rt extends Ot{start(){this.events={body:["click","touchstart","mouseover","mouseup","mousedown","keydown","keyup","paste","copy","cut","drop","dragstart","dragover","dragleave"],doc:["keydown","mousedown","mouseup","click"],win:["focus"],frame:["click"],layout:["focus"]},this._bindEvents(this.app.page.getFrameBody(),this.events.body,""),this._bindEvents(this.app.page.getWin(),this.events.win,"win"),this._bindEvents(this.app.page.getFrameDoc(),this.events.frame,"frame"),this._bindEvents(this.app.page.getDoc(!1),this.events.doc,"doc"),this._bindEvents(this.app.editor.getLayout(),this.events.layout,"layout")}stop(){this._unbindEvent(this.app.page.getFrameBody(),this.app.page.getWin(),this.app.page.getFrameDoc(),this.app.page.getDoc(),this.app.editor.getLayout())}onclick(t){this._onclick(t)}onkeydown(t){return this._onkeydown(t)}onpaste(t){return this._onpaste(t)}oncopy(t){return this._oncopy(t)}oncut(t){return this._oncut(t)}ondocclick(t){this.event.isTrigger()&&!this.event.isToolClick(t)&&(this.event.isOutsideEditor(t)&&!this.event.isMouseDown()&&this.event.checkPopupsOpen(t),this.app.broadcast("document.click",{e:t}))}ondockeydown(t){return this._ondockeydown(t)}ondocmouseup(t){this.isPopupMouseUp||this.event.isOutsideEditor(t)&&(this.app.editor.setBlur(),this.app.broadcast("document.mouseup",{e:t}))}onframeclick(t){this.event.isTrigger()&&"HTML"===t.target.tagName&&this.selector.setByClick(t)}onlayoutfocus(t){return this._onfocus(t)}}class jt extends Ot{start(){this.events={editor:["click","touchstart","mouseover","mouseup","mousedown","keyup","keydown","drop","dragstart","dragover","dragleave","focus"],doc:["keydown","mousedown","mouseup","click","paste","cut","copy"],win:["focus"]},this._bindEvents(this.app.editor.getEditor(),this.events.editor,""),this._bindEvents(this.app.page.getDoc(),this.events.doc,"doc"),this._bindEvents(this.app.page.getWin(),this.events.win,"win")}stop(){this._unbindEvent(this.app.editor.getEditor(),this.app.page.getDoc(),this.app.page.getWin())}onfocus(t){return this._onfocus(t)}onclick(t){return this._onclick(t)}onkeydown(t){return this._onkeydown(t)}ondocpaste(t){return this._onpaste(t)}ondoccopy(t){return this._oncopy(t)}ondoccut(t){return this._oncut(t)}ondocclick(t){!this.event.isTrigger()||this.event.isToolClick(t)||this.isPopupMouseUp||(this.event.isOutsideEditor(t)&&!this.event.isMouseDown()&&(this.event.checkPopupsOpen(t),this.app.editor.setBlur(t)),this.app.broadcast("document.click",{e:t}))}ondockeydown(t){return this._ondockeydown(t)}ondocmouseup(t){this.event.isOutsideEditor(t)&&setTimeout((()=>{this.event.isMouseDown()&&(this.selector.handleMouseUp(t),this._observeAndContext(t)),this.app.broadcast("document.mouseup",{e:t})}),2)}}class Vt{constructor(t){this.app=t,this.register={},this.containers={},this.buttonsCustom={},this.buttonsRemove={},this.buttonsBlockSpecific={},this.state={type:!1,button:!1,instance:!1}}stop(){this.closeTooltip()}closeTooltip(){this.app.$body.find(".rx-tooltip").remove()}close(t,...e){t&&!t.preventDefault&&(e.unshift(t),t=null);this._handleContexts(e,["dropdown","control","context"]).forEach((e=>this.app[e].close(t)))}unset(...t){this._handleContexts(t,["toolbar","extrabar","context"]).forEach((t=>this.app[t].unsetActive()))}disable(...t){let e=["path","extrabar","statusbar","toolbar"];if(this.app.isReadonly()){const t=this.config.get("readonly");"object"==typeof t&&(e=e.filter((e=>!t.hasOwnProperty(e))))}this._handleContexts(t,e).forEach((t=>this.app[t].disable()))}disableToolbar(t,e){this._findButtons(t).each((t=>this._enableDisable(t,e,!0)))}enable(...t){this._handleContexts(t,["path","extrabar","statusbar","toolbar"]).forEach((t=>this.app[t].enable()))}enableToolbar(t,e){this._findButtons(t).each((t=>this._enableDisable(t,e,!1)))}_enableDisable(t,e,s){if(e.length>0){let i=t.data("name");e.includes(i)&&t.dataget("instance").setState({disabled:s})}else t.dataget("instance").setState({disabled:s})}isAnyOpen(...t){return t.some((t=>this.app[t]&&this.app[t].isOpen()))}updateTheme(t){["tooltip","control","context"].forEach((e=>this.app.$body.find(`.rx-${e}`).attr("rx-data-theme",t))),["dropdown"].forEach((e=>this.app.$body.find(`.rx-${e}-`+this.uuid).each((e=>e.attr("rx-data-theme",t)))))}updatePosition(...t){t.forEach((t=>this.app[t].updatePosition()))}updateEvents(...t){t.forEach((t=>this.app[t].updateEvents()))}observeButtons(t){t.find(".rx-button").each((t=>t.dataget("instance")?.observe()))}loadToolbar(t,e){let s=this.app.block.get();return e!==(!!s&&s.getType())?(e=this.buildButtons(t),this.loadBlockButtons(t)):this.observeButtons(this.getContainer(t)),e}loadBlockButtons(t){this.buildBlockButtons(t,this.getContainer(t))}build(t,e){return new zt(this,t,e)}loadButtonsFromArray(t,e,s,i){return t=this._buildButtonObj(s,t),e=this._buildButtonObj(s,e),this._makeButtons(s,!1,t,e,i)}loadButtons(t,e,s,i,r){t=this._buildButtonObj(s,t),e=this._buildButtonObj(s,e);const a=this._getToggledButtons(i),n=this._makeButtons(s,i,t,e,r);return i&&i.html(""),this._createButtons(n,a,s,i)}buildButtons(t,e,s){const i=s?[]:this._getButtonsFromconfig(t,e),r=this._getCustomButtons(t,e,s),a="control"===t?[]:this.getButtonsRemove(t),n=this.getContainer(t),o=this._getToggledButtons(n),l=this._makeButtons(t,n,i,r,a,s);(n||"context"===t&&e)&&n.html(""),this._createButtons(l,o,t,n),this._buildButtonsOrder(t,n);let h=this.app.block.get();return!!h&&h.getType()}buildBlockButtonsGetter(t,e=[]){const s=this.app.block.get();if(!s)return;const i={},r=s.getButtons(t)||{};return Object.entries(r).forEach((([s,r])=>{const a=this._buildObject(t,s,r);e.includes(s)||this._isHiddenButton(t,s)||(i[s]=a)})),i}buildBlockButtons(t,e,s=[]){const i=this.app.block.get();if(!i)return;const r=i.getButtons(t)||{};Object.entries(r).forEach((([i,r])=>{const a=this._buildObject(t,i,r);if(!s.includes(i)&&!this._isHiddenButton(t,i)){new d(this.app,i,a,t,e)}}))}buildDepth(t,e){let s="",i=["dropdown"].includes(t);this.config.is("bsmodal")?s=i?1061:1060:this.app.isProp("fullscreen")&&(s=i?10002:10001),e.css("z-index",s)}getContainer(t){return this.containers[t]??=this.dom([])}getButtonsCustom(t){return this.buttonsCustom[t]??={}}getButtonsBlockSpecific(t){return this.buttonsBlockSpecific[t]??={}}getButtonsRemove(t){return this.buttonsRemove[t]??=[]}addContainer(t,e){this.containers[t]=e}registerButton(t,e){this.register[t]=e}addButton(t,e,s,i){if(this.app.isStarted()){let i=this._buildObject(t,e,s);new d(this.app,e,i,t,this.getContainer(t))}else i?(this.buttonsBlockSpecific[t]??={},this.buttonsBlockSpecific[t][e]=s):(this.buttonsCustom[t]??={},this.buttonsCustom[t][e]=s),this.registerButton(e,s)}removeButton(t,e){this.buttonsRemove[t]??=[],Array.isArray(e)?this.buttonsRemove[t].push(...e):this.buttonsRemove[t].push(e)}setButton(){}setButtonColor(t,e){const s=t.dataget("instance");if(!s||s.getProp("color"))if(e&&Object.keys(e).length){const{color:t,background:i}=e;t&&i?(s.setBackground(i),s.setColor(t)):s.setBackground(t||i)}else s.resetBackground()}setState(t){let e=this.state;this.state=t,e&&(this.state.prev=e)}setActive(t,e){this.unsetActive(t),this._findButtonInstance(t,e)?.setState({active:!0})}setActiveKeys(t,e,s){t.forEach((t=>this._setButtonsActiveByKeys(t,e))),t.forEach((t=>this._setButtonsStyle(t,s)))}setToggled(t,e){this.unsetToggled(t),this._findButtonInstance(t,e)?.setState({pressed:!0})}getState(){return this.state}getButton(t,e){return this._findButtonInstance(t,e)}unsetActive(t,e){if(e){let s=this._findButtonInstance(t,e);s&&s.setState({active:!1})}else this._findButtons(t).each((t=>{t.dataget("instance").setState({active:!1}),t.dataget("instance").resetBackground()}))}unsetToggled(t,e,s){if(e){let s=this._findButtonInstance(t,e);s&&s.setState({pressed:!1})}else this._findButtons(t).each((t=>{let e=t.dataget("instance");e.setState({pressed:!1}),(!s||s&&e.getName()!==s)&&t.removeClass("rx-in-modal")}))}_handleContexts(t,e){return 0===t.length?e:t}_setButtonsActiveByKeys(t,e){e.forEach((e=>this._findButtonInstance(t,e)?.setState({active:!0})))}_setButtonsStyle(t,e){this._findButtons(t).each((t=>this.setButtonColor(t,e)))}_findButton(t,e){return this.getContainer(t).find("[data-name="+e+"]")}_findButtonInstance(t,e){let s=this._findButton(t,e);if(0!==s.length)return s.dataget("instance")}_findButtons(t){return this.getContainer(t).find(".rx-button")}_makeButtons(t,e,s,i,r,a){const n=a?[]:this._getExtendFromconfig(t),o=this._getBlockButtons(t);"dropdown"===t&&"control"===this.app.dropdown.getName()&&(t="control");let l=[...s,...i,...n,...o],h=[...r,...this.config.get(`${t}.hide`)||[]];return l=this._shiftLastPositionButtons(l),l.filter((t=>!h.includes(t.name)))}_buildButtonsOrder(t,e){const s=this._findButtons(t).all(),i=document.createDocumentFragment(),r=this.config.get("buttons."+t),a=l.opts.buttons[t];r&&a!==r&&(r.forEach((t=>{const e=s.find((e=>e.getAttribute("data-name")===t));e&&i.appendChild(e)})),s.forEach((t=>{r.includes(t.getAttribute("data-name"))||i.appendChild(t)})),e.html(""),e.append(i))}_buildObject(t,e,s){let i=this._getButtonObj(e);return i=i?l.extend(!0,{},i,s):l.extend(!0,{},s),i.name=void 0!==i.name?i.name:e,!this._isHiddenButton(t,e)&&i}_buildButtonObj(t,e){let s=[];return Array.isArray(e)?e.forEach((e=>{let i={};"object"==typeof e&&(i=e,e=e.name);const r=this._buildObject(t,e,i);r&&s.push(r)})):Object.entries(e).forEach((([e,i])=>{const r=this._buildObject(t,e,i);r&&s.push(r)})),s}_shiftLastPositionButtons(t){const e=t.findIndex((t=>"last"===t.position));if(-1!==e){const[s]=t.splice(e,1);t.push(s)}return t}_getButtonsFromconfig(t,e){let s=[...this.config.get("buttons."+t)];return"context"===t&&e&&(s=[]),this._buildButtonObj(t,s)}_getCustomButtons(t,e,s){let i="control"===t?{}:this.getButtonsCustom(t);return i=s?{}:i,"context"===t&&e&&(i=this.getButtonsBlockSpecific(t)),this._buildButtonObj(t,i)}_getExtendFromconfig(t){const e=this.config.get(`${t}.add`)||{};return this._buildButtonObj(t,e)}_getBlockButtons(t){const e=this.app.block.get(),s="control"===t?{}:e&&e.getButtons(t)||{};return this._buildButtonObj(t,s)}_getToggledButtons(t){const e={};return t&&t.find(".pressed").each((t=>{const s=t.dataget("instance");s&&(e[s.getName()]={title:s.getTitle(),icon:s.getIcon(),command:s.getCommand()})})),e}_createButtons(t,e,s,i){const r={};return t.forEach((t=>{const a=new d(this.app,t.name,t,s,i);r[t.name]=a,e[t.name]&&(a.setState({pressed:!0}),a.setIcon(e[t.name].icon),a.setCommand(e[t.name].command),a.setTitle(e[t.name].title))})),r}_isHiddenButton(t,e){const s=this.app.block.get(),i={add:"addbar",html:"source",format:"format",line:"line",pre:"pre",quote:"quote",layout:"layouts",wrapper:"wrapper",table:"table",image:"image",todo:"todo"};return void 0!==i[e]&&!this.config.is(i[e])||(!("trash"!==e||!s||!s.isType("noneditable")||this.config.is("noneditable.remove"))||(!("trash"!==e||!s||!s.isNondeletable())||!("trash"!==e&&"duplicate"!==e||!s||!s.isType("column"))))}_getButtonObj(t){const e=this.config.get("buttonsObj");let s=!!e[t]&&e[t];return s=!s&&this.app.ui.register[t]?this.app.ui.register[t]:s,s}}class zt{constructor(t,e,s){this.ui=t,this.type=e,this.uuid=t.uuid,this.$container=s,this.build()}build(){this.$toolbar=new r("<div>").addClass("rx-"+this.type+" rx-"+this.type+"-"+this.uuid),this.$toolbarButtons=new r("<div>").addClass("rx-"+this.type+"-buttons"),this.$toolbarLine=new r("<div>").addClass("rx-"+this.type+"-line").hide(),this.$toolbar.append(this.$toolbarButtons),"context"===this.type&&this.$toolbar.append(this.$toolbarLine),this.$container.append(this.$toolbar),this.ui.addContainer(this.type,this.$toolbarButtons)}getElement(){return this.$toolbar}getElementLine(){return this.$toolbarLine}}l.UIForm=class{constructor(t,e){this.app=t,this.dom=t.dom,this.loc=t.loc,this.tools={},this.data=!1,this.app.broadcast("form.before.create",{params:e}),this.create(e)}create(t){this.params={title:!1,data:!1,width:!1,items:!1,focus:!1,setter:!1,getter:!1,command:!1,...t},this.data=this.params.data,this._build()}setFocus(t){this._buildFocus(t)}setSetter(t){this.params.setter=t}setData(t){this.data=t}getSetter(){return this.params.setter}getCommand(){return this.params.command}getElement(){return this.$form}getItem(t){let e=this.getTool(t);return e?e.getInput().closest(".rx-form-item"):this.dom()}getInput(t){let e=this.getTool(t);return e?e.getInput():this.dom()}getTool(t){return void 0!==this.tools[t]&&this.tools[t]}getData(t){let e;return t?void 0!==this.tools[t]&&(e=this.tools[t].getValue()):(e={},Object.keys(this.tools).forEach(function(t){e[t]=this.tools[t].getValue()}.bind(this))),e}_build(){this.$form=this.dom("<div>").addClass("rx-form"),this._buildWidth(),this._buildTitle(),this._buildData(),this._buildForm(),this._buildFocus(),this.app.broadcast("form.create",{form:this,params:this.params})}_buildWidth(){this.params.width&&this.$form.css("width",this.params.width)}_buildData(){this.data||(this.data=!!this.params.getter&&this.app.api(this.params.getter,this))}_buildFocus(t){if(t=t||this.params.focus)if(void 0!==this.tools[t])this.tools[t].setFocus();else{const t=this.$form.find("input").first();t.length&&t.focus()}}_buildTitle(){this.params.title&&(this.$title=this.dom("<div>").addClass("rx-form-title"),this.$title.html(this.loc.parse(this.params.title)),this.$form.append(this.$title))}_buildForm(){this._renderTools(),this._renderData(),this.$form.find("input[type=text],input[type=url],input[type=email]").on("keydown.rx-form",function(t){if(13===t.which)return t.preventDefault(),!1}.bind(this))}_renderTools(){const t=["flex","flex2","flex3"];for(let[e,s]of Object.entries(this.params.items))if(s.title){let t=this.dom('<div class="rx-form-section">');t.html(this.loc.parse(s.title)),this.$form.append(t)}else if(t.includes(e)){let t=this.dom('<div class="rx-form-flex">');this.$form.append(t);for(let[e,i]of Object.entries(s))this._renderTool(e,i,t)}else this._renderTool(e,s,this.$form)}_renderTool(t,e,s){if(!e.type)return;const i=this._getToolClassName(e),r=new l[i](this.app,t,e,this);let a=r.getElement();a&&(this.tools[t]=r,s.append(a))}_renderData(){if(this.data)for(let t in this.data)void 0!==this.tools[t]&&this.tools[t].setValue(this.data[t])}_getToolClassName(t){return"Tool"+t.type.charAt(0).toUpperCase()+t.type.slice(1)}};class Wt{constructor(t){this.app=t}init(){this.isEnabled()&&(this.$toolbox=this.app.container.get("toolbox"),this._buildToolbar(),this._buildRaised(),this._buildSticky())}stop(){this.isEnabled()&&this.$toolbar.remove()}load(){this.build()}build(){this.isEnabled()&&this.app.ui.buildButtons("toolbar")}add(t,e){this.app.ui.addButton("toolbar",t,e)}remove(t){this.app.ui.removeButton("toolbar",t)}setActive(t){this.app.ui.setActive("toolbar",t)}setToggled(t){this.app.ui.setToggled("toolbar",t)}unsetActive(t){this.app.ui.unsetActive("toolbar",t)}unsetToggled(t,e){this.app.ui.unsetToggled("toolbar",t,e)}getButton(t){return this.app.ui.getButton("toolbar",t)}getElement(){return this.$toolbar}enable(...t){this.enableSticky(),this.app.ui.enableToolbar("toolbar",t)}disable(...t){this.disableSticky(),this.app.ui.disableToolbar("toolbar",t)}enableSticky(){this.isEnabled()&&this.sticky.enableSticky()}disableSticky(){this.isEnabled()&&this.sticky.disableSticky()}isSticky(){return this.sticky.isSticky()}isEnabled(){return this.config.is("toolbar")}isRaised(){return this.config.is("toolbar.raised")}isExternal(){return this.config.is("toolbar.target")}rebuildSticky(){this.sticky.observeSticky()}_buildToolbar(){const t=this.app.container.get("toolbar");this.$toolbar=this.app.ui.build("toolbar",t).getElement()}_buildSticky(){this.sticky=new Ut(this.app,this),this.sticky.enableSticky()}_buildRaised(){this.config.is("toolbar.raised")&&this.$toolbox.addClass("rx-raised")}}class Zt{constructor(t){this.app=t,this.eventname="rx-toolbar"}init(){this.isEnabled()&&this._buildToolbar()}stop(){this.isEnabled()&&this.$toolbar.remove()}load(){this.build()}build(){this.isEnabled()&&this.app.ui.buildButtons("extrabar")}add(t,e){this.app.ui.addButton("extrabar",t,e)}remove(t){this.app.ui.removeButton("extrabar",t)}setActive(t){this.app.ui.setActive("extrabar",t)}setToggled(t){this.app.ui.setToggled("extrabar",t)}unsetActive(t){this.app.ui.unsetActive("extrabar",t)}unsetToggled(t,e){this.app.ui.unsetToggled("extrabar",t,e)}getButton(t){return this.app.ui.getButton("extrabar",t)}getElement(){return this.$toolbar}enable(...t){this.app.ui.enableToolbar("extrabar",t)}disable(...t){this.app.ui.disableToolbar("extrabar",t)}isEnabled(){return this.config.is("extrabar")}_buildToolbar(){const t=this.app.container.get("toolbar");this.$toolbar=this.app.ui.build("extrabar",t).getElement()}}class Ut{constructor(t,e){this.toolbar=e,this.app=t,this.config=t.config,this.eventname="rx-toolbar",this.$toolbox=this.app.container.get("toolbox")}isSticky(){let t=this.app.container.get("main"),e=this.toolbar.isRaised()?parseInt(this.$toolbox.css("margin-top")):0,s=t.offset().top+parseInt(t.css("border-top-width"))+e,i=this.$toolbox.offset().top;return i>s||i<s}enableSticky(){this.config.is("toolbar.sticky")&&!this.config.is("toolbar.target")&&(this.config.is("scrollOverflow")?this._startStickyOverflowEvent():(this._applyStickyStyles(),this._startStickyEvent()),this.config.is("scrollOverflow")&&this._observeOverflowSticky())}disableSticky(){this.config.is("toolbar.sticky")&&(this._removeStickyStyles(),this._stopStickyEvent())}observeSticky(){if(this._isSource())return;let t=this.app.scroll.getTarget(),e=0-(this.app.scroll.isTarget()?parseInt(t.css("padding-top")):0)+parseInt(this.config.get("toolbar.stickyTopOffset"));this.app.isProp("fullscreen")&&(e=0),this.$toolbox.css({top:`${e}px`}),this.broadcastSticky()}broadcastSticky(){this.isSticky()?(this.$toolbox.addClass("rx-sticky-on"),this.app.broadcast("toolbar.sticky")):(this.$toolbox.removeClass("rx-sticky-on"),this.app.broadcast("toolbar.static"))}_isSource(){return!!this.app.source.is()&&(this.$toolbox.css("top",0),!0)}_applyStickyStyles(){this.$toolbox.addClass("rx-sticky"),this.$toolbox.css("top",`${this.config.get("toolbar.stickyTopOffset")}px`)}_removeStickyStyles(){this.$toolbox.removeClass("rx-sticky rx-fixed-on"),this.$toolbox.css({position:"","z-index":"","max-width":"",top:""})}_getStickyTarget(){return this.app.scroll.getTarget()}_startStickyOverflowEvent(){const t=this._getStickyTarget(),e=this.app.container.get("main");setTimeout((()=>e.attr("data-initial-width",e.width())),0),t.on(`scroll.${this.eventname}`,this._observeOverflowSticky.bind(this)),t.on(`resize.${this.eventname}`,this._resizeOverflowSticky.bind(this))}_startStickyEvent(){this._getStickyTarget().on(`scroll.${this.eventname}`,this.observeSticky.bind(this))}_stopStickyEvent(){this._getStickyTarget().off(`.${this.eventname}`)}_resizeOverflowSticky(){const t=this.app.container.get("main");t.css("width",""),t.attr("data-initial-width",t.width()),this.$toolbox.hasClass("rx-fixed-on")&&this.$toolbox.css("max-width",`${t.width()}px`)}_observeOverflowSticky(){if(this._isSource())return;const t=this.app.editor.getRect(),e=this.app.container.get("main"),s=this.app.scroll.getTarget(),i=e.offset().top,r=e.data("initial-width"),a=this.$toolbox.height(),n=t.bottom-80,o=s.get().pageYOffset;o>=i&&o<=n?(this._applyFixedStyles(e,r,a),this.app.broadcast("toolbar.sticky")):(this._removeFixedStyles(e),this.app.broadcast("toolbar.static"))}_applyFixedStyles(t,e,s){this.$toolbox.css({position:"fixed","z-index":1060,"max-width":`${t.width()}px`,top:"0px"}),t.css({width:`${e}px`,"padding-top":`${s}px`}),this.$toolbox.addClass("rx-fixed-on")}_removeFixedStyles(t){this.$toolbox.css({position:"","z-index":"","max-width":"",top:""}),t.css({width:"","padding-top":""}),this.$toolbox.removeClass("rx-fixed-on")}}class qt{constructor(t){this.app=t,this.customButtons={},this.removeButtons=[]}add(t,e){this.customButtons[t]=e,this.app.ui.registerButton(t,e)}remove(t){if(Array.isArray(t))for(let e=0;e<t.length;e++)this.removeButtons.push(t[e]);else this.removeButtons.push(t)}getItems(){let t=[...this.config.get("popups.addbar")],e=this.config.get("addbarItems")||{},s=l.extend(!0,{},e,this.customButtons),i=this.app.ui.loadButtons(t,s,"addbar",!1,this.removeButtons),r=["text","address","list","todo","quote","dlist"];for(let[t,e]of Object.entries(i))-1!==r.indexOf(t)&&e.setCommand("block.add");return i}popup(t,e){let s=[...this.config.get("popups.addbar")],i=this.config.get("addbarItems")||{};const r=this.config.get("addbar.hide")||[];this.customButtons=l.extend(!0,{},i,this.customButtons);let a=[...this.removeButtons,...r];!t&&this.app.toolbar.isEnabled()&&(t=e,e=this.app.toolbar.getButton("add")),this.app.dropdown.create("addbar",{items:s,extend:this.customButtons,remove:a,type:"addbar"}),this.app.dropdown.open(t,e)}}class Kt{constructor(t){this.app=t,this.eventName="rx-context",this.instance=!1,this.line=!1}init(){if(!this.isEnabled())return;let t=this.app.ui.build("context",this.app.$body);this.$context=t.getElement(),this.$contextLine=t.getElementLine(),this.$contextButtons=this.app.ui.getContainer("context"),this.$context.hide()}stop(){this.isEnabled()&&(this.$context.remove(),this.app.scroll.getTarget().off("."+this.eventName))}remove(t){this.app.ui.removeButton("context",t)}addLine(t){this.line=t}add(t,e,s){this.app.ui.addButton("context",t,e,s)}showLine(t=!1){t=t||this.line,this.$contextLine.html(t).show()}unsetActive(t){this.app.ui.unsetActive("context",t)}unsetToggled(t,e){this.app.ui.unsetToggled("context",t,e)}getButton(t){return this.app.ui.getButton("context",t)}getElement(){return this.$context}getInstance(){return this.instance}isOpen(){if(this.isEnabled())return this.$context.hasClass("open")}isEnabled(){return this.config.is("context")}close(){this._close()}open(){if(this.line=!1,!this.isEnabled()||this.app.block.isTool())return;if(this.config.is("context.click"))return void this._open();const t=new L(this.app),e=new K(this.app);let s=t.getCurrent(),i=this._getBlockSelection(s),r=this._getInlineSelection(s);t.is()&&e.isTool(s)?this.app.block.setTool(!0):i&&t.is()&&!t.isCollapsed()?this._open():r&&0!==r.length?(this.instance=r.dataget("instance"),this.instance.isContext()&&this._open(r)):this._close()}updateEvents(){this.isEnabled()&&(this.app.scroll.getTarget().off("."+this.eventName),this.app.editor.getEditor().off("."+this.eventname),this._buildEvents())}updatePosition(){if(!this.isEnabled())return;let t=this.$context.width(),e=this.app.editor.getRect(),s=this.app.page.getDoc().scrollTop();const i=new L(this.app);let r=i.getPosition("end"),a=0,n=0;if(this.app.isMode("iframe")){let t=this.app.editor.getRect();a=t.top,n=t.left}const o=i.getPosition();let l=o.left+n+2,h=o.bottom+a+s;if(this.app.blocks.is()&&0===r.left&&0===r.top){s=0;let t=this.app.blocks.get({last:!0,selected:!0,instances:!0}),e=t.getOffset();l=e.left+n+2,h=e.top+t.getBlock().height()}if(this.app.editor.isSelectAll()){let t=this.app.blocks.get({last:!0}),e=t.offset();l=e.left+n+2,h=e.top+a+t.height()+s}if(l+t>e.right&&(l=r.left+n-t-2),r.left-n===0&&r.right-a===0&&this.instance){let t=this.instance.getOffset(),e=this.instance.getBlock().height();l=t.left,h=t.top+e}this.app.ui.buildDepth("context",this.$context),this.$context.css({left:l+"px",top:h+2+"px"}),this.$context.attr({dir:this.config.get("dir"),"rx-data-theme":this.app.editor.getTheme()})}_open(t){this._shouldShowToolbar()&&(this.$contextLine.html("").hide(),this.instance&&this.$contextButtons.html(""),this.app.ui.buildButtons("context",this.instance,t),""===this.$contextButtons.html()&&(this.instance=!1),this.line&&this.$contextLine.html(this.line).show(),this._buildPosition(),this._buildEvents(),this.app.broadcast("context.open"))}_shouldShowToolbar(){if(!this.config.is("context.exclude")&&!this.config.is("context.include"))return!0;const t=new L(this.app).getNodes({type:"block"}),e=this.config.get("context.exclude")||{},s=this.config.get("context.include")||{},i=e.tags||[],r=e.blocks||[],a=s.tags||[],n=s.blocks||[];for(let e of t){const t=e.tagName.toLowerCase(),s=e.getAttribute("data-rx-type");if(i.includes(t)||r.includes(s))return!1;if((a.length||n.length)&&!a.includes(t)&&!n.includes(s))return!1}return!0}_close(){this.isEnabled()&&this.$context.hasClass("open")&&(this.$context.hide().removeClass("open"),this.instance=!1,this.app.scroll.getTarget().off("."+this.eventname),this.app.editor.getEditor().off("."+this.eventname),this.app.broadcast("context.close"))}_getBlockSelection(t){return 0===this.dom(t).closest("[data-rx-inline], [data-rx-type=noneditable], [data-rx-type=figcaption]").length}_getInlineSelection(t){return t?this.dom(t).closest("[data-rx-inline]"):this.app.editor.getLayout().find("[data-rx-inline]").filter((t=>t.hasClass("rx-block-focus"))).eq(0)}_buildPosition(){this.$context.addClass("open"),this.updatePosition(),this.$context.show()}_buildEvents(){let t=this.app.scroll.getTarget();this.app.scroll.isTarget()&&t.on("scroll."+this.eventname,this._scroll.bind(this)),t.on("resize."+this.eventName,this.updatePosition.bind(this)),this.app.editor.getEditor().on("scroll."+this.eventname,this._scroll.bind(this))}_scroll(){const t=(t,e=0)=>{const s=t.offset().top+e,r=s+t.height();return i+this.$context.height()>r||s>i?(this.$context.hide(),!0):this.isOpen()?(this.$context.show(),!1):void 0},e=new L(this.app).getPosition("end"),s=this.app.page.getDoc().scrollTop(),i=e.bottom+s+2;this.$context.css("top",`${i}px`);let r=!1;if(this.app.scroll.isTarget()){r=t(this.app.scroll.getTarget(),20)}if(this.config.is("maxHeight")&&!r){t(this.app.editor.getEditor())}}_isInstance(t){let e=this.app.block.get(),s=e&&e.isEditable(),i=e&&"pre"!==e.getType();return s&&i}}class Gt{constructor(t){this.app=t,this.eventName="rx-control",this.parentTypes={list:[{name:"parent",title:"## list.select-list ##"}],cell:[{name:"parent",title:"## table.select-table ##"},"cell-setting"],cellParent:[{name:"parent",title:"## table.select-table ##"},{name:"parent",title:"## table.select-cell ##",params:{cell:!0}}],column:[{name:"parent",title:"## layout.select-layout ##"},{name:"parent",title:"## layout.select-column ##",params:{column:!0}}]}}init(){this.isEnabled()&&this._buildToolbar()}stop(){this.isEnabled()&&(this._removeControl(),this._stopEvents())}add(t,e){this.app.ui.addButton("control",t,e)}remove(t){this.app.ui.removeButton("control",t)}isEnabled(){return this.config.is("control")}build(){let t=this.app.block.get();t?this.open(t):this.close()}getButton(t){return this.app.ui.getButton("control",t)}getElement(){return this.$control}trigger(){this.isEnabled()&&this.getButton("toggle").getElement().click()}popup(t,e){if(this._shouldCloseDropdown())return void this.app.dropdown.close();let s=[...this.config.get("popups.control")];this._getParentElement()&&(s=this._getParentButtons(s));const i=this.app.ui.getButtonsCustom("control"),r=this.app.ui.getButtonsRemove("control");this.app.dropdown.create("control",{items:s,extend:i,remove:r}),this.app.dropdown.open(t,e)}open(t){this.isEnabled()&&(this.instance=t,this._hasControl()?(this._setParentInstance(),this.instance?(this._buildEvents(),this._prepareToOpen(),this._updatePositions(),this._buildReorder()):this.close()):this.close())}close(){this.isEnabled()&&this.$control&&(this.$control.hide(),this._stopEvents(),this.instance=!1)}updateEvents(){this.isEnabled()&&(this._stopEvents(),this._buildEvents())}updatePosition(){if(!this.isEnabled()||!this.instance)return void this.close();const{top:t,left:e}=this._calculatePosition();this.$control.show(),(this._shouldHideForScrollTarget(t)||this._shouldHideForEditor(t))&&this.$control.hide(),this._setPosition(t,e)}_calculatePosition(){const t=this.instance.getOffset(),e=this.$control.width(),{topOutlineFix:s,leftOutlineFix:i}=this._getOutlineFixes(),{frameOffsetTop:r,frameOffsetLeft:a}=this._getFrameOffsets(),n=parseInt(this.instance.getBlock().css("margin-left")),o=this._getAdjustedLeftOutlineFix(i,n);return{top:t.top+r-s,left:t.left+a-e-o}}_getOutlineFixes(){const t=parseInt(this.instance.getBlock().css("padding-top"));return{topOutlineFix:this.instance.isType("line")&&0===t?14:5,leftOutlineFix:5}}_getFrameOffsets(){let t=0,e=0;if(this.app.isMode("iframe")){const s=this.app.editor.getRect();t=s.top,e=s.left}return{frameOffsetTop:t,frameOffsetLeft:e}}_getAdjustedLeftOutlineFix(t,e){return e<0?t+e:t}_shouldHideForScrollTarget(t){if(this.app.scroll.isTarget()){const e=this.app.scroll.getTarget(),s=e.offset().top+e.height(),i=e.offset().top,r=t+this.$control.height(),a=parseInt(e.css("padding-top"));return r>s||i+a>t}return!1}_shouldHideForEditor(t){if(this.config.is("maxHeight")){const e=this.app.editor.getEditor(),s=e.offset().top+e.height(),i=e.offset().top;return t+this.$control.height()>s||i>t}return!1}_setPosition(t,e){this.app.ui.buildDepth("control",this.$control),this.$control.css({top:`${t}px`,left:`${e}px`})}_removeControl(){this.$control.remove()}_shouldCloseDropdown(){return this.app.dropdown.isOpen()&&"control"===this.app.dropdown.getName()}_getParentElement(){return this.instance.getClosest(["list","wrapper","layout","todo","table"])}_getParentButtons(t){return this.instance.isType("cell")?t.unshift(...this.parentTypes.cell):this.instance.getClosest("cell")?t.unshift(...this.parentTypes.cellParent):this.instance.getClosest("column")?t.unshift(...this.parentTypes.column):this.instance.getClosest("list")?t.unshift(...this.parentTypes.list):t.unshift("parent"),t}_setParentInstance(){this.instance.isParent()&&(this.instance=this.instance.getParent())}_prepareToOpen(){this.app.ui.buildButtons("control"),this.$control.attr("rx-data-theme",this.app.editor.getTheme()),this.$control.show()}_hasControl(){return!1!==this.instance.getControl()}_updatePositions(){this.updatePosition(),this.app.dropdown.updatePosition()}_stopEvents(){this.app.scroll.getTarget().off("."+this.eventName),this.app.editor.getEditor().off("."+this.eventName)}_buildReorder(){const t=this.getButton("toggle");this.config.is("reorder")&&this.instance.isReorder()&&new k(this.app,this,t,this.$control,this.instance)}_buildToolbar(){this.$control=this.app.ui.build("control",this.app.$body).getElement(),this.$control.hide()}_buildEvents(){let t=this.app.scroll.getTarget();t.on("resize."+this.eventName,this.updatePosition.bind(this)),t.on("scroll."+this.eventName,this.updatePosition.bind(this)),this.app.editor.getEditor().on("scroll."+this.eventName,this.updatePosition.bind(this))}}class Jt{constructor(t){this.app=t,this.classname="rx-pathbar",this.activeClass="active",this.pathItemClass="rx-pathbar-item"}init(){this.config.is("pathbar")&&(this.$pathbar=this.dom("<div>").attr("dir",this.config.get("dir")),this.$pathbar.addClass(this.classname+" "+this.classname+"-"+this.uuid),this.app.container.get("pathbar").append(this.$pathbar),this._buildRoot(),this._buildActive())}build(){this.config.is("pathbar")&&(this._clear(),this._buildRoot(),this.app.blocks.is()||(this._buildItems(),this._buildActive()))}enable(){this.config.is("pathbar")&&this.$pathbar.removeClass("disable")}disable(){this.config.is("pathbar")&&this.$pathbar.addClass("disable")}_clear(){this.$pathbar.find("."+this.pathItemClass).off(".rx-path-"+this.uuid),this.$pathbar.html("")}_createItem(){return this.dom("<span>").addClass(this.pathItemClass)}_buildRoot(){let t=this.config.get("pathbar.title");t=t||this.loc.get("pathbar.title"),this._buildItem(!1,t)}_buildItems(){let t=this.app.block.get();if(!t)return;let e=t.getBlock().parents("[data-rx-type]");e.nodes.reverse(),e.each(this._buildParentItem.bind(this)),this._buildItem(t)}_buildParentItem(t){let e=t.dataget("instance");e.isType(["row"])||this._buildItem(e)}_buildItem(t,e){let s=this._createItem();s.dataset("instance",t),s.on("click.rx-path-"+this.uuid,this._selectItem.bind(this)),this._buildTitle(s,e||t.getTitle()),this.$pathbar.append(s)}_buildTitle(t,e){let s=this.dom("<span>").html(e);t.append(s)}_buildActive(){this.$pathbar.find("."+this.pathItemClass).removeClass(this.activeClass).last().addClass(this.activeClass)}_selectItem(t){if(t.stopPropagation(),t.preventDefault(),this.$pathbar.hasClass("disable"))return;let e=this.dom(t.target).closest("."+this.pathItemClass).dataget("instance");if(this.app.dropdown.close(),this.app.context.close(),e){let t=!!e.isType("column")&&"column";this.app.block.set(e,t)}else this._clear(),this._buildRoot(),this._buildActive(),this.app.block.unset(),this.app.blocks.unset()}}class Xt{constructor(t){this.app=t,this.dom=t.dom,this.config=t.config,this.classname="rx-statusbar",this.isSticky=this.config.is("statusbar.sticky"),this.onScroll=this._onScroll.bind(this)}init(){this.$statusbar=this.dom("<div>").attr("dir",this.app.config.get("dir")).addClass(this.classname+" "+this.classname+"-"+this.uuid),this.$leftContainer=this.dom("<div>").addClass(`${this.classname}-start`),this.$rightContainer=this.dom("<div>").addClass(`${this.classname}-end`),this.$statusbar.append(this.$leftContainer,this.$rightContainer),this.isSticky&&(this.$statusbar.addClass("rx-statusbar-sticky"),this.updatePosition(),this._attachEvents()),this.app.container.get("statusbar").append(this.$statusbar)}is(){return""!==this.$statusbar.html()}enable(){this.$statusbar.removeClass("disable")}disable(){this.$statusbar.addClass("disable")}add(t,e,s="start"){return this.update(t,e,s)}update(t,e,s="start"){let i="end"===s?this.$rightContainer:this.$leftContainer,r=i.find(`[data-name="${t}"]`);return 0===r.length&&(r=this._buildItem(t),i.append(r)),r.html(e),this.isSticky&&this.updatePosition(),r}getHeight(){return this.is()?this.$statusbar.outerHeight():0}getElement(){return this.$statusbar}get(t,e="start"){return("end"===e?this.$rightContainer:this.$leftContainer).find(`[data-name="${t}"]`)}remove(t,e="start"){this.get(t,e).remove()}clear(t="both"){"start"!==t&&"both"!==t||this.$leftContainer.empty(),"end"!==t&&"both"!==t||this.$rightContainer.empty()}destroy(){this.isSticky&&this._detachEvents(),this.$statusbar.remove()}updatePosition(){if(!this.isSticky)return;const t=this.app.editor.getEditor().get(),e=t.getBoundingClientRect(),s=this.config.is("toolbar")?120:60,i=this.app.scroll.getVisibility(s);return i.isBottomEdge?i.isTopEdge&&i.isTopVisible?this._setStatusBarPosition(t,e,i):i.isTopEdge||i.isBottomVisible?i.isTopEdge||i.isBottomVisible?this._clearStatusBarPosition():void this._setStatusBarPosition(t,e,i):this._setStatusBarPosition(t,e,i):this._clearStatusBarPosition()}_buildItem(t){let e=this.dom("<span>").addClass(this.classname+"-item").attr("data-name",t);return this.$statusbar.append(e),e}_setStatusBarPosition(t,e,s){this.app.scroll.isTarget()?this.$statusbar.css({position:"absolute",width:`${e.width}px`,left:`${t.offsetLeft}px`,top:s.bottom-this.getHeight()+"px"}):this.$statusbar.css({position:"fixed",width:`${e.width}px`,left:`${e.left}px`,bottom:0})}_clearStatusBarPosition(){this.$statusbar.css({position:"",width:"",top:"",left:"",bottom:""})}_attachEvents(){this.app.scroll.getTarget().on("scroll",this.onScroll),window.addEventListener("resize",this.onScroll)}_detachEvents(){this.app.scroll.getTarget().off("scroll",this.onScroll),window.removeEventListener("resize",this.onScroll)}_onScroll(){this.updatePosition()}}class Qt{constructor(t){this.app=t,this.name=!1,this.trigger=!1,this.savedSelection=!1,this.tabs={},this._isOpen=!1,this._keydownHandler=null,this._inheritPosition=!1,this.defs={title:!1,panel:!1,grid:!1,tabs:!1,form:!1,focus:!1,width:!1,html:!1,maxWidth:!1,replace:!1,items:!1,remove:!1,extend:!1,passive:!1,keys:[]}}init(){const t=document.createElement("div");t.className=`rx-dropdown rx-dropdown-${this.uuid} rx-hidden`,t.dir=this.config.get("dir"),t.setAttribute("rx-data-theme",this.app.editor.getTheme());const e=document.createElement("div");e.className="rx-dropdown-title";const s=document.createElement("div");s.className="rx-dropdown-tabs";const i=document.createElement("div");i.className="rx-dropdown-items",t.appendChild(e),t.appendChild(s),t.appendChild(i),this.dropdown=t,this.dropdownTitle=e,this.dropdownTabs=s,this.dropdownItems=i,this.app.$body.append(t)}stop(){this.app.$body.find(".rx-dropdown-"+this.uuid).remove()}isPositionTop(){return!1}isOpen(){return this._isOpen}isPanel(){return this.params.panel}getElement(){return this.dropdown}getName(){return this.name}getForm(){return this.params.form}getTabForm(t){return this.tabs[t].form}addTab(t,e){this.tabs[t]=e}getTabBox(t){return this.dropdownItems.querySelector(`[data-tab-box=${t}]`)}setTabItems(t,e){const s=this.getTabBox(t);this._renderItems(e,s)}create(t,e){this.params=l.extend({},this.defs,e),this.name=t,this.tabs={},this.dropdownTitle.innerHTML=this.params.title?this.params.title:"",this.dropdownTabs.innerHTML="",this.dropdownItems.innerHTML="",this.dropdown.style.width="",this.dropdown.style.maxWidth="",this.dropdown.style.maxHeight="",this.dropdown.classList.remove("rx-dropdown-type-grid")}open(t,e){if(this.dropdown.dataset.name===this.name)return this.close();this._keydownHandler&&document.removeEventListener("keydown",this._keydownHandler),this._stopEvents(),this.app.emit("dropdown.before.open",{dropdown:this}),this.dropdown.dataset.name=this.name,this._isOpen=!0;const s=e.isButton?e.getElement().get():e;if(this.params.grid&&this.dropdown.classList.add("rx-dropdown-type-grid"),this.trigger&&this.trigger.classList.remove("pressed"),this.trigger=s,e.isButton&&this.trigger.classList.add("pressed"),this._inheritPosition&&this._openAtCoords){const{x:t,y:e}=this._openAtCoords;return this._openAtCoords=null,void this.openAt({x:t,y:e})}this.params.replace||this.trigger.classList.contains("rx-option-item")||this.saveSelection();const i=this._buildItems(),r=this.trigger.getBoundingClientRect(),{top:a,left:n}=this._getPosition(r);this._setSize(r),this._setPosition(n,a),this.dropdown.classList.remove("rx-hidden"),this._inheritPosition=!1,this._setFocus(i),this._buildDepth(),this._startEvents(),this.app.event.setStrategyMouseUp(!1),this.app.emit("dropdown.open",{dropdown:this})}openAt({x:t,y:e}){this._isOpen&&this.close(),this._keydownHandler&&document.removeEventListener("keydown",this._keydownHandler),this._isOpen=!0,this._openAtCoords={x:t,y:e},this._inheritPosition=!1,this.dropdown.dataset.name=this.name,this.saveSelection(),this._buildItems(),this._setSize(),this._setPosition(t,e),this.dropdown.classList.remove("rx-hidden"),this.app.event.setStrategyMouseUp(!1),this._setFocus(),this._buildDepth(),this.app.emit("dropdown.open",{dropdown:this})}close(){this._isOpen&&(this.trigger&&this.trigger.classList.remove("pressed"),this._isOpen=!1,this.name=!1,this.savedSelection=!1,this.dropdown.dataset.name="",this.dropdown.classList.add("rx-hidden"),this.app.event.eventStrategy.isPopupMouseUp=!1,this._keydownHandler&&document.removeEventListener("keydown",this._keydownHandler),this.app.emit("dropdown.close"))}updatePosition(){if(!this.isOpen())return;const t=this.trigger.getBoundingClientRect(),{top:e,left:s}=this._getPosition(t);this._setSize(t),this._setPosition(s,e),0===s&&0===e?this.dropdown.classList.add("rx-hidden"):this.dropdown.classList.remove("rx-hidden")}saveSelection(t){const e=new _(this.app),s=this.app.block.get();!1!==t&&(t=s&&!this.app.blocks.is()?s.getBlock():this.app.editor.getLayout());const i=e.get();this.savedSelection={el:t,offset:i}}restoreSelection(){if(!this.savedSelection)return;const{el:t,offset:e}=this.savedSelection;if(this.dom(t).dataget("instance")&&this.app.block.set(t),e){this.app.create("offset").set(e)}}_startEvents(){this.app.scroll.getTarget().on("resize.rx-dropdown scroll.rx-dropdown",this.updatePosition.bind(this)),this.app.editor.getEditor().on("scroll.rx-dropdown",this.updatePosition.bind(this))}_stopEvents(){this.app.scroll.getTarget().off(".rx-dropdown"),this.app.editor.getEditor().off(".rx-dropdown")}_buildDepth(){let t="";this.config.is("bsmodal")?t=1061:this.app.isProp("fullscreen")&&(t=10001),this.dropdown.style.zIndex=t}_buildItems(){let t;if(Object.keys(this.tabs).length){let e=0;Object.entries(this.tabs).forEach((([s,i])=>{const r=document.createElement("span");r.className="rx-dropdown-tab",r.dataset.tab=s,r.innerHTML=this.loc.parse(i.title),r.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation();const e=t.target.closest(".rx-dropdown-tab"),s=e.dataset.tab;this.dropdownTabs.querySelectorAll(".rx-dropdown-tab").forEach((t=>t.classList.remove("active"))),this.dropdownItems.querySelectorAll(".rx-dropdown-tab-box").forEach((t=>{const e=t.dataset.tabBox;t.classList.toggle("rx-hidden",e!==s)})),e.classList.add("active"),this.app.event.setStrategyMouseUp(!1)}));const a=document.createElement("div");a.className="rx-dropdown-tab-box",a.dataset.tabBox=s,0===e?r.classList.add("active"):a.classList.add("rx-hidden"),i.form?(this._renderForm(i.form,a),i.focus&&!t&&(t=i)):i.html?this.dom(a).append(i.html):i.items,this.dropdownTabs.appendChild(r),this.dropdownItems.appendChild(a),e++}))}else this.params.form?this._renderForm(this.params.form,this.dropdownItems):this.params.html?this.dom(this.dropdownItems).append(this.params.html):(this._renderItems(this.params.items,this.dropdownItems),this._handleNavigate());return t}_getPosition(t){const e=!this.app.scroll.isTarget(),s=this.app.scroll.getTarget().get();let i=e?s.scrollY:0;this.app.isProp("fullscreen")&&(i=window.scrollY);let r=t.top+t.height+i,a=t.left;if(this.params.replace||this.trigger.classList.contains("rx-option-item")){const t=this.dropdown.getBoundingClientRect();r=t.top+i,a=t.left}this.dropdown.style.visibility="hidden",this.dropdown.classList.remove("rx-hidden");const n=this._getSize(),o=this.app.editor.getEditor().get().getBoundingClientRect(),l=a+n,h=o.right;return l>h&&(a=Math.max(h-n,o.left)),this.dropdown.style.visibility="",this.dropdown.classList.add("rx-hidden"),{top:r,left:a}}_setPosition(t,e){this.dropdown.style.top=`${e}px`,this.dropdown.style.left=`${t}px`}_getSize(){return this.params.width||this.params.maxWidth?parseInt(this.params.width||this.dropdown.style.maxWidth):this.dropdown.getBoundingClientRect().width}_setSize(t=!1){this.params.width&&(this.dropdown.style.width=this.params.width),this.params.maxWidth&&(this.dropdown.style.maxWidth=this.params.maxWidth);const e=window.innerHeight-(t?t.bottom:0);this._adjustMaxHeight(e)}_setFocus(t){this.params.form&&this.params.focus&&this.params.form.setFocus(this.params.focus),t&&t.form.setFocus(t.focus)}_renderItems(t,e){t=this._prepareItems(t);const s=["text","address","list","todo","quote","dlist"],i=document.createElement("ul");i.className="rx-option-list",Object.entries(t).forEach((([t,e])=>{const r=this._checkObserve(t,e);if(!r||!this._checkPermissions(t,e))return;e=!0!==r?r:e;const a=document.createElement("li");let n;if(e.items)a.className="rx-option-header",a.innerHTML=e.title,n=document.createElement("li"),e.grid&&(n.className="rx-dropdown-grid-container"),this._renderItems(e.items,n);else{a.className="rx-option-item",this.params.passive&&a.classList.add("passive"),e.active&&a.classList.add("active"),e.disabled&&a.classList.add("disabled"),e.classname&&a.classList.add(e.classname);const i=document.createElement("label");i.className="rx-option-label",e.name&&(i.dataset.name=e.name),e.danger&&i.classList.add("danger");const r=document.createElement("span");r.className="rx-option-icon",i.append(r),e.icon&&(r.innerHTML=e.icon);const n=document.createElement("span");if(n.className="rx-option-text",e.size&&n.classList.add(`rx-option-text-${e.size}`),n.innerHTML=void 0!==e.title?this.loc.parse(e.title):"",i.append(n),e.shortcut){const t=document.createElement("span");t.className="rx-option-shortcut",t.innerHTML=e.shortcut,i.append(t)}if(e.template&&(e.params={...e.params??{},template:e.template}),e.command){const i="addbar"===this.name&&s.includes(e.name)?"block.add":e.command,r=e.name||t;a.dataset.rxCommand=i,e.beforeCall&&(a.dataset.beforeCall=e.beforeCall),a.dataset.name=r,e.params&&(a.dataset.params=JSON.stringify(e.params,((t,e)=>"icon"===t?void 0:e))),a.addEventListener("click",(t=>{t.preventDefault(),this._executeCommand(i,e.beforeCall,e.params,a,r,t)}))}a.appendChild(i)}i.appendChild(a),n&&i.appendChild(n)})),e.appendChild(i),0!==this.params.keys.length&&this._setActiveKeys(this.params.keys)}_renderForm(t,e){const s=t.getElement();this.dom(e).append(s),s.on("keydown",(e=>{if("Enter"!==e.key)return;if(!["INPUT"].includes(e.target.tagName))return;let i;const r=s.find('[data-role="primary"]').first();r.length&&r.attr("data-command")?i=r.attr("data-command"):t.getCommand()&&(i=t.getCommand()),i&&(e.preventDefault(),this.restoreSelection(),this.app.api(i,t))}))}_adjustMaxHeight(t){const e=Math.max(t-10,120);this.dropdown.style.maxHeight=`${e}px`}_executeCommand(t,e,s,i,r,a){this.restoreSelection(),"panel"===this.name&&/popup/.test(t)&&(this._inheritPosition=!0),e&&this.app.api(e,s,i,r,a),this.app.api(t,s,i,r,a)}_checkPermissions(t,e){const s=this.app.block.get();return!(s&&!s.isAllowedButton(e.name,e))}_checkObserve(t,e){if(e.observer){let t=this._fetchUpdatedObject(e);return t||!1}return!0}_fetchUpdatedObject(t){const e=this.app.api(t.observer,t,t.name,t.toolbar);return e||!1}_setActiveKeys(t){for(let e=0;e<t.length;e++){this.dropdown.querySelectorAll("[data-name="+t[e]+"]").forEach((t=>{t.parentNode.classList.add("active")}))}}_handleNavigate(){const t=Array.from(this.dropdown.querySelectorAll(".rx-option-item"));let e=-1;const s=t=>{const e=(t=>t.getBoundingClientRect())(t);return{x:e.left+e.width/2,y:e.top+e.height/2}},i=e=>{t.forEach(((t,s)=>t.classList.toggle("focus",s===e))),t[e]?.scrollIntoView({block:"nearest"})};this._keydownHandler=r=>{if(this.isOpen()&&0!==t.length)if("ArrowDown"===r.key||"ArrowUp"===r.key||"ArrowRight"===r.key||"ArrowLeft"===r.key){if(r.preventDefault(),-1===e)return e=0,void i(e);const a=t[e],n=s(a);let o=t.map(((t,e)=>({el:t,index:e,center:s(t)}))).filter((t=>t.index!==e));const l={ArrowDown:t=>t.center.y>n.y&&Math.abs(t.center.x-n.x)<t.el.offsetWidth,ArrowUp:t=>t.center.y<n.y&&Math.abs(t.center.x-n.x)<t.el.offsetWidth,ArrowRight:t=>t.center.x>n.x&&Math.abs(t.center.y-n.y)<t.el.offsetHeight,ArrowLeft:t=>t.center.x<n.x&&Math.abs(t.center.y-n.y)<t.el.offsetHeight}[r.key];o=o.filter(l),o.length>0&&(o.sort(((t,e)=>Math.hypot(t.center.x-n.x,t.center.y-n.y)-Math.hypot(e.center.x-n.x,e.center.y-n.y))),e=o[0].index,i(e))}else if("Enter"===r.key&&-1!==e){r.preventDefault();const s=t[e],i=s.dataset.rxCommand,a=s.dataset.beforeCall,n=s.dataset.name||null,o=s.dataset.params?JSON.parse(s.dataset.params):{};i&&this._executeCommand(i,a,o,s,n,r)}},document.addEventListener("keydown",this._keydownHandler)}_prepareItems(t){if(Array.isArray(t)){let e=this.params.extend?this.params.extend:{},s=[],i="dropdown";if("control"===this.name){i="control";let t=this.config.get("control.add");t&&(e=l.extend(!0,{},e,t));let r=this.config.get("control.hide");r&&(s=[...s,...r])}this.params.remove&&(s=this.params.remove);const r=this.app.ui.loadButtonsFromArray(t,e,"dropdown",s),a=this.app.ui.buildBlockButtonsGetter(i,s);if("control"===i){(this.config.get("control.hide")||[]).forEach((t=>{delete a[t]}))}t={...r,...a},t=this._sortButtons(t)}return t}_sortButtons(t){const e=Object.entries(t).map((([t,e])=>({key:t,name:e.name||t,value:e,position:e.position}))),s=[],i=t=>{const e=t.position;if(e)if("first"===e)s.unshift(t);else if("last"===e)s.push(t);else if("object"==typeof e){const r=Array.isArray(e.after||e.before)?e.after||e.before:[e.after||e.before],a=(i=r,s.findIndex((t=>i.includes(t.name))));-1!==a?e.after?s.splice(a+1,0,t):e.before?s.splice(a,0,t):s.push(t):s.push(t)}else s.push(t);else s.push(t);var i};e.forEach((t=>{t.position&&"first"!==t.position||i(t)})),e.forEach((t=>{s.some((e=>e.name===t.name))||i(t)}));const r={};return s.forEach(((t,e)=>{r[e]=t.value})),r}}class Yt{constructor(t){this.app=t,this.handleStr="",this.triggers=[{trigger:"/",builder:"command.buildItems"}]}addTrigger(t){this.triggers.push(t)}build(t){const e=this.app.keycodes,s=t.which,i=t.ctrlKey||t.metaKey,r=[e.LEFT,e.UP,e.RIGHT,e.DOWN];if(s===e.ESC)return;if(i||r.includes(s)||s===e.SHIFT||s===e.DELETE)return;const a=new L(this.app).getElement();a&&a.closest&&a.closest("a")||(s!==e.SPACE?this.emit():this.hidePanelForce())}buildItems({filter:t,panel:e}){const s=new T(this.app),i={add:"Add",format:"Turn into"},r={add:this.app.addbar.getItems(),format:this.app.format.getItems()},a={};let n=0;return Object.entries(r).forEach((([e,r])=>{const o=!(!t||""===t)&&new RegExp(s.escapeRegExp(t),"gi"),l=i[e],h={};let p=0;Object.entries(r).forEach((([t,e])=>{if(!e.getTitle()||!e.isButton())return;const s=e.getTitleText();o&&-1===t.search(o)&&-1===s.search(o)||(e.beforeCall="command.insertFromPanel",h[t]=e,p++)})),p>0&&(n++,a[e]={title:l,name:e,items:h})})),{items:a,size:n}}emit(){const t=new L(this.app).getText("before",50);for(let e of this.triggers){const s=t.lastIndexOf(e.trigger);if(-1===s)continue;const i=t.slice(s+e.trigger.length);return this.handleTrigger=e.trigger,this.handleStr=i.replace(/\uFEFF/g,""),void this.fire(e)}this.hidePanelForce()}fire(t){if(t.loader)return void this.app.api(t.loader,{filter:this.handleStr,panel:!0});const{items:e,size:s}=this.app.api(t.builder,{filter:this.handleStr,panel:!0});0===s?this.hidePanel():this.showPanel(e)}showPanel(t){const e=this.app.page.getDoc().scrollTop(),s=new L(this.app).getPosition();this.app.dropdown.create("panel",{items:t,panel:!0,maxWidth:"328px"}),this.app.dropdown.openAt({y:s.bottom+e,x:s.left})}hidePanel(){this.app.dropdown.close()}hidePanelForce(){this.hidePanel(),this.handleStr=""}insertFromPanel(t,e,s,i){this.replaceTrigger(),this.hidePanelForce()}replaceTrigger(t=""){const e=this.handleTrigger,s=new C(this.app);s.insert("start");const i=s.find("start");if(!1===i)return;const r=this.dom(i),a=i.previousSibling,n=new RegExp(e+this.handleStr+"$");let o=a.textContent.replace(/\uFEFF/g,"");if(o=o.replace(n,""),a.textContent=o,this.isHTMLReplacement(t)){const e=new v(this.app),s=this.dom(t);r.before(s),e.set(s,"after")}else r.before(t);s.restore()}isHTMLReplacement(t){return/<\/?[a-z][\s\S]*>/i.test(t.trim())}}class te{constructor(t){this.app=t,this.instance=!1,this.$block=!1,this.tool=!1}create(t){const e=this.app.create("block.text");return t&&e.getBlock().html(t),e}createHtml(t){return this.create(t).getOuterHtml()}trigger(t){if(this.is()&&("childlist"===t.type||"characterData"===t.type)){const t=this.instance.getBlock().get().firstChild;if(t&&"rx-selection-marker-start"===t.id){const e=new v(this.app);return t.childNodes[0].textContent.trim(),t.replaceWith(...t.childNodes),void e.set(this.instance.getBlock(),"end")}}this.is()&&this.instance.getPlaceholder()&&(this.instance.isEditable()&&this.instance.isEmpty(!1,!0)&&this.instance.setEmpty(!0),"childlist"!==t.type&&"characterData"!==t.type||this.instance.trigger(t))}isTool(){return this.tool}setTool(t){this.tool=t,this.app.observer.trigger=!t,t&&this.unset()}setNonEditable(){this.is()&&(this.$block.attr("contenteditable",!1),this.instance.setNoneditable(!0))}clearNonEditable(){this.is()&&(this.instance.isEditable()&&this.$block.attr("contenteditable",!0),this.instance.setNoneditable(!1))}isNonEditable(){return this.is()?this.instance.isNondeletable():null}is(t){return t?this._isBlockActive(t):this.get()}setParent(t){if(!this.is())return;this._closeUI();const e=t&&t.column?"column":"force",s=this._getParentByParams(t);s&&this.set(s,e)}set(t,e,s){if(t&&(!0===s||!this._isBlockActive(t))&&(this.app.editor.deselectAll(),this.app.blocks.unset(),this.unset(),this.instance=this._getInstance(t),this.instance)){if(this.instance.isType("noneditable")&&!this.config.is("noneditable.select"))return this.instance=!1,!1;this.instance.isType("column")&&"column"!==e?(this.instance=this.instance.getFirstBlockInstance(),e="start"):this.instance.isParent()&&(this.instance=this.instance.getParent()),this.$block=this.instance.getBlock(),this.$block.addClass("rx-block-focus"),this.config.is("block.outline")&&this.config.is("control")&&!this.instance.isFocusable()&&this.instance.getControl()&&this.$block.addClass("rx-block-control-focus"),this._setCaret(e),this.app.toolbar.build(),this.app.extrabar.build(),this.app.control.build(),this.app.path.build(),this.app.broadcast("block.set",{instance:this.instance})}}unset(){this.instance&&(this.$block&&this.$block.removeClass("rx-block-focus rx-block-control-focus"),this.instance=!1,this.$block=!1,this.setTool(!1),this.app.dropdown.close(),this.app.control.close(),this.app.context.close(),this.app.path.build(),this.app.broadcast("block.unset"))}get(){return this.instance}setData(t){this.instance&&this.instance.setData(t)}getData(){return this.instance?this.instance.getData():null}unwrap(){if(!this.is()||!this.instance.isType(["layout","wrapper"]))return;this.app.dropdown.close();const t=this.instance.getBlock();let e=this.instance.getType(),s=t.children().first();"wrapper"===e?t.unwrap():"layout"===e&&(s=s.children().first(),t.find("[data-rx-type=column]").unwrap(),t.unwrap()),this.set(s,"start"),this.app.editor.build(),this.app.broadcast("block.unwrap",{type:e})}remove(t){if(!this.is())return;this._closeUI();const e=this.instance.getType();this.app.broadcast("block.before.remove",{type:e,instance:this.instance});const s={traverse:!0,...t},i="image"===e?this._getDataImage():{};this.instance.remove({traverse:s.traverse}),s.traverse||this.unset(),"image"===e&&(this.app.image.setImageState(this.instance,i,!1),this.app.broadcast("image.remove",i)),"embed"===e&&this.app.broadcast("embed.remove",this.instance.getContent()),this.app.broadcast("block.remove",{type:e}),this.app.editor.isEmpty()&&this.app.editor.setEmpty()}change(t,e){this.is()&&this.instance.change(t,e)}insert(t){if(this.is())return this.instance.insert(t)}add(t,e,s){this._closeUI();const i=new E(this.app),r=t?.template||null;let a;if(r)a=i.insert({html:r});else{const t=this.app.create(`block.${s}`);a=i.insert({instance:t,type:"add"})}return setTimeout((()=>{this.app.broadcast("block.add",{inserted:a})}),1),a}duplicate(){if(!this.is())return;this._closeUI();const t=this.instance.duplicate(),e=this.instance.insert({instance:t,position:"after",caret:"start",type:"duplicate"});return this.app.broadcast("block.duplicate",{instance:e}),e}moveUp(){this.is()&&this.instance.move("up")}moveDown(){this.is()&&this.instance.move("down")}_closeUI(){this.app.dropdown.close(),this.app.ui.closeTooltip()}_getParentByParams(t){return t&&t.cell?this.instance.getClosest("cell"):t&&t.column?this.instance.getClosest("column"):this.instance.getClosest(["list","wrapper","layout","todo","table"])}_getInstance(t){return t&&t.app?t:this.dom(t).dataget("instance")}_getDataImage(){return{url:this.instance.getSrc(),id:this.instance.getId(),uid:this.instance.getDataImage()}}_isBlockActive(t){return t=t.$block?t.$block:t,this.instance&&this.dom(t).get()===this.$block.get()}_setCaret(t){if("skip"===t)return;const e=["todo","list"],s=new T(this.app),i=this.instance.getType(),r=t=>t.includes(i),a="force"===t&&r(e)||!t&&r(e);if(r(e)&&"end"===t)this.instance.setCaret(t);else if("column"===t||this.instance.isFocusable()||this.instance.isInline()&&!this.instance.isEditable())this._setFocus(i);else if(a)this.setCaret();else if(t&&"force"!==t){if(this._setSvgCaret(s))return;this.instance.setCaret(t)}else t||this._setSvgCaret(s)}_setSvgCaret(t){if(this.instance.isEditable()){const e=this.instance.getBlock();if(""===e.text().trim()&&(t.isOnlySvgContent(e)||t.hasSvgAt(e,"end")))return this.instance.setCaret("end"),!0}}_setFocus(t){this.app.scroll.save(),this.$block.attr("tabindex","-1"),this.$block.focus(),"noneditable"!==t&&setTimeout((()=>{new L(this.app).remove()}),0),this.app.scroll.restore()}}class ee{constructor(t){this.app=t,this.selected=[],this.focusClass="rx-block-meta-focus"}build(){const t=this.app.editor.getLayout();t.find("[data-rx-first-level]").removeAttr("data-rx-first-level"),t.children("[data-rx-type]").attr("data-rx-first-level",!0)}trigger(t){this.is()&&("childlist"!==t.type&&"characterData"!==t.type||this.get({selected:!0,instances:!0}).forEach((e=>{e.trigger(t)})))}is(){return this.selected.length>0}set(t){this.unset(),this.selected=Array.isArray(t)?t:t.all(),this.selected.forEach((t=>{this.dom(t).addClass(this.focusClass)})),this.app.path.build()}setInstances(t){this.unset();this.selected=t.map((t=>{const e=t.getBlock();return e.addClass(this.focusClass),e})),this.app.path.build()}unset(){this.selected=[],this.app.editor.getLayout().find("."+this.focusClass).removeClass(this.focusClass),this.app.block.setTool(!1)}has(t){return 0!==this.count(t)}count(t){return this.get(t).length}get(t={}){let e=this.app.editor.getLayout().find("[data-rx-type]");if(t.selected&&(e=e.filter("."+this.focusClass)),t.firstLevel&&(e=e.filter("[data-rx-first-level]")),!1===t.firstLevel&&(e=e.not("[data-rx-first-level]")),t.type&&(e=e.filter(this._getTypesSelector(t.type))),t.editable&&(e=e.filter("[contenteditable=true]")),t.except&&(e=e.not(this._getTypesSelector(t.except))),t.first&&(e=e.first()),t.last&&(e=e.last()),t.instances){const s=[];return e.each((t=>{s.push(t.dataget("instance"))})),t.first||t.last?s[0]:s}return e}removeAll(){if(this.app.editor.isSelectAll())return this._removeAllSelected(),this.get({first:!0});this.get({selected:!0}).each((t=>{t.closest("[data-rx-first-level]").remove()}))}remove(t){if(this.app.editor.isSelectAll())return void this._removeAllSelected();const e=this.get({selected:!0}),s=e.last(),i=this._getNextElement(s);e.get().reverse().forEach((t=>this._removeSelected(t))),this.get({selected:!0,type:["cell","column"],instances:!0}).forEach((t=>this._fillEmptyBlocks(t))),t&&0!==i.length?this.app.block.set(i,"start"):this.app.context.close()}_removeAllSelected(){this.app.editor.setEmpty(),this.app.editor.deselectAll(),this.app.editor.setFocus("start",!1)}_removeSelected(t){const e=this.dom(t).dataget("instance"),s=e.getType();if(!("noneditable"===s&&!this.config.is("noneditable.remove"))&&-1===["cell","row","column","figcaption"].indexOf(s)){this._shouldRemoveInstance(s,e)&&e.remove({traverse:!1})}}_shouldRemoveInstance(t,e){const s=["todo","list","wrapper"];return!["wrapper","layout","table","todo","list"].includes(t)||(!("table"!==t||!this._isTableSelected($node))||(!(!s.includes(t)||!e.isEmpty(!0))||!("layout"!==t||!this._isLayoutSelected(e.getBlock(),e))))}_fillEmptyBlocks(t){if(t.isEmpty()){const e=this.app.block.create();t.getBlock().append(e.getBlock())}}_getTypesSelector(t){return Array.isArray(t)?"[data-rx-type="+t.join("],[data-rx-type=")+"]":`[data-rx-type=${t}]`}_getNextElement(t){const e=t.dataget("instance"),s=e.getType(),i=e.getClosest(["cell","column"]);let r=t.nextElement();return["todoitem","listitem"].includes(s)&&e.isLastElement()?r=e.getParent().getBlock().nextElement():i&&i.isLastElement()&&(r=i.getParent().getBlock().nextElement()),r}_isLayoutSelected(t,e){const s=e.getColumns(),i=s.filter((t=>t.getBlock().hasClass(this.focusClass)&&t.isEmpty())).length;return s.length===i}_isTableSelected(t){const e=t.find("tr");return e.length===e.filter(`.${this.focusClass}`).length}}class se{constructor(t){this.app=t}init(){this.popupManager=new ie(this.app)}getItems(){return this.popupManager.getItems()}popup(t,e){this.popupManager.popup(t,e)}remove(t){this.popupManager.remove(t)}set(t,e,s){if(this.app.block.isTool())return;this.app.dropdown.close();const i=new L(this.app),r=this.app.block.get(),a=this._getInstances(i,r);if(this.params=t||{},this.name=s,this.tag=this._buildTag(),this.type=this._buildType(),this.multiple=a.length>1,this.isSelectAll=this.app.editor.isSelectAll(),this.$editor=this.app.editor.getLayout(),this.collection=[],a.length){if(!!a.some((t=>t.isNondeletable())))return;this.app.broadcast("format.before.set",{instances:a}),this._format(a),this.app.scroll.restore()}}_getInstances(t,e){return!this.app.editor.isSelectAll()&&t.isCollapsed()?e?[e]:[]:this.app.blocks.is()?this.app.blocks.get({selected:!0,instances:!0}):e?[e]:[]}_format(t){const e=new C(this.app);this.converter=new re(this.app,this),this.isSelectAll||e.save(),t.forEach((t=>this._processInstance(t))),this._convertFormatted(),this._combineSelected("list"),this._combineSelected("todo"),setTimeout((()=>this._buildConverted(e)),0)}_processInstance(t){if(-1===["text","heading","address","list","listitem","todo","todoitem","quote","pre"].indexOf(t.getType()))return;const e=this._hasSameTag(t),s=this._processNewInstance(t,e);e&&t.isType(this.type)&&this.collection.push(t),s&&(Array.isArray(s)?this.collection.push(...s):this.collection.push(s))}_processNewInstance(t,e){return this._shouldConvertToText(t,e)?this.converter.convertToText(t):t.isType(["text","heading","address"])?this.converter.convertText(this.type,t):t.isType("listitem")?this._processConvertListItem(t,e):t.isType("todoitem")?this.converter.convertTodoItem(this.type,t):t.isType(["pre","quote"])?this.converter.convertPreQuote(this.type,t):t.isType("list")?this.converter.convertList(this.type,t):t.isType("todo")?this.converter.convertTodo(this.type,t):this.isSelectAll?this._processAllSelected(t,e):void 0}_processAllSelected(t,e){return["heading","text"].includes(this.type)&&t.isType(["list","todo"])?this.converter.convertAllSelected(t):"list"===this.type&&!e&&t.isType("list")?this.converter.convertAllSelectedList(t):void 0}_processConvertListItem(t,e){let s=!e&&this.listType?"list":this.type,i=t.getParentTop();return i.length&&i.tag(this.tag)&&(s="text"),this.converter.convertListItem(s,t)}_shouldConvertToText(t,e){return!this.multiple&&e&&!this._isParams()&&["heading","address"].includes(this.type)}_convertFormatted(){Object.entries({".rx-format-todo-to-listitem":"convertFormattedTodoToList",".rx-format-todo-to-text":"convertFormattedTodoToText",".rx-format-list-to-text":"convertFormattedListToText",".rx-format-listitem-to-todo":"convertFormattedListToTodo"}).forEach((([t,e])=>{this.$editor.find(t).each((t=>this.converter[e](t)))}))}_buildConverted(t){let e;this.isSelectAll?(e=new L(this.app),this._setParams(e),this._finalizeSelection()):(t.restore(),e=new L(this.app),this._setParams(e),this._setFocus(e,!1))}_setFocus(t,e=!0){let s=this.dom([]);if(this.multiple){const e=t.getNodes({type:"block",partial:!0});this.app.blocks.set(e),s=e}else{let t=this.collection[0];(t.isType("list")||t.isType("todo"))&&(t=t.getFirstItemInstance());let i=!(!t.isEmpty||!t.isEmpty())&&"start";i=e?i:"skip",this.app.block.set(t,i),s=t.getBlock()}this.app.editor.build(),this.app.broadcast("format.set",{$nodes:this.dom(s),name:this.name}),t.isCollapsed()||this.app.context.open()}_finalizeSelection(){this.app.editor.deselectAll(),this.app.editor.build(),this.app.editor.selectAll(!1,!1);const t=this.app.blocks.get();this.app.broadcast("format.set",{$nodes:t,name:this.name})}_setParams(t){if(!t.is())return;const e=t.getNodes({tags:[this.tag],partial:!0}),s=new K(this.app),{classParamSize:i,styleParamSize:r,attrsParamSize:a}=this._checkParams(e,s);e.length&&(this._setClass(e,i),this._setStyle(e,r),this._setAttrs(e,a))}_checkParams(t,e){let s=0,i=0,r=0;return t.forEach((t=>{const a=this.dom(t);this.params.classname&&a.hasClass(this.params.classname)&&s++,this.params.style&&e.hasStyle(a,this.params.style)&&i++,this.params.attrs&&e.hasAttrs(a,this.params.attrs)&&r++})),{classParamSize:s,styleParamSize:i,attrsParamSize:r}}_setAttrs(t,e){if(!this.params.attrs)return;const s=this.params.attrs;this.dom(t).each((i=>{const r=i.dataget("instance");r&&(t.length===e?this._removeAttrs(r,s):this._setAttrsForInstance(r,s))}))}_removeAttrs(t,e){Object.keys(e).forEach((e=>t.removeAttr(e)))}_setAttrsForInstance(t,e){Object.entries(e).forEach((([e,s])=>t.setAttr(e,s)))}_setStyle(t,e){if(!this.params.style)return;const s=new R(this.app),i={...this.params.style};t.length===e&&Object.keys(i).forEach((t=>i[t]="")),this.dom(t).css(i).each((t=>{s.cacheElementStyle(t),""===t.attr("style")&&t.removeAttr("style")}))}_setClass(t,e){if(!this.params.classname)return;const s=t.length===e?"removeClass":"addClass";this.dom(t)[s](this.params.classname)}_combineSelected(t){const e=new L(this.app);if(e.is()){e.getNodes({types:[t],partial:!0}).forEach((e=>this._combineBlock(e,t)))}}_combineBlock(t,e){const s=this.dom(t).dataget("instance");if(s){const t=s.getPrev(e);t&&t.getTag()===s.getTag()&&(t.getBlock().append(s.getBlock().children()),s.remove())}}_buildTag(){return{numberedlist:"ol",bulletlist:"ul",text:this.config.get("markup")}[this.name]||this.params.tag||this.name}_buildType(){return["text","p","div"].includes(this.tag)?"text":["h1","h2","h3","h4","h5","h6"].includes(this.tag)?"heading":["ol","ul"].includes(this.tag)?"list":this.params.type||this.name}_isParams(){return Boolean(this.params.style||this.params.classname||this.params.attrs)}_hasSameTag(t){const e=t.getTag();return t.isType("quote")&&"quote"===this.tag||t.isType(["todo","todoitem"])&&"todo"===this.tag||e===this.tag}}class ie{constructor(t){this.app=t,this.config=t.config,this.dropdown=t.dropdown,this.observer=t.observer,this.ui=t.ui,this.removeButtons=[]}getItems(){const t=[...this.config.get("popups.format")],e=this._getFormatItemsWithCommands();return this.ui.loadButtons(t,e,"format",!1,this.removeButtons)}popup(t,e){const s=[...this.config.get("popups.format")],i=this._getFormatItemsWithCommands(),r=this.observer.getKeys();this.dropdown.create("format",{items:s,extend:i,keys:r,remove:this.removeButtons,type:"formatbar"}),this.dropdown.open(t,e)}remove(t){Array.isArray(t)?this.removeButtons.push(...t):this.removeButtons.push(t)}_getFormatItemsWithCommands(){const t=this.config.get("formatItems");if(t)for(let e in t)t[e].command="format.set";return t}}class re{constructor(t,e){this.app=t,this.format=e,this.config=t.config,this.tag=e.tag,this.type=e.type,this.collection=e.collection,this.replacer=new ae(this.app,e)}convertAllSelectedList(t){const e=t.getBlock();return this.replacer.replaceListToListElement("list",this.tag,e)}convertAllSelected(t){const e=t.getBlock(),s=[];return e.children().each((t=>{const e=t.dataget("instance"),i=e.getContent(),r="text"===this.type?"block.text":"block.heading",a="text"===this.type?{content:i}:{level:this.tag.replace("h",""),content:i},n=this.app.create(r,a);e.getBlock().after(n.getBlock()),e.remove(),s.push(n)})),e.unwrap(),s}convertFormattedListToText(t){this._convertListOrTodoToText(t,"list")}convertFormattedTodoToText(t){this._convertListOrTodoToText(t,"todo")}convertFormattedListToTodo(t){this._convertTodoList(t,"list","todo","todoitem","rx-format-listitem-to-todo")}convertFormattedTodoToList(t){this._convertTodoList(t,"todo","list","listitem","rx-format-todo-to-listitem",this.tag)}convertToText(t){return this.replacer.replaceTo("text",this.config.get("markup"),t)}convertText(t,e){return{heading:()=>this.replacer.replaceTo("heading",this.tag,e),text:()=>this.replacer.replaceTo("text",this.config.get("markup"),e),address:()=>this.replacer.replaceTo("text",this.config.get("markup"),e),list:()=>this.replacer.replaceToList(e),todo:()=>this.replacer.replaceToTodo(e),quote:()=>this.replacer.replaceToQuote(e)}[t]()}convertTodoItem(t,e){return{heading:()=>this.replacer.replaceListTodoToText("heading","todo",e),text:()=>this.replacer.replaceListTodoToText("text","todo",e),list:()=>this.replacer.replaceTodoToList(e),todo:()=>e}[t]()}convertPreQuote(t,e){return{heading:()=>this.replacer.replaceToHeading(e),text:()=>this.replacer.replaceToText(e),list:()=>this.replacer.replaceToList(e),todo:()=>this.replacer.replaceToTodo(e),quote:()=>this.replacer.replaceToQuote(e)}[t]()}convertList(t,e){let s=e.getItems();if("text"===t||"heading"===t)this._convertItemsToTextOrHeading(s,e,t);else{if("list"===t)return this.replacer.replaceListToList(this.tag,e);"quote"===t?this._convertItemsToQuote(s,e):"todo"===t&&this._convertItemsToTodoList(s,e)}}convertTodo(t,e){let s=e.getItems();"text"===t||"heading"===t?this._convertItemsToTextOrHeading(s,e,t,!0):"quote"===t?this._convertItemsToQuote(s,e):"list"===t&&this._convertItemsToList(s,e)}convertListItem(t,e){if("text"===t&&!e.hasParentList())return this.replacer.replaceListTodoToText("text","list",e);if("heading"===t&&!e.hasParentList())return this.replacer.replaceListTodoToText("heading","list",e);if("todo"===t){const t=this.app.create("block.todoitem",{content:e.getContent()}),s=t.getBlock();return e.getBlock().after(s),e.remove(),s.closest("[data-rx-type=list]").addClass("rx-format-listitem-to-todo"),t}return"list"===t?this.replacer.replaceListToList(this.tag,e):void 0}_convertItemsToTextOrHeading(t,e,s,i=!1){let r,a;for(let n=0;n<t.length;n++){const o=i?t[n].content:t[n];a="text"===s?this.app.create("block.text",{content:o}):this.app.create("block.heading",{level:this.tag.replace("h",""),content:o}),0===n&&(r=a),e.getBlock().before(a.getBlock())}r&&this.app.block.set(r.getBlock(),"start"),e.remove()}_convertItemsToQuote(t,e){let s=t.map((t=>t.content||t)).join(""),i=this.app.create("block.quote",{content:s});e.getBlock().before(i.getBlock()),this.app.block.set(i.getBlock(),"start"),e.remove()}_convertItemsToList(t,e){let s=this.app.create("block.list",{numbered:"ol"===this.tag});e.getBlock().before(s.getBlock()),s.setEmpty(),t.forEach((t=>{let e=this.app.create("block.listitem",{content:t.content||t});s.getBlock().append(e.getBlock())})),this.app.block.set(s.getBlock(),"start"),e.remove()}_convertItemsToTodoList(t,e){let s=this.app.create("block.todo");e.getBlock().before(s.getBlock()),s.setEmpty(),t.forEach((t=>{let e=this.app.create("block.todoitem",{content:t.content||t});s.getBlock().append(e.getBlock())})),this.app.block.set(s.getBlock(),"start"),e.remove()}_convertTodoList(t,e,s,i,r,a=null){let n;if(t.find("li").length===t.find(`[data-rx-type=${i}]`).length){a&&(t=t.replaceTag(a)),t.removeAttr("data-rx-type"),t.children().removeAttr("data-rx-type"),n=this.app.create(`block.${s}`,t);const i=t.dataget("instance");i&&"todo"===e&&n.setAttrs(i.getAttrs()),this.collection.push(n)}else{const r=this._findConvertedItem(e,s,i,t).nextElement();r?.attr("data-rx-type")===e&&0===r.get().children.length&&r.remove()}t.removeClass(r)}_convertListOrTodoToText(t,e){if(0===t.find("li").length)return void t.unwrap();const s=this._findConvertedText(e,t),i=s.nextElement();i?.attr("data-rx-type")===e&&0===i.get().children.length&&i.remove(),s.unwrap(),t.removeClass("rx-format-todo-to-text")}_findConvertedItem(t,e,s,i){const r=`[data-rx-type=${s}]`;let a,n,o=i.find(r).first().prevElement().get();if(o)for(n=i.cloneEmpty(),"list"===e&&(n=n.replaceTag(this.tag)),i.after(n),a=this.app.create(`block.${e}`,n),this.collection.push(a);o.nextSibling;)n.append(o.nextSibling);else n=i,"list"===e&&(n=n.replaceTag(this.tag)),a=this.app.create(`block.${e}`,n),this.collection.push(a);return this._appendNextSiblings(t,i,n,r),n}_findConvertedText(t,e){const s="[data-rx-type=text],[data-rx-type=heading]";let i,r=e.find(s).first().prevElement().get();if(r)for(i=e.cloneEmpty(),i=i.replaceTag(this.tag),e.after(i);r.nextSibling;)i.append(r.nextSibling);else i=e;return this._appendNextSiblings(t,e,i,s),i}_appendNextSiblings(t,e,s,i){let r=s.find(i).last().get();if(r){const i=e.cloneEmpty();for(s.after(i),this.app.create(`block.${t}`,i);r.nextSibling;)i.append(r.nextSibling)}}}class ae{constructor(t,e){this.app=t,this.tag=e.tag}replaceToList(t){return this._replaceToListOrTodo(t,"list",{numbered:"ol"===this.tag})}replaceToTodo(t){return this._replaceToListOrTodo(t,"todo")}replaceToQuote(t){return this._replaceToBlock(t,"quote",{content:t.getPlainText()})}replaceToHeading(t){return this._replaceToBlock(t,"heading",{level:this.tag.replace("h",""),content:t.getContent()})}replaceToText(t){return this._replaceToBlock(t,"text",{content:t.getContent()})}replaceListTodoToText(t,e,s){const i=s.getContent(!0),r="text"===t?"block.text":"block.heading",a="text"===t?{content:i}:{level:this.tag.replace("h",""),content:i},n=this.app.create(r,a),o=n.getBlock(),l=s.getBlock().find("li");return s.getBlock().after(o),l.each((e=>{const s=e.dataget("instance"),i="text"===t?"block.text":"block.heading",r="text"===t?{content:s.getContent(!0)}:{level:this.tag.replace("h",""),content:s.getContent(!0)},a=this.app.create(i,r);o.after(a.getBlock())})),s.remove(),o.closest("[data-rx-type="+e+"]").addClass("rx-format-"+e+"-to-text"),n}replaceTodoToList(t){const e=t.getContent(),s=this.app.create("block.listitem",{content:e}),i=s.getBlock();return t.getBlock().after(i),t.remove(),i.closest("[data-rx-type=todo]").addClass("rx-format-todo-to-listitem"),s}replaceListToList(t,e,s){const i=e.isType("listitem")?e.getParentTop():e.getBlock();if(!i.tag(t))return this.replaceListToListElement("list",t,i,s)}replaceListToListElement(t,e,s,i){const r=s.dataget("instance"),a=r?r.getAttrs():null,n=s.replaceTag(e);n.removeAttr("data-rx-type"),n.children().removeAttr("data-rx-type");const o=this._parseInstance(t,n,a);return n.find("ol, ul").each((s=>{this.replaceListToListElement(t,e,s,i)})),o}replaceTo(t,e,s,i){if(s.getTag()===e)return;const r=s.getBlock();let a=s.getAttrs();const n=r.replaceTag(e);return n.removeAttr("data-rx-type class"),"text"!==t&&n.removeAttr("data-rx-tag"),this._parseInstance(t,n,a)}_parseInstance(t,e,s){const i=this.app.create("block."+t,e);return i.setAttrs(s),i}_replaceToListOrTodo(t,e,s={}){const i=new W(this.app);let r=t.getContent();r=i.removeBlockTags(r);let a=this.app.create("block."+e,s);return a.getFirstItemInstance().setContent(r),a=this._setDataStyle(t,a),this._insertAfterAndRemove(t,a),a}_replaceToBlock(t,e,s={}){let i=this.app.create("block."+e,s);return i=this._setDataStyle(t,i),this._insertAfterAndRemove(t,i),i}_setDataStyle(t,e){const s=t.getBlock().attr("data-rx-style-cache");return s&&e.getBlock().attr("style",s),e}_insertAfterAndRemove(t,e){t.getBlock().after(e.getBlock()),t.remove()}}class ne{constructor(t){this.app=t,this.ampRegex='(\\b\\w+="[^"]*)&amp;([^"]*")'}observe(t,e){if(!this.config.is("embed"))return!1;const s=this.app.block.get();return s&&s.isType("embed")&&(t.command="embed.edit"),t}build(t){t?this._callScripts(t):this._findScripts()}popup(t,e){const s=this.app.create("form",{items:{embed:{type:"textarea",placeholder:"## embed.description ##",rows:6},caption:{type:"input",placeholder:"## embed.caption ##"},flex:{responsive:{type:"checkbox",text:"## embed.responsive-video ##",auto:!0},insert:{type:"button",text:"## buttons.insert ##",command:"embed.create",role:"primary"}}}});this.config.is("embed.responsive")&&s.getInput("responsive").attr("checked",!0),this.app.dropdown.create("embed",{form:s,width:"320px",focus:"embed"}),this.app.dropdown.open(t,e),this._buildCodemirror(s)}edit(t,e,s,i){const r=this.app.block.get();if(!r)return;const a={embed:r.getContent().replace(new RegExp(this.ampRegex,"g"),"$1&$2"),caption:r.getCaption(),responsive:r.isResponsive()},n=this.app.create("form",{data:a,items:{embed:{type:"textarea",placeholder:"## embed.description ##",rows:6},caption:{type:"input",placeholder:"## embed.caption ##"},flex:{responsive:{type:"checkbox",text:"## embed.responsive-video ##",auto:!0},save:{type:"button",text:"## buttons.save ##",command:"embed.save",role:"primary"}}}});this.app.dropdown.create("embed",{form:n,width:"320px",focus:"embed"}),this.app.dropdown.open(i,e),this._buildCodemirror(n)}create(t){this.app.dropdown.close(),this.insert(t.getData())}insert(t){const e=this._getEmbedCode(t);if(""===e)return;const s=this._createInstance(t,e);return new E(this.app).insert({instance:s}),this.app.broadcast("embed.insert",{content:e,instance:s}),s}save(t){this.app.dropdown.close(),this.update(t.getData())}get(){const t=this.app.block.get();return t&&t.isType("embed")?t:null}update(t){const e=this.app.block.get(),s=this._getEmbedCode(t);if(""===s)return this.app.block.remove(),null;const i=this._createInstance(t,s,e);return this._isNeedToChange(t,i,e)&&(this.app.block.change(i),this.app.broadcast("embed.change",{content:s,instance:i})),i}remove(){this.app.dropdown.close(),this.app.block.remove()}_buildCodemirror(t){const e=t.getInput("embed");this.app.codemirror.create({el:e,height:"200px",focus:!0})}_getEmbedCode(t){const e=new q(this.app);let s=(void 0!==t.embed?t.embed:t.content).trim();return s=this.app.codemirror.val(s),s=this._removeScript(s),s=e.sanitize(s),s=this._isHtmlString(s)||""===s?s:this._parseUrl(s),s}_isHtmlString(t){return/^\s*<(\w+|!)[^>]*>/.test(t)}_isFigure(t){return/^<figure/.test(t)}_isNeedToChange(t,e,s){return s.getContent()!==e.getContent()||t.responsive!==s.isResponsive()||t.caption!==s.getCaption()}_removeScript(t){if(!this.config.is("embed.script")){t=new W(this.app).removeTagsWithContent(t,["script"])}return t}_parseUrl(t){const e='<iframe width="560" height="315" src="',s='" frameborder="0" allowfullscreen></iframe>',i=this.config.get("regex.mp4video"),r=this.config.get("regex.youtube"),a=this.config.get("regex.vimeo");if(t.match(i))return t.replace(i,(t=>`<video controls src="${t}"></video>`));if(t.match(r)){const i=-1!==t.search("youtube-nocookie.com")?"https://www.youtube-nocookie.com":"https://www.youtube.com";return e+t.replace(r,i+"/embed/$1")+s}return t.match(a)?e+t.replace(a,"https://player.vimeo.com/video/$2")+s:t}_createInstance(t,e,s){let i;if(e=e.replace(new RegExp(this.ampRegex,"g"),"$1&$2"),s){i=s.duplicateEmpty().getBlock().html(e)}else i=this._isFigure(e)?e:"<figure>"+e+"</figure>",i=this.dom(i);return this.app.create("block.embed",i,{caption:t.caption,responsive:t.responsive})}_findScripts(){const t=this.app.editor.getLayout().find("[data-rx-type=embed]").find("script").all();this.build(t)}_callScripts(t){t.forEach(((e,s)=>{if(e.src){const i=e.src,r=this.dom("<script>").attr({src:i,async:!0,defer:!0});this.app.page.getDoc().find(`head script[src="${i}"]`).remove(),r.on("load",(()=>{if(i.includes("instagram")){const t=this.app.page.getWinNode();t?.instgrm?.Embeds.process()}this.build(t.slice(s+1))})),this.app.page.getDoc().get().head?.appendChild(r.get())}}))}}class oe{constructor(t){this.app=t,this.dataStates=[]}popupWrap(t,e){this._popupStyle(t,e,"wrap")}popupOutset(t,e){this._popupStyle(t,e,"outset")}popup(t,e){const s=this.config.get("image.create");s?s(this.app):(!this.config.is("image.url")||this.config.is("image.select")||this.config.is("image.upload")?(this.app.dropdown.create("image",{width:"300px"}),this.createUploadTab("image.insertByUpload"),this.createUrlTab(),this.createSelectTab()):this.app.dropdown.create("image",{width:"300px",focus:"url",form:this._createImageByUrl()}),this.app.dropdown.open(t,e))}createSelectTab(t){this.config.is("image.select")&&(this.$selectbox=this.dom('<div class="rx-dropdown-images">'),this._createSelectBox(this.$selectbox,t),this.app.dropdown.addTab("select",{title:"## image.tab-select ##",html:this.$selectbox}))}createUrlTab(){this.config.is("image.url")&&this.app.dropdown.addTab("url",{title:"## image.tab-url ##",focus:"url",form:this._createImageByUrl()})}createUploadTab(t){this.config.is("image.upload")&&(this.$uploadBox=this.dom("<div>"),this.$upload=this.dom("<div>"),this.$uploadBox.append(this.$upload),this._buildUpload(this.$upload,t),this.app.dropdown.addTab("upload",{title:"## image.tab-upload ##",html:this.$uploadBox}))}createPropsTab(){const t=this.app.create("form",{getter:"block.getData",items:{flex:{width:{type:"input",width:"100px",label:"## image.width ##",observer:"image.observeImageWidth"},height:{type:"input",width:"100px",label:"## image.height ##",observer:"image.observeImageHeight"}},src:{type:"input",label:"## image.src ##"},alt:{type:"input",label:"## image.alt-text ##"},caption:{type:"input",label:"## image.caption ##",observer:"image.observeImageCaption"},url:{type:"input",label:"## image.link ##",observer:"image.observeImageLink"},flex2:{target:{type:"checkbox",text:"## image.link-in-new-tab ##",observer:"image.observeImageLink",auto:!0},save:{type:"button",text:"## buttons.save ##",command:"image.save",role:"primary"}}}});this.app.dropdown.addTab("props",{title:"## image.tab-props ##",form:t})}edit(t,e){const s=this.config.get("image.edit");s?s(this.app,this.app.block.get()):(this.app.dropdown.create("image",{width:"300px"}),this.createPropsTab(),this.createUploadTab("image.changeByUpload"),this.createSelectTab(!0),this.app.dropdown.open(t,e))}wrap(t){this._applyImageClass(t,"wrap")}outset(t){this._applyImageClass(t,"outset")}observe(t,e){const s=this.app.block.get();switch(e){case"image":s&&s.isType("image")&&(t.command="image.edit");break;case"wrap":case"outset":if(!this.config.is(e))return}return t}observeStates(){const t=this._findImages(),e=[];t.each(this._addImageState.bind(this)),t.each((t=>{const s=t.attr("data-image");s&&(e[s]=t)})),Object.entries(this.dataStates).forEach((([t])=>{this.dataStates[t].status=!!e[t]}))}observeImageLink(t){return!!this.config.is("image.link")&&t}observeImageCaption(t){const e=this.app.block.get();return!(!e||!e.isFigure())&&t}observeImageWidth(t){return!!this.config.is("image.width")&&t}observeImageHeight(t){return!!this.config.is("image.height")&&t}drop(t,e){const s=Array.from(e.files).map((t=>t||e.items[i]?.getAsFile())).filter(Boolean);if(!s.length)return;const r=this.dom(t.target).closest("[data-rx-type]");r.length&&this.app.block.set(r),this._uploadImage(s,"image.insertByDrop",t)}parseInserted(t){if(!this.config.is("image.upload"))return;let e=0;const s=[],i=[];if(this.pasteInsertedImages=[],this.resolved=[],t.each((t=>{const e=t.dataget("instance");e&&i.push(e)})),i.forEach(((t,i)=>{if("image"!==t.getType())return;const r=t.getSrc();/^data:/i.test(r)?(s.push(this._dataURLtoFile(r,`image_${Date.now()}`)),this.pasteInsertedImages.push(t)):/^blob:/i.test(r)&&(e++,this.pasteInsertedImages.push(t),fetch(r).then((t=>{if(!t.ok)throw new Error(`Failed to fetch blob: ${t.statusText}`);return t.blob()})).then((t=>{const e=new File([t],`image_${i}`,{type:t.type||"image/png"});this.resolved.push(e)})))})),e>0){const t=setInterval((()=>{this.resolved.length===e&&(clearInterval(t),this._uploadImage(this.resolved,"image.insertFromInserted"))}),100)}s.length>0&&this._uploadImage(s,"image.insertFromInserted")}paste(t,e){this.config.is("image.upload")&&this._uploadImage([t],"image.insertFromBlob",e)}insertFromClipboard(t,e){const s=(e.getData("text/plain")||e.getData("text/html")).trim();if(s)return;if(!this.app.broadcast("editor.before.paste",{e:t,html:s,type:"image"}).isStopped())for(const t of e.items)if(t.type.startsWith("image"))return this.paste(t.getAsFile()),!0}insertFromBlob(t){this.insert(t,"upload");const e=this.insertedImages?this.insertedImages[0].getBlock():this.dom([]);this.app.broadcast("editor.paste",{$nodes:e,instances:this.insertedImages})}insertFromInserted(t){Object.entries(t).forEach((([t,e],s)=>{this.pasteInsertedImages[s]?.setData(e)}))}insertByDrop(t,e){if(this.app.block.is()){const s=this.app.block.get();if(s.isType("image"))return void this.update(t,!0,!0);if(e&&s.isEditable()){new E(this.app).insertPoint(e)}}this.insert(t,"upload")}insertByUrl(t){const e=t.getInput("url").val().trim();e&&this.insert({file:{url:e,id:new T(this.app).getRandomId()}},"upload")}insertByUpload(t){this.app.dropdown.restoreSelection(),this.insert(t,"upload")}insertFromSelect(t){t.preventDefault(),this.app.dropdown.restoreSelection(),this.insert({file:this._createObjectFromSelect(t)},"select")}insert(t,e="insert"){this.app.dropdown.close(),this._insert(t,e)}changeFromSelect(t){t.preventDefault();const e=this._createObjectFromSelect(t);this.update(e)}changeByUpload(t){this.update(t,!1,!0)}change(t,e){return this.update(t,e)}update(t,e=!0,s=!1){e&&this.app.dropdown.close();const i=this.app.block.get();return this.app.broadcast("image.before.change",{instance:i,data:t}),this._extractItems(t,(t=>{const e=s?this._processData(t):t;e.srcset||(e.srcset=""),i.setData(e),this.app.broadcast("image.change",{instance:i,data:e}),s&&this.app.broadcast("image.upload",{instance:i,data:e})})),i}get(){const t=this.app.block.get();return t&&t.isType("image")?t:null}save(t){const e=t.getData();this.app.dropdown.close(),this.app.block.setData(e)}remove(){this.app.dropdown.close(),this.app.block.remove()}error(t){this.app.broadcast("image.upload.error",{response:t})}getStates(){return this.dataStates}setImageState(t,e,s){e.uid&&(this.dataStates[e.uid].status=s)}_insert(t,e){this.imageslen=0,this.imagescount=0;const s=new E(this.app),i=[],r=this.app.block.get();this._extractItems(t,(t=>{const r=this.app.create("block.image",this._processData(t));r&&(s.insert({instance:r,remove:!1}),r.getImage().one("load",this._checkImageLoad.bind(this)),i.push(r),this.app.broadcast(`image.${e}`,{instance:r,data:t}),this.$last=r.getBlock(),this.imageslen++)})),r&&r.isEditable()&&r.isEmpty()&&r.remove(),this.insertedImages=i}_processData(t){const{src:e,url:s,link:i}=t;return t.src=e||s,t.url=i||null,t}_extractItems(t,e){Array.isArray(t)?t.reverse().forEach((t=>e(t))):"object"==typeof t&&null!==t&&(t.src||t.url?e(t):Object.values(t).reverse().forEach((t=>{"object"==typeof t&&(t.src||t.url)&&e(t)})))}_popupStyle(t,e,s){const i=this.config.get(s),r=this.app.block.get(),a=r?r.getClassname(i):"none",n=Object.entries(i).reduce(((t,[e,i])=>(t[e]={title:this.loc.get(`${s}.${s}-${e}`),command:`image.${s}`,active:e===a,params:{classname:i}},t)),{});this.app.dropdown.create(s,{items:n}),this.app.dropdown.open(t,e)}_applyImageClass(t,e){this.app.dropdown.close();const s=t.classname,i=this.config.get(e),r=this.app.block.get();r&&("wrap"===e?(["none","wrap-center"].includes(s)&&r.setStyle({"max-width":""}),this.config.is("wrapWithStyle")?["none","wrap-center"].includes(s)?(r.removeClasses(i),this._toggleCentered(r,s)):(this._unsetCentered(r),r.setClassname(s,i)):r.setClassname(s,i)):r.setClassname(s,i),this.app.control.updatePosition(),this.app.broadcast(`image.${e}`,{image:r}))}_uploadImage(t,e,s=null){if(!t.length||!this.config.is("image.upload"))return;const i={url:this.config.get("image.upload"),name:this.config.get("image.name"),data:this.config.get("image.data"),multiple:this.config.get("image.multiple"),success:e,error:"image.error"};new x(this.app,{params:i}).send(s,t)}_toggleCentered(t,e){if("none"===e)this._unsetCentered(t);else{"center"===t.getBlock().css("text-align")?this._unsetCentered(t):this._setCentered(t)}}_setCentered(t){t.setStyle({"text-align":"center"}),t.getImage().css({"margin-left":"auto","margin-right":"auto"}),t.getCaptionElement().css({"text-align":"center","margin-left":"auto","margin-right":"auto"})}_unsetCentered(t){t.setStyle({"text-align":""}),t.getImage().css({"margin-left":"","margin-right":""}),t.getCaptionElement().css({"text-align":"","margin-left":"","margin-right":""})}_buildUpload(t,e){if(!this.config.is("image.upload"))return;let s={box:!0,placeholder:this.loc.get("image.upload-new-placeholder"),url:this.config.get("image.upload"),name:this.config.get("image.name"),data:this.config.get("image.data"),multiple:this.config.get("image.multiple"),success:e,error:"image.error"};new x(this.app,{element:t,params:s})}_createObjectFromSelect(t){const e=this.dom(t.target),s=e.data();return["id","alt","caption","url","width","height"].forEach((t=>{const i=e.attr(`data-${t}`);null!==i&&(s[t]=i)})),s}_createSelectBox(t,e){if(!this.config.get("image.select"))return;const s=this.config.get("image.select");if("object"==typeof s)this._parseList(s,callback);else{const t=e?"image.changeFromSelect":"image.insertFromSelect",i=this.config.is("reloadmarker")?{d:(new Date).getTime()}:{};this.ajax.request(this.config.get("image.selectMethod"),{url:s,data:i,success:function(e){this._parseList(e,t)}.bind(this)})}}_createImageByUrl(){return this.app.create("form",{command:"image.insertByUrl",items:{flex:{url:{type:"input",placeholder:this.loc.get("image.url-placeholder"),auto:!0},insert:{type:"button",text:"## buttons.insert ##",command:"image.insertByUrl",role:"primary"}}}})}_checkImageLoad(){this.imagescount++,this.app.page.getDocNode().body.contains(this.$last.get())&&this.imagescount===this.imageslen&&(this.app.block.unset(),this.app.block.set(this.$last),this.app.editor.adjustHeight(),this.app.observer.observe())}_parseList(t,e){Object.entries(t).forEach((([t,s])=>{if("object"!=typeof s)return;const i=s.thumb||s.url;if(!i)return;const r=this.dom("<img>").attr({src:i,"data-src":s.url,"data-callback":e});["id","alt","caption","link","width","height"].forEach((t=>{void 0!==s[t]&&r.attr(`data-${t}`,s[t])})),r.on("click",(t=>{const e=this.dom(t.target).attr("data-callback");e&&this.app.api(e,t)})),this.$selectbox.append(r)}))}_blobToImage(t){return new Promise((e=>{const s=URL.createObjectURL(t),i=new Image;i.onload=()=>{URL.revokeObjectURL(s),e(i)},i.src=s}))}_dataURLtoFile(t,e){const[s,i]=t.split(","),r=s.match(/:(.*?);/)[1],a=atob(i),n=new Uint8Array(a.length);for(let t=0;t<a.length;t++)n[t]=a.charCodeAt(t);return new File([n],e,{type:r})}_findImages(){return this.app.editor.getLayout().find("[data-image]")}_addImageState(t){const e=t.attr("data-image");e&&(this.dataStates[e]={type:"image",status:!0,url:t.attr("src"),$img:t,id:e})}}class le{constructor(t){this.app=t}popup(t,e){const s=this._prepareLayoutItems();this.app.dropdown.create("layout",{items:s}),this.app.dropdown.open(t,e)}insert(t){this.app.dropdown.close();const e=this.app.create("block.layout",t);new E(this.app).insert({instance:e})}_prepareLayoutItems(){const t=this.config.get("layouts"),e=l.extend(!0,{},t);return Object.entries(e).forEach((([t,e])=>{e.command="layout.insert",e.params=l.extend(!0,{},e)})),e}}class he{constructor(t){this.app=t,this.dropdowns={format:this._createDropdown("link.popupCreate","## link.link ##"),change:this._createDropdown("link.popupEdit","## link.edit-link ##")}}popup(t,e,s){const i=this.get().eq(0).length,r=new L(this.app),a=!!this._isImageLink()||r.is();!t&&0===i||!a||0===i?(e=!(!t&&this._isImageLink())&&e,!0===s&&this.app.toolbar.isEnabled()&&(t=e,e=this.app.toolbar.getButton("link")),this.popupCreate(!1,e,"link",t)):1===i&&(this.app.dropdown.create("link-dropdown",{items:this.dropdowns.change}),this.app.dropdown.open(t,e))}popupCreate(t,e,s,i){const r=new L(this.app),a=r.getText(),n=this.config.get("link.create");if(n)return n(this.app,a);this.emptyInline=!1;const o=r.getInline();o&&""===o.innerText&&(this.emptyInline=o);const l={text:a||"",target:this.config.get("link.target")},h=this.app.create("form",{data:l,items:{url:{type:"input",placeholder:"## link.url ##"},text:{type:"input",placeholder:"## link.text ##"},flex:{target:{type:"checkbox",text:"## link.link-in-new-tab ##",auto:!0},insert:{type:"button",text:"## buttons.insert ##",command:"link.insert",role:"primary"}}}});this.app.dropdown.create("link",{width:"280px",focus:"url",form:h}),this.app.dropdown.open(i,e)}popupEdit(t,e,s,i){const r=this.get().eq(0),a=this._getLinkData(r),n=this.config.get("link.edit");if(n)return n(this.app,r,a);const o=this.app.create("form",{data:a,items:{url:{type:"input",placeholder:"## link.url ##"},text:{type:"input",placeholder:"## link.text ##"},flex:{target:{type:"checkbox",text:"## link.link-in-new-tab ##",auto:!0},save:{type:"button",text:"## buttons.save ##",command:"link.save",role:"primary"}}}});this.app.dropdown.create("link",{width:"280px",focus:"url",form:o}),this.app.dropdown.open(i,e)}create(t){const e=this.app.block.get(),s=new L(this.app),{link:i,type:r}=this._getOrCreateLink(e,s,this.emptyInline);t.text=t.text||s.getText()||t.url,this.app.editor.save();const a=this._setData(t,i,r);return t?("link"===r&&s.select(i),this.observeContext(i),this.app.broadcast("link.add",{element:i,data:a})):this.app.editor.restore(),this.app.observer.observe(),i}update(t){const e=this.get(),s=new L(this.app),i=s.isCollapsed();this.app.editor.save();let r=null;return e.each((e=>{const s=this._isImageLink()?"image":"link",a=this._setData(t,e,s);this.app.broadcast("link.change",{element:e,data:a}),i&&"link"===s&&t.hasOwnProperty("text")&&(r=e)})),this.app.editor.restore(),r&&s.select(r),e}save(t){const e=t.getData();if(!e.url)return;this.app.dropdown.close(),this.app.editor.save();const s=this.get().eq(0),i=this._isImageLink()?"image":"link",r=this._setData(e,s,i);this.app.editor.restore(),this.app.observer.observe(),this.app.broadcast("link.change",{element:s,data:r})}insert(t){const e=t.getData();e.url&&(this.app.dropdown.close(),this.create(e))}open(t,e){const{href:s}=e.getParams();s&&this.app.page.getWinNode().open(s,"_blank")}observeContext(t){this.app.context.isOpen()&&(this.addToContext(t),this.app.context.showLine(),this.app.context.updatePosition())}observe(t,e,s){const i=new L(this.app);if("context"===s&&"link"===e&&i.is()){const t=this.get();this.addToContext(t)}return t}addToContext(t){const e=t.eq(0).attr("href");1===t.length&&e&&"#"!==e&&this.app.context.addLine(`<a href="${e}">${this._truncateLinkText(e)}</a>`),t.length>0&&this.app.context.add("unlink",{position:{before:"link"}})}unlink(t){this.app.dropdown.close(),this.app.context.close();const e=t?this.dom(t):this._getLinks();!new L(this.app).is()&&this._isImageLink()?this._unlinkImage():e.length&&this._unlinkLinks(e)}get(){const t=this.app.block.get();return this._isImageLink()?t.getLinkElement():this._getLinks()||this.dom()}_createDropdown(t,e){return{link:{title:e,command:t,icon:!1,shortcut:"Ctrl+k"},unlink:{title:"## link.unlink ##",command:"link.unlink",icon:!1}}}_isImageLink(){const t=this.app.block.get();return t&&t.isType("image")&&t.getLinkElement()}_unlinkLinks(t){this.app.editor.save(),t.each((t=>{this.app.broadcast("link.remove",{data:{url:t.attr("href"),text:t.text(),type:"link"}}),t.unwrap()})),this.app.editor.restore(),this.app.observer.observe()}_unlinkImage(){const t=this.app.block.get(),e=t.getLinkElement();t.setUrl(""),this.app.broadcast("link.remove",{data:{url:e.attr("href"),text:"",type:"image"}}),this.app.observer.observe()}_getOrCreateLink(t,e,s=!1){if(t&&t.isType("image"))return{link:t.getLinkElement(),type:"image"};if(t&&t.isEditable()&&t.isEmpty()&&!e.getText()){const e=this.dom("<a>");return t.getBlock().append(e),{link:e,type:"link"}}if(!t){const t=this.dom("<a>"),e=this.app.block.create();e.getBlock().append(t);return this.app.blocks.get({first:!0}).before(e.getBlock()),this.app.block.set(e),{link:t,type:"link"}}if(s){new v(this.app).set(s,"start")}const i=this.app.inline.set({tag:"a"});return{link:this.dom(i.first()),type:"link"}}_setData(t,e,s="link"){if(t=this._cleanUrl(t),t=this._encodeUrl(t),"image"===s){const e=this.app.block.get();e.setUrl(t.url),e.setTarget(t.target)}else t.url&&e.attr("href",t.url),t.hasOwnProperty("text")&&e.text(t.text),t.target?e.attr("target","_blank"):e.removeAttr("target");return t}_getLinkData(t){return t.length?this._encodeUrl({text:t.text(),url:t.attr("href"),target:t.attr("target")||this.config.get("link.target")}):null}_getLinks(){const t=new L(this.app);if(!t.is())return this.dom();const e=t.getNodes({tags:["a"]});return e.length?this.dom(e):this.dom()}_truncateLinkText(t){const e=this.config.get("link.truncate"),s=t.replace(/^https?:\/\//i,"");return s.length>e?s.substring(0,e)+"...":s}_cleanUrl(t){if(!t.url)return t;const e=new V(this.app);return t.url=e.escapeHtml(t.url),t.url=-1!==t.url.search(/^javascript:/i)?"":t.url,t}_encodeUrl(t){return t.url=t.url?t.url.replace(/&amp;/g,"&"):"",t}}class pe{constructor(t){this.app=t,this.dropdowns={list:["bulletlist","numberedlist","todo"],haslist:["bulletlist","numberedlist","todo","indent","outdent"]}}popup(t,e){const s=this._isList()?this.dropdowns.haslist:this.dropdowns.list;this.app.dropdown.create("list",{items:s}),this.app.dropdown.open(t,e)}indent(){const t=new L(this.app),e=t.getBlock();if(!e)return!1;const s=this.dom(e),i=s.prevElement().get();if(this.app.dropdown.close(),(t.isFullySelected(s)||t.isCollapsed())&&i&&"LI"===i.tagName){this.app.editor.save(e);const t=this.dom(i),r=t.children("ul, ol");if(0!==r.length)r.append(s);else{const e=s.closest("ul, ol").tag(),i=this.dom("<"+e+">");i.append(s),t.append(i)}return this.app.editor.restore(),this.app.control.updatePosition(),!0}return!1}outdent(){const t=new L(this.app),e=t.getBlock();if(!e)return!1;const s=this.dom(e),i=s.parent(),r=i.closest("li"),a=s.prevElement().get(),n=s.nextElement().get();if(this.app.dropdown.close(),t.isAll(s)||t.isCollapsed()){if(0===r.length&&!a)return this._replaceListWithText();if(0===r.length)return!1;const t=new C(this.app);if(t.save(),a&&n){const t=this._getAllNext(s.get()),e=this.dom("<"+i.tag()+">");t.length&&t.forEach((t=>e.append(t))),r.after(s),s.append(e)}else r.after(s),0===i.children().length?i.remove():a||s.append($listItem);return t.restore(),this.app.control.updatePosition(),!0}return!1}_isList(){const t=this.app.block.get();return t&&t.isType("listitem")}_getAllNext(t){const e=[];for(;t&&(t=this.dom(t).nextElement().get());)e.push(t);return e}_replaceListWithText(){const t=this.app.block.get();if(!t.hasParentList()){this.app.dropdown.close(),this.app.context.close();const e=new C(this.app);e.save();const s=t.getParent().getBlock(),i=this.app.block.create(t.getContent());return s.before(i.getBlock()),t.getBlock().remove(),0===s.children().length&&s.remove(),this.app.editor.build(),this.app.block.set(i),e.restore(),!1}}}class ce{constructor(t){this.app=t,this.dropdowns=this._buildDropdowns()}observe(t,e,s){if(!this.config.is("table"))return!1;if("dropdown"!==s){const e=this.app.block.get();e&&e.getBlock().closest("table").length&&(t.command="table.popup")}return t}popup(t,e){const s=this.app.block.get();if(s){const i=this._filterDropdownItems(s);this.app.dropdown.create("table",{items:i}),this.app.dropdown.open(t,e)}}addHead(){const{$table:t,columns:e}=this._getTableInfo();this.removeHead();const s=this.dom("<thead>"),i=this._buildRow(!1,e,"<th>");s.append(i),t.prepend(s),this.app.block.set(i.children("td, th").first(),"start")}addRowBelow(){this._addRow("below")}addRowAbove(){this._addRow("above")}addColumnBefore(){this._addColumn("before")}addColumnAfter(){this._addColumn("after")}removeHead(){this._closeUI();const{$table:t}=this._getTableInfo(),e=t.find("thead");0!==e.length&&(e.remove(),this.app.block.set(t,"start"))}removeRow(){this._closeUI();const t=this._getCurrentCell();if(!t)return;const e=t.getTable(),s=t.getRow(),i=s.getBlock().closest("thead");i.length?i.remove():s.remove(),e.getRows().length?this.app.block.set(e.getFirstBlock(),"start"):e.remove({traverse:!0})}removeColumn(){this._closeUI();const t=this._getCurrentCell();if(!t)return;const e=t.getTable(),s=t.getBlock(),i=s.closest("table"),r=this._getColumnIndex(s);if(i.find("tr").each((t=>{t.find("td, th").eq(r).remove()})),e.getCells().length){const t=Math.max(0,r-1);let s;if(0!==t){s=this.dom(i.find("tr").first().find("td, th").get(t));let e=s.dataget("instance");s=e.getFirstElement()}else s=e.getFirstBlock();this.app.block.set(s,"start")}else e.remove({traverse:!0})}removeTable(){this.app.dropdown.close();this.app.block.get().getBlock().closest("table").dataget("instance").remove({traverse:!0}),this.app.editor.isEmpty()&&this.app.editor.setEmpty()}cellSetting(t,e){const s=this.app.block.get(),i=this.app.create("form",{data:{width:s.getWidth(),nowrap:s.getNowrap()},setter:"table.setCell",command:"table.saveCell",items:{width:{type:"input",placeholder:"## table.width ##"},nowrap:{type:"checkbox",text:"## table.nowrap ##"}}});this.app.dropdown.create("cell-setting",{form:i,focus:"width"}),this.app.dropdown.open(t,e)}setCell(t){this._saveCell(t)}saveCell(t){this.app.dropdown.close(),this._saveCell(t)}_saveCell(t){const e=this.app.block.get(),s=t.getData();""!==s.width&&e.setWidth(s.width),e.setNowrap(s.nowrap),this.app.control.updatePosition()}_buildDropdowns(){return{items:{addhead:{title:"## table.add-head ##",command:"table.addHead"},addcolumnbefore:{title:"## table.add-column-before ##",command:"table.addColumnBefore"},addcolumnafter:{title:"## table.add-column-after ##",command:"table.addColumnAfter"},addrowbelow:{title:"## table.add-row-below ##",command:"table.addRowBelow"},addrowabove:{title:"## table.add-row-above ##",command:"table.addRowAbove"},removehead:{title:"## table.remove-head ##",command:"table.removeHead",divider:"top"},removecolumn:{title:"## table.remove-column ##",command:"table.removeColumn"},removerow:{title:"## table.remove-row ##",command:"table.removeRow"},removetable:{title:"## table.delete-table ##",command:"table.removeTable",divider:"top",danger:!0}}}}_filterDropdownItems(t){const e={...this.dropdowns.items};(t.isNondeletable()||t.isNondeletableParent())&&delete e.removetable;const s=t.isType("table");return Object.keys(e).forEach((t=>{"removetable"!==t&&(e[t].disabled=s)})),e}_closeUI(){this.app.dropdown.close(),this.app.control.close()}_getColumnIndex(t){const e=t.closest("tr");let s=0;return e.find("td, th").each(((e,i)=>{e.get()===t.get()&&(s=i)})),s}_getCurrentCell(){const t=this.app.block.get();return t.isType("cell")?t:t.getClosest("cell")}_getTableInfo(){const t=this.app.block.get(),e=(t.isType("cell")?t:t.getClosest("cell")).getTable().getBlock(),s=e.find("tr").first().children("td, th").length;return{$table:e,columns:s}}_addColumn(t){this._closeUI();const e=this._getCurrentCell();if(!e)return;const s=e.getBlock().closest("table"),i=e.getBlock().get().cellIndex,r=e.getBlock().closest("tr").get().rowIndex;let a=null;if(s.find("tr").each(((e,s)=>{const n=this.dom(e.find("td, th").get(i));if(!n.length)return;const o=this._createNewCell(n);n[t](o),s===r&&(a=o)})),a){const t=a.dataget("instance");this.app.block.set(t.getFirstElement(),"start")}}_createNewCell(t){const e=t.clone().removeClass("rx-block-focus").empty();this.app.create("block.cell",e);const s=this.app.block.create();return e.append(s.getBlock()),e}_addRow(t){this._closeUI();const e="below"===t?"after":"before",s=this.app.block.get().getClosest("row").getBlock(),i=s.closest("tr"),r=s.closest("thead"),a=i.children("td, th").length,n=this._buildRow(i,a,"<td>");r.length?r.after(n):i[e](n);const o=n.dataget("instance");this.app.block.set(o.getFirstElement(),"start")}_buildRow(t,e,s){const i=t?this._cloneRow(t):this._createEmptyRow(e,s);return this.app.create("block.row",i),i.find("td, th").each((t=>{const e=this.app.create("block.cell",t),s=this.app.block.create();e.getBlock().append(s.getBlock())})),i}_createEmptyRow(t,e){const s=this.dom("<tr>");for(let i=0;i<t;i++){const t=this.dom(e);this.app.create("block.cell",t),s.append(t)}return s}_cloneRow(t){const e=t.clone();return e.find("td, th").removeClass("rx-block-focus").empty(),e}}l.add("block","address",{mixins:["block"],props:{type:"address",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.dom("<address>")},handleDelete(t,e,s){if(s.is("backspace")&&this.isCaretEnd()&&this._removeEmptyBrTags())return t.preventDefault(),!0},handleEnter(t){if(t.preventDefault(),!this.isEmpty()&&!this.isCaretEnd()||!this._removeEmptyBrTags())return this._insertBreakline();this._insertAfterEmptyBlock()},_removeEmptyBrTags(){const t=new T(this.app),e=this.$block.children(),s=e.length,i=e.eq(s-1);let r=this.$block.html().trim();return r=t.removeInvisibleChars(r),!(!r.endsWith("<br>")&&!r.endsWith("<br/>"))&&(i.remove(),!0)},_insertAfterEmptyBlock(){this.insertEmpty({position:"after",caret:"start",type:"input"})},_insertBreakline(){return new E(this.app).insertBreakline(),!0}}),l.add("block","dlist",{mixins:["block"],props:{type:"dlist",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{items:{getter:"getItems"}},create(){return this.dom("<dl>").append(this.dom("<dt>").html("Term")).append(this.dom("<dd>").html("Description"))},build(){this._buildItems()},setCaret(t){const e=new v(this.app),s="start"===t?this.getFirstItem():this.getLastItem();e.set(s,t)},getLastItem(){return this.$block.children().last()},getFirstItem(){return this.$block.children().first()},getItems(){const t=[];return this.$block.find("dt").each((e=>{const s=this.unparseInlineBlocks(e.clone()).html(),i=e.nextElement(),r=i&&i.tag("dd")?this.unparseInlineBlocks(i.clone()).html():"";t.push({term:s,desc:r})})),t},handleEnter(t){t.preventDefault();const e=new E(this.app),s=new L(this.app),i=new T(this.app),r=new v(this.app),a=this.dom(s.getBlock()),n=a.tag();if(!r.is(a,"end")||this.isCaretEnd()){if(this.isEmpty()||this.isCaretEnd()){const t=i.isEmptyHtml(a.html());return"dt"===n&&t?(a.remove(),this.insertEmpty({position:"after",caret:"start",type:"input"}),!0):(this._insertCorrespondingTag(a,n,r),!0)}return this.isCaretStart()||e.insertBreakline(),!0}this._insertCorrespondingTag(a,n,r)},_insertCorrespondingTag(t,e,s){const i=this.dom("dt"===e?"<dd>":"<dt>");t.after(i),s.set(i,"start")},_buildItems(){const t=this.data.get("items");t&&(this.$block.html(""),t.forEach((t=>{this.$block.append(this.dom("<dt>").html(t.term)),this.$block.append(this.dom("<dd>").html(t.desc))})))}}),l.add("block","embed",{mixins:["block"],parser:!1,props:{type:"embed",focusable:!0,editable:!1,inline:!1,control:{embed:{position:{after:"add"}}}},defaults:{content:{getter:"getContent",setter:"setContent"},caption:{getter:"getCaption",setter:"setCaption"},responsive:{getter:"getResponsive",setter:"setResponsive"}},start(){this.embedClassname=this.opts.get("embed.classname"),this.responsiveClassname=this.opts.get("embed.responsiveClassname")},create(){return this.dom("<figure>")},parse(){this.$embed=this.embedClassname?this.$block.find("."+this.embedClassname):this.$block,this.$block.hasClass("rx-figure-iframe")&&this.$block.data("figure-frame",!0);let t=0===this.$embed.length?this._initializeEmbed():this.$embed.html();this.parseCaption(),this.setContent(t),this._handleResponsive()},build(){this.$embed=this._createEmbed(),this._handleResponsive()},getContent(){return decodeURI(this.$block.attr("data-embed-content")).trim()},getCaption(){return this.figcaption?this.figcaption.getContent():null},getResponsive(){return this.$embed.hasClass(this.responsiveClassname)||null},getVideoTitle(){return this.$embed.find("video").attr("title")},getVideoPoster(){return this.$embed.find("video").attr("poster")},isResponsive(){return this.getResponsive()},setContent(t){t=t.trim(),this.$embed.html(t),this.$block.attr("data-embed-content",encodeURI(t))},setCaption(t){this.figcaption?this.figcaption.setContent(t):this._buildCaption(t)},setResponsive(t){t&&this.$embed.addClass(this.responsiveClassname)},_initializeEmbed(){let t=this.$block.find("figcaption"),e=this.$block.clone();e.find("figcaption").remove();let s=e.html();return this.$embed=this._createEmbed(),0!==t.length&&this.$block.append(t),s},_handleResponsive(){this.opts.is("embed.responsive")&&this.$embed.addClass(this.responsiveClassname)},_createEmbed(){if(!this.embedClassname)return this.$block;let t=this.dom("<div>").addClass(this.embedClassname);return this.$block.html(""),this.$block.append(t),t}}),l.add("block","figcaption",{mixins:["block"],props:{type:"figcaption",editable:!0,inline:!1,control:!1},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.dom(this.opts.get("figcaption.template"))},parse(){this._buildPlaceholder()},build(){this._buildPlaceholder()},getFigure(){return this.$block.closest("figure").dataget("instance")},handleDelete(t,e,s){if(s.is("delete")&&this.isCaretEnd())return t.preventDefault(),!0},handleArrow(t,e,s){if(s.is("up+left")&&this.isCaretStart()||s.is("down+right")&&this.isCaretEnd())return t.preventDefault(),this.app.block.set(this.getFigure()),!0},handleTab(t){return t.preventDefault(),this.app.block.set(this.getFigure()),!0},handleEnter(t){if(t.preventDefault(),this.isEmpty()||this.isCaretEnd()||this.isCaretStart())return!0;return new E(this.app).insertBreakline(),!0},_buildPlaceholder(){this.$block.attr("data-placeholder")||this.setPlaceholder(this.lang.get("placeholders.figcaption"))}}),l.add("block","heading",{mixins:["block"],props:{type:"heading",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"},level:{getter:"getLevel",setter:"setLevel"}},create(){return this.dom("<h"+(this.data.get("level")||2)+">")},setLevel(t){this.getLevel()!==Number(t)&&(this.$block=this.$block.replaceTag(`h${t}`))},getLevel(){return Number(this.getTag().replace("h",""))},handleEnter(t){if(t.preventDefault(),this.isEmpty()||this.isCaretEnd())this.insertEmpty({position:"after",caret:"start",remove:!1,type:"input"});else if(this.isCaretStart())this.insert({instance:this.duplicateEmpty(),position:"before",type:"input"});else{const t=new G(this.app).split(this.$block);this.app.block.set(t,"start"),this.app.emit("block.split",{element:t.get()})}return!0}}),l.add("block","image",{mixins:["block"],props:{type:"image",focusable:!0,editable:!1,inline:!1,control:{image:{position:{after:"add"}},wrap:{position:{after:"image"}},outset:{position:{after:"image"}}}},defaults:{src:{getter:"getSrc",setter:"setSrc"},srcset:{getter:"getSrcset",setter:"setSrcset"},url:{getter:"getUrl",setter:"setUrl"},alt:{getter:"getAlt",setter:"setAlt"},width:{getter:"getWidth",setter:"setWidth"},height:{getter:"getHeight",setter:"setHeight"},img:{getter:"getImageStyle"},target:{getter:"getTarget",setter:"setTarget"},caption:{getter:"getCaption",setter:"setCaption"},wrap:{getter:"getWrap"}},create(){return this.dom("<"+this.opts.get("image.tag")+">")},parse(){this._parseImage(),this._parseLink(),this.parseCaption()},build(){this._buildImageTag(),this._buildImage(),this._buildLink()},getLinkElement(){return this.$link},getSrc(){return this.$image.attr("src")},getId(){return this.$image.attr("id")},getAlt(){return this.$image.attr("alt")},getSrcset(){return this.$image.attr("srcset")},getUrl(){return this.$link?this.$link.attr("href"):null},getTarget(){return this.$link&&"_blank"===this.$link.attr("target")},getWrap(){let t=this.$block.tag();return t===this.opts.get("image.tag")?null:t},getCaption(){return this.figcaption?this.figcaption.getContent():null},getCaptionElement(){return this.figcaption?this.figcaption.getBlock():null},getWidth(){return this._getStyle("width")},getHeight(){let t=this._getStyle("height");return null===t?this.$image.height():t},getImageStyle(){return this._getStyle()},getDataImage(){return this.$image.attr("data-image")},getImage(){return this.$image},setAlt(t){this.$image.attr("alt",t.replace(/"/g,"'"))},setId(t){this.$image.attr("id",t),this.$image.attr("data-image",t)},setSrc(t){this.$image.attr("src",t)},setSrcset(t){this.$image.attr("srcset",t)},setHeight(t){if(""!==(t=t?t.trim():"")){let e=this.$image.width();e=0===e?parseInt(this.$image.attr("width")):e;let s=this.$image.height();s=0===s?parseInt(this.$image.attr("height")):s;const i=e/s,r=parseInt(t),a=Math.trunc(r*i);this._setWidth(a+"px"),this._setHeight(r)}else this._resetImageHeight();new R(this.app).cacheElementStyle(this.$image),this.app.broadcast("image.position"),this.app.control.updatePosition()},setWidth(t,e){if(""!==(t=t?t.trim():"")){const s=t.includes("%");let i=s?t:parseInt(t),r=0!==this.$image.width()&&this.$image.width()/this.$image.height();e=this._determineHeight(e,i,r),s?(this.$image.removeAttr("height"),this.$image.css("height",""),this._setWidth(i)):(this._setWidth(i+"px"),this._setHeight(e))}else this._resetImageDimensions();new R(this.app).cacheElementStyle(this.$image),this.app.broadcast("image.position"),this.app.control.updatePosition()},setCaption(t){this.figcaption?this.figcaption.setContent(t):this._buildCaption(t)},setUrl(t){this.$link?""===t||null===t?(this.$link.unwrap(),this.$link=!1):this.$link.attr("href",t):""!==t&&null!==t&&this._createLink(t)},setTarget(t){this.$link&&(t&&""!==t?this.$link.attr("target","_blank"):this.$link.removeAttr("target"))},_determineHeight(t,e,s){return t=this.data.is("height")?!1===s?parseInt(this.data.get("height")):Math.round(e/s):!1!==s&&(t||Math.round(e/s))},_setWidth(t){this.$image.css({width:t}).attr({width:t.replace("px","")})},_setHeight(t){!1!==t&&this.$image.css({height:t+"px"}).attr({height:t})},_resetImageHeight(){this.$image.removeAttr("height"),this.$image.css({height:""}),""===this.$image.attr("style")&&this.$image.removeAttr("style")},_resetImageDimensions(){this.$image.removeAttr("width height"),this.$image.css({width:"",height:""}),""===this.$image.attr("style")&&this.$image.removeAttr("style")},_createLink(t){this.$link=this.dom("<a>"),this.$image.wrap(this.$link),this.$link.attr("href",t)},_getStyle(t){let e=new T(this.app).cssToObject(this.$image.attr("style"));return t?this._getStyleValue(e,t):this._getAllStyles(e)},_getStyleValue(t,e){let s=t[e]?t[e].replace("px",""):this.$image.attr(e);return s||null},_getAllStyles:t=>Object.keys(t).length>0?{style:t}:null,_parseImage(){let t=this.data.get("img");this.$image=this.$block.find("img"),t&&this._buildImageParams(t)},_parseLink(){let t=this.$block.find("a");0===t.closest("figcaption").length&&0!==t.length&&(this.$link=t)},_buildImageTag(){let t=this.getTag(),e=this.opts.get("image.tag"),s=this.data.get("wrap");if(t!==e||s&&t!==s){let t=s||e;this.$block=this.$block.replaceTag(t)}},_buildImage(){const t=this.data.getValues();this.$image=this.dom("<img>"),this.$block.append(this.$image),this._buildImageParams(t)},_buildImageParams(t){["src","alt","srcset"].forEach((e=>{t.hasOwnProperty(e)&&this.$image.attr(e,t[e])})),t.img&&t.img.style&&this.$image.css(t.img.style)},_buildLink(){const t=this.data.getValues();t.url&&(this.$link=this.dom("<a>").attr("href",t.url),this.$image.wrap(this.$link),t.target&&this.$link.attr("target","_blank"))}}),l.add("block","wrapper",{mixins:["block"],nested:!0,props:{type:"wrapper",focusable:!0,inline:!1,control:{unwrap:{position:{after:"add"}}}},defaults:{wrap:{getter:"getWrap",setter:"setWrap"},children:{getter:"getChildren"}},create(){let t=this.dom(this.opts.get("wrapper.template"));return this.app.has("email")&&t.addClass("email-wrapper"),t},build(){this.params.children||this.fillEmpty()},parse(){this.app.has("email")&&this.$block.addClass("email-wrapper")},setCaret(t){const e=this.getFirstBlock();0!==e.length&&e.dataget("instance")?this.app.block.set(e,t):this._focusAndCollapseSelection()},setWrap(t){this.$block=this.$block.replaceTag(t)},getWrap(){let t=this.$block.tag();return"div"===t?null:t},getFirstBlock(){return this.$block.children().first()},fillEmpty(){this.isEmpty()&&this.$block.append(this.app.block.create().getBlock())},_focusAndCollapseSelection(){const t=new L(this.app);this.app.scroll.save(),this.$block.attr("tabindex","-1").focus(),t.collapse(),setTimeout((()=>t.remove()),1),this.app.scroll.restore()}}),l.add("block","layout",{mixins:["block"],nested:!0,props:{type:"layout",focusable:!0,inline:!1,control:{unwrap:{position:{after:"add"}}}},defaults:{children:{getter:"getChildren"}},create(){const t=this.opts.get("layout.grid"),e=this.dom("<div>");return t?e.addClass(t):e.attr(this.opts.get("dataBlock"),"layout").addClass("rx-layout-grid")},parse(){const t=this.opts.get("layout.grid"),e=this.opts.get("layout.column");t?this._handleGridSetup(e):this.$block.addClass("rx-layout-grid")},build(){this.params.children||(this.params.pattern?this._buildFromPattern():(this._createAndAppendColumn("50%"),this._createAndAppendColumn("50%")))},setCaret(t){let e="start"===t?this.getFirstBlock():this.getLastBlock();this.app.block.set(e,t)},getFirstBlock(){return this.getFirstColumn().children().first()},getLastBlock(){return this.getLastColumn().children().last()},getFirstColumn(){return this.$block.find("[data-rx-type=column]").first()},getLastColumn(){return this.$block.find("[data-rx-type=column]").last()},getColumns(){return this.$block.find("[data-rx-type=column]").map((t=>this.dom(t).dataget("instance")))},_handleGridSetup(t){if(!t){this.$block.children().each((t=>{this.app.create("block.column",t)}));new u(this.app).parse(this.$block)}},_buildFromPattern(){const t=this.params.pattern.split("|");this.params.grid&&this.$block.addClass(this.params.grid),t.forEach((t=>{const e=this._parsePatternPart(t),s=this.app.create("block.column",e);this.$block.append(s.getBlock())}))},_parsePatternPart:t=>t.includes("%")?{width:t}:"-"!==t?{classname:t}:{},_createAndAppendColumn(t){const e=this.app.create("block.column",{width:t});this.$block.append(e.getBlock())}}),l.add("block","column",{mixins:["block"],nested:!0,props:{type:"column",focusable:!0,inline:!1},defaults:{children:{getter:"getChildren"},width:{getter:"getWidth",setter:"setWidth"}},create(){const t=this.opts.get("layout.grid"),e=this.opts.get("layout.column"),s=this.dom("<div>");return t&&!e?s:e?s.addClass(e):s.attr(this.opts.get("dataBlock"),"column")},build(){if(!this.params.children&&this.isEmpty()){let t=this.app.block.create();this.$block.append(t.getBlock())}},getFirstBlock(){return this.$block.children().first()},getLastBlock(){return this.$block.children().last()},getFirstBlockInstance(){return this.getFirstBlock().dataget("instance")},getLastBlockInstance(){return this.getLastBlock().dataget("instance")},getNextColumn(){const t=this.$block.nextElement();return t.length>0&&"column"===t.data("block")&&t},isLastElement(){return 0===this.$block.nextElement().length},setWidth(t){this.opts.get("layout.grid")||this.$block.css("flex-basis",t)},getWidth(){return this.opts.get("layout.grid")?null:this.$block.css("flex-basis")},handleTab(t){t.preventDefault();const e=this.getNextColumn()||this.getClosest("layout").getNext();return e&&this.app.block.set(e,"start"),!0}}),l.add("block","line",{mixins:["block"],props:{type:"line",focusable:!0,editable:!1,inline:!1},create(){return this.dom(this.opts.get("line.template"))}}),l.add("block","list",{mixins:["block"],props:{type:"list",focusable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{numbered:{getter:"getNumbered"},items:{getter:"getItems"}},create(){return this.dom(`<${this._createTag()}>`).append(this.dom("<li>"))},parse(){this.parseItems("ul, ol","list"),this.parseItems("li","listitem")},build(){this._buildItems(),this.parseItems("ul, ol","list"),this.parseItems("li","listitem")},setCaret(t){let e="start"===t?this.getFirstItem():this.getLastItem();this.app.block.set(e,t)},getFirstItem(){return this.$block.find("li").first()},getFirstItemInstance(){return this.getFirstItem().dataget("instance")},getLastItem(){return this.$block.find("li").last()},getLastItemInstance(){return this.getLastItem().dataget("instance")},getNumbered(){return"ol"===this.getTag()},getItems(){return this.$block.children().all().map((t=>this.dom(t).dataget("instance").getContent()))},_createTag(){return this.data.get("numbered")?"ol":"ul"},_buildItems(){const t=this.data.get("items");t&&(this.$block.empty(),t.forEach((t=>this.$block.append(this.dom("<li>").html(t)))))}}),l.add("block","listitem",{mixins:["block"],props:{type:"listitem",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.dom("<li>")},isListEnd(){return this.getParent().isCaretEnd()},isListTopEnd(){return this.getParentTopInstance().isCaretEnd()},isFirstElement(){return 0===this.$block.prevElement().length},isLastElement(){return 0===this.$block.nextElement().length},hasParentList(){return 0!==this.$block.parent().closest("li").length},hasChild(){return 0!==this.$block.find("ul, ol").length},getChild(){return this.$block.find("ul, ol").first()},getParentTop(){return this.$block.parents("ul, ol").last()},getParentTopInstance(){return this.getParentTop().dataget("instance")},getParentItem(){return this.$block.parent().closest("li").dataget("instance")},getParent(){return this.$block.parent().closest(this._buildTraverseSelector("list")).dataget("instance")},getContent(t=!1){let e=this.$block.clone();return t?e.find("ul, ol").remove():e.find("ul, ol").before("<br>").unwrap(),e=this.unparseInlineBlocks(e),e.html().replace(/<\/?li[^>]*>/g,"\n").replace(/\s\s+/g," ").replace(/\t/g,"").trim()},handleArrow(t,e,s){return s.is("up+left")?this._traverse("prev",t,s):s.is("down+right")?this._traverse("next",t,s):void 0},handleDelete(t,e,s){return s.is("backspace")&&this.isCaretStart()&&this.isFirstElement()&&!this.hasParentList()?(t.preventDefault(),this._handleBackspaceDelete(),!0):s.is("delete")&&this.isListEnd()&&this.isLastElement()&&!this.hasParentList()?(t.preventDefault(),this._handleForwardDelete(),!0):void setTimeout((()=>{const t=new L(this.app);this.$block=this.dom(t.getBlock()),this.$block.find("span").not("[data-rx-style-cache]").unwrap(),this.$block.get().normalize()}),0)},handleTab(t){if(!this.opts.is("tab.spaces")||this.isCaretStart())return t.preventDefault(),this.app.list.indent(),!0},handleEnter(t){t.preventDefault();const e=new v(this.app).is(this.$block,"end",["ul","ol"]);return this.hasChild()&&e?this._handleEnterWithChildAtEnd():!this.hasChild()&&this.hasParentList()&&this.isListTopEnd()?this._handleEnterAtNestedEnd():this.isEmpty()||this.isCaretEnd()?this._handleEnterAtEmptyOrEnd():this.isCaretStart()?this._handleEnterAtStart():this._handleEnterInMiddle(),this.app.observer.observe(),!0},_handleEnterWithChildAtEnd(){const t=new T(this.app);let e=this.getChild(),s=this._createItem(),i=e.clone();e.remove(),this.app.block.set(s,"start"),s.getBlock().append(t.createInvisibleChar()),s.getBlock().append(i)},_handleEnterAtNestedEnd(){const t=new L(this.app).getBlockControlled(),e=!!t&&this.dom(t).dataget("instance");if(e&&e.isEmpty()){const t=this.app.create("block.listitem");e.getParent().insert({position:"append",instance:t,type:"input"}),e.remove()}else{const t=this._createItem();this.app.block.set(t,"start"),this.app.broadcast("list.item",{instance:t})}},_handleEnterAtEmptyOrEnd(){const t=new L(this.app).getBlockControlled(),e=!!t&&this.dom(t).dataget("instance");if(e&&!this.hasParentList()&&e.isEmpty()){const t=this.isListEnd()?"after":"split";this.getParent().insertEmpty({position:t,caret:"start",type:"input"}),e.remove()}else{const t=this._createItem();this.app.block.set(t,"start"),this.app.broadcast("list.item",{instance:t})}},_handleEnterAtStart(){this._createItem("before"),this.app.block.set(this)},_handleEnterInMiddle(){const t=new G(this.app).split(this.$block),e=this._createItem();e.setContent(t.html()),t.remove(),this.app.block.set(e,"start"),this.app.broadcast("list.item",{instance:e})},_handleBackspaceDelete(){const t=this.getParent(),e=this.getContent(),s=this.app.block.create(e),i=this.getParent();this.remove(),t.getBlock().before(s.getBlock()),i.isEmpty(!0)&&i.remove(),this.app.block.set(s,"start")},_handleForwardDelete(){const t=this.getParent().getNext();if(t)if(t.isType("quote")){const e=t.getBlock().text();this._insertHtml(e),t.remove()}else if(t.isEditable()){const e=t.getHtml();this._insertHtml(e),t.remove()}else if(t.isType("todo")){const e=t.getFirstItem(),s=t.getFirstContent().html();e.remove(),this._insertHtml(s),t.isEmpty()&&t.remove()}else if(t.isType("list")){const e=t.getBlock().children();this.$block.append(e),t.remove()}else this.app.block.set(t,"start")},_traverse(t,e,s){if("prev"===t?!this.isFirstElement()||!this.isCaretStart():!this.isLastElement()||!this.isCaretEnd())return;e.preventDefault();let i=this.getParent();this.hasParentList()&&(i=this.getParentItem());const r="prev"===t?"getPrev":"getNext";let a=i[r]();if(a||(a=i[r+"Parent"]()),a)this.app.block.set(a,"prev"===t?"end":"start");else if(this.app.block.set(i),"prev"===t){new v(this.app).set(i.getFirstItem(),"before")}return!0},_createItem(t){let e=this.app.create("block.listitem");return t=t||"after",this.$block[t](e.getBlock()),e}}),l.add("block","noneditable",{mixins:["block"],parser:!1,props:{type:"noneditable",focusable:!0,editable:!1,inline:!1},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.dom("<div>").attr(this.opts.get("dataBlock"),"noneditable")},handleDelete(t,e,s){if(!this.opts.is("noneditable.remove")&&(s.is("delete")||s.is("backspace")))return t.preventDefault(),!0}}),l.add("block","pre",{mixins:["block"],props:{type:"pre",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"},caption:{getter:"getCaption",setter:"setCaption"}},create(){return this.dom(this.opts.get("pre.template"))},parse(){this.parseCaption()},getCodeElement(){const t=this.$block.find("code"),e=this.$block.find("pre");return t.length?t:e.length?e:this.$block},getPlainText(){return this._getPlainText(this.getCodeElement())},getContent(){return this.getCodeElement().html().trim()},getCaption(){return this.figcaption?this.figcaption.getContent():null},setContent(t){this.getCodeElement().html(t)},setCaption(t){this.figcaption?this.figcaption.setContent(t):this._buildCaption(t)},setCaret(t){new v(this.app).set(this.getCodeElement(),t)},handleArrow(t,e,s){if(!this.getNext()&&this.isCaretEnd()&&s.is("down")){t.preventDefault();let e=this.app.block.create();return this.insert({instance:e,position:"after",caret:"start",remove:!1,type:"input"}),!0}},handleTab(t){return t.preventDefault(),this._insertSpaces(this.opts.get("pre.spaces")),!0},handleEnter(t){return t.preventDefault(),this._insertNewlineIfNeeded(),!0},_insertNewlineIfNeeded(){const t=this.$block.html().search(/\n$/),e=new E(this.app);this.isCaretEnd()&&-1===t?e.insertNewline("after",!0):e.insertNewline()},_insertSpaces(t){const e=document.createTextNode(" ".repeat(t));new E(this.app).insertNode(e,"end"),this._fixDoubleNewlines()},_fixDoubleNewlines(){const t=new L(this.app).getCurrent().previousSibling,e=t&&t.textContent;e&&-1!==e.search(/\n\n/g)&&(t.textContent=e.replace(/\n\n/g,"\n"))}}),l.add("block","quote",{mixins:["block"],props:{type:"quote",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"},caption:{getter:"getCaption",setter:"setCaption"}},create(){return this.dom(this.opts.get("quote.template"))},parse(){this._parseItem(),this._parseCaption()},build(){this._parseItem(),this._parseCaption()},isEmpty(t){return this._isEmpty(this.getCurrentItem(),t)},getPlaceholder(){return this.getItem().attr("data-placeholder")},getCurrentItem(){const t=new L(this.app);return this._isCaption(t.getParent())?this.$quotecaption:this.$quoteitem},getItem(){return this.$quoteitem},setCaret(t){new v(this.app).set(this.$quoteitem,t)},setContent(t){this.$quoteitem.html(t)},setEmpty(){this.getCurrentItem().html("")},setPlaceholder(t){this._setAttr(this.getItem(),"data-placeholder",t)},setCaption(t){this.$quotecaption.html(t)},getContent(){return this.$quoteitem.html()},getCaption(){return this.$quotecaption?this.$quotecaption.html():null},handleDelete(t,e,s){const i=new v(this.app),r=new L(this.app),a=new T(this.app);let n=this._getItemFromSelection(r),o=this._getCaptionFromSelection(r),l=this.dom(o),h=this.getPrev();if(s.is("backspace")&&this._isCaption(o)&&i.is(o,"start")){if(a.isEmptyHtml(l.html())&&!l.attr("data-placehoder"))return t.preventDefault(),this.$quotecaption.remove(),!0;t.preventDefault(),this.$quotecaption.find("br").remove()}else s.is("delete")&&this._isCaption(o)&&i.is(o,"end")||s.is("delete")&&this._isItem(n)&&i.is(n,"end")?t.preventDefault():s.is("backspace")&&this._isItem(n)&&i.is(n,"start")&&h&&h.isEditable()&&(t.preventDefault(),this.app.block.set(h,"end"),this._insertHtml(this.getPlainText()),this.remove());return!0},handleArrow(t,e,s){if(!this.getNext()&&this.isCaretEnd()&&s.is("down"))return t.preventDefault(),this._createNewInputAfter(),!0},handleEnter(t){t.preventDefault();const e=new L(this.app),s=new E(this.app),i=new v(this.app);let r=this._getCaptionFromSelection(e),a=i.is(r,"end");return this._isCaption(r)?a?(t.preventDefault(),this._createNewInputAfter()):this.$quotecaption.tag("cite")&&s.insertBreakline(!1,!1):s.insertBreakline(),!0},_createNewInputAfter(){let t=this.app.block.create();this.insert({instance:t,position:"after",caret:"start",remove:!1,type:"input"})},_isCaption(t){return t&&this.$quotecaption&&t===this.$quotecaption.get()},_isItem(t){return t&&t===this.$quoteitem.get()},_getItemFromSelection:t=>t.getBlock(),_getCaptionFromSelection(t){return this.$quotecaption&&this.$quotecaption.tag("cite")?t.getClosest("cite"):t.getParent()},_parseItem(){this.$quoteitem=this.$block.find("p").first(),0===this.$quoteitem.length&&(this.$quoteitem=this.$block)},_parseCaption(){let t=this.isFigure()?this.$block.find("figcaption"):this.$block.find("p").last(),e=t.find("cite");this.$quotecaption=e.length?e:!!t.length&&t}}),l.add("block","table",{mixins:["block"],nested:"td, th",props:{type:"table",focusable:!0,inline:!1,control:{table:{position:{after:"add"}}}},defaults:{head:{getter:"getHead"},foot:{getter:"getFoot"},items:{getter:"getItems"}},create(){return this.dom(this.opts.get("table.template"))},build(){this._buildItems(),this._parseAndBuild(),this.fillEmpty()},parse(){this._parseAndBuild()},setCaret(t){const e="start"===t?this.getFirstBlock():this.getLastBlock();this.app.block.set(e,t)},getFirstBlock(){return this.getFirstCell().children().first()},getFirstCell(){return this.$block.find("th, td").first()},getLastBlock(){return this.getLastCell().children().last()},getLastCell(){return this.$block.find("th, td").last()},getRows(){return this.$block.find("tr")},getCells(){return this.$block.find("th, td")},getHead(){return this.$block.find("thead").length>0},getFoot(){return this.$block.find("tfoot").length>0},getItems(){const t=this.opts.get("tags.block").join(","),e=this.$block.find("tr");let s=[];return e.each((e=>{let i=[];e.find("th, td").each((e=>{e=e.clone(),(e=this.unparseInlineBlocks(e)).find(t).unwrap(),i.push(e.html().trim())})),s.push(i)})),s},fillEmpty(){this.getCells().each(function(t){if(t.dataget("instance").isEmpty()){let e=this.app.block.create();t.append(e.getBlock())}}.bind(this))},_parseAndBuild(){this._buildNowrap(),this.parseItems("tr","row"),this.parseItems("td, th","cell")},_buildItems(){const t=this.data.get("items");if(!t)return;const e=this.data.get("head"),s=this.data.get("foot"),i=t.length,r=e?this.dom("<thead>"):null,a=this.dom("<tbody>"),n=s?this.dom("<tfoot>"):null;t.forEach(((t,o)=>{const l=0===o,h=o===i-1,p=this.dom("<tr>");l&&e?r.append(p):h&&s?n.append(p):a.append(p),t.forEach((t=>{const s=l&&e?"th":"td",i=this.dom(`<${s}>`),r=this.app.create("block.text",{table:!0});r.getBlock().html(t),i.append(r.getBlock()),p.append(i)}))})),this.$block.empty(),e&&this.$block.append(r),this.$block.append(a),s&&this.$block.append(n)},_buildNowrap(){let t=this.opts.get("table.nowrap");this.$block.find("th, td").filter("."+t).addClass("rx-nowrap")}}),l.add("block","cell",{mixins:["block"],props:{type:"cell",inline:!1,focusable:!0,reorder:!1,control:{table:{position:{after:"add"}}}},defaults:{content:{getter:"getContent",setter:"setContent"},width:{getter:"getWidth",setter:"setWidth"},nowrap:{getter:"getNowrap",setter:"setNowrap"}},create(){return this.dom("<td>")},getTable(){return this.getClosest("table")},getRow(){return this.getClosest("row")},getNextCell(){return this._getSiblingCell("getNext","getNextRow","getFirst")},getPrevCell(){return this._getSiblingCell("getPrev","getPrevRow","getLast")},getFirstElement(){return this.$block.find("[data-rx-type]").first()},getWidth(){return this.$block.attr("width")||""},getNowrap(){return this.$block.hasClass("rx-nowrap")},setWidth(t){this._applyToEachCell((e=>{(t=t.endsWith("%")?t:t.replace("px",""))?e.attr("width",t):e.removeAttr("width")}))},setNowrap(t){const e=this.opts.get("table.nowrap")+" rx-nowrap";this._applyToEachCell((s=>t?s.addClass(e):s.removeClass(e)))},setEmpty(){let t=this.app.block.create();this.$block.html(""),this.$block.append(t.getBlock())},setCaret(t){new v(this.app).set(this.getFirstElement(),t)},isLastElement(){const t=this.getTable().getBlock().find("th, td").last();return this.$block.get()===t.get()},handleTab(t){t.preventDefault();const e=this.getNextCell()||this.getClosest("table").getNext();return e&&this.app.block.set(e,"start"),!0},_getSiblingCell(t,e,s){let i=this[t]();if(!i){const t=this.getRow(),r=t&&t[e]();i=r&&r[s]("cell")}return i},_applyToEachCell(t){const e=this._getCellIndex();this.getTable().getBlock().find("tr").each(((s,i)=>{const r=this.dom(s.get().cells[e]);t(r)}))},_getCellIndex(){const t=this.$block.closest("tr").find("td, th").all();return Array.from(t).indexOf(this.$block.get())}}),l.add("block","row",{mixins:["block"],props:{type:"row",inline:!1,focusable:!0,control:!1},create(){return this.dom("<tr>")},setCaret(t){new v(this.app).set(this.getFirstElement(),t)},getTable(){return this.getClosest("table")},getFirstElement(){return this.$block.find("td, th").first().find("[data-rx-type]").first()},getLastElement(){return this.$block.find("td, th").last().find("[data-rx-type]").first()},getNextRow(){return this._getAdjacentRow("next")},getPrevRow(){return this._getAdjacentRow("prev")},_getAdjacentRow(t){let e=this["next"===t?"getNext":"getPrev"](),s=this.$block.parent();if(!e&&!s.tag("table")){e=s["next"===t?"nextElement":"prevElement"]().find("tr")["next"===t?"first":"last"]().dataget("instance")}return e}}),l.add("block","text",{mixins:["block"],props:{type:"text",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.params.table?this.dom('<div data-rx-tag="tbr">'):this.opts.is("breakline")?this.dom('<div data-rx-tag="br">'):this.dom(`<${this.opts.get("markup")}>`)},handleEnter(t){let e;if(t.preventDefault(),this.isEmpty()||this.isCaretEnd())e=this._createNewBlockForEnter(),this.insert({instance:e,position:"after",caret:"start",remove:!1,type:"input"});else if(this.isCaretStart())e=this._createNewBlockForEnter(),this.insert({instance:e,position:"before",type:"input"});else{const t=new G(this.app),e=this.getBlock(),s=t.split(e);this.app.block.set(s,"start"),this.app.emit("block.split",{element:s.get()})}return!0},_createNewBlockForEnter(){let t="tbr"===this.$block.attr("data-rx-tag")?this.app.create("block.text",{table:!0}):this.app.block.create();return this.opts.is("clean.enter")||(t=this.duplicateEmpty(),t.getBlock().removeAttr("id")),this.opts.is("clean.enterinline")&&(t=this._cloneInline(t)),t},_cloneInline(t){const e=new L(this.app),s=new K(this.app),i=e.getInline();if(i){let e=s.getInlines(i),r=null;e.forEach(((t,e)=>{if("A"===t.tagName)return;let s=t.cloneNode();s.removeAttribute("id"),s.innerHTML="",r=0===e?null:s})),r&&(t=this.app.block.create(r.outerHTML))}return t}}),l.add("block","todo",{mixins:["block"],props:{type:"todo",focusable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{items:{getter:"getItems"}},create(){let t=this.dom("<ul>");if(!this.data.get("items")){let e=this.app.create("block.todoitem");t.append(e.getBlock())}return t},parse(){this.parseItems("li","todoitem")},build(){this._buildItems(),this.parseItems("li","todoitem")},setCaret(t){let e="start"===t?this.getFirstItem():this.getLastItem();this.app.block.set(e,t)},getItems(){return this.$block.children().all().map((t=>{let e=this.dom(t).dataget("instance");return{content:e.getContent(),checked:e.getChecked()}}))},getFirstItem(){return this.$block.children().first()},getFirstItemInstance(){return this.getFirstItem().dataget("instance")},getFirstContent(){return this.getFirstItem().find("div").first()},getLastItem(){return this.$block.children().last()},getLastItemInstance(){return this.getLastItem().dataget("instance")},getLastContent(){const t=new T(this.app).findTodoItemTag();return this.getLastItem().find(t).last()},_buildItems(){let t=this.data.get("items");t&&t.forEach((t=>{let e=this.app.create("block.todoitem",t);this.$block.append(e.getBlock())}))}}),l.add("block","todoitem",{mixins:["block"],props:{type:"todoitem",inline:!1,editable:!0,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{setter:"setContent",getter:"getContent"},checked:{setter:"setChecked",getter:"getChecked"}},create(){return this.dom("<li>")},parse(){this._parse()},build(){this.$block.html(this.opts.get("todo.templateItem")),this._parse()},setCaret(t){new v(this.app).set(this.$content,t)},isFirstElement(){return 0===this.$block.prevElement().length},isLastElement(){return 0===this.$block.nextElement().length},isListEnd(){return this.getParent().isCaretEnd()},getContentItem(){return this.$content},getParent(){return this.$block.parent().closest(this._buildTraverseSelector("todo")).dataget("instance")},getContent(){return this.unparseInlineBlocks(this.$content.clone()).html().trim()},getChecked(){return"1"===this.$block.attr("data-checked")},setContent(t){this.$content.html(t)},setChecked(t){this.$input.attr("checked",t),this.$block.attr("data-checked",t?"1":"0")},setPlaceholder(t){this.$content.attr("data-placeholder",t)},setEmpty(){this.$content.html("")},handleArrow(t,e,s){return s.is("left")&&this.isCaretStart()||s.is("up")?this._traverse(t,"prev"):s.is("right")&&this.isCaretEnd()||s.is("down")?this._traverse(t,"next"):void 0},handleDelete(t,e,s){return s.is("delete")?this._handleDeleteForward(t):s.is("backspace")?this._handleDeleteBackward(t):void 0},handleTab(t){return this._traverse(t,"next")},handleEnter(t){return t.preventDefault(),this.isEmpty()||this.isCaretEnd()?this._handleEmptyOrEnd():this.isCaretStart()?this._createAndSetItem("before"):this._handleContentSplit(),!0},_handleDeleteForward(t){let e=this.getNext(),s=this.getParent();if(this.isCaretEnd()&&e&&e.isType("todoitem"))return t.preventDefault(),this._insertItem("delete",e),!0;if(this.isCaretEnd()&&this.isLastElement()&&(e=this.getNextParent(),e)){if(t.preventDefault(),e.isType("quote")){let t=e.getBlock().text();this._insertHtml(t,!1),e.remove()}else if(e.isEditable()){let t=e.getHtml();this._insertHtml(t,!1),e.remove()}else if(e.isType("todo")){let t=e.getBlock().children();s.getBlock().append(t),e.remove()}else if(e.isType("list")){let t=e.getBlock().children().first(),s=t.html();t.remove(),this._insertHtml(s,!1),e.isEmpty()&&e.remove()}else this.app.block.set(e,"start");return!0}},_handleDeleteBackward(t){let e=this.getNext(),s=this.getPrev(),i=this.getParent();if(this.isCaretStart()&&s&&s.isType("todoitem"))return t.preventDefault(),this._insertItem("backspace",s),!0;if(this.isCaretStart()&&this.isFirstElement()&&(e=this.getPrevParent(),e)){if(t.preventDefault(),e.isEditable()){let t=this.getContent();this.app.block.set(e,"end"),this._insertHtml(t),this.remove(),i.isEmpty()&&i.remove()}else if(e.isType("todo")){let t=i.getBlock().children();e.getBlock().append(t),this.app.block.set(t.first(),"start",!0),i.remove()}else if(e.isType("list")){let t=this.getContent(),s=e.getLastItem();this.app.block.set(s,"end"),this._insertHtml(t),this.remove(),i.isEmpty()&&i.remove()}else this.app.block.set(e,"start");return!0}},_insertItem(t,e){let s;"delete"===t?(s=e.getPlainText(),e.remove()):(s=this.getPlainText(),this.remove(),this.app.block.set(e,"end")),this._insertHtml(s,!1)},_handleEmptyOrEnd(){const t=new L(this.app).getBlockControlled(),e=!!t&&this.dom(t).dataget("instance");e&&this.isListEnd()&&e.isEmpty()?(this.getParent().insertEmpty({position:"after",caret:"start",type:"input"}),e.remove()):this._createAndSetItem()},_handleContentSplit(){const t=new G(this.app).split(this.$content),e=this._createItem();e.setContent(t.html()),t.remove(),this.app.block.set(e,"start")},_createAndSetItem(t="after"){const e=this._createItem(t);this.app.block.set(e,"start")},_traverse(t,e){t.preventDefault();const s="next"===e,i=s?"getNext":"getPrev",r=s?"getNextParent":"getPrevParent",a=s?"start":"end";let n=this[s?"isLastElement":"isFirstElement"]()?this.getParent():this,o=n[i]();if(o)this.app.block.set(o,a);else{if(o=n[r](),!o)return!0;this.app.block.set(o,a)}},_createItem(t){let e=this.app.create("block.todoitem");return t=t||"after",this.$block[t](e.getBlock()),e},_parse(){let t=this.$block.html(),e=this.$block.attr("data-placeholder"),s=this.opts.get("todo.templateItem"),i=this.opts.get("todo.templateItemDone"),r=this.$block.find("input");let a=new T(this.app).findTodoItemTag(),n=this.$block.find(a);this.$input=0!==r.length?r:this.dom(this.opts.get("todo.templateInput")),this.$input.attr("tabindex","-1"),this.$content=0!==n.length?n:this.dom(this.opts.get("todo.templateContent")),this.$content.attr("contenteditable",!0),e&&this.setPlaceholder(e),this.opts.get("todo.template")&&(t=this._extractCheckboxContent(t,s,i)),this._updateItemState(t,r,n,s,i),this._appendNewElements(r,n),this.$input.on("click.rx-todo",this._clickInput.bind(this)),this.$input.on("pointerdown.rx-todo",this._clickInput.bind(this))},_updateItemState(t,e,s,i,r){let a=i.replace(/\s/g,"");const n=this.opts.get("todo.toggleClass");let o;t.startsWith(r)?(t=t.replace(r,""),o="1",this._setAttributes(!0,o)):(t.startsWith(a)||t.startsWith(i))&&(t=t.replace(t.startsWith(a)?a:i,""),o="0",this._setAttributes(!1,o)),n&&this.$block.toggleClass(n,"1"===o),0===e.length&&0===s.length&&(t=t.trim(),this.$content.html(t),this.$block.html(""))},_setAttributes(t,e){this.$input.attr("checked",t),this.$block.attr("data-checked",e)},_appendNewElements(t,e){0===t.length&&this.$block.append(this.$input),0===e.length&&this.$block.append(this.$content)},_clickInput(t){if(t.preventDefault(),t.stopPropagation(),this.app.event.isPaused())return;this.$input.get().checked=!this.$input.get().checked,this.app.block.set(this.$block);let e=this.$input.attr("checked")?"1":"0";this.$block.attr("data-checked",e);const s=this.opts.get("todo.toggleClass");s&&this.$block.toggleClass(s,"1"===e)},_extractCheckboxContent(t,e,s){const i=new T(this.app),r=document.createElement("div");r.innerHTML=t;const a=r.textContent||"",n=i.escapeRegExp(e),o=i.escapeRegExp(s),l=new RegExp("("+n+"|"+o+")\\s*(.*)","g").exec(a);return l?l[0].trim():t}}),l.add("block","mergetag",{mixins:["block"],props:{type:"mergetag",editable:!1,control:!1,inline:!0,context:!0},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.dom("<span>").attr(this.opts.get("dataBlock"),"mergetag")}}),window.Redactor=l,window.addEventListener("load",(function(){l("[data-redactor]")})),"object"==typeof module&&module.exports&&(module.exports=l,module.exports.Redactor=l)}();